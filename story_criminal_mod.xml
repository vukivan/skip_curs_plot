<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Story_Criminal" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>

    <cue name="Patch_Userdata" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start"/>
      </conditions>
      <actions>
        <do_if value="Ch6_Complete.state == cuestate.active or Ch6_Complete.state == cuestate.complete or Ch6_Complete.state == cuestate.cancelled">
          <do_if value="@Start.$PlayerChoiceAE">
            <set_userdata storystate="'story_criminal_wildcard'" value="1"/>
          </do_if>
          <do_else>
            <set_userdata storystate="'story_criminal_arrested_curs'" value="1"/>
          </do_else>
        </do_if>
      </actions>
    </cue>

    <!-- 
      Ch6 'fan' force effect, see room_gen_prison_forceemitter_macro
    -->
    <cue name="Start" namespace="this" mapeditor="false" version="4">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start"/>
        <check_value value="player.galaxy.macro.ismacro.{macro.xu_ep2_universe_macro}" comment="only in main-galaxy"/>
      </conditions>
      <actions>
        <set_value name="$DebugChance"                exact="0"/>
        <set_value name="$DeepDebugChance"            exact="0"     comment="for AI scripts and similar external code"/>
        <set_value name="$MissionCue"                 exact="this"/>
        <set_value name="$Page"                       exact="30252"/>

        <debug_text text="'Initializing Criminal Story'" chance="$DebugChance"/>

        <!-- Chapter List for Force Cues to abort -->
        <set_value name="$Chapters" exact="[Ch1_Intro,
                                            Ch2_Piracy_Induction,
                                            Ch3_Piracy_Targeted,
                                            Ch4_Mellerds_Trust,
                                            Ch5_Preparations,
                                            Ch6_Final]"/>

        <!--Custom gamestart flags (only reliable after 6.20 gamestarts)-->
        <set_value name="$story_criminal_wildcard" exact="1"/>
        <set_value name="$story_criminal_arrested_curs" exact="0"/>
        <set_value name="$HasCustomGamestartSkip" exact="
                   $story_criminal_wildcard or 
                   $story_criminal_arrested_curs"/>
      </actions>
      <patch sinceversion="2">
        <set_value name="$HasCustomGamestartSkip" exact="false"/>
      </patch>
      <patch sinceversion="3">
        <do_if value="not $PirateLandmark01.exists">
          <find_station name="$PirateLandmark01" space="$PirateSectors" godstationentry="'pirate_landmark_01'" required="true" />
          <debug_text text="'Tidebreak ' + $PirateLandmark01 + ' ' + $PirateLandmark01.knownname + ' has been restored.'" filter="savegame"/>
        </do_if>
      </patch>
      <patch sinceversion="4">
        <set_value name="$story_criminal_wildcard" exact="false"/>
        <set_value name="$story_criminal_arrested_curs" exact="false"/>
      </patch>
      <cues>

        <cue name="Setup">
          <actions>
            <find_sector name="$PirateSectors" extension="'ego_dlc_pirate'" multiple="true"/>
          </actions>
          <cues>

            <cue name="Setup_Locations">
              <delay exact="1s" comment="small delay as a workaround for events firing in different order when loading an existing savegame"/>
              <actions>
                <find_station name="$PirateLandmark01" space="$PirateSectors" godstationentry="'pirate_landmark_01'" required="true" />
                <find_station name="$PirateLandmark02" space="$PirateSectors" godstationentry="'pirate_landmark_02'" required="true"/>
                <!--find_station name="$PirateLandmarks" space="$PirateSectors" multiple="true" godstationentry="['pirate_landmark_01', 'pirate_landmark_02']" /-->

                <!-- Prison Station -->
                <find_sector name="$EighteenBillionSector" macro="macro.cluster_02_sector001_macro" required="true"/>
                <find_station name="$PrisonStation" space="$EighteenBillionSector" godstationentry="'story_prison_station_id'" required="true"/>

                <!-- S1 - Loan Shark Space -->
                <find_sector macro="macro.Cluster_501_Sector001_macro"  required="true" groupname="$S1_SectorGroup" name="$S1a_North"/>
                <find_sector macro="macro.Cluster_502_Sector001_macro"  required="true" groupname="$S1_SectorGroup" name="$S1b_Center"/>
                <find_sector macro="macro.Cluster_503_Sector001_macro"  required="true" groupname="$S1_SectorGroup" name="$S1c_South"/>

                <!-- Base Game Sectors -->
                <find_sector macro="macro.cluster_02_sector001_macro"  required="true" name="$18Bil_Sector"/>
                <find_sector macro="macro.cluster_08_sector001_macro"  required="true" name="$SilentWitness1_Sector"/>

                <!-- Relevant Gates -->
                <find_gate name="$Accelerator_S1b_S1a" space="$S1b_Center" destination="$S1a_North" required="true"/>
                <find_gate name="$Accelerator_S1b_S1c" space="$S1b_Center" destination="$S1c_South" required="true"/>
                <find_gate name="$Accelerator_S1a_S1b" space="$S1a_North" destination="$S1b_Center" required="true"/>
                <find_gate name="$Gate_S1a_18Bil" space="$S1a_North" destination="$18Bil_Sector" required="true" />
                <find_gate name="$Gate_S1a_SilentWit1" space="$S1a_North" destination="$SilentWitness1_Sector" required="true" />
              </actions>
            </cue>

            <cue name="Setup_Character_Maestro" version="2">
              <actions>
                <debug_text text="'Creating Maestro'" chance="$DebugChance"/>
                <create_cue_actor name="$MaestroActor" cue="namespace" macro="character_story_maestro_macro">
                  <page exact="10453"/>
                  <owner exact="faction.civilian"/>
                  <skills>
                    <skill type="management"  exact="15"/>
                    <skill type="morale"      exact="12"/>
                    <skill type="piloting"    exact="5"/>
                    <skill type="engineering" exact="3"/>
                    <skill type="boarding"    exact="6"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$MaestroActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$MaestroActor" icon="'captain'" title="'{30252,151}'"/>
                <set_value name="md.$PersistentCharacters.$MaestroActor" exact="$MaestroActor"/>
                <set_value name="$MaestroActorCutsceneKey"   exact="table[ $key = 'ShowNPCFace']"/>
                <set_value name="$MaestroActor.$cutscenekey" exact="table[ $key = 'ShowNPCFace']"/>
                <set_value name="$AddStoryMentors_Maestro"/>
              </actions>
              <patch sinceversion="2">
                <set_value name="$AddStoryMentors_Maestro"/>
              </patch>
              <cues>
                <cue name="PATCH_AddStoryMentors_Maestro" onfail="cancel">
                  <conditions>
                    <check_value value="$AddStoryMentors_Maestro?"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$MaestroActor]"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Setup_Character_Axiom" version="2">
              <actions>
                <debug_text text="'Creating Axiom'" chance="$DebugChance"/>
                <create_cue_actor name="$AxiomActor" cue="namespace" macro="character_story_axiom_macro">
                  <page exact="10356"/>
                  <owner exact="faction.civilian"/>
                  <skills>
                    <skill type="management"  exact="8"/>
                    <skill type="morale"      exact="12"/>
                    <skill type="piloting"    exact="7"/>
                    <skill type="engineering" exact="15"/>
                    <skill type="boarding"    exact="7"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$AxiomActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$AxiomActor" icon="'specialist'" title="'{30252,151}'"/>
                <set_value name="md.$PersistentCharacters.$AxiomActor" exact="$AxiomActor"/>
                <set_value name="$AxiomActorCutsceneKey"   exact="table[ $key = 'ShowNPCFace']"/>
                <set_value name="$AxiomActor.$cutscenekey" exact="table[ $key = 'ShowNPCFace']"/>
                <set_value name="$AxiomActor.$donotscan" comment="prevents police from scanning the ship"/>
                <set_value name="$AddStoryMentors_Axiom"/>
              </actions>
              <patch sinceversion="2">
                <set_value name="$AddStoryMentors_Axiom"/>
              </patch>
              <cues>
                <cue name="PATCH_AddStoryMentors_Axiom" onfail="cancel">
                  <conditions>
                    <check_value value="$AddStoryMentors_Axiom?"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$AxiomActor]"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Setup_Character_Ace" version="2">
              <actions>
                <debug_text text="'Creating Ace'" chance="$DebugChance"/>
                <create_cue_actor name="$AceActor" cue="namespace" macro="character_story_ace_macro">
                  <page exact="10558"/>
                  <owner exact="faction.civilian"/>
                  <skills>
                    <skill type="management"  exact="6"/>
                    <skill type="morale"      exact="13"/>
                    <skill type="piloting"    exact="15"/>
                    <skill type="engineering" exact="6"/>
                    <skill type="boarding"    exact="0"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$AceActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$AceActor" icon="'pilot'" title="'{30252,151}'"/>
                <set_value name="md.$PersistentCharacters.$AceActor" exact="$AceActor"/>
                <set_value name="$AceActorCutsceneKey"   exact="table[ $key = 'ShowNPCFace']"/>
                <set_value name="$AceActor.$cutscenekey" exact="table[ $key = 'ShowNPCFace']"/>
                <set_value name="$AceActor.$donotscan" comment="prevents police from scanning the ship"/>
                <set_value name="$AddStoryMentors_Ace"/>
              </actions>
              <patch sinceversion="2">
                <set_value name="$AddStoryMentors_Ace"/>
              </patch>
              <cues>
                <cue name="PATCH_AddStoryMentors_Ace" onfail="cancel">
                  <conditions>
                    <check_value value="$AddStoryMentors_Ace?"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$AceActor]"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Setup_Character_KrissMellerd" version="2">
              <actions>
                <debug_text text="'Creating Kriss Mellerd'" chance="$DebugChance"/>
                <create_cue_actor name="$KrissMellerdActor" cue="namespace" macro="character_story_kriss_mellerd_macro">
                  <page exact="10188" comment="Kriss Mellerd"/>
                  <owner exact="faction.ministry"/>
                  <skills>
                    <skill type="management"  exact="14"/>
                    <skill type="morale"      exact="11"/>
                    <skill type="piloting"    exact="2"/>
                    <skill type="engineering" exact="8"/>
                    <skill type="boarding"    exact="6"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$KrissMellerdActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$KrissMellerdActor" icon="'manager'" title="'{30252,152}'"/>
                <set_value name="md.$PersistentCharacters.$KrissMellerdActor" exact="$KrissMellerdActor"/>
                <set_value name="$KrissMellerdActorCutsceneKey"   exact="table[ $key = 'ShowNPCFace']"/>
                <set_value name="$KrissMellerdActor.$cutscenekey" exact="table[ $key = 'ShowNPCFace']"/>
                <set_value name="$AddStoryMentors_KrissMellerd"/>
              </actions>
              <patch sinceversion="2">
                <set_value name="$AddStoryMentors_KrissMellerd"/>
              </patch>
              <cues>
                <cue name="PATCH_AddStoryMentors_KrissMellerd" onfail="cancel">
                  <conditions>
                    <check_value value="$AddStoryMentors_KrissMellerd?"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$KrissMellerdActor]"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Setup_Character_StevLucca">
              <actions>
                <debug_text text="'Creating Stev Lucca'" chance="$DebugChance"/>
                <create_cue_actor name="$StevLuccaActor" cue="namespace" macro="character_story_stev_lucca_macro">
                  <page exact="10454"/>
                  <owner exact="faction.civilian"/>
                  <skills>
                    <skill type="management"  exact="4"/>
                    <skill type="morale"      exact="6"/>
                    <skill type="piloting"    exact="5"/>
                    <skill type="engineering" exact="5"/>
                    <skill type="boarding"    exact="0"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$StevLuccaActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$StevLuccaActor" icon="'shadyguy'"/>
                <set_value name="md.$PersistentCharacters.$StevLuccaActor" exact="$StevLuccaActor"/>
                <set_value name="$StevLuccaActorCutsceneKey"   exact="table[ $key = 'ShowNPCFace']"/>
                <set_value name="$StevLuccaActor.$cutscenekey" exact="table[ $key = 'ShowNPCFace']"/>
                <create_list name="$LuccaSaid"/>
              </actions>
            </cue>

            <!-- Ch4 -->
            <cue name="Setup_Character_ShadyBarContactActor">
              <actions>
                <debug_text text="'Creating ShadyBarActor'" chance="$DebugChance"/>
                <create_cue_actor name="$ShadyBarContactActor" cue="namespace" macro="character_story_shady_bar_person_macro">
                  <page exact="10175"/>
                  <owner exact="faction.civilian"/>
                  <skills>
                    <skill type="management"  exact="13"/>
                    <skill type="morale"      exact="11"/>
                    <skill type="piloting"    exact="2"/>
                    <skill type="engineering" exact="5"/>
                    <skill type="boarding"    exact="0"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$ShadyBarContactActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$ShadyBarContactActor" icon="'shadyguy'"/>
                <!-- TODO: Select proper title for this guy. He is, among other things, the handler of the GS1 player character. -->
                <set_value name="md.$PersistentCharacters.$ShadyBarContactActor" exact="$ShadyBarContactActor"/>
                <set_value name="$ShadyBarContactActorCutsceneKey"   exact="table[ $key = 'ShowNPCFace']"/>
                <set_value name="$ShadyBarContactActorCutsceneKey.$cutscenekey" exact="table[ $key = 'ShowNPCFace']"/>
              </actions>
            </cue>

            <cue name="Setup_Character_ShadyBarDecoyActor">
              <actions>
                <debug_text text="'Creating ShadyBarActor Decoy'" chance="$DebugChance"/>
                <create_cue_actor name="$ShadyBarDecoyActor" cue="namespace">
                  <select race="race.teladi" faction="faction.ministry"/>
                  <page exact="10559"/>
                  <owner exact="faction.civilian"/>
                  <skills>
                    <skill type="management"  exact="4"/>
                    <skill type="morale"      exact="6"/>
                    <skill type="piloting"    exact="5"/>
                    <skill type="engineering" exact="5"/>
                    <skill type="boarding"    exact="0"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$ShadyBarDecoyActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$ShadyBarDecoyActor" icon="'shadyguy'"/>
                <set_value name="md.$PersistentCharacters.$ShadyBarDecoyActor" exact="$ShadyBarDecoyActor"/>
                <set_value name="$ShadyBarDecoyActorCutsceneKey"   exact="table[ $key = 'ShowNPCFace']"/>
                <set_value name="$ShadyBarDecoyActor.$cutscenekey" exact="table[ $key = 'ShowNPCFace']"/>

                <create_list name="$DecoySaid"/>
              </actions>
            </cue>

            <cue name="Setup_Character_MellerdsThugActor">
              <actions>
                <debug_text text="'Creating MellerdsThugActor'" chance="$DebugChance"/>
                <create_cue_actor name="$MellerdsThugActor" cue="namespace" macro="character_scavenger_male_asi_01_macro">
                  <name name="'{20301,1004} {20301,1182}'"/>
                  <page exact="10174"/>
                  <owner exact="faction.ministry"/>
                  <skills>
                    <skill type="management"  exact="4"/>
                    <skill type="morale"      exact="6"/>
                    <skill type="piloting"    exact="5"/>
                    <skill type="engineering" exact="5"/>
                    <skill type="boarding"    exact="0"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$MellerdsThugActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$MellerdsThugActor" icon="'marineofficer'" title="'{30252,155}'"/>
                <set_value name="md.$PersistentCharacters.$MellerdsThugActor" exact="$MellerdsThugActor"/>
                <set_value name="$MellerdsThugActorCutsceneKey"   exact="table[ $key = 'ShowNPCFace']"/>
                <set_value name="$MellerdsThugActor.$cutscenekey" exact="table[ $key = 'ShowNPCFace']"/>
              </actions>
            </cue>
            <cue name="Setup_Character_Marine_1">
              <actions>
                <debug_text text="'Creating MellerdsThugActor'" chance="$DebugChance"/>
                <create_cue_actor name="$MellerdsMarine1Actor" cue="namespace" macro="character_argon_male_marine_helmet_01_macro">
                  <owner exact="faction.ministry"/>
                  <skills>
                    <skill type="management"  exact="0"/>
                    <skill type="morale"      exact="6"/>
                    <skill type="piloting"    exact="0"/>
                    <skill type="engineering" exact="0"/>
                    <skill type="boarding"    exact="5"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$MellerdsMarine1Actor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$MellerdsMarine1Actor" icon="'marineofficer'" title="'{30252,155}'"/>
              </actions>
            </cue>
            <cue name="Setup_Character_Marine_2">
              <actions>
                <debug_text text="'Creating MellerdsThugActor'" chance="$DebugChance"/>
                <create_cue_actor name="$MellerdsMarine2Actor" cue="namespace" macro="character_scavenger_female_afr_01_macro">
                  <owner exact="faction.ministry"/>
                  <skills>
                    <skill type="management"  exact="0"/>
                    <skill type="morale"      exact="6"/>
                    <skill type="piloting"    exact="0"/>
                    <skill type="engineering" exact="0"/>
                    <skill type="boarding"    exact="5"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$MellerdsMarine2Actor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$MellerdsMarine2Actor" icon="'marineofficer'" title="'{30252,155}'"/>
              </actions>
            </cue>

            <cue name="Setup_RaiderHubShip">
              <actions>
                <set_value name="$EmpyreanCursPaint" exact="ware.paintmod_0098" comment="Cobalt"/>
              </actions>
              <delay exact="1.5s"/>
              <actions>
                <set_value name="$ClosestAccelerator" exact="$Gate_S1a_18Bil"/>

                <create_position name="$RaiderHubShipPos" object="$ClosestAccelerator" space="$S1a_North" x="0km" y="-500m" z="13km"/>
                <create_rotation name="$FaceGate"
                                 pitch="$ClosestAccelerator.rotation.pitch"
                                 roll="$ClosestAccelerator.rotation.roll"
                                 yaw="$Gate_S1a_18Bil.rotation.yaw + 360deg"/>

                <create_cue_actor name="$RaiderHubShipPilotActor" cue="namespace" macro="character_story_arcadian_endeavour_crew_argon_female_asi">
                  <name name="'{30252,151}'"/>
                  <owner exact="faction.civilian"/>
                  <skills>
                    <skill type="management"  exact="2"/>
                    <skill type="morale"      exact="15"/>
                    <skill type="piloting"    exact="15"/>
                    <skill type="engineering" exact="5"/>
                    <skill type="boarding"    exact="4"/>
                  </skills>
                </create_cue_actor>

                <create_ship name="$RaiderHubShip" capturable="false" missioncue="namespace" macro="ship_pir_l_scavenger_01_a_storyhighcapacity_macro" sector="$S1a_North" commandeerable="false">
                  <owner exact="faction.civilian" overridenpc="true"/>
                  <loadout ref="story_raiderhubship"/>
                  <pilot actor="$RaiderHubShipPilotActor"/>
                  <paint ware="$EmpyreanCursPaint"/>
                  <safepos x="$RaiderHubShipPos.x" y="$RaiderHubShipPos.y" z="$RaiderHubShipPos.z"/>
                  <rotation value="$FaceGate"/>
                </create_ship>

                <set_value name="$CrewSetup" exact="[ [ 6, macro.character_story_arcadian_endeavour_crew_teladi_female_generic, entityrole.service ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_argon_female_cau,      entityrole.service ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_argon_male_cau,        entityrole.service ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_argon_female_afr,      entityrole.service ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_pirate_male_cau,       entityrole.service ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_pirate_female_afr,     entityrole.service ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_pirate_male_asi,       entityrole.service ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_scavenger_female_cau,  entityrole.service ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_scavenger_male_afr,    entityrole.service ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_scavenger_female_asi,  entityrole.service ],
                                                      [ 3, macro.character_story_arcadian_endeavour_crew_teladi_female_pilot,   entityrole.marine  ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_argon_male_afr,        entityrole.marine  ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_argon_female_asi,      entityrole.marine  ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_argon_male_asi,        entityrole.marine  ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_pirate_female_cau,     entityrole.marine  ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_pirate_male_afr,       entityrole.marine  ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_pirate_female_asi,     entityrole.marine  ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_scavenger_male_cau,    entityrole.marine  ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_scavenger_female_afr,  entityrole.marine  ],
                                                      [ 1, macro.character_story_arcadian_endeavour_crew_scavenger_male_asi,    entityrole.marine  ] ]"/>

                <do_for_each in="$CrewSetup" name="$CurrentDefinition">
                  <do_all exact="$CurrentDefinition.{1}">
                    <do_if value="$CurrentDefinition.{3} == entityrole.service">
                      <create_cue_actor name="this.$Actor" cue="namespace" macro="$CurrentDefinition.{2}">
                        <owner exact="faction.civilian"/>
                        <skills>
                          <!-- Taken from service_argon_random_elite -->
                          <skill type="engineering" min="10" max="12"/>
                          <skill type="morale" min="10" max="12"/>
                          <skill type="piloting" min="3" max="6"/>
                          <skill type="management" min="1" max="2"/>
                          <skill type="boarding" min="1" max="3"/>
                        </skills>
                      </create_cue_actor>
                    </do_if>
                    <do_else>
                      <create_cue_actor name="this.$Actor" cue="namespace" macro="$CurrentDefinition.{2}">
                        <owner exact="faction.civilian"/>
                        <skills>
                          <!-- Taken from marine_argon_random_elite -->
                          <skill type="boarding" min="10" max="12"/>
                          <skill type="morale" min="10" max="12"/>
                          <skill type="engineering" min="2" max="3"/>
                          <skill type="piloting" min="4" max="6"/>
                          <skill type="management" min="1" max="3"/>
                        </skills>
                      </create_cue_actor>
                    </do_else>
                    <create_npc_template entity="this.$Actor" name="this.$Template" object="$RaiderHubShip" role="$CurrentDefinition.{3}"/>
                  </do_all>
                </do_for_each>

                <set_object_name object="$RaiderHubShip" page="30252" line="201" comment="Arcadian Endeavour"/>
                <set_value name="$RaiderHubShip.pilot.$donotscan" comment="prevents police from scanning the ship"/>
                <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                  <param name="Object" value="$RaiderHubShip"/>
                  <param name="RequesterCue" value="namespace"/>
                  <param name="MinHull" value="100"/>
                  <param name="ReachedThresholdSignalCue" value="null"/>
                  <param name="IncludeEngines" value="true" comment="AE needs to escape in Ch6, so keep engines alive"/>
                  <param name="IncludeTurrets" value="true" comment="AE needs to fight in Ch6, keep turrets alive"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </run_actions>
                <set_object_min_shield object="$RaiderHubShip" exact="20"/>
                <create_order object="$RaiderHubShip" id="'MoveWait'">
                  <param name="destination" value="[$S1a_North, $RaiderHubShipPos]"/>
                </create_order>

              </actions>
              <cues>
                <cue name="Setup_RaiderHubShip_MaestroPosition">
                  <conditions>
                    <event_cue_completed cue="Setup_RaiderHubShip"/>
                  </conditions>
                  <actions>
                    <create_position name="$MaestroPos" x="0.96" y="0.03" z="1.88" space="$RaiderHubShip.controlroom"/>
                    <create_rotation name="$MaestroRot" yaw="-10.0deg"/>

                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MaestroActor,
                                                                                              table[
                                                                                              $requestercue = namespace,
                                                                                              $location = $RaiderHubShip.controlroom,
                                                                                              $priority = 100,
                                                                                              $rotation = $MaestroRot,
                                                                                              $position = $MaestroPos,
                                                                                              $debugchance = 0,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                              ]"/>
                  </actions>
                </cue>
                <cue name="Setup_RaiderHubShip_AxiomShip">
                  <conditions>
                    <event_cue_completed cue="Setup_RaiderHubShip"/>
                  </conditions>
                  <actions>
                    <set_value name="$AxiomShipMacro" exact="macro.ship_arg_s_trans_container_02_b_macro"/>
                    <find_dockingbay name="this.$RaiderHubShipDock" object="$RaiderHubShip" required="true">
                      <match_dock storage="true" size="$AxiomShipMacro.docksize"/>
                    </find_dockingbay>
                    <find_dockingbay name="this.$RaiderHubShipDockInternal" object="$RaiderHubShip" required="true">
                      <match_dock storage="true" size="$AxiomShipMacro.docksize"/>
                    </find_dockingbay>
                    <create_ship name="$AxiomShip" macro="$AxiomShipMacro" dock="this.$RaiderHubShipDock" capturable="false" commandeerable="false" comment="Used by Axiom + player in Ch6 to fly to Prison Station">
                      <owner exact="faction.civilian" overridenpc="true" />
                      <loadout ref="story_courier_minimal"/>
                      <paint ware="$EmpyreanCursPaint"/>
                    </create_ship>
                  </actions>
                </cue>
                <cue name="Setup_AceShip">
                  <conditions>
                    <event_cue_completed cue="Setup_RaiderHubShip"/>
                  </conditions>
                  <actions>
                    <set_value name="$AceShipMacro" exact="macro.ship_tel_s_trans_container_01_a_macro"/>
                    <create_loadout result="$AceLoadout" comment="Magpie Vanguard, S Courier (ship_tel_s_trans_container_01_a_macro)">
                      <macros>
                        <engine macro="engine_tel_s_combat_01_mk3_macro" path="../con_engine_02"/>
                        <engine macro="engine_tel_s_combat_01_mk3_macro" path="../con_engine_01"/>
                        <weapon macro="weapon_gen_s_gatling_01_mk2_macro" path="../con_weapon_01"/>
                        <shield macro="shield_tel_s_standard_01_mk3_macro" path="../con_shield_01"/>
                        <shield macro="shield_tel_s_standard_01_mk3_macro" path="../con_shield_02"/>
                      </macros>
                      <ammunition>
                        <ammunition macro="countermeasure_flares_01_macro" exact="4"/>
                      </ammunition>
                      <software>
                        <software ware="software_dockmk2"/>
                        <software ware="software_flightassistmk1"/>
                        <software ware="software_scannerlongrangemk2"/>
                        <software ware="software_scannerobjectmk2"/>
                        <software ware="software_targetmk1"/>
                        <software ware="software_trademk1"/>
                      </software>
                      <virtualmacros>
                        <thruster macro="thruster_gen_s_combat_01_mk3_macro"/>
                      </virtualmacros>
                    </create_loadout>
                    <find_dockingbay name="this.$RaiderHubShipDockInternal" object="$RaiderHubShip" required="true">
                      <match_dock storage="true" size="$AceShipMacro.docksize"/>
                    </find_dockingbay>

                    <create_ship name="$AceShip" missioncue="namespace" macro="$AceShipMacro" dock="this.$RaiderHubShipDockInternal" sector="$S1a_North" capturable="false" commandeerable="false">
                      <owner exact="faction.civilian"/>
                      <loadout loadout="$AceLoadout"/>
                      <equipmentmods>
                        <engine ware="ware.mod_engine_forwardthrust_01_mk3"/>
                        <shield ware="ware.mod_shield_capacity_01_mk3"/>
                        <ship ware="ware.mod_ship_mass_01_mk3"/>
                      </equipmentmods>
                      <paint ware="$EmpyreanCursPaint"/>
                    </create_ship>

                    <set_value name="$AceShipDefault" exact="$AceShip" comment="$AceShip is the current one, but Ace can have multiple ships so keep references to them."/>
                    <set_object_name object="$AceShip" page="30252" line="202" comment="Golden Flea"/>

                    <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                      <param name="Object" value="$AceShip"/>
                      <param name="MinHull" value="70"/>
                      <param name="RequesterCue" value="namespace"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>

                    <!-- Disabled for now to make sure Ace's remains docked on AE until needed in ch2 -->
                    <!--create_order id="'AssignCommander'" object="$AceShip" immediate="true">
                      <param name="commander" value="$RaiderHubShip"/>
                      <param name="assignment" value="assignment.defence"/>
                      <param name="cancelorders" value="true"/>
                    </create_order-->
                    <create_order object="$AceShip" id="'Wait'">
                      <param name="noattackresponse" value="true"/>
                      <param name="allowdocked" value="true" comment="default = this.ship.isplayerowned and not this.ship.iscapitalship"/>
                    </create_order>
                  </actions>
                </cue>
                <cue name="Setup_RaiderHubShip_Interiors" version="2">
                  <conditions>
                    <event_cue_completed cue="Setup_RaiderHubShip"/>
                  </conditions>
                  <actions>
                    <!-- Room Variables -->
                    <set_value name="$RoomObject" exact="$RaiderHubShip"/>
                    <get_room_definition macro="$CorridorMacro" doors="$Doors" race="race.teladi" tags="tag.corridor" />
                    <!-- race.argon looks to clean, Teladi sort of fits the pir ship better.. -->

                    <!-- Generator Room -->
                    <!-- Determine interior macros -->
                    <get_room_definition macro="$GeneratorRoomMacro" tags="tag.generatorroom" />
                    <!-- Create persistent interior. -->
                    <create_dynamic_interior      roomname="$RaiderHubShip_GeneratorRoom"         room="$GeneratorRoomMacro"
                                              corridorname="$RaiderHubShip_GeneratorCorridor" corridor="$CorridorMacro"
                                              interiorname="$RaiderHubShip_GeneratorInterior"
                                              name="'{20007,1531}'" comment="Generator Room"
                                              object="$RoomObject" persistent="true"/>
                    <set_dynamic_interior_private object="$RoomObject" interior="$RaiderHubShip_GeneratorInterior" private="true"/>

                    <!-- Crew Quarters Room -->
                    <!-- Determine interior macros -->
                    <get_room_definition macro="$CrewQuartersRoomMacro" tags="tag.crewquarters" />
                    <!-- Create persistent interior. -->
                    <create_dynamic_interior      roomname="$RaiderHubShip_CrewQuartersRoom"         room="$CrewQuartersRoomMacro"
                                              corridorname="$RaiderHubShip_CrewQuartersCorridor" corridor="$CorridorMacro"
                                              interiorname="$RaiderHubShip_CrewQuartersInterior" roomtype="roomtype.crewquarters"
                                              name="'{20007,1251}'" comment="Crew Quarter Room"
                                              object="$RoomObject" persistent="true"/>

                  </actions>
                  <patch sinceversion="2">
                    <!--Crew Quarters Room-->
                    <!--Determine interior macros-->
                    <get_room_definition macro="$CrewQuartersRoomMacro" tags="tag.crewquarters" />
                    <!--Create persistent interior.-->
                    <create_dynamic_interior      roomname="$RaiderHubShip_CrewQuartersRoom"         room="$CrewQuartersRoomMacro"
                                              corridorname="$RaiderHubShip_CrewQuartersCorridor" corridor="$CorridorMacro"
                                              interiorname="$RaiderHubShip_CrewQuartersInterior" roomtype="roomtype.crewquarters"
                                              name="'{20007,1251}'" comment="Crew Quarter Room"
                                              object="$RoomObject" persistent="true"/>
                  </patch>
                </cue>

                <cue name="Setup_RaiderHubStorage_DEBUG">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <find_dockingbay object="$RaiderHubShip" name="$RaiderHubDocks" multiple="true"/>
                    <do_all exact="$RaiderHubDocks.count" counter="$d">
                      <debug_text text="'- %s `%s` free:%s capacity:%s'.[$RaiderHubDocks.{$d}, $RaiderHubDocks.{$d}.name, $RaiderHubDocks.{$d}.shipstorage.free, $RaiderHubDocks.{$d}.shipstorage.capacity]"/>
                    </do_all>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Setup_Remember_Boso_HQ" onfail="cancel">
              <conditions>
                <check_value value="md.X4Ep1_Mentor_Subscriptions.Start.$BoronMet?"/>
              </conditions>
              <actions>
                <signal_cue cue="Setup_Boso_HQ"/>
              </actions>
            </cue>

            <cue name="Setup_Retrieve_Boso_HQ">
              <conditions>
                <check_any>
                  <event_cue_completed cue="md.X4Ep1_Mentor_Subscriptions.First_Meeting"/>
                  <event_cue_completed cue="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors"/>
                </check_any>
              </conditions>
              <actions>
                <signal_cue cue="Setup_Boso_HQ"/>
              </actions>
            </cue>

            <cue name="Setup_Boso_HQ">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="1s"/>
              <actions>
                <!-- Remember Boso/HQ from X4Ep1_Mentor_Subscriptions -->
                <set_value name="$BosoTa" exact="md.$PersistentCharacters.$BosoTa"/>
                <assert value="$BosoTa != null" text="'Boso is null'"/>

                <set_value name="$HQ" exact="md.X4Ep1_Mentor_Subscriptions.Start.$HQ"/>
                <set_value name="$BosoCutsceneKey"      exact="table[ $key = 'ShowCharacterBoron']"/>
              </actions>
            </cue>

            <cue name="Setup_Remember_Dal" onfail="cancel">
              <conditions>
                <check_value value="md.Story_Diplomacy_Intro.Pt11_End.state == cuestate.complete"/>
              </conditions>
              <actions>
                <signal_cue cue="Setup_Dal"/>
              </actions>
            </cue>

            <cue name="Setup_Retrieve_Dal">
              <conditions>
                <event_cue_completed cue="md.Story_Diplomacy_Intro.Pt11_End"/>
              </conditions>
              <actions>
                <signal_cue cue="Setup_Dal"/>
              </actions>
            </cue>

            <cue name="Setup_Dal">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="1s"/>
              <actions>
                <!-- Remember Dal from X4Ep1_Diplomacy_Subscriptions -->
                <set_value name="$DalBusta" exact="md.$PersistentCharacters.$DalBusta"/>
                <assert value="$DalBusta != null" text="'DalBusta is null'"/>
                <set_value name="$BosoTa" exact="md.$PersistentCharacters.$BosoTa"/>
                <assert value="$BosoTa != null" text="'Boso is null'"/>

                <set_value name="$HQ" exact="md.X4Ep1_Mentor_Subscriptions.Start.$HQ"/>
                <set_value name="$DalCutsceneKey"       exact="table[ $key = 'ShowCharacterDal']"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Debug">
          <cues>
            <cue name="Debug_tag_upperlock_open">
              <!--
                1) signal: 
                   => triggers the "open gate" cutscene as used in ch4
                   => forces ch6 prison
                
                2) go to prison block -> right -> airlock (you can see it through the airlock window)
                   => "gate" is open
                
                3) leave sector
                4) save & load
                5) re-enter sector
                   => "gate" is closed                
              -->
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>

                <find_station name="$PrisonStation" space="$EighteenBillionSector" godstationentry="'story_prison_station_id'" required="true"/>
                <find_object_component name="$PrisonModule"   object="$PrisonStation"  macro="macro.landmarks_gen_prison_01_macro" recursive="true"/>
                <find_object_component name="$PrisonCorridor" object="$PrisonModule"      macro="macro.prison_escape_v2_macro" recursive="true"/>
              </actions>
              <cues>
                <cue name="Ch4_4_Cutscene_AirlockOpens_DEBUGv3">
                  <actions>
                    <!-- Lock Switch -->
                    <set_value name="$Ch4_SwitchPulled"/>
                    <!--<set_triggers_locked object="$PrisonOfficeRoom" group="tag.terminal_01" locked="true"/>-->

                    <!-- Setup Cutscene -->
                    <trigger_animation object="$PrisonCorridor" group="tag.upperlock" trigger="activate" comment="this should not be necessary"/>
                    <find_object_component name="$PrisonModule"   object="$PrisonStation"  macro="macro.landmarks_gen_prison_01_macro" recursive="true"/>
                    <find_object_component name="$PrisonMarker_22" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy22_macro"  required="true" comment="Airlock-tower Floor 1"/>

                    <play_cutscene result="this.$CutsceneID" key="'Story_Criminal_Ch4_Airlock'" abortable="true" targetmonitor="true">
                      <param name="SphereRoom" object="$PrisonMarker_22"/>
                    </play_cutscene>
                  </actions>
                  <delay exact="5s"/>
                  <actions>
                    <!--<signal_cue cue="Ch4_4_Cutscene_AirlockOpens_Completed" comment="continue conversation"/>-->
                  </actions>
                  <delay exact="5s"/>
                  <actions>
                    <!-- Open Lock -->

                    <trigger_animation object="$PrisonCorridor" group="tag.upperlock" trigger="deactivate" comment="open large airlock to the next set of riddles"/>
                  </actions>
                  <cues>
                    <cue name="Ch4_4_Cutscene_AirlockOpens_Completed_DEBUGv3">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_cutscene_stopped cutscene="parent.$CutsceneID"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <!-- Continue Conversation -->
                        <force_cue cue="Ch6_PrisonStation_Force"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch2_DEBUG_Acquire_Unstable_Crystals">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_inventory ware="ware.inv_unstablecrystal" exact="3"/>
              </actions>
            </cue>

            <cue name="Ch2_DEBUG_Acquire_HackingMaterials">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_inventory ware="ware.inv_agidevice_02" exact="5"/>
                <add_inventory ware="ware.inv_decryptionmodule" exact="1"/>
                <add_inventory ware="ware.inv_interfaceunit" exact="1"/>
              </actions>
            </cue>

            <cue name="Ch2_DEBUG_Acquire_ApparatusMaterials">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_inventory ware="ware.inv_agidevice_01" exact="5"/>
                <add_inventory ware="ware.inv_decryptionmodule" exact="1"/>
                <add_inventory ware="ware.inv_interfaceunit" exact="1"/>
                <add_inventory ware="ware.inv_securityapparatus" exact="1"/>
                <add_inventory ware="ware.inv_securityapparatus_chip" exact="1"/>
              </actions>
            </cue>

            <cue name="Ch2_DEBUG_SecuritySlicer">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_inventory ware="ware.inv_securitydecryptionsystem" exact="1"/>
              </actions>
            </cue>

            <cue name="Ch3_DEBUG_Bomblauncher">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_inventory ware="ware.weapon_gen_spacesuit_demolition_01_mk1" exact="1"/>
              </actions>
            </cue>

            <cue name="Ch3_DEBUG_EMPBomb">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_inventory ware="ware.bomb_player_limpet_emp_01_mk1" exact="4"/>
              </actions>
            </cue>

            <cue name="CharacterShowcase">
              <conditions>
                <event_cue_signalled/>
                <check_value value="$PirateLandmark01.exists"/>
              </conditions>
              <actions>

                <do_if value="not this.$Room?">
                  <!-- create room with mad scientist npc-->
                  <get_room_definition macro="$CorridorMacro" doors="$ResultDoors" race="$PirateLandmark01.owner.primaryrace" tags="tag.corridor"/>
                  <set_value name="$RoomMacro" exact="macro.room_gen_managersoffice_01_macro"/>
                  <set_value name="$InteriorName" exact="'Criminal Gathering'"/>
                  <do_if value="($RoomMacro != null) and ($CorridorMacro != null)">
                    <create_dynamic_interior roomname="this.$Room" object="$PirateLandmark01" name="$InteriorName" corridor="$CorridorMacro" room="$RoomMacro" corridorname="$ResultCorridorName" interiorname="$ResultInteriorName" persistent="true"/>
                  </do_if>
                </do_if>

                <!-- Mission guidance -->
                <do_if value="@this.$Room.exists">

                  <do_if value="player.station != $PirateLandmark01">
                    <teleport_player object="$PirateLandmark01" instant="true" force="true"/>
                  </do_if>

                  <set_value name="$MissionCue" exact="this"/>
                  <create_mission cue="$MissionCue" name="'Story Debug Criminal NPCs'" description="'Set Guidance to the Criminal NPC`s for Story Debugging.'"
                                  type="missiontype.plot" faction="faction.civilian"  difficulty="level.trivial" abortable="false" activate="false">
                    <briefing>
                      <objective step="1" action="objective.flyto" object="this.$Room"/>
                    </briefing>
                  </create_mission>
                  <set_objective_from_briefing cue="$MissionCue" step="1"/>

                  <!-- move all characters to same room, note that this will break the story! -->
                  <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                    param="['add_definition', $MaestroActor, table[
                            $requestercue = $MissionCue,
                            $priority = 100,
                            $location = this.$Room,
                            $position = position.[3.0, 0.0, -7.6],
                            $rotation = rotation.[-90deg, 0deg, 0deg],
                            $debugchance = 0,
                            $debugcaller = if $DebugChance == 100 then this else null]
                        ]"/>
                  <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                    param="['add_definition', $AxiomActor, table[
                            $requestercue = $MissionCue,
                            $priority = 100,
                            $location = this.$Room,
                            $position = position.[3.0, 0.0, -6.6],
                            $rotation = rotation.[-90deg, 0deg, 0deg],
                            $debugchance = 0,
                            $debugcaller = if $DebugChance == 100 then this else null]
                        ]"/>
                  <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                    param="['add_definition', $AceActor, table[
                            $requestercue = $MissionCue,
                            $priority = 100,
                            $location = this.$Room,
                            $position = position.[3.0, 0.0, -5.6],
                            $rotation = rotation.[-90deg, 0deg, 0deg],
                            $debugchance = 0,
                            $debugcaller = if $DebugChance == 100 then this else null]
                        ]"/>
                  <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                      param="['add_definition', $KrissMellerdActor, table[
                            $requestercue = $MissionCue,
                            $priority = 100,
                            $location = this.$Room,
                            $position = position.[-3.229, 0.0, -7.6],
                            $rotation = rotation.[90deg, 0deg, 0deg],
                            $debugchance = 0,
                            $debugcaller = if $DebugChance == 100 then this else null]
                        ]"/>
                  <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                      param="['add_definition', $StevLuccaActor, table[
                            $requestercue = $MissionCue,
                            $priority = 100,
                            $location = this.$Room,
                            $position = position.[-3.229, 0.0, -6.6],
                            $rotation = rotation.[90deg, 0deg, 0deg],
                            $debugchance = 0,
                            $debugcaller = if $DebugChance == 100 then this else null]
                        ]"/>

                </do_if>
              </actions>
            </cue>

            <cue name="Test_NPC_Spacesuit_Navigation">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_cue_actor name="$SpaceSuitPilot" cue="$MissionCue" macro="character_paranid_plot_pirate_duke_macro">
                  <owner exact="faction.civilian"/>
                  <name name="'Spacesuit Testpilot'"/>
                </create_cue_actor>

                <create_ship name="$Suit" macro="ship_par_xs_spacesuit_01_a_macro" sector="player.sector">
                  <owner exact="faction.civilian" overridenpc="true"/>
                  <pilot actor="$SpaceSuitPilot"/>
                  <safepos object="player.entity.ship" z="20m" allowyaxis="true"/>
                </create_ship>

              </actions>
              <cues>

                <cue name="Fly_Order" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$TargetPos" exact="event.param"/>

                    <cancel_all_orders object="$Suit"/>
                    <create_object name="$TargetBeacon" macro="macro.eq_arg_satellite_02_macro" owner="faction.ownerless" sector="$Suit.sector">
                      <position object="$Suit.sector" space="$Suit.sector" value="$TargetPos"/>
                    </create_object>

                    <create_order id="'MoveWait'" object="$Suit" immediate="true">
                      <param name="destination" value="[$Suit.sector, $TargetPos]"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Fly_Forward" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_position name="$TargetPos" x="0km" y="0km" z="100m" object="$Suit" space="$Suit.sector"/>
                    <signal_cue_instantly cue="Fly_Order" param="$TargetPos"/>
                  </actions>
                </cue>

                <cue name="Fly_Right" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_position name="$TargetPos" x="100m" y="0m" z="0m" object="$Suit" space="$Suit.sector"/>
                    <signal_cue_instantly cue="Fly_Order" param="$TargetPos"/>
                  </actions>
                </cue>

                <cue name="Fly_Left" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_position name="$TargetPos" x="-100m" y="0m" z="0m" object="$Suit" space="$Suit.sector"/>
                    <signal_cue_instantly cue="Fly_Order" param="$TargetPos"/>
                  </actions>
                </cue>

                <cue name="Fly_Up" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_position name="$TargetPos" x="0km" y="100m" z="0m" object="$Suit" space="$Suit.sector"/>
                    <signal_cue_instantly cue="Fly_Order" param="$TargetPos"/>
                  </actions>
                </cue>

                <cue name="SetPlayerShip_AsDockShip">
                  <actions>
                    <set_value name="$DockShip" exact="player.ship"/>
                  </actions>
                </cue>

                <cue name="Fly_Dock" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_order id="'DockAndWait'" object="$Suit" >
                      <param name="destination" value="$DockShip"/>
                    </create_order>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Debug_Skipper" onfail="cancel">
              <conditions>
                <check_value value="player.debug" comment="skipper only in debug builds"/>
              </conditions>
              <actions>
                <!--set_value name="$MissionCue" exact="this"/-->
              </actions>
              <cues>
                <cue name="Debug_SkipperShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.Setup.Debug_Setup_SkipperShip_Create"/>
                  </actions>
                </cue>

                <cue name="Debug_SkipperShip_Completed">
                  <conditions>
                    <event_cue_completed cue="md.Setup.Debug_Setup_SkipperShip_Create_Completed"/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="Debug_Skipper_CreateActor"/>
                    <signal_cue cue="Debug_Skipper_Spawn"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_CreateActor">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentCheatChapter" exact="null"/>
                    <create_cue_actor name="$SkipperActor" cue="$MissionCue" macro="character_argon_male_marine_helmet_01_macro">
                      <owner exact="faction.civilian"/>
                      <name name="'Criminal Story Skipper'"/>
                    </create_cue_actor>
                    <set_entity_type entity="$SkipperActor" type="entitytype.crowd"/>
                    <set_entity_traits entity="$SkipperActor" missionactor="true" customhandler="true"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Spawn" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_position name="$SkipperPos" x="4.1" y="-1m" z="9.4m"/>

                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, 
                    table[
                      $requestercue = $MissionCue,
                      $priority = 100,
                      $location = md.Setup.Debug_Setup_SkipperShip.$SkipperShip.controlroom,
                      $position = $SkipperPos,
                      $rotation = rotation.[-159.9deg, 0deg, 0deg],
                      $debugchance = 0,
                      $debugcaller = if $DebugChance == 100 then this else null]
                    ]"/>

                  </actions>
                </cue>

                <cue name="Debug_Skipper_Disconnect" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, 
                    table[
                      $requestercue = $MissionCue,
                      $priority = 100,
                      $location = 'disconnect',
                      $debugchance = $DeepDebugChance,
                      $debugcaller = if $DebugChance == 100 then this else null]
                    ]"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation">
                  <conditions>
                    <event_cue_completed cue="Debug_Skipper_CreateActor"/>
                  </conditions>
                  <cues>

                    <cue name="Debug_Skipper_Conversation_Start" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$SkipperActor"/>
                      </conditions>
                      <actions>
                        <add_player_choice highlighted="true" section="skipper_main" text="'PLEASE SAVE YOUR GAME'"/>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Conversation_Main" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_conversation_next_section actor="$SkipperActor" section="skipper_main"/>
                          <event_conversation_returned_to_section actor="$SkipperActor" section="skipper_main"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <add_player_choice_sub section="skipper_unlock_dummy" text="'Unlock Dummy'"/>
                        <add_player_choice_sub section="skipper_itemx_skip" text="'Cheat Items'" comment="make sure it matches the skipper_itemx-prefix"/>
                        <add_player_choice_sub section="skipper_chx_skip" text="'Skip to Chapter'" comment="make sure it matches the skipper_ch-prefix"/>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Unlock_Dummy" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$SkipperActor" section="skipper_unlock_dummy"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Dummy unlocked'"/>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Items" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$SkipperActor" sectionprefix="skipper_item"/>
                      </conditions>
                      <actions>
                        <do_if value="event.param == 'skipper_itemx_skip'">
                          <add_player_choice_sub section="skipper_item_uc"    text="'Unstable Crystals'"/>
                          <add_player_choice_sub section="skipper_item_hack"  text="'Hacking Crafting Materials'"/>
                          <add_player_choice_sub section="skipper_item_ha"    text="'Apparatus Crafting Materials'"/>
                          <add_player_choice_sub section="skipper_item_sds"    text="'Security Decryption System'"/>
                          <add_player_choice_sub section="skipper_item_bl"    text="'Bomblauncher'"/>
                          <add_player_choice_sub section="skipper_item_emp"   text="'EMP bomb'"/>
                        </do_if>
                        <do_else>
                          <do_if value="event.param == 'skipper_item_uc'">
                            <force_cue cue="Ch2_DEBUG_Acquire_Unstable_Crystals"/>
                          </do_if>
                          <do_elseif value="event.param == 'skipper_item_ha'">
                            <force_cue cue="Ch2_DEBUG_Acquire_HackingMaterials"/>
                          </do_elseif>
                          <do_elseif value="event.param == 'skipper_item_hack'">
                            <force_cue cue="Ch2_DEBUG_Acquire_ApparatusMaterials"/>
                          </do_elseif>
                          <do_elseif value="event.param == 'skipper_item_sds'">
                            <force_cue cue="Ch2_DEBUG_SecuritySlicer"/>
                          </do_elseif>
                          <do_elseif value="event.param == 'skipper_item_bl'">
                            <force_cue cue="Ch3_DEBUG_Bomblauncher"/>
                          </do_elseif>
                          <do_elseif value="event.param == 'skipper_item_emp'">
                            <force_cue cue="Ch3_DEBUG_EMPBomb"/>
                          </do_elseif>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Chapters" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$SkipperActor" sectionprefix="skipper_ch"/>
                      </conditions>
                      <actions>
                        <do_if value="event.param == 'skipper_chx_skip'">
                          <add_player_choice_sub section="skipper_ch1" text="'Skip to Ch 1'"/>
                          <add_player_choice_sub section="skipper_ch2" text="'Skip to Ch 2'"/>
                          <add_player_choice_sub section="skipper_ch3" text="'Skip to Ch 3'"/>
                          <add_player_choice_sub section="skipper_ch4" text="'Skip to Ch 4'"/>
                          <add_player_choice_sub section="skipper_ch5" text="'Skip to Ch 5'"/>
                          <add_player_choice_sub section="skipper_ch6" text="'Skip to Ch 6'"/>
                        </do_if>
                        <do_else>
                          <do_if value="event.param != 'skipper_ch1'">
                            <cancel_cue cue="Ch1_Intro"/>
                          </do_if>
                          <do_if value="event.param == 'skipper_ch1'">
                            <force_cue cue="Ch1_Force"/>
                          </do_if>
                          <do_elseif value="event.param == 'skipper_ch2'">
                            <force_cue cue="Ch2_Force"/>
                          </do_elseif>
                          <do_elseif value="event.param == 'skipper_ch3'">
                            <force_cue cue="Ch3_Force"/>
                          </do_elseif>
                          <do_elseif value="event.param == 'skipper_ch4'">
                            <force_cue cue="Ch4_Force"/>
                          </do_elseif>
                          <do_elseif value="event.param == 'skipper_ch5'">
                            <force_cue cue="Ch5_Force"/>
                          </do_elseif>
                          <do_elseif value="event.param == 'skipper_ch6'">
                            <force_cue cue="Ch6_Force"/>
                          </do_elseif>
                        </do_else>
                      </actions>
                    </cue>

                  </cues>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <!-- *** STORY REMINDERS *** -->

        <library name="Story_Reminder">
          <params>
            <param name="Actor"/>
            <param name="Lines"/>
            <param name="CancelCue"                comment="If this cue gets activated, the reminder gets cancelled."/>
            <param name="Delay"    default="15min" comment="The inital delay for the first reminder."/>
            <param name="Interval" default="30min" comment="The time that's added to the interval between reminders each time."/>
            <param name="Limit"    default="2h"    comment="If the interval between reminders gets this long, we take it as a hint to cancel the reminder altogether."/>
          </params>
          <cues>

            <cue name="Story_Reminder_Delay">
              <delay exact="$Delay"/>
              <actions>
                <signal_cue cue="Story_Reminder_Speak_Actor"/>
              </actions>
            </cue>

            <cue name="Story_Reminder_Speak_Actor">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Story_Reminder_Speak_Actor_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Actor"/>
                  <param name="Lines"             value="$Lines"/>
                  <param name="EndSignalCue"      value="Story_Reminder_Speak_Actor_Finished"/>
                </cue>

                <cue name="Story_Reminder_Speak_Actor_Finished">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$Delay ge $Limit">
                      <signal_cue cue="Story_Reminder_Cancel"/>
                    </do_if>
                    <do_else>
                      <set_value name="$Delay" exact="$Interval" operation="add"/>
                      <reset_cue cue="Story_Reminder_Delay"/>
                      <reset_cue cue="Story_Reminder_Speak_Actor"/>
                    </do_else>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Story_Reminder_Cancel">
              <conditions>
                <check_any>
                  <event_cue_signalled/>
                  <event_cue_activated cue="$CancelCue"/>
                </check_any>
              </conditions>
              <actions>
                <cancel_cue cue="parent"/>
              </actions>
            </cue>

          </cues>
        </library>


        <!-- *** STORY MANAGER INTERACTION *** -->

        <cue name="Story_Activation_Manager">
          <cues>

            <!-- The 1st Chapter will always be activated on game start -->

            <cue name="Activate_Immediately" onfail="cancel">
              <conditions>
                <check_value value="not $HasCustomGamestartSkip"/>
              </conditions>
              <delay exact="3s"/>
              <actions>
                <signal_cue cue="Ch1_Intro"/>
              </actions>
            </cue>

            <cue name="Handle_Custom_Gamestart_Skip" onfail="cancel">
              <conditions>
                <check_value value="$HasCustomGamestartSkip"/>
              </conditions>
              <cues>
                <cue name="Handle_Custom_Gamestart_Skip_Activate">
                  <actions>
                    <set_job_active activate="true" job="'ministry_food_smuggler_s'"/>
                    <set_job_active activate="true" job="'ministry_tech_trader_s'"/>

                    <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_criminal_arcadian_endeavour"/>
                    <do_if value="$story_criminal_wildcard and player.module != 'x4ep1_gamestart_pirate2'">
					  <delay  exact="20s"/>
					  <find_station name="$Closeby_Station" space="player.galaxy" sortbydistanceto="player.entity">
						<match_relation_to faction="faction.player" relation="dock"/>
						<match_dock size="tag.dock_s" free="true"/>
					  </find_station>
					  <find_dockingbay name="$ShipDock" object="$Closeby_Station" checkoperational="true">
						<match_dock size="tag.dock_s" storage="false" walkable="true" free="true"/>
					  </find_dockingbay>
                      <create_ship name="$EscapeShip" macro="ship_tel_s_trans_container_02_a_macro" dock="$ShipDock">
                        <owner exact="faction.player"/>
                        <pilot>
                          <select faction="faction.player" race="race.teladi" tags="tag.aipilot"/>
                        </pilot>
                        <loadout ref="story_raven_hangar"/>
                        <equipmentmods>
                          <ship ware="ware.mod_ship_hidecargo_01"/>
                        </equipmentmods>
                        <!-- Ministry Camo 1 -->
                        <paint ware="ware.paintmod_0045"/>
                      </create_ship>
                      <set_object_name object="$EscapeShip" page="20101" line="22504" comment="Raven Prototype readtext.{20101}.{22504}"/>
                    </do_if>


                    <do_elseif value="$story_criminal_arrested_curs and player.module != 'x4ep1_gamestart_pirate2'">
                      <add_faction_relation faction="faction.player" otherfaction="faction.ministry" value="0.015" reason="relationchangereason.missioncompleted"/>
                    </do_elseif>
                  </actions>
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>


        <!-- *** STORY CHAPTERS *** -->

        <!-- Chapter 1:
              - Player smuggles space weed
        -->

        <cue name="Ch1_Intro">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>

          </actions>
          <cues>

            <cue name="Ch1_S1a_ProximityCheck" onfail="cancel">
              <conditions>
                <check_value value="player.entity.sector == $S1a_North"/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="Ch1_Entering_S1a" param="player.sector"/>
              </actions>
            </cue>

            <cue name="Ch1_S1a_Periodic" checkinterval="10s" >
              <conditions>
                <check_all>
                  <check_value value="(player.sector == $RaiderHubShip.sector) and (player.entity.distanceto.{$RaiderHubShip} lt 25km)"/>
                </check_all>
              </conditions>
              <actions>
                <signal_cue cue="Ch1_Create_MissionOffer" check="false" comment="might already have triggered (in which this cue is cancelled a bit further below)"/>
              </actions>
              <delay exact="10s"/>
              <actions>
                <do_if value="$Ch1_OfferCreated?">
                  <cancel_cue cue="this"/>
                </do_if>
                <do_else>
                  <reset_cue cue="this"/>
                </do_else>
              </actions>
            </cue>

            <cue name="Ch1_Entering_S1a" instantiate="true">
              <conditions>
                <check_any>
                  <event_object_changed_sector object="player.entity" sector="$S1a_North"/>
                  <event_cue_signalled/>
                </check_any>
              </conditions>
              <actions>
                <do_if value="event.param2 == $S1b_Center">
                  <set_value name="$RevisedGate" exact="$Accelerator_S1a_S1b"/>
                </do_if>
                <do_elseif value="event.param2 == $SilentWitness1_Sector">
                  <set_value name="$RevisedGate" exact="$Gate_S1a_SilentWit1"/>
                </do_elseif>
                <do_if value="$RevisedGate?">
                  <!-- Have the ship warp to player gate -->
                  <get_safe_pos result="$RevisedPos" object="$RevisedGate" sector="$S1a_North" min="5km" max="20km" z="18km" allowyaxis="false"/>
                  <warp object="$RaiderHubShip" sector="$S1a_North">
                    <position value="$RevisedPos"/>
                  </warp>
                </do_if>
                <do_if value="not $Ch1_OfferCreated?">
                  <signal_cue cue="Ch1_Create_MissionOffer"/>
                </do_if>
              </actions>
            </cue>

            <cue name="Ch1_Maestro_UninterestedConversation" instantiate="true">
              <conditions>
                <check_all>
                  <event_conversation_started actor="$MaestroActor"/>
                  <check_value value="(player.module != 'x4ep1_gamestart_pirate2' or (md.GS_Pirate2.Start.$EscapeWithoutAxiom? or md.GS_Pirate2.Start.$EscapeSpacesuit?))
                               and (Ch1_1_Briefing.state == cuestate.waiting)" comment="Only ever play this if the story has not yet begun, and the player was not yet invited"/>
                </check_all>
              </conditions>
              <actions>
                <add_npc_line speaker="$MaestroActor" hidechoices="true">
                  <text line="30252164" comment="What Creature want?"/>
                  <text line="30252165" comment="No time for law-abiding civilian. Interested in hardened criminals only!"/>
                </add_npc_line>
              </actions>
            </cue>

            <cue name="Ch1_PreMission_AddIllegalWares_DEBUG">
              <conditions>
                <event_cue_signalled/>
                <check_value value="player.ship.exists"/>
              </conditions>
              <actions>
                <add_wares object="player.ship" ware="ware.spaceweed" exact="5"/>
              </actions>
            </cue>

            <cue name="Ch1_Create_MissionOffer">
              <conditions>
                <check_all>
                  <event_cue_signalled/>
                  <!-- for testing specific inventory wares: ware.inv_xxx.illegalto.{faction.argon}.{null} -->
                  <check_value value="(player.module != 'x4ep1_gamestart_pirate2' or (md.GS_Pirate2.Start.$EscapeWithoutAxiom? or md.GS_Pirate2.Start.$EscapeSpacesuit?)) and 
                                      (player.ship.cargo.illegalto.{faction.argon} or player.ship.cargo.illegalto.{faction.teladi} or player.ship.cargo.illegalto.{faction.paranid} or player.ship.cargo.illegalto.{faction.loanshark} or 
                                       player.entity.inventory.illegalto.{faction.argon} or player.entity.inventory.illegalto.{faction.teladi} or player.entity.inventory.illegalto.{faction.paranid} or player.entity.inventory.illegalto.{faction.loanshark})"
                                      comment="PirateGS2 leads into the mission automatically, unless if you left Axiom behind or left in the spacesuit when flying to the AE, then they need illegal item or ware to trigger mission offer"/>
                </check_all>
              </conditions>
              <actions>
                <cancel_cue cue="Ch1_Maestro_UninterestedConversation"/>
                <set_value name="$Ch1_OfferCreated"/>
                <set_value name="$PirateMissionRewardCr_1" exact="50000Cr"/>
                <substitute_text text="$Ch1_Reward" source="{30252,1020}">
                  <replace string="'$CREDITS$'" with="$PirateMissionRewardCr_1"/>
                </substitute_text>

                <create_offer cue="$MissionCue" actor="$MaestroActor" name="{30252,1001}" description="{30252,1002}" reward="$PirateMissionRewardCr_1" rewardtext="$Ch1_Reward" type="missiontype.plot" faction="faction.civilian" difficulty="level.medium" abortable="false">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$MaestroActor" text="$MaestroActor.knownname"/>
                    <objective step="2" action="objective.smuggle" text="{20201,4101}"/>
                  </briefing>
                </create_offer>
                <do_if value="(player.ship.primarypurpose == purpose.fight)">
                  <set_value name="$line" exact="30252102" comment="In fighter!"/>
                </do_if>
                <do_else>
                  <set_value name="$line" exact="30252103" comment="In trade ship"/>
                </do_else>

                <append_to_list name="md.$MissionDND" exact="Ch1_PreMission_Conversation"/>

              </actions>
              <cues>

                <cue name="Ch1_PreMission_Conversation" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$MaestroActor" conversation="default"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line speaker="$MaestroActor" hidechoices="true">
                      <text line="30252109" comment="You found your way onto ship. Good!"/>
                    </add_npc_line>
                  </actions>
                  <delay exact="1s"/>
                  <actions>
                    <set_value name="$MaestroInConv" exact="true"/>
                    <do_if value="$MissionCue.hasmissionoffer">
                      <!-- automatically open the briefing menu when talking to Maestro personally, if the missionoffer wasn't accepted yet (otherwise players have no clue what do do) -->
                      <open_conversation_menu menu="MissionBriefingMenu" param="[0, 0, $MissionCue, true]"/>
                    </do_if>
                  </actions>
                  <cues>
                    <cue name="Ch1_PreMission_Conversation_End">
                      <conditions>
                        <event_conversation_finished actor="$MaestroActor"/>
                      </conditions>
                      <actions>
                        <remove_value name="$MaestroInConv"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>


                <!-- Maestro first contacts the player to offer the beginning criminal mission -->
                <cue name="Ch1_MissionOfferHint_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$MaestroActor"/>
                  <param name="DelayInitial"      value="3s"/>
                  <param name="Lines"             value="[[30252101],[$line],[30252104],[30252105],[30252106]]"/>
                  <param name="EndSignalCue"      value="Ch1_MissionOffer_Hint"/>
                  <!--
                  Hey, you!
                  In the fighter!/In the trade ship!
                  My scans show that you carry contraband!
                  Safe to say you do not mind dirtying hands?
                  If true I want to offer mission you might be interested in!
                  -->
                </cue>

                <cue name="Ch1_MissionOffer_Hint">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <remove_from_list name="md.$MissionDND" exact="Ch1_PreMission_Conversation"/>

                    <show_help line="833" position="1" force="true" comment="A new story mission is now available in the MISSION OFFERS tab of your map menu." allowclose="true"/>
                    <signal_cue cue="Ch1_MissionBosoComment"/>
                  </actions>
                </cue>

                <cue name="Ch1_MissionBosoComment">
                  <conditions>
                    <check_all>
                      <event_cue_signalled/>
                      <check_value value="$BosoTa?"/>
                    </check_all>
                  </conditions>
                  <cues>

                    <!-- Boso chimes in  -->
                    <cue name="Ch1_BosoMissionComment_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="DelayInitial"      value="1s"/>
                      <param name="Lines"             value="[[30252101]]"/>
                      <param name="EndSignalCue"      value="Ch1_MissionDalComment"/>
                      <!--
                      If I may suggest, my assistant should stay clear of any illicit business.
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch1_MissionDalComment">
                  <conditions>
                    <check_all>
                      <event_cue_signalled/>
                      <check_value value="$DalBusta?"/>
                    </check_all>
                  </conditions>
                  <cues>

                    <!-- Dal chimes in  as well -->
                    <cue name="Ch1_DalMissionComment_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="DelayInitial"      value="1s"/>
                      <param name="Lines"             value="[[30252101],[30252102]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                      Nonesense! You don't pass up such an opportunity to gain insight into this place's socioeconomics!
                      Besides: In a system owned by the Syndicate, who really is the criminal?
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Mission_Accepted">
                  <conditions>
                    <event_object_signalled object="$MaestroActor" param="'accept'"/>
                  </conditions>
                  <actions>
                    <remove_offer cue="$MissionCue"/>
                  </actions>
                  <cues>

                    <cue name="Mission_Accepted_NonConv" onfail="cancel">
                      <conditions>
                        <check_value value="not $MaestroInConv?"/>
                      </conditions>
                      <cues>
                        <cue name="Ch1_MissionAccepted_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$MaestroActor"/>
                          <param name="DelayInitial"      value="1s"/>
                          <param name="Lines"             value="[[30252107],[30252108]]"/>
                          <param name="EndSignalCue"      value="Ch1_1_Briefing"/>
                          <!--
                            Good! Meet me aboard the Arcadian Endeavour for further discussion!
                            And bring S-sized ship with sufficient cargo space!
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Mission_Accepted_Conv" onfail="cancel">
                      <conditions>
                        <check_value value="$MaestroInConv?"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch1_1_Briefing"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_1_Briefing">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <cancel_cue cue="Ch1_Create_MissionOffer"/>

                <set_value name="$PirateMissionRewardCr_1" exact="50000Cr"/>
                <substitute_text text="$Ch1_Reward" source="{30252,1020}">
                  <replace string="'$CREDITS$'" with="$PirateMissionRewardCr_1"/>
                </substitute_text>

                <set_value name="$ObjectiveStep" exact="1"/>
                <create_mission cue="$MissionCue" name="{30252,1001}" description="{30252,1002}" reward="$PirateMissionRewardCr_1" rewardtext="$Ch1_Reward" type="missiontype.plot" faction="faction.civilian" difficulty="level.medium" abortable="false" icon="'briefing_maestro_01'" iconcaption="$MaestroActor.knownname">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$MaestroActor" text="$MaestroActor.knownname"/>
                    <objective step="2" action="objective.smuggle" text="{20201,4101}"/>
                  </briefing>
                </create_mission>
                <set_objective_from_briefing cue="$MissionCue" step="$ObjectiveStep"/>
              </actions>
              <cues>

                <cue name="Ch1_1_AxiomConversation" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$AxiomActor"/>
                  </conditions>
                  <actions>
                    <do_if value="Ch1_2_Smuggling.state == cuestate.waiting">
                      <add_npc_line speaker="$AxiomActor" hidechoices="true">
                        <text line="30252101" comment="Best go talk to the Maestro now."/>
                      </add_npc_line>
                    </do_if>
                    <do_else>
                      <add_npc_line speaker="$AxiomActor" hidechoices="true">
                        <text line="30252102" comment="So, the captain of this here outfit reckons our band of misfits could do with another pilot worth their mettle? Don't mess up the delivery!"/>
                      </add_npc_line>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch1_1_BriefingConversation" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$MaestroActor"/>
                      <event_conversation_next_section actor="$MaestroActor" section="conv_questions"/>
                      <event_conversation_next_section actor="$MaestroActor" section="conv_decline"/>
                      <event_conversation_next_section actor="$MaestroActor" section="conv_continue"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <remove_value name="$SmugglingShip"/>
                    <allow_conversation_escape enabled="false"/>
                    <find_object_component name="$DockedPlayerShips" object="$RaiderHubShip" includeobjects="true" multiple="true" owner="faction.player" docked="true" class="class.ship_s"/>
                    <do_all exact="$DockedPlayerShips.count" counter="$i">
                      <do_if value="$DockedPlayerShips.{$i}.cargo.free.container ge 240">
                        <set_value name="$SmugglingShip" exact="$DockedPlayerShips.{$i}"/>
                        <set_value name="$SpaceweedCapacity" exact="1000 - (1000 - $SmugglingShip.cargo.free.container/3)i"/>
                        <break/>
                      </do_if>
                    </do_all>

                    <do_if value="event.name == 'event_conversation_started'">
                      <do_if value="Ch1_2_Smuggling.state == cuestate.waiting">
                        <do_if value="not $IntroductionCompleted?">

                          <do_if value="(player.module == 'x4ep1_gamestart_pirate2') and (not md.GS_Pirate2.Start.$EscapeWithoutAxiom?)" comment="changed dialogue to refer to GS">
                            <add_npc_line speaker="$MaestroActor" hidechoices="true">
                              <text line="30252110" comment="There you are!"/>
                              <text line="30252111" comment="I am the Maestro."/>
                              <text line="30252112" comment="You have already met the Axiom."/>
                              <text line="30252113" comment="Split appreciates you helping him escape!"/>
                              <text line="30252114" comment="Even if your motives might have been self-serving."/>
                              <text line="30252116" comment="Me and my crew, the Empyrean Curs, have embarked on a journey towards complete independence."/>
                              <text line="30252117" comment="We are interested in bringing on someone who does not mind breaking laws."/>
                              <text line="30252118" comment="Safe to say you fit the profile."/>
                              <text line="30252119" comment="Our regular smuggler and best pilot, the Ace, has prior engagements."/>
                              <text line="30252120" comment="So, we need someone to smuggle spaceweed."/>
                              <text line="30252121" comment="Small assignment to see if you are trustworthy. You interested?"/>
                            </add_npc_line>
                          </do_if>
                          <do_else>
                            <add_npc_line speaker="$MaestroActor" hidechoices="true">
                              <text line="30252110" comment="There you are!"/>
                              <text line="30252111" comment="I am the Maestro."/>
                              <text line="30252115" comment="I invited you here because I noticed you carry illegal wares."/>
                              <text line="30252116" comment="Me and my crew, the Empyrean Curs, have embarked on a journey towards complete independence."/>
                              <text line="30252117" comment="We are interested in bringing on someone who does not mind breaking laws."/>
                              <text line="30252118" comment="Safe to say you fit the profile."/>
                              <text line="30252119" comment="Our regular smuggler and best pilot, the Ace, has prior engagements."/>
                              <text line="30252120" comment="So, we need someone to smuggle spaceweed."/>
                              <text line="30252121" comment="Small assignment to see if you are trustworthy. You interested?"/>
                            </add_npc_line>
                          </do_else>
                          <add_player_choice text="{30252,30252101}" section="conv_questions" comment="Tell me more about yourself!" position="top_left"/>
                          <add_player_choice text="{30252,30252102}" section="conv_decline" comment="Not right now." position="bottom_left"/>
                          <add_player_choice text="{30252,30252103}" section="conv_continue" comment="Sign me up!" highlighted="true" position="bottom_right"/>
                          <set_value name="$IntroductionCompleted"/>
                        </do_if>
                        <do_else>

                          <do_if value="not $RepeatAttempt?">

                            <add_npc_line speaker="$MaestroActor" hidechoices="true">
                              <text line="30252148" comment="You returned. Good!"/>
                              <text line="30252120" comment="So, we need someone to smuggle spaceweed."/>
                              <text line="30252121" comment="Small assignment to see if you are trustworthy. You interested?"/>
                            </add_npc_line>
                            <add_player_choice text="{30252,30252101}" section="conv_questions" comment="Tell me more about yourself!" position="top_left"/>
                            <add_player_choice text="{30252,30252102}" section="conv_decline" comment="Not right now." position="bottom_left"/>
                            <add_player_choice text="{30252,30252103}" section="conv_continue" comment="Sign me up!" highlighted="true" position="bottom_right"/>
                          </do_if>
                          <do_elseif value="$SmugglingShip? and $RepeatAttempt?">
                            <!--The player returned with enough storage -->
                            <add_npc_line speaker="$MaestroActor" hidechoices="true">
                              <text line="30252148" comment="You returned. Good!"/>
                              <text line="30252143" comment="My crew has already transferred the spaceweed into your ship's cargo."/>
                              <text line="30252144" comment="I will let buyer know to expect you."/>
                              <text line="30252145" comment="To get to the buyer you traverse policed space. Be careful not be spotted."/>
                              <text line="30252146" comment="Swift travels!"/>
                            </add_npc_line>

                            <add_wares object="$SmugglingShip" ware="ware.spaceweed" exact="$SpaceweedCapacity"/>
                            <set_value name="$Ch2_SmugglingWaresAdded" exact="true"/>

                          </do_elseif>
                          <do_else>
                            <!--The player returned but without enough storage -->
                            <add_npc_line speaker="$MaestroActor" hidechoices="true">
                              <text line="30252148" comment="You returned. Good!"/>
                              <text line="30252147" comment="Unfortunately, the ship you came in cannot fit the package. Return with a bigger storage."/>
                            </add_npc_line>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.acquire_units" text="{30288,1031}" object="$MaestroActor" updatebriefing="true" comment="Return with a larger cargo capacity(Custom Action)"/>
                          </do_else>

                        </do_else>
                      </do_if>
                      <do_else>
                        <!-- Idle Line -->
                        <add_npc_line speaker="$MaestroActor" line="30252162" hidechoices="true" comment="Get going! Buyer anxiously awaits delivery."/>
                        <do_if value="not $Ch1_MaestroIntroductionComplete?">
                          <add_player_choice text="{30252,30252101}" section="conv_questions" comment="" position="top_left"/>
                          <add_player_choice_return text="{1002,2}" comment="Goodbye"/>
                        </do_if>
                      </do_else>
                    </do_if>
                    <do_else>

                      <do_if value="event.param == 'conv_questions'">

                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252122" comment="Yes, of course!"/>
                          <text line="30252123" comment="You ask: How come a Split commands the Empyrean Curs, a rabble of pirate misfits?"/>
                          <text line="if md.$SplitFactions.count ge 1 then 30252124 else 30252125" comment="And so far from Split space!/When this part of the network is still disconnected from Rhonkar's domain?"/>
                          <text line="30252126" comment="See, I was never part of the broader Split culture."/>
                          <text line="30252127" comment="Born into a small makeshift family of Split during shutdown."/>
                          <text line="if md.$SplitFactions.count ge 1 then 30252128 else 30252129" comment="Even though connection was re-established I do not feel I belong with ferocious Split./Even if I could return, I doubt I would feel at home in ferocious Split society."/>
                          <text line="30252130" comment="Always I prefer to use wits."/>
                          <text line="30252131" comment="And be free from all obligations."/>
                          <text line="30252132" comment="Growing up in Windfall you really do not have choice except to fall in with the Vigor Syndicate."/>
                          <text line="30252133" comment="They taught me to steal, cheat and kill - if I must."/>
                          <text line="30252134" comment="But I disagree with the direction they are headed now."/>
                          <text line="30252135" comment="Short-sighted exploitation of vulnerable people, lack of vision."/>
                          <text line="30252136" comment="So much more interesting marks out there now."/>
                          <text line="30252137" comment="Me and trusted friends decided to strike out on our own."/>
                          <text line="30252138" comment="Now, we roam the network aboard our ship looking for opportunities to make money however we see fit."/>
                        </add_npc_line>
                        <do_if value="Ch1_2_Smuggling.state == cuestate.waiting">
                          <add_player_choice text="{30252,30252101}" section="conv_questions" comment="" position="top_left"/>
                          <add_player_choice text="{30252,30252102}" section="conv_decline" comment="" position="bottom_left"/>
                          <add_player_choice text="{30252,30252103}" section="conv_continue" comment="" highlighted="true" position="bottom_right"/>
                        </do_if>
                        <set_value name="$Ch1_MaestroIntroductionComplete"/>
                      </do_if>
                      <do_elseif value="event.param == 'conv_decline'">

                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252139" comment="Then why did you come?"/>
                          <text line="30252140" comment="Shame, would have made for a good pirate!"/>
                          <text line="30252141" comment="Feel free to return if you change your mind!"/>
                        </add_npc_line>
                        <signal_cue cue="Ch1_DeclineBosoComment"/>
                      </do_elseif>
                      <do_elseif value="event.param == 'conv_continue'">

                        <set_value name="$RepeatAttempt"/>
                        <do_if value="$SmugglingShip?">
                          <!--The player has enough storage -->
                          <add_npc_line speaker="$MaestroActor" hidechoices="true">
                            <text line="30252142" comment="Good! I knew I could count on you."/>
                            <text line="30252143" comment="My crew has already transferred the spaceweed into your ship's cargo."/>
                            <text line="30252144" comment="I will let buyer know to expect you."/>
                            <text line="30252145" comment="To get to the buyer you traverse policed space. Be careful not be spotted."/>
                            <text line="30252146" comment="Swift travels!"/>
                          </add_npc_line>
                          <add_wares object="$SmugglingShip" ware="ware.spaceweed" exact="$SpaceweedCapacity"/>
                          <set_value name="$Ch2_SmugglingWaresAdded" exact="true"/>

                        </do_if>
                        <do_else>
                          <!--The player does not have enough storage -->
                          <add_npc_line speaker="$MaestroActor" hidechoices="true">
                            <text line="30252147" comment="Unfortunately, the ship you came in cannot fit the package. Return with a bigger storage."/>
                          </add_npc_line>
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.acquire_units" text="{30288,1031}" object="$MaestroActor" updatebriefing="true" comment="Return with a larger cargo capacity(Custom Action)"/>
                        </do_else>

                      </do_elseif>

                    </do_else>
                  </actions>

                  <cues>
                    <cue name="Ch1_1_BriefingConversation_Ended">
                      <conditions>
                        <event_conversation_finished actor="$MaestroActor"/>
                        <check_value value="$Ch2_SmugglingWaresAdded?"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch1_1_Continue" check="false" comment="might already have triggered by _line_finished 30252146"/>
                      </actions>
                    </cue>
                  </cues>

                </cue>

                <cue name="Ch1_DeclineBosoComment" instantiate="true">
                  <conditions>
                    <check_all>
                      <event_cue_signalled/>
                      <check_value value="$BosoTa?"/>
                    </check_all>
                  </conditions>
                  <cues>

                    <!-- Boso chimes in (again) -->
                    <cue name="Ch1_DeclineBosoComment_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="DelayInitial"      value="3s"/>
                      <param name="Lines"             value="[[30252111]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                      I am so proud of you! It is not easy to look the temptation of criminal, easy profit in the eye and say: "No".
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch1_1_Continue">
                  <conditions>
                    <check_any>
                      <event_cue_signalled comment="guaranteed (conversation ended and Maestro having give the spaceweed)"/>
                      <event_speak_line_finished actor="$MaestroActor" line="30252146" comment="unreliable"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <update_mission cue="$MissionCue" description="{30252,1003}"/>
                    <signal_cue cue="Ch1_2_Smuggling"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_2_Smuggling" comment="If playership is destroyed (losing spaceweed), player can get another ship buy spaceweed somewhere and continue the mission">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="0.1s"/>
              <actions>
                <find_station_by_true_owner name="$PostentialPiratestations" faction="faction.hatikvah" space="player.galaxy" sortbygatedistanceto="player.entity" state="componentstate.operational" multiple="true" sortlimit="12">
                  <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                </find_station_by_true_owner>

                <shuffle_list list="$PostentialPiratestations"/>

                <sort_list list="$PostentialPiratestations" sortbyvalue="loop.element.gatedistance.{player.entity}"/>

                <do_if value="$PostentialPiratestations.count">

                  <do_all exact="$PostentialPiratestations.count" counter="$i">
                    <find_sell_offer result="$spaceweedselloffers" seller="$PostentialPiratestations.{$i}" wares="ware.spaceweed" multiple="true"/>
                    <find_buy_offer result="$spaceweedbuyoffers" buyer="$PostentialPiratestations.{$i}" wares="ware.spaceweed" multiple="true"/>

                    <do_if value="$spaceweedselloffers.count == 0 and $spaceweedbuyoffers.count == 0">
                      <set_value name="$SmuggleStation" exact="$PostentialPiratestations.{1}"/>
                      <signal_cue cue="Ch1_2_DeliverWares_Setup"/>
                      <break/>
                    </do_if>
                  </do_all>

                  <remove_value name="$PostentialPiratestations"/>
                </do_if>

                <do_if value="not $SmuggleStation?">
                  <signal_cue cue="Ch1_2_SpawnPirateStation"/>
                </do_if>
              </actions>
              <cues>

                <cue name="Ch1_Story_Reminder">
                  <cues>
                    <cue name="Ch1_Story_Reminder_Ref" ref="Story_Reminder">
                      <param name="Actor"       value="$MaestroActor"/>
                      <param name="Lines"       value="[[30252163]]"/>
                      <param name="CancelCue"   value="Ch1_Complete"/>
                      <param name="Delay"       value="40min"/>
                      <!--
                        Did creature make delivery yet? What are you waiting for?
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_2_SpawnPirateStation" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <find_sector name="$FallbackSector" macro="macro.cluster_44_sector001_macro"/>
                    <create_station name="$SmuggleStation" macro="macro.station_gen_factory_base_01_macro" owner="faction.hatikvah" sector="$FallbackSector" state="componentstate.operational" constructionplan="'gen_piratedock'">
                      <safepos x="250km" z="-200km" space="$FallbackSector"/>
                    </create_station>
                    <signal_objects object="player.galaxy" param="'init station'" param2="$SmuggleStation" param3="false"/>
                    <signal_cue cue="Ch1_2_DeliverWares_Setup"/>
                  </actions>
                  <patch sinceversion="2">
                    <reset_cue cue="Ch1_2_DeliverWares_Setup"/>
                    <find_sector name="$FallbackSector" macro="macro.cluster_44_sector001_macro"/>
                    <create_station name="$SmuggleStation" macro="macro.station_gen_factory_base_01_macro" owner="faction.hatikvah" sector="$FallbackSector" state="componentstate.operational" constructionplan="'gen_piratedock'">
                      <safepos x="250km" z="-200km" space="$FallbackSector"/>
                    </create_station>
                    <signal_objects object="player.galaxy" param="'init station'" param2="$SmuggleStation" param3="false"/>
                    <signal_cue cue="Ch1_2_DeliverWares_Setup"/>
                  </patch>
                </cue>

                <cue name="Ch1_2_DeliverWares_Setup">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="0.1s"/>
                  <actions>

                    <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                    <set_value name="$Wares" exact="table[
                                                    {ware.spaceweed}           =  $SpaceweedCapacity,
                                                    ]"/>

                    <create_list name="$TradeOfferList"/>
                    <do_for_each in="$Wares" name="$CurrentWare">
                      <do_if value="$Wares.{$CurrentWare} gt 0">
                        <create_trade_offer buyer="$SmuggleStation" object="$SmuggleStation" ware="$CurrentWare" amount="$Wares.{$CurrentWare}" missioncue="$MissionCue" name="$TradeOffer" playeronly="true" price="0ct"/>
                        <append_to_list name="$TradeOfferList" exact="$TradeOffer"/>
                      </do_if>
                    </do_for_each>
                  </actions>
                  <cues>

                    <cue name="Ch1_2_MoveAE_ToIdealGate">
                      <actions>
                        <!-- Dynamically find the gate in WF1 which brings player toward the SmuggleStation (mosty likely the North gate, leading to 'Silent Witness') -->
                        <get_jump_path component="$jumppath" multiple="true" uselocalhighways="false">
                          <start object="$RaiderHubShip"/>
                          <end object="$SmuggleStation.sector"/>
                        </get_jump_path>
                        <debug_text text="'Path = ' + $jumppath" chance="$DebugChance"/>
                        <do_if value="($jumppath.count ge 1) and ($jumppath.{1}.isclass.gate)">
                          <create_position name="this.$RaiderHubShipGatePos" object="$jumppath.{1}" space="$jumppath.{1}.sector" x="0km" y="-500m" z="13km"/>
                          <create_order object="$RaiderHubShip" id="'MoveWait'">
                            <param name="destination" value="[$jumppath.{1}.sector, this.$RaiderHubShipGatePos]"/>
                          </create_order>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch1_2_DeliverWares">
                      <conditions>
                        <event_cue_completed cue="Ch1_2_DeliverWares_Setup"/>
                      </conditions>
                      <cues>

                        <cue name="TradeWares_Ref" ref="md.RML_Trade_Wares.TradeWares">
                          <param name="EndSignalCue"  value="Ch1_2_DeliveryFinished"/>
                          <param name="MissionCue"    value="$MissionCue"/>
                          <param name="StartStep"     value="$ObjectiveStep"/>

                          <param name="TradeOffers"     value="[$TradeOffer]" />

                          <param name="DebugChance"   value="$DebugChance" />
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch1_2_EnteredPolicedSpaceWarning">
                      <conditions>
                        <check_any>
                          <event_object_changed_sector group="global.$PlayerContainerGroup"/>
                          <event_object_changed_sector object="$SmugglingShip"/>
                        </check_any>
                        <check_all>
                          <check_value value="event.param.policefaction != null"/>
                          <check_value value="event.object.cargo.illegalto.{event.param.policefaction}"/>
                        </check_all>
                      </conditions>
                      <cues>

                        <!-- Maestro warns the player when they enter policed space -->
                        <cue name="Ch1_MaestroWarning_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$MaestroActor"/>
                          <param name="DelayInitial"      value="4s" comment="avoid interrupting betty 'entering system: ...'"/>
                          <param name="Lines"             value="[[30252149],[30252150],[30252151],[30252152],[30252153]]"/>
                          <param name="EndSignalCue"      value="Ch1_BosoCarefulComment"/>
                          <!--
                            You just entered a system in which spaceweed is illegal.
                            Most groups that share the network are prohibiting at least some wares. Some systems are more lenient than others.
                            It is crucial to our subsistence to be aware of these nuances.
                            Keep your distance from police ships. Hope they don't spot you.
                            If they do, hope your ship is faster than theirs!
                          -->
                        </cue>

                        <cue name="Ch1_BosoCarefulComment">
                          <conditions>
                            <check_all>
                              <event_cue_signalled/>
                              <check_value value="$BosoTa?"/>
                            </check_all>
                          </conditions>
                          <cues>

                            <!-- Boso chimes in (yet again) -->
                            <cue name="Ch1_WarningBosoComment_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$BosoTa"/>
                              <param name="DelayInitial"      value="3s"/>
                              <param name="Lines"             value="[[30252121]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                I am so proud of you! It is not easy to look the temptation of criminal, easy profit in the eye and say: "No".
                              -->
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Ch1_Police_Halt" instantiate="true">
                          <conditions>
                            <event_object_signalled group="global.$PlayerShipsGroup" param="'halt'" param3="'policehalt'" />
                          </conditions>
                          <delay exact="2s"/>
                          <actions>
                            <!--debug_text text="'Signalled p=%s p2=%s p3=%s'.[event.param, event.param2, event.param3]"/-->
                            <set_value name="$Ch1_SmuggleScan" operation="add"/>
                            <set_value name="this.$policeship" exact="event.param2"/>

                            <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                              <param name="Actor"             value="$MaestroActor"/>
                              <param name="Lines"             value="[[30252154]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                <t id="30252154">Police heading your way. Quick, put distance between you and law!(worried)</t>
                              -->
                            </run_actions>
                            <!--debug_text text="'Boosting police-skill'"/-->
                            <!-- remember original skill -->
                            <set_value name="this.$piloting" exact="this.$policeship.pilot.skill.piloting"/>
                            <set_value name="this.$morale" exact="this.$policeship.pilot.skill.morale"/>
                            <!-- temporarily boost skill, so police is extremely good in detecting contraband -->
                            <set_skill entity="this.$policeship.pilot" type="skilltype.piloting" exact="15"/>
                            <set_skill entity="this.$policeship.pilot" type="skilltype.morale" exact="15"/>
                          </actions>
                          <delay exact="15s"/>
                          <actions>
                            <!-- restore original skill -->
                            <!--debug_text text="'Restoring police-skill'"/-->
                            <set_skill entity="this.$policeship.pilot" type="skilltype.piloting" exact="this.$piloting"/>
                            <set_skill entity="this.$policeship.pilot" type="skilltype.morale" exact="this.$morale"/>
                          </actions>
                        </cue>

                        <cue name="Ch1_Police_IllegalWareFound" instantiate="true">
                          <conditions>
                            <event_object_signalled group="global.$PlayerShipsGroup" param="'police_illegalfound_player'" />
                          </conditions>
                          <actions>
                            <!--debug_text text="'Signalled p=%s p1=%s p2=%s'.[event.param, event.param2, event.param3]"/-->
                            <set_value name="$Ch1_SmuggleCaught" operation="add"/>
                            <do_if value="$BosoTa?">
                              <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                                <param name="Actor"             value="$BosoTa"/>
                                <param name="Lines"             value="[[30252122]]"/>
                                <param name="EndSignalCue"      value="null"/>
                                <!--
                                  <t id="30252122">Oh deary me, you got caught!</t>
                                -->
                              </run_actions>
                            </do_if>
                          </actions>
                        </cue>

                        <cue name="Ch1_Police_PlayerFlee" instantiate="true">
                          <conditions>
                            <event_object_signalled group="global.$PlayerShipsGroup" param="'police_scannoncompliance_player'" />
                          </conditions>
                          <actions>
                            <debug_text text="'Signalled p=%s p1=%s p2=%s'.[event.param, event.param2, event.param3]" chance="0"/>
                            <set_value name="$Ch1_SmuggleFlee" operation="add"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch1_2_DroppedSpaceWeed">
                      <conditions>
                        <event_object_dropped_objects object="$SmugglingShip"/>
                        <check_any exact="event.param.count" counter="$i">
                          <check_value value="event.param.{$i}.wares.{ware.spaceweed}.exists"/>
                        </check_any>
                      </conditions>
                      <cues>

                        <!-- Maestro comments on the player dropping the illegal ware -->
                        <cue name="Ch1_MaestroDroppedWareComment_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$MaestroActor"/>
                          <param name="DelayInitial"      value="1s"/>
                          <param name="Lines"             value="[[30252155],[30252156],[30252157]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            You dropped spaceweed? Not good start!
                            If you want to be part of our crew, ensure the delivery happens!
                            Even if you pay for it out of pocket.
                          -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch1_2_AtStation">
                      <conditions>
                        <event_object_dock_assigned_at object="$SmuggleStation"/>
                        <check_value value="event.param2.isplayerowned and event.param2.cargo.{ware.spaceweed}.count ge 1"/>
                      </conditions>
                      <cues>

                        <!-- Maestro lets the player know to transfer the wares -->
                        <cue name="Ch1_MaestroTradeHint_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$MaestroActor"/>
                          <param name="DelayInitial"      value="3s"/>
                          <param name="Lines"             value="[[30252158],[30252159]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            I squared it with the buyer so that you should be able to just transfer the spaceweed without an issue.
                            Usually, you cannot sell illegal wares to stations without establishing a black market there first.
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch1_2_Docked_Trade_Hint">
                      <conditions>
                        <event_object_docked_at container="$SmuggleStation"/>
                        <check_value value="event.param == player.ship"/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <show_help_overlay id="'docked_trade'" highlightonly="true" comment="hilight the 'trade' entry"/>
                        <show_help line="25002" position="18" force="true" comment="Open the TRADE interface to deliver the wares to the station." allowclose="false"/>
                      </actions>
                      <cues>
                        <cue name="Ch1_Docked_Trade_HintClosed">
                          <conditions>
                            <event_ui_triggered screen="'DockedMenu'" control="'menu_close'"/>
                          </conditions>
                          <actions>
                            <remove_help all="true"/>
                            <remove_help_overlay id="'docked_trade'"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch1_2_DeliveryFinished">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <speak actor="$MaestroActor" broadcast="true" backgroundcomm="false" comment="speak to also trigger in menu">
                          <text delay="2s" line="30252160" comment="The buyer confirmed the transaction and wired the money."/>
                          <text line="30252161" comment="Well done!"/>
                        </speak>
                        <remove_help_overlay id="'docked_trade'" comment="player-owned could have made the delivery, guarantee removal of ui-hilight"/>
                      </actions>
                      <cues>

                        <cue name="Ch1_2_LinesFinished">
                          <conditions>
                            <event_speak_finished actor="$MaestroActor" line="30252160"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch1_Complete"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_Complete">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Chapter 1 completed'" chance="$DebugChance"/>
                <remove_mission cue="$MissionCue" type="completed"/>
                <reward_player money="50000Cr"/>
              </actions>
              <delay exact="3s"/>
              <actions>
                <write_to_logbook category="missions" faction="faction.player" title="{30252,1121}" text="{30252,1122}" comment="As a first test of your resolve, and familiarity with illicit activity"/>
                <signal_cue cue="Ch2_Piracy_Induction"/>
                <cancel_cue cue="parent"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="Arcadian_Endeavour_Retreat_Order" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <cancel_all_orders object="$RaiderHubShip"/>
            <set_value name="$ClosestAccelerator" exact="$Gate_S1a_18Bil"/>
            <create_position name="$RaiderHubShipPos" object="$ClosestAccelerator" space="$S1a_North" x="0km" y="-500m" z="13km"/>
            <cancel_all_orders object="$RaiderHubShip"/>
            <create_order object="$RaiderHubShip" id="'MoveWait'" default="true">
              <param name="destination" value="[$ClosestAccelerator.sector, $RaiderHubShipPos]"/>
              <param name="noattackresponse" value="true"/>
              <param name="debugchance" value="$DebugChance"/>
              <param name="lookat" value="$ClosestAccelerator.position"/>
            </create_order>
          </actions>
        </cue>

        <cue name="Ch2_Force">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch2_Piracy_Induction">
            <cancel_cue cue="Ch1_Intro"/>
            <signal_cue cue="Ch2_Piracy_Induction"/>
          </force>
        </cue>


        <!-- Chapter 2:
              - Establish Black Market Contact
              - Cargo Robbery
              - Sabotage 
        -->

        <cue name="Ch2_PlaceAxiomActor">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- Move the other 2 pirate crew members in place-->
            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $AxiomActor, md.GS_Pirate2.Start]" comment="Remove earlier placement request, or the actor will keep moving back to that position."/>

            <create_position name="$AxiomPos" x="0.09" y="0.05" z="-13.325" space="$RaiderHubShip_GeneratorRoom"/>
            <create_rotation name="$AxiomRot" yaw="-180deg"/>
            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor,
                                                                                              table[
                                                                                              $requestercue = $MissionCue,
                                                                                              $location = $RaiderHubShip_GeneratorRoom,
                                                                                              $priority = 100,
                                                                                              $rotation = $AxiomRot,
                                                                                              $position = $AxiomPos,
                                                                                              $debugchance = $DeepDebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                              ]"/>

          </actions>
        </cue>

        <cue name="Ch2_Piracy_Induction">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Ch2_Mission_Setup">
              <actions>
                <signal_cue_instantly cue="Ch2_PlaceAxiomActor"/>

                <create_mission_thread cue="$MissionCue" name="{30252,2101}" description="{30252,2102}"
                                   type="missiontype.plot" faction="faction.civilian" difficulty="level.medium" abortable="false" icon="'briefing_maestro_01'" iconcaption="$MaestroActor.knownname" threadtype="parallel"/>

                <find_object_component name="$Dock" object="$RaiderHubShip" checkoperational="true" macro="macro.dockingbay_arg_s_01_macro"/>
                <create_position name="$AcePos" x="4.62" z="21.542"/>
                <create_rotation name="$AceRot" yaw="-142.0deg"/>

                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AceActor,
                                                                                              table[
                                                                                              $requestercue = $MissionCue,
                                                                                              $location = $Dock,
                                                                                              $priority = 100,
                                                                                              $rotation = $AceRot,
                                                                                              $position = $AcePos,
                                                                                              $debugchance = $DeepDebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                              ]"/>

                <create_group groupname="$Ch2_ExcludedStations"/>
                <add_to_group groupname="$Ch2_ExcludedStations" object="$PrisonStation"/>

              </actions>
            </cue>

            <cue name="Ch2_1_BlackMarket">
              <conditions>
                <event_cue_completed cue="Ch2_Mission_Setup"/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep_1" exact="1"/>
                <set_value name="$MissionCue_Ch2_BlackMarket" exact="this"/>

                <create_mission cue="$MissionCue_Ch2_BlackMarket" name="{30252,2201}" description="{30252,2202}" rewardtext="{30252,2220}" type="missiontype.plot" faction="faction.civilian" difficulty="level.medium" abortable="false" icon="'briefing_maestro_01'" iconcaption="$MaestroActor.knownname" missionthread="$MissionCue">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$MaestroActor" text="$MaestroActor.name"/>
                  </briefing>
                </create_mission>
                <set_objective_from_briefing cue="$MissionCue_Ch2_BlackMarket" step="$ObjectiveStep_1"/>

              </actions>
              <cues>

                <!-- Maestro congratulates the player on a job well done -->
                <cue name="Ch2_ChipmunkInduction_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$MaestroActor"/>
                  <param name="DelayInitial"      value="2s"/>
                  <param name="Lines"             value="[[30252201],[30252202],[30252203],[30252204],[30252205, 0.5s, Ch2_1_Chipmunk_Achievement],[30252206],[30252207],[if player.module == 'x4ep1_gamestart_pirate2' then 30252209 else 30252208]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Let me be the first to congratulate you:
                      Welcome to the Empyrean Curs!
                      And before I forget: You might have noticed we do not do names here!
                      So, since you will stick around we need to come up with something for you.
                      You competent smuggler; Shall call you "the Chipmunk"!  30252205
                      The reason why we were taking on new members is string of recent setbacks. We lost crew and assets to Teladi Ministry of Finance.
                      Need help getting back on our feet. 
                      Return to Arcadian Endeavour to get to know other members of crew!/Return to our base. Me and the Axiom have tasks for you, and you also meet last member of Empyrean Curs!
                  -->
                </cue>

                <cue name="Ch2_1_Chipmunk_Achievement">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <unlock_achievement name="TOA_PLOT_CRIMINAL_1" comment="One Busy Chipmunk"/>
                  </actions>
                </cue>

                <cue name="Ch2_1_Maestro_Conversation" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$MaestroActor"/>
                  </conditions>
                  <actions>
                    <do_if value="not $Ch2_MaestroConversation?">
                      <allow_conversation_escape enabled="false"/>
                      <add_npc_line speaker="$MaestroActor" hidechoices="true">
                        <text line="30252210" comment="There you are, Chipmunk!"/>
                        <text line="30252211" comment="Relieved to see my skills of appraising one's criminal talents did not betray me!"/>
                        <text line="30252212" comment="As I mentioned before, the Empyrean Curs are very much still growing."/>
                        <text line="30252213" comment="We used to be connected to many black market dealers in the policed systems, but Ministry of Finance especially has ratcheted up internal and external security."/>
                        <text line="30252214" comment="You help us establish new shady connection!"/>
                        <text line="30252215" comment="Need to buy specific illegal item from black market, but none of our current associates carry it. "/>
                        <text line="30252216" comment="I marked station with highest likelihood of criminal elements residing."/>
                        <text line="30252217" comment="Do not be nervous. I talk you through process."/>
                        <text line="30252218" comment="Best get to it!"/>
                      </add_npc_line>
                      <set_value name="$Ch2_MaestroConversation"/>
                    </do_if>
                    <do_elseif value="$WormwoodProtocolsDelivered?" comment="We can't check for 'ware.inv_wormwood_protocols' in inventory, because the player gives them to Maestro at some point.">
                      <add_npc_line speaker="$MaestroActor" hidechoices="true">
                        <text line="30252246" comment="Please see to tasks at hand! We need to grow for pirate enterprise to flourish."/>
                      </add_npc_line>
                    </do_elseif>
                    <do_elseif value="not $BlackMarketProtocolsCompleted? and not$WormwoodProtocolsDelivered?">
                      <add_npc_line speaker="$MaestroActor" hidechoices="true">
                        <text line="30252218" comment="Best get to it!"/>
                      </add_npc_line>
                    </do_elseif>
                  </actions>
                  <cues>
                    <cue name="Ch2_1_Maestro_Conversation_Ended">
                      <conditions>
                        <event_conversation_finished actor="$MaestroActor"/>
                      </conditions>
                      <actions>
                        <do_if value="($Ch2_MaestroConversation?) and not ($Ch2_MaestroConversation_Tasks?)" comment="only once">
                          <set_value name="$Ch2_MaestroConversation_Tasks"/>
                          <signal_cue cue="Ch2_1_DetermineBlackMarketStation"/>
                        </do_if>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_1_DetermineBlackMarketStation_Retry" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <reset_cue cue="Ch2_1_FindBlackMarket"/>
                  </actions>
                  <cues>
                    <cue name="Ch2_1_BlackMarketDestroyed_Maestro_Delivery" onfail="cancel">
                      <conditions>
                        <check_value value="not $BlackMarketDeliveryCompleted?"/>
                      </conditions>
                      <cues>
                        <cue name="Ch2_1_Maestro_BlackMarketRetryDeliveryComment_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$MaestroActor"/>
                          <param name="DelayInitial"      value="3s"/>
                          <param name="Lines"             value="[[30252214],[30252216],[30252218]]"/>
                          <param name="EndSignalCue"      value="Ch2_1_DetermineBlackMarketStation"/>
                          <!--
                            <t id="30252214">(5/9)You help us establish new shady connection!</t>
                            <t id="30252216">(7/9)Split mark station with highest chance of criminal elements there.</t>
                            <t id="30252218">(9/9)Best get to it!</t>
                          -->
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch2_1_BlackMarketDestroyed_Maestro_Protocols" onfail="cancel">
                      <conditions>
                        <check_value value="$BlackMarketDeliveryCompleted? and not $BlackMarketProtocolsCompleted?"/>
                      </conditions>
                      <cues>
                        <cue name="Ch2_1_Maestro_BlackMarketRetryProtocolsComment_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$MaestroActor"/>
                          <param name="DelayInitial"      value="3s"/>
                          <param name="Lines"             value="[[30252214],[30252216],[30252218]]"/>
                          <param name="EndSignalCue"      value="Ch2_1_DetermineBlackMarketStation"/>
                          <!--
                            <t id="30252216">(7/9)Split mark station with highest chance of criminal elements there.</t>
                            <t id="30252238">(2/2)Now buy Woodworm Security Protocols and return them to me!</t>
                            <t id="30252218">(9/9)Best get to it!</t>
                          -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_1_DetermineBlackMarketStation" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <find_station_by_true_owner name="$Ch2_BlackMarketStation" faction="faction.teladi" space="$18Bil_Sector" defencestation="false" excluded="$Ch2_ExcludedStations">
                      <match_content controlpost="controlpost.shadyguy"/>
                      <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                    </find_station_by_true_owner>

                    <do_if value="$Ch2_BlackMarketStation.isoperational">
                      <add_to_group groupname="$Ch2_ExcludedStations" object="$Ch2_BlackMarketStation"/>
                      <signal_cue cue="Ch2_1_FindBlackMarket"/>
                    </do_if>
                    <do_else>
                      <find_station_by_true_owner name="$Ch2_BlackMarketStation" faction="faction.teladi" space="player.galaxy" sortbygatedistanceto="player.entity" excluded="$Ch2_ExcludedStations">
                        <match_content controlpost="controlpost.shadyguy"/>
                        <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                      </find_station_by_true_owner>
                      <do_if value="not $Ch2_BlackMarketStation.isoperational" comment="no TEL stations found, spawn one">
                        <create_station name="$Ch2_BlackMarketStation" macro="macro.station_gen_factory_base_01_macro" owner="faction.teladi" sector="$18Bil_Sector" state="componentstate.operational" constructionplan="'tel_equipmentdock'">
                          <safepos space="$18Bil_Sector" min="80km" max="150km"/>
                        </create_station>
                        <signal_objects object="player.galaxy" param="'init station'" param2="$Ch2_BlackMarketStation" param3="false"/>
                        <signal_cue_instantly cue="md.NPC_ShadyGuy.AddShadyGuys" param="table[$stations = [$Ch2_BlackMarketStation]]"/>
                      </do_if>
                      <add_to_group groupname="$Ch2_ExcludedStations" object="$Ch2_BlackMarketStation"/>
                      <signal_cue cue="Ch2_1_FindBlackMarket"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch2_1_FindBlackMarket" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep_1" operation="add" exact="1"/>
                    <set_objective cue="$MissionCue_Ch2_BlackMarket" step="$ObjectiveStep_1" action="objective.flyto" object="$Ch2_BlackMarketStation" updatebriefing="true" radius="8km"/>
                    <activate_mission cue="$MissionCue_Ch2_BlackMarket"/>
                    <add_to_group groupname="md.Signal_Leaks.Manager.$ExcludedObjects" object="$Ch2_BlackMarketStation" comment="make sure our mission is not interrupted by random signal leak missions"/>
                  </actions>
                  <patch sinceversion="2">
                    <!-- In a previous version $Ch2_BlackMarketStation could change after guidance was set. Updating guidance to point to the correct station -->
                    <set_objective cue="$MissionCue_Ch2_BlackMarket" step="$ObjectiveStep_1" action="objective.flyto" object="$Ch2_BlackMarketStation" updatebriefing="true" radius="8km"/>
                  </patch>
                  <cues>

                    <cue name="Ch2_1_BlackMarketDestroyed">
                      <conditions>
                        <event_object_destroyed object="$Ch2_BlackMarketStation"/>
                        <check_value value="(not $BlackMarketDeliveryCompleted?) or (not $BlackMarketProtocolsCompleted?)"/>
                      </conditions>
                      <actions>
                        <debug_text text="'BlackMarketStation destroyed'" chance="$DebugChance"/>
                        <signal_cue cue="Ch2_1_DetermineBlackMarketStation_Retry"/>
                      </actions>
                    </cue>

                    <cue name="Ch2_1_InStationProximity" checkinterval="1s">
                      <conditions>
                        <check_value value="player.entity.distanceto.{$Ch2_BlackMarketStation} le 8km"/>
                        <check_value value="not $BlackMarketDeliveryCompleted?" comment="only if not yet delivered unstable crystals to shadyguy"/>
                      </conditions>
                      <cues>

                        <!-- Maestro points the player towards the signal leak -->
                        <cue name="Ch2_AtBlackMarketStation_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$MaestroActor"/>
                          <param name="DelayInitial"      value="0.5s"/>
                          <param name="Lines"             value="[[30252219],[30252220],[30252221, 2s],[30252222]]"/>
                          <param name="EndSignalCue"      value="Ch2_AtBlackMarketStation_ScanModeHint"/>
                          <!--
                            Approaching station now.
                            Initial contact with a black marketeer occurs through signal leaks.
                            I found one. Marked it for you!
                            Fly close in scan mode to intercept signal.
                          -->
                        </cue>

                        <cue name="Ch2_AtBlackMarketStation_ScanModeHint">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="player.input.controller">
                              <show_help line="14106" duration="12s" position="13" width="256" force="true" comment="Activate SCAN MODE from the SHIP MENU \($INPUT_ACTION_OPEN_COCKPIT_MENU$\)."/>
                            </do_if>
                            <do_else>
                              <show_help line="14101" duration="12s" position="13" width="256" force="true" comment="Press $INPUT_ACTION_TOGGLE_SCAN_MODE$ to activate SCAN MODE."/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Ch2_1_Create_Leak_Resetter" comment="Retry if @$SurfacePos fails" version="2">
                          <actions>
                            <reset_cue cue="Ch2_1_OfferBlackMarketMission"/>
                          </actions>
                          <delay exact="1s"/>
                          <actions>
                            <set_value name="$LeakObject" exact="$Ch2_BlackMarketStation"/>
                            
                            <do_if value="not $LeakObject.exists">
                              <!-- caught by Ch2_1_BlackMarketDestroyed which signals Ch2_1_DetermineBlackMarketStation_Retry -->
                            </do_if>
                            <do_else>
                              <do_if value="not $LeakObject.isphysicsready">
                                <reset_cue cue="this"/>
                              </do_if>
                              <do_else>
                                <find_signalleak_location name="$LeakLocations" container="$Ch2_BlackMarketStation" excludefilled="true" multiple="true"/>

                                <do_all exact="$LeakLocations.count" counter="$leak_i" reverse="true">
                                  <!--Currently only interested in placing signal leaks on operational components-->
                                  <do_if value="not $LeakLocations.{$leak_i}.component.isoperational">
                                    <debug_text text="'Removing ' + $LeakLocations.{$leak_i} + ' as its component is not operational.'" chance="$DebugChance"/>
                                    <remove_value name="$LeakLocations.{$leak_i}"/>
                                  </do_if>
                                </do_all>

                                <do_if value="$LeakLocations.count gt 1" comment="need more than 1 to not repeat locations on failure">
                                  <shuffle_list list="$LeakLocations"/>
                                  <set_value name="$SignalLeakLocation" exact="$LeakLocations.last"/>
                                </do_if>
                                <set_value name="$MissionLeakMacro" exact="macro.signalleak_s_standard_01_macro" />

                                <find_object_surface posname="$SurfacePos" rotname="$SurfaceRot" object="$SignalLeakLocation.component" height="$MissionLeakMacro.boundingbox.max.y - $MissionLeakMacro.boundingbox.center.y">
                                  <position value="$SignalLeakLocation.offset" />
                                  <!-- the rotation created by the normal would look away from the surface, we want a rotation that's looking parallel to the surface -->
                                  <offsetrotation pitch="-90deg" />
                                </find_object_surface>

                                <do_if value="@$SurfacePos">
                                  <create_signal_leak name="$SignalLeak" groupname="$Leaks" macro="$MissionLeakMacro" type="signalleaktype.voice" object="$SignalLeakLocation.component">
                                    <position value="$SurfacePos" />
                                    <rotation value="$SurfaceRot" />
                                    <voice page="10101" lines="1000003"/>
                                  </create_signal_leak>
                                  <create_position name="$SignalLeakPos" object="$SignalLeak" space="$SignalLeak.sector"/>

                                  <set_value name="$ObjectiveStep_1" operation="add" exact="1"/>
                                  <set_objective cue="$MissionCue_Ch2_BlackMarket" step="$ObjectiveStep_1" action="objective.scan" object="$SignalLeak" updatebriefing="true"/>
                                  <signal_cue cue="Ch2_1_OfferBlackMarketMission"/>
                                </do_if>
                                <do_else>
                                  <debug_text text="'SurfacePos for SignalLeak failed'" chance="$DebugChance"/>
                                  <reset_cue cue="this"/>
                                  <!-- TODO Handling (Retry?) -->
                                </do_else>
                              </do_else>
                            </do_else>
                          </actions>
                          <patch sinceversion="2">
                            <do_if value="(Ch2_1_Scanned_Leak.state == cuestate.waiting) and (not $SignalLeak.exists)">
                              <set_value name="$PATCH_Mantis1240" comment="flag for future debugging"/>
                              <reset_cue cue="Ch2_1_Create_Leak_Resetter" comment="this"/>
                            </do_if>
                          </patch>
                          <cues>

                            <cue name="Ch2_1_ScanHintTrigger">
                              <conditions>
                                <event_cue_completed cue="Ch2_1_Create_Leak_Resetter"/>
                              </conditions>
                              <cues>


                                <cue name="Ch2_1_ScanHint" checkinterval="0.5s">
                                  <conditions>
                                    <check_value value="$SignalLeak.exists"/>
                                    <check_value value="$SignalLeak.distanceto.{player.entity} lt 250m and player.activity != activity.scan"/>
                                  </conditions>
                                  <cues>

                                    <!--  points the player towards scan mode -->
                                    <cue name="Ch2_ScanModeHint_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                      <param name="Actor"             value="$MaestroActor"/>
                                      <param name="DelayInitial"      value="0.5s"/>
                                      <param name="Lines"             value="[[30252223]]" comment="Activate scan mode now!"/>
                                      <param name="EndSignalCue"      value="null"/>
                                      <!--
                                        Activate scan mode now!
                                      -->
                                    </cue>

                                  </cues>
                                </cue>

                              </cues>
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Ch2_1_OfferBlackMarketMission">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$Station" exact="$Ch2_BlackMarketStation" />
                            <set_value name="$TextOffset" exact="2500" />

                            <set_value name="$Valid" exact="false"/>
                            <set_value name="$Actor" exact="$Station.controlentity.{controlpost.shadyguy}"/>
                            <set_value name="$RewardObj" exact="$Actor"/>

                            <set_value name="$RewardText" exact="{30135,106}" comment="'(Reward)Access to unsanctioned trade offers'"/>

                            <set_value name="$DeliveryAmount" exact="3" />
                            <set_value name="$DeliveryItem" exact="ware.inv_unstablecrystal" />
                            <set_value name="$VoiceTable" exact="table[$SignalLeakVoiceLine = 1000002]" />

                          </actions>
                          <cues>
                            <cue name="GM_BringItems__Ref" ref="md.GM_BringItems.Start">
                              <param name="OfferObject"               value="$SignalLeak" />
                              <param name="Client"                    value="$Actor" />
                              <param name="ClientOwner"               value="$LeakObject.owner" />
                              <param name="MissionLevel"              value="1" />
                              <param name="Difficulty"                value="level.easy" />
                              <param name="MissionThread"             value="$MissionCue" />
                              <param name="Page"                      value="$Page" />
                              <param name="TextOffset"                value="$TextOffset" />
                              <param name="GenerateReward"            value="true" />
                              <param name="RewardObj"                 value="$RewardObj"/>
                              <param name="RewardText"                value="$RewardText"/>
                              <param name="VoiceTable"                value="$VoiceTable" />
                              <param name="DeliveryNPC"               value="$Actor" />
                              <param name="DeliveryStation"           value="$Station" />
                              <param name="DeliveryItem"              value="$DeliveryItem" />
                              <param name="DeliveryAmount"            value="$DeliveryAmount" />
                              <param name="DeclineButton"             value="false"/>
                              <param name="MissionAbortable"          value="false"/>
                              <param name="RemoveOnSectorChange"      value="false"/>
                              <param name="ReportSignalCue"           value="Ch2_1_ReportSignalCue"/>
                              <param name="CancelOfferCue"            value="GM_BringItems__Cancelled"/>
                              <param name="DebugChance"               value="$DebugChance" />
                            </cue>

                            <!--Somewhat useless cue as there are no other subcues to keep the instance alive but better have it as a standard for missions which do.-->
                            <cue name="GM_BringItems__Cancelled">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <!--signal_cue cue="Ch2_1_DetermineBlackMarketStation_Retry"/-->
                              </actions>
                            </cue>

                            <cue name="Ch2_1_ReportSignalCue" instantiate="true">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <!--debug_text text="'Mission feedback: %s [%s]'.[static.$FeedbackValue.$ID, static.$EndFeedbackValue.$ID]"/-->

                                <do_if value="static.$FeedbackValue.$ID == '$MISSION_ACCEPTED' and not static.$EndFeedbackValue.$ID?">
                                  <cancel_cue cue="Ch2_1_Scanned_Leak"/>
                                  <signal_cue cue="Ch2_1_MaestroCrystalHint"/>
                                  <set_value name="$ObjectiveStep_1" operation="add" exact="1"/>
                                  <set_value name="$BlackMarketActor" exact="$Ch2_BlackMarketStation.controlentity.{controlpost.shadyguy}"/>
                                  <set_objective cue="$MissionCue_Ch2_BlackMarket" step="$ObjectiveStep_1" action="objective.custom" customaction="{30252,2131}" text="{30252,2501}" object="$BlackMarketActor" updatebriefing="true" comment="Complete(Custom Action): Favours Amongst Friends(Mission Title)"/>
                                  <destroy_object object="$SignalLeak"/>
                                  <cancel_cue cue="Ch2_1_BosoUnlocked_Hint"/>
                                </do_if>

                                <do_if value="static.$EndFeedbackValue.$ID?">
                                  <do_if value="static.$EndFeedbackValue.$ID" exact="'$MISSION_SUCCEEDED'">
                                    <signal_cue cue="Ch2_1_BlackMarketCompleted"/>
                                  </do_if>
                                  <do_elseif value="static.$EndFeedbackValue.$ID == '$MISSION_ABORTED'">
                                    <!-- Should not happen (MissionAbortable = false) -->
                                    <debug_text text="'Mission was aborted'" chance="$DebugChance"/>
                                  </do_elseif>
                                  <do_elseif value="static.$EndFeedbackValue.$ID == '$MISSION_FAILED' or static.$EndFeedbackValue.$ID == '$DELIVERYNPC_KILLED' or static.$EndFeedbackValue.$ID == '$DELIVERY_STATION_DESTROYED'">
                                    <debug_text text="'GM failed with %s'.[static.$EndFeedbackValue.$ID]" chance="$DebugChance"/>
                                    <!--signal_cue cue="Ch2_1_DetermineBlackMarketStation_Retry"/-->
                                  </do_elseif>
                                </do_if>
                              </actions>
                            </cue>

                            <cue name="Ch2_1_Scanned_Leak">
                              <conditions>
                                <event_player_signal_unlock_finished signal="$SignalLeak"/>
                              </conditions>
                              <actions>
                                <set_value name="$ObjectiveStep_1" operation="add" exact="1"/>
                                <set_objective cue="$MissionCue_Ch2_BlackMarket" step="$ObjectiveStep_1" action="objective.custom" customaction="{30190,20}" text="{30252,2501}" object="$Ch2_BlackMarketStation" radius="10km" updatebriefing="true" />

                                <speak actor="$MaestroActor">
                                  <text line="30252224" delay="4s" comment="Before you can trade you must earn Black Marketeer's trust. "/>
                                  <text line="30252225" comment="Accept the job offer!"/>
                                </speak>
                              </actions>
                              <delay exact="90s"/>
                              <actions>
                                <signal_cue cue="Ch2_1_AcceptMissionHint"/>
                              </actions>
                            </cue>

                            <cue name="Ch2_1_BosoUnlocked_Hint">
                              <conditions>
                                <event_cue_completed cue="md.X4Ep1_Mentor_Subscriptions.Phase_SignalLeak_Conversation_Accept_Mission"/>
                              </conditions>
                              <cues>
                                <!-- Maestro comments on Boso's offer -->
                                <cue name="Ch2_BosoHint_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$MaestroActor"/>
                                  <param name="DelayInitial"      value="3s"/>
                                  <param name="Lines"             value="[[30252227],[30252228],[30252229]]"/>
                                  <param name="EndSignalCue"      value="null"/>
                                  <!--
                                    Peculiar. This signal was not what I was looking for.
                                    He sounded like he needed help. Best pursue on your own time.
                                    We still need to find a Black Marketeer's signal!
                                  -->
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Ch2_1_AcceptMissionHint">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>

                                <!-- Maestro reminds the player to check their mission offers  -->
                                <cue name="Ch2_AcceptMissionHint_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$MaestroActor"/>
                                  <param name="DelayInitial"      value="1s"/>
                                  <param name="Lines"             value="[[30252226]]"/>
                                  <param name="EndSignalCue"      value="null"/>
                                  <!--
                                    Still need to accept mission now before we continue.
                                  -->
                                </cue>

                              </cues>
                            </cue>

                            <cue name="Ch2_1_MaestroCrystalHint">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>

                                <cue name="Ch2_PlayerInventoryCheck" onfail="cancel">
                                  <conditions>
                                    <check_value value="player.entity.inventory.{$DeliveryItem}.count lt $DeliveryAmount"/>
                                  </conditions>
                                  <cues>

                                    <!-- Maestro points player towards unstable crystals -->
                                    <cue name="Ch2_UnstableCrystalHint_Ref_v2" ref="md.LIB_Dialog.Speak_Actor">
                                      <param name="Actor"             value="$MaestroActor"/>
                                      <param name="DelayInitial"      value="8.5s"/>
                                      <param name="Lines"             value="[[30252230],[30252231],[30252232],[30252233],[30252234]]"/>
                                      <param name="EndSignalCue"      value="null"/>
                                      <!--
                                      You need to deliver Unstable Crystals.
                                      Crystals can be used to craft Spacesuit bombs, which is why trading them is prohibited.
                                      But they are a fairly common natural occurrence.
                                      The crystals can be harvested from asteroids.
                                      Either mine asteroids yourself or look for crystals that have broken off in regions with concentrated mining activity!
                                      -->
                                    </cue>

                                  </cues>
                                </cue>

                                <cue name="Ch2_1_EnoughCrystalsMaestroHint" checkinterval="5s">
                                  <conditions>
                                    <check_value value="player.entity.inventory.{ware.inv_unstablecrystal}.count ge $DeliveryAmount"/>
                                  </conditions>
                                  <cues>

                                    <!-- Maestro tells the player they now have enough crystals to return to the shady guy -->
                                    <cue name="Ch2_DeliveryHint_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                      <param name="Actor"             value="$MaestroActor"/>
                                      <param name="DelayInitial"      value="4s"/>
                                      <param name="Lines"             value="[[30252235],[30252236]]"/>
                                      <param name="EndSignalCue"      value="null"/>
                                      <!--
                                        Good, you have enough crystals now.
                                        Time to return to Black Marketeer!
                                       -->
                                    </cue>

                                  </cues>
                                </cue>

                              </cues>
                            </cue>

                            <cue name="Ch2_1_BlackMarketCompleted">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_value name="$BlackMarketDeliveryCompleted" exact="true"/>
                              </actions>
                              <cues>
                                <!-- Maestro points out the player has to buy  Wormwood Security Protocols -->
                                <cue name="Ch2_BlackMarketFinished_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$MaestroActor"/>
                                  <param name="DelayInitial"      value="2s"/>
                                  <param name="Lines"             value="[[30252237],[30252238]]"/>
                                  <param name="EndSignalCue"      value="Ch2_1_BuyItem"/>
                                  <!--
                                    <t id="30252237">(1/2)Good! You established this contact. Make use whenever you see fit.</t>
                                    <t id="30252238">(2/2)Now buy Woodworm Security Protocols and return them to me!(Woodworm Security Protocols same as {20201,55401})</t>
                                  -->
                                </cue>
                              </cues>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch2_1_BuyItem_FastForward" onfail="cancel" comment="In case station was destroyed but player already delivered the crystals, skip-forward to the fetching of the security protocals">
                      <conditions>
                        <check_value value="$BlackMarketDeliveryCompleted?" comment="delivered unstable crystals to shadyguy"/>
                      </conditions>
                      <actions>
                        <set_value name="$Actor" exact="$Ch2_BlackMarketStation.controlentity.{controlpost.shadyguy}"/>
                        <set_entity_traits entity="$Actor" tradesvisible="true" comment="Unlocks the (existing) shadyguy and places him in the bar"/>
                        <signal_cue cue="Ch2_1_BuyItem"/>
                      </actions>
                    </cue>

                    <cue name="Ch2_1_BuyItem">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!--set_stock_reference entity="$Actor" stock="'story_pirate_trader'" /-->
                        <signal_objects object="$Actor" param="'add_itemtrader_ware'" param2="ware.inv_wormwood_protocols" param3="ware.inv_wormwood_protocols.averageprice"/>
                        <add_inventory entity="$Actor" ware="ware.inv_wormwood_protocols" exact="1"/>
                        <set_value name="$ObjectiveStep_1" operation="add" exact="1"/>
                        <set_objective cue="$MissionCue_Ch2_BlackMarket" step="$ObjectiveStep_1" action="objective.buy" object="$Actor" text="ware.inv_wormwood_protocols.name" updatebriefing="true" />
                        <activate_mission cue="$MissionCue_Ch2_BlackMarket"/>
                      </actions>
                      <cues>

                        <cue name="Ch2_1_ShadyGuy_Retry">
                          <conditions>
                            <event_object_destroyed object="$Actor"/>
                          </conditions>
                          <actions>
                            <debug_text text="'Shady guy with Security Protocols killed.'" chance="$DebugChance"/>
                            <!--signal_cue cue="Ch2_1_DetermineBlackMarketStation_Retry"/-->
                          </actions>
                        </cue>

                        <cue name="Ch2_1_ItemBought">
                          <conditions>
                            <event_inventory_added object="player.entity"/>
                            <check_value value="event.param.{ware.inv_wormwood_protocols}?"/>
                          </conditions>
                          <actions>
                            <set_value name="$ObjectiveStep_1" operation="add" exact="1"/>
                            <set_objective cue="$MissionCue_Ch2_BlackMarket" step="$ObjectiveStep_1" action="objective.deliver" object="$MaestroActor" text="ware.inv_wormwood_protocols.name" updatebriefing="true" />
                            <set_value name="$BlackMarketProtocolsCompleted" exact="true"/>
                          </actions>
                          <cues>

                            <cue name="Ch2_1_HandOver" instantiate="true">
                              <conditions>
                                <check_any>
                                  <event_conversation_started actor="$MaestroActor"/>
                                  <event_conversation_next_section actor="$MaestroActor" section="conv_questions"/>
                                </check_any>
                              </conditions>
                              <actions>
                                <do_if value="event.name == 'event_conversation_started'">
                                  <allow_conversation_escape enabled="false"/>
                                  <do_if value="player.entity.inventory.{ware.inv_wormwood_protocols}.count ge 1">
                                    <set_value name="$WormwoodProtocolsDelivered" exact="true"/>
                                    <remove_inventory entity="player.entity" ware="ware.inv_wormwood_protocols" exact="1"/>
                                    <add_npc_line speaker="$MaestroActor" hidechoices="true">
                                      <text line="30252242" comment="Well done, Chipmunk!"/>
                                      <text line="30252239" comment="Split appreciates you running these errands."/>
                                      <text line="30252240" comment="Split would have sent other members to station, too, but we all are already well known to authorities."/>
                                      <text line="30252241" comment="Higher likelihood of arrest. You are new face, less trouble."/>
                                      <text delay="1s" line="30252243" comment="These leaked security protocols will help gain valuable insights into Ministry operations on Wormwood Scrubs."/>
                                      <text line="30252244" comment="Will be useful for forging IDs."/>
                                    </add_npc_line>
                                    <add_player_choice text="{30252,30252201}" section="conv_questions" comment="What do we need IDs for?" position="top_left"/>
                                  </do_if>
                                  <do_else>
                                    <!-- handled by Ch2_1_Maestro_Conversation-->
                                  </do_else>
                                </do_if>
                                <do_else>
                                  <add_npc_line speaker="$MaestroActor" hidechoices="true">
                                    <text line="30252251" comment="You will see when time right!"/>
                                  </add_npc_line>
                                </do_else>
                              </actions>
                            </cue>

                            <cue name="Ch2_1_Completed_v2">
                              <conditions>
                                <event_conversation_finished actor="$MaestroActor"/>
                              </conditions>
                              <actions>
                                <remove_value name="$BlackMarketProtocolsCompleted"/>
                                <remove_from_group group="md.Signal_Leaks.Manager.$ExcludedObjects" object="$Ch2_BlackMarketStation" comment="make sure our mission is not interrupted by random signal leak missions"/>
                                <remove_from_list name="$Ch2_Missions" exact="$MissionCue_Ch2_BlackMarket"/>
                                <remove_mission cue="$MissionCue_Ch2_BlackMarket" type="completed"/>
                                <signal_cue cue="Ch2_FinishCheck" comment="All 3 submissions in Ch2 completed?"/>
                              </actions>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <!-- The way Ace behaves in all of 2.2 is pretty basic, he currently warps around a lot, which we might want to keep, but also might want to change. Probably better handling (Wingman-lite?) -->
            <cue name="Ch2_2_CargoRobbery">
              <conditions>
                <event_cue_completed cue="Ch2_Mission_Setup"/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep_2" exact="1"/>
                <set_value name="$MissionCue_Ch2_CargoRobbery" exact="this"/>

                <create_mission cue="$MissionCue_Ch2_CargoRobbery" name="{30252,2301}" description="{30252,2302}" rewardtext="{30252,2320}" type="missiontype.plot" faction="faction.civilian" difficulty="level.medium" abortable="false" icon="'briefing_ace_01'" iconcaption="$AceActor.knownname" missionthread="$MissionCue" activate="false">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$AceActor" text="$AceActor.name"/>
                  </briefing>
                </create_mission>
                <set_objective_from_briefing cue="$MissionCue_Ch2_CargoRobbery" step="$ObjectiveStep_2"/>
              </actions>
              <cues>

                <cue name="Ch2_2_Order_AceShip">
                  <actions>
                    <!-- Ace ship is docked at the AE from the very start of the story with the 'Wait' order running 
                      This will let the ship move from internal storage to the dock and then lift off 
                      TODO: Might need some rework, e.g. if the dialog with Ace is on the AE, then maybe Ace can walk to her ship first and then lift off.
                    -->
                    <create_order id="'AssignCommander'" object="$AceShip" immediate="true">
                      <param name="commander" value="$RaiderHubShip"/>
                      <param name="assignment" value="assignment.defence"/>
                      <param name="cancelorders" value="true"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Ch2_2_Ace_Conversation" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$AceActor"/>
                      <event_conversation_next_section actor="$AceActor" section="conv_questions"/>
                      <event_conversation_next_section actor="$AceActor" section="conv_continue"/>
                    </check_any>
                  </conditions>
                  <actions>

                    <do_if value="event.name == 'event_conversation_started'">
                      <allow_conversation_escape enabled="false"/>
                      <do_if value="not $Ch2_InitialAceConversation?">
                        <add_npc_line speaker="$AceActor" hidechoices="true">
                          <text line="30252201" comment="Ah, hello. You must be the Chipmunk!"/>
                          <text line="30252202" comment="I must have just missed you the last time you were here."/>
                          <text line="30252203" comment="You see, of everyone in the Empyrean Curs, I am the best pilot!"/>
                          <text line="30252204" comment="Need someone to lead the charge towards unsuspecting traders, or tangle with the local security forces?"/>
                          <text line="30252205" comment="You can always call on me!"/>
                          <text line="30252206" comment="Oh, I am Ace, by the way. A pleasure to meet you!"/>
                        </add_npc_line>
                        <set_value name="$Ch2_InitialAceConversation"/>
                        <add_player_choice text="{30252,30252202}" section="conv_questions" comment="Tell me a little about yourself!" position="top_left"/>
                        <add_player_choice text="{30252,30252203}" section="conv_continue" comment="Well, it's nice to meet you!" position="bottom_right" highlighted="true"/>
                      </do_if>
                      <do_else>
                        <do_if value="$Ch2_Missions.indexof.{$MissionCue_Ch2_CargoRobbery}">
                          <add_npc_line speaker="$AceActor" hidechoices="true">
                            <text line="30252259" comment="We could really use the revenue generated from this robbery."/>
                          </add_npc_line>
                        </do_if>
                        <do_else>
                          <add_npc_line speaker="$AceActor" hidechoices="true">
                            <text line="30252263" comment="That sure was a classic hold-up. Perfectly executed!"/>
                          </add_npc_line>
                        </do_else>
                      </do_else>
                    </do_if>
                    <do_else>

                      <do_if value="event.param == 'conv_questions'">
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$AceActor" hidechoices="true">
                          <text line="30252207" comment="Certainly! "/>
                          <text line="30252208" comment="I was the first one to join the Empyrean Curs after its founding!"/>
                          <text line="30252209" comment="It quickly became obvious that out of us four, I was the one who was the most gifted pilot."/>
                          <text line="30252210" comment="In those first years, when the Vigor Syndicate was not quite as consolidated as it is now, we mostly made our profits targeting the occasional luxury trader."/>
                          <text line="30252211" comment="Or by occasionally smuggling illicit wares when for brief moments in time when someone ambitious came along and seized control and wanted to enforce some sense of law. "/>
                          <text line="30252212" comment="The Syndicate has grown stronger and more dangerous, though, and with the gates reconnecting us to other systems, we have started turning our attention outwards."/>
                          <text line="30252213" comment="Usually I participate in scouting efforts, but also in combat raids, which is my true burning passion."/>
                          <text line="30252214" comment="I like fighting my enemies head on... for the most part."/>
                        </add_npc_line>
                        <add_player_choice text="{30252,30252202}" section="conv_questions" comment="Tell me a little about yourself!" position="top_left"/>
                        <add_player_choice text="{30252,30252203}" section="conv_continue" comment="Well, it's nice to meet you!" position="bottom_right" highlighted="true"/>
                      </do_if>
                      <do_elseif value="event.param == 'conv_continue'">
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$AceActor" hidechoices="true">
                          <text line="30252215" comment="Yes, but enough with these formal introductions."/>
                          <text line="30252216" comment="The Maestro asked me to see how well you perform under pressure. "/>
                          <text line="30252217" comment="Coming under fire is the truest test of character, after all."/>
                          <text line="30252218" comment="So, the two of us are going to rob a trader!"/>
                          <text line="30252219" comment="Do not be nervous, I will be with you every step of the way."/>
                          <text line="30252220" comment="You go ahead now, and I will be right behind you!"/>
                        </add_npc_line>
                      </do_elseif>

                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch2_2_Ace_Finished">
                  <conditions>
                    <check_any>
                      <event_speak_line_finished actor="$AceActor" line="30252220" comment="unreliable (but you can trigger the above conversation again)"/>
                      <event_speak_line_finished actor="$AceActor" line="30252259" comment="line spoken when triggering again"/>
                      <event_speak_finished actor="$AceActor" line="30252215" comment="reliable (first line of the add_npc_line-block, not the last!)"/>
                      <event_speak_finished actor="$AceActor" line="30252259" comment="reliable"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch2_2_SelectStation"/>
                  </actions>
                  <delay exact="1.5s"/>
                  <actions>
                    <speak actor="$AceActor" line="30252260" comment="In my trusty old ship. Perhaps it is time for an upgrade?"/>
                  </actions>
                </cue>

                <cue name="Ch2_2_SelectStation" comment="called again, in case destroyed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <find_station_by_true_owner name="$FactoryStation" faction="faction.argon" space="$SilentWitness1_Sector" defencestation="false" hastradeoffer="true" excluded="$Ch2_ExcludedStations">
                      <match_products wares="[ware.quantumtubes, ware.microchips, ware.antimatterconverters]"/>
                      <!--match_distance value="$sector.coreposition" space="$sector" min="$sector.coresize"/-->
                    </find_station_by_true_owner>
                    <do_if value="$FactoryStation.isoperational">
                      <!-- nothing -->
                    </do_if>
                    <do_else>
                      <find_station_by_true_owner name="$FactoryStation" faction="faction.argon" space="player.galaxy" defencestation="false" hastradeoffer="true" sortbygatedistanceto="player.entity" excluded="$Ch2_ExcludedStations">
                        <match_products wares="[ware.quantumtubes, ware.microchips, ware.antimatterconverters]"/>
                      </find_station_by_true_owner>
                      <do_if value="not $FactoryStation.isoperational" comment="no TEL stations found, spawn one">
                        <create_station name="$FactoryStation" macro="macro.station_gen_factory_base_01_macro" owner="faction.argon" sector="$SilentWitness1_Sector" state="componentstate.operational" constructionplan="'arg_tradestation'">
                          <safepos space="$18Bil_Sector" min="80km" max="150km"/>
                        </create_station>
                        <signal_objects object="player.galaxy" param="'init station'" param2="$FactoryStation" param3="false"/>
                      </do_if>
                    </do_else>
                    <add_to_group groupname="$Ch2_ExcludedStations" object="$FactoryStation"/>
                    <debug_text text="'Selected %s (destroycount=%s)'.[$FactoryStation.name, if $FactoryStationDestroyed? then $FactoryStationDestroyed else 0]" chance="$DebugChance"/>

                    <signal_cue cue="Ch2_2_GetToStation" check="false" comment="only needs to be signalled once, even if the station was destroyed and another was selected (so silently fail)"/>

                  </actions>
                  <cues>
                    <!-- If it's destroyed, silently select a new station. If the player is in the 'scanning ships' phase, spawned traders will automatically start spawning 
                        from the new station (and either way, _any_ matching ship will work, the spawned ones are just to make it easier to find one) -->
                    <cue name="Ch2_2_FactoryStation_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$FactoryStation"/>
                      </conditions>
                      <actions>
                        <set_value name="$FactoryStationDestroyed" operation="add"/>
                        <reset_cue cue="Ch2_2_SelectStation"/>
                        <signal_cue cue="Ch2_2_SelectStation"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_2_GetToStation">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep_2" exact="2"/>
                    <get_safe_pos result="$Ch2_Objective_Offset" object="$FactoryStation" sector="$FactoryStation.sector" min="10km" max="15km"/>
                    <set_objective cue="$MissionCue_Ch2_CargoRobbery" action="objective.undock" text="$RaiderHubShip.name" step="$ObjectiveStep_2" updatebriefing="true"/>
                    <find_object_component name="$Dock" object="$RaiderHubShip" checkoperational="true" macro="macro.dockingbay_arg_s_01_macro"/>
                    <activate_mission cue="$MissionCue_Ch2_CargoRobbery"/>
                  </actions>
                  <cues>

                    <cue name="Ch2_2_ChangePilot" checkinterval="1s">
                      <conditions>
                        <check_value value="not player.entity.hascontext.{$RaiderHubShip}"/>
                      </conditions>
                      <actions>

                        <debug_text text="'Destroy the pilot'" chance="$DebugChance"/>
                        <!-- dismiss old pilot, if any -->
                        <set_value name="$oldpilot" exact="$AceShip.pilot"/>

                        <set_objective cue="$MissionCue_Ch2_CargoRobbery" action="objective.wait"/>
                        <do_if value="$oldpilot.exists">
                          <dismiss_control_entity actor="$oldpilot" object="$AceShip" />
                          <signal_objects object="$oldpilot" param="'npc_despawn'" param2="table[$disconnect = true]"/>
                        </do_if>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $AceActor, $MissionCue]"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>

                        <!-- Ace's ship is docked at the AE (from the start of the script), the moment the player undocks, Ace's ship (with Ace onboard) 
                          is recalled to the dock and then lifts off - that looks quite nice. -->
                        <assign_control_entity object="$AceShip" actor="$AceActor" post="controlpost.aipilot" transfer="true" init="true"/>
                        <signal_objects object="$AceActor" param="'npc_state_reinit'"/>
                        <cancel_all_orders object="$AceShip"/>
                        <create_order id="'MoveWait'" object="$AceShip" immediate="true">
                          <param name="destination" value="[$FactoryStation.sector, $Ch2_Objective_Offset]" />
                          <param name="lookat" value="$FactoryStation.position"/>
                          <param name="timeout" value="0s" comment="with 0s this will be infinite" />
                          <param name="recallsubordinates" value="false" />
                        </create_order>
                      </actions>
                      <cues>


                        <!-- Ace tells the player to fly ahead -->
                        <cue name="Ch2_AceHeadsUp_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AceActor"/>
                          <param name="DelayInitial"      value="3.5s"/>
                          <param name="Lines"             value="[[30252221], [30252222], [30252223], [30252224], [30252225]]"/>
                          <param name="EndSignalCue"      value="Ch2_2_PointToSRobberyStation"/>
                          <!--
                            Let us see if we cannot find a system that is not too heavily patrolled.
                            We would not want you killed in action on our first outing.
                            Whenever we are looking for a suitable target to rob, it is usually a good idea at a station.
                            Space is vast after all and finding ships can be difficult, but everyone needs to dock at port eventually. 
                            I sent you the location of the station I selected now.
                           -->
                        </cue>

                        <cue name="Ch2_2_PointToSRobberyStation">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$ObjectiveStep_2" operation="add" exact="1"/>
                            <set_objective cue="$MissionCue_Ch2_CargoRobbery" action="objective.flyto" step="$ObjectiveStep_2" offset="$Ch2_Objective_Offset" object="$FactoryStation.sector" text="{30252, 2330}" radius="3km" updatebriefing="true"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch2_2_PlayerAtPosition" checkinterval="1s">
                      <conditions>
                        <check_value value="($FactoryStation.exists) and (player.entity.distanceto.[$FactoryStation.sector, $Ch2_Objective_Offset] le 3.2km)"/>
                      </conditions>
                      <actions>
                        <set_value name="$Ch_2_AtStation"/>
                        <set_value name="$ObjectiveStep_2" operation="add" exact="1"/>
                        <set_objective cue="$MissionCue_Ch2_CargoRobbery" action="objective.wait" object="$FactoryStation" step="$ObjectiveStep_2" updatebriefing="true"/>

                        <set_value name="$RandomisedDelay" exact="20s"/>
                        <create_group groupname="$ActiveTraders"/>
                      </actions>
                      <delay exact="2s"/>
                      <actions>
                        <do_if value="not $AceShip.pilot">
                          <assign_control_entity object="$AceShip" actor="$AceActor" post="controlpost.aipilot" transfer="true" init="true"/>
                          <signal_objects object="$AceActor" param="'npc_state_reinit'"/>
                        </do_if>

                        <do_if value="$AceShip.sector != $FactoryStation.sector">
                          <warp object="$AceShip" sector="$FactoryStation.sector">
                            <safepos object="player.ship" min="20km" max="25km" allowyaxis="false"/>
                          </warp>
                        </do_if>
                        <!-- TODO: Actually set up a wingmate behaviour for the rest of Ch2 (active while in $FactoryStation.sector) -->
                        <cancel_all_orders object="$AceShip"/>
                        <create_order id="'ProtectShip'" object="$AceShip" immediate="true">
                          <param name="target" value="player.ship"/>
                        </create_order>
                      </actions>
                      <cues>

                        <!-- Ace points out that traders go from and to stations -->
                        <cue name="Ch2_AceFactoryHint_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AceActor"/>
                          <param name="DelayInitial"      value="3s"/>
                          <param name="Lines"             value="[[30252226], [30252227], [30252228], [30252229]]"/>
                          <param name="EndSignalCue"      value="Ch2_2_AceScanObjective"/>
                          <!--
                            This station is selling valuable high-tech wares, which do not run cheap.
                            Wares are usually transported off a station by trade ships.
                            Keep an eye out for m-sized High-Tech Traders, they make for especially easy marks!
                            Scan any you come across, to check their current cargo capacity.
                           -->
                        </cue>

                        <cue name="Ch2_2_AceScanObjective">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$ObjectiveStep_2" operation="add" exact="1"/>
                            <set_objective cue="$MissionCue_Ch2_CargoRobbery" action="objective.scan" text="{30252,2331} + ' ' + {20204, 401}" object="$FactoryStation.sector" radius="150km" step="$ObjectiveStep_2" updatebriefing="true"/>
                            <signal_cue cue="Ch2_2_ScanningShips"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch2_2_CreateAdditionalTradeShips" version="3">
                      <conditions>
                        <event_cue_completed cue="Ch2_2_PlayerAtPosition"/>
                      </conditions>
                      <actions>
                        <create_group groupname="$stations"/>
                        <find_sector_in_range name="$PotentialSectors" object="$FactoryStation" maxdistance="2" multiple="true"/>
                      </actions>
                      <patch sinceversion="3">
                        <!-- The player was able to capture mission-generated ships in an earlier version -->
                        <do_for_each name="$ship" in="$ActiveTraders" reverse="true">
                          <remove_from_group group="$ActiveTraders" object="$ship" chance="if $ship.isplayerowned then 100 else 0"/>
                          <do_if value="$ship.order.id == 'MoveDie' and $ship.isplayerowned">
                            <!-- ship might already be in the process of dying -->
                            <cancel_all_orders object="$ship"/>
                          </do_if>
                        </do_for_each>
                      </patch>
                      <cues>

                        <cue name="Ch2_2_Objective_DEBUG">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_objective cue="$MissionCue_Ch2_CargoRobbery" action="objective.flyto" text="'Find All Tradeships'" step="$ObjectiveStep_2" group="$ActiveTraders" updatebriefing="true"/>
                          </actions>
                        </cue>

                        <cue name="Ch2_2_CreateTraders" checkinterval="90s" instantiate="true" comment="keep spawning new ones, so the player doesn't have to wait endlessly. 90s + $RandomisedDelay">
                          <conditions>
                            <check_value value="$ActiveTraders.count lt 6 and player.entity.sector == $FactoryStation.sector"/>
                            <check_value value="(not $Ch2_TargetShip?) or ($Ch2_TargetShip? and not $Ch2_TargetShip.exists)" comment="ignore if player already is following a target (which wasn't destroyed)"/>
                          </conditions>
                          <delay exact="$RandomisedDelay"/>
                          <actions>
                            <set_value name="$WaresList" exact="[$FactoryStation.products.random]"/>
                            <set_value name="$TraderFaction" exact="[faction.argon, faction.teladi, faction.paranid].random"/>

                            <get_ship_definition reference="$TradeShipDef" size="class.ship_m" faction="$TraderFaction" tags="[tag.trader, tag.container]"/>
                            <set_value name="$RandomisedDelay" min="20s" max="80s"/>
                            <find_dockingbay name="$dock" object="$FactoryStation">
                              <match_dock size="tag.dock_m" free="true" storage="true" />
                            </find_dockingbay>

                            <do_if value="$dock.isoperational">
                              <set_value name="$PotentialSector" exact="$PotentialSectors.random"/>

                              <!-- find suitable delivery station - with several fallbacks -->
                              <set_value name="this.$factor" exact="1.0"/>
                              <clear_group group="$stations"/>
                              <do_while value="(this.$factor ge 0.0) and ($stations.count == 0)">
                                <debug_text text="'Searching station range %s'.[this.$factor]" chance="$DebugChance"/>
                                <find_station groupname="$stations" space="$PotentialSector" multiple="true" comment="Find station in the outskirts of the sector (not in the core)">
                                  <match_distance value="$PotentialSector.coreposition" space="$PotentialSector" min="$PotentialSector.coresize * this.$factor"/>
                                  <match_relation_to faction="$TraderFaction" relation="dock"/>
                                  <match_dock size="tag.dock_s"/>
                                </find_station>
                                <set_value name="this.$factor" exact="this.$factor - 0.15"/>
                              </do_while>

                              <do_if value="$stations.count" comment="If there was no suitable station just skip, it'll retry in the next interval">
                                <create_ship name="$TradeShip" ref="$TradeShipDef" dock="$dock" capturable="false" groupname="$ActiveTraders">
                                  <owner exact="$TraderFaction" overridenpc="true" />
                                  <pilot group="argon.pilot">
                                    <skills>
                                      <skill type="piloting" min="8" max="15" />
                                      <skill type="morale" min="4" max="8" />
                                    </skills>
                                  </pilot>
                                  <cargo>
                                    <wares list="$WaresList">
                                      <fillpercent exact="70"/>
                                    </wares>
                                  </cargo>
                                </create_ship>

                                <debug_text text="'TradeShip %s to any targetstation %s'.[$TradeShip, $stations]" chance="$DebugChance"/>

                                <!--TODO: Find how to realistically name these ships so that they are indistinguishable from the real deal -->
                                <set_object_name object="$TradeShip" page="20204" line="401" comment="TEMP High-Tech Trader"/>
                                <create_order id="'DockAndWait'" object="$TradeShip" default="true" comment="stay docked">
                                  <param name="destination"       value="$stations.random" />
                                  <param name="noboost"           value="true" comment="make it crawl, so player has a chance to find a spot not-near any stations"/>
                                  <param name="noattackresponse"  value="true" comment="disables call for help/disables attack order overriding the movement order/still lets ship turn hostile/still lets turrets shoot"/>
                                  <param name="debugchance"       value="$DebugChance"/>
                                </create_order>
                              </do_if>
                              <do_else>
                                <debug_text text="'TradeShip no targetstations - skipping'" chance="$DebugChance"/>
                              </do_else>
                            </do_if>
                            <do_else>
                              <debug_text text="'TradeShip no dock - skipping'" chance="$DebugChance"/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Ch2_2_TraderDocked" instantiate="true">
                          <conditions>
                            <event_object_docked group="$ActiveTraders"/>
                            <check_value value="event.param != $FactoryStation"/>
                          </conditions>
                          <actions>
                            <debug_text text="'TradeShip %s docked at %s'.[event.object, event.param]" chance="$DebugChance"/>
                            <cancel_all_orders object="event.object"/>
                            <create_order id="'DockAndWait'" object="event.object" default="true">
                              <param name="destination" value="event.param" comment="stay docked"/>
                              <param name="debugchance" value="$DebugChance"/>
                            </create_order>
                            <request_store_ship object="event.param" ship="event.object" />
                          </actions>
                        </cue>

                        <cue name="Ch2_2_TraderStored" instantiate="true">
                          <conditions>
                            <event_object_moved_into_internal_storage group="$ActiveTraders"/>
                          </conditions>
                          <actions>
                            <debug_text text="'TradeShip %s into storage and destroyed'.[event.object]" chance="$DebugChance"/>
                            <destroy_object object="event.object" explosion="false"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch2_2_ScanningShips">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch2_2_ScanModeReminder" checkinterval="3s" comment="one-time hint">
                      <conditions>
                        <check_value value="$FactoryStation.sector == player.ship.sector"/>
                        <count_ships result="$ShipsInProximity" class="class.ship_m" space="player.entity.sector" min="1">
                          <match_distance object="player.entity" max="3km"/>
                          <match excluded="player.ship"/>
                        </count_ships>
                        <!--check_value value="(not $Ch2_TargetShip?) or ($Ch2_TargetShip? and not $Ch2_TargetShip.exists)"/-->
                      </conditions>
                      <cues>

                        <cue name="Ch2_2_ProximityCheck" onfail="cancel">
                          <conditions>
                            <check_value value="player.activity != activity.scan"/>
                          </conditions>
                          <cues>

                            <!-- Ace points the the player towards scan mode  -->
                            <cue name="Ch2_2_ScanHint_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="Lines"             value="[[30252230]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                You need to change into Scan mode to be able to scan your target.
                              -->
                            </cue>

                            <cue name="Ch2_2_ScanModeHint">
                              <actions>
                                <do_if value="player.input.controller">
                                  <show_help line="14106" position="13" width="256" allowclose="true" timeout="false" force="true" comment="Activate SCAN MODE from the SHIP MENU \($INPUT_ACTION_OPEN_COCKPIT_MENU$\)."/>
                                  <show_help line="15112" position="13" width="256" allowclose="true" timeout="false" force="true" comment="Fly close to the target and select SCAN from the context menu."/>
                                  <!--show_help line="15114" position="13" width="256" force="true" timeout="false" comment="If the ship is moving away from you, press $INPUT_STATE_MATCH_SPEED$ to match speed with the ship you are pursuing."/-->
                                  <!--show_help_multi log="false" position="13" force="true" allowclose="false">
                                    <text line="14106" comment="Activate SCAN MODE from the SHIP MENU \($INPUT_ACTION_OPEN_COCKPIT_MENU$\)."/>
                                    <text line="15112" comment="Fly close to the target and select SCAN from the context menu."/>
                                    <text line="15114" comment="If the ship is moving away from you, press $INPUT_STATE_MATCH_SPEED$ to match speed with the ship you are pursuing."/>
                                  </show_help_multi-->
                                </do_if>
                                <do_else>
                                  <show_help line="14101" position="13" width="256" allowclose="true" timeout="false" force="true" comment="Press $INPUT_ACTION_TOGGLE_SCAN_MODE$ to activate SCAN MODE."/>
                                  <show_help line="15112" position="13" width="256" allowclose="true" timeout="false" force="true" comment="Fly close to the target and select SCAN from the context menu."/>
                                  <!--show_help line="15114" position="13" width="256" force="true" timeout="false" comment="If the ship is moving away from you, press $INPUT_STATE_MATCH_SPEED$ to match speed with the ship you are pursuing."/-->
                                  <!--show_help_multi log="false" position="13" force="true" allowclose="false">
                                    <text line="14101" comment="Press $INPUT_ACTION_TOGGLE_SCAN_MODE$ to activate SCAN MODE."/>
                                    <text line="15112" comment="Fly close to the target and select SCAN from the context menu."/>
                                    <text line="15114" comment="If the ship is moving away from you, press $INPUT_STATE_MATCH_SPEED$ to match speed with the ship you are pursuing."/>
                                  </show_help_multi-->
                                </do_else>
                              </actions>
                              <cues>
                                <cue name="Ch2_2_ScanMode_Activated">
                                  <conditions>
                                    <event_player_changed_activity activity="activity.scan"/>
                                  </conditions>
                                  <actions>
                                    <remove_help line="[14101,14106]" comment="If player entered scan mode, show the next queued hint"/>
                                  </actions>
                                </cue>
                                <cue name="Ch2_2_Scan_Performed">
                                  <conditions>
                                    <event_scan_started scanner="player.entity"/>
                                  </conditions>
                                  <actions>
                                    <remove_help line="[15112]" comment="If player performed a (deep)scan, remove the hint"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch2_2_PlayerScannedShip">
                      <conditions>
                        <event_scan_finished scanner="global.$PlayerControlledGroup"/>
                        <check_value value="Ch2_2_Completed_v2.state != cuestate.complete" comment="ignore, if player already completed ch2.2 ($Ch2_TargetShip is likely to not exist at this point)"/>
                        <check_value value="(not $Ch2_TargetShip?) or ($Ch2_TargetShip? and not $Ch2_TargetShip.exists)" comment="ignore if player already is following a target (which wasn't destroyed) and scans another ship"/>
                      </conditions>
                      <actions>
                        <set_value name="this.$ScannedShip" exact="event.param"/>
                        <do_if value="$ActiveTraders.indexof.{this.$ScannedShip} or event.param.job == 'argon_tech_trader_m' or event.param.job == 'paranid_tech_trader_m' or event.param.job == 'teladi_tech_trader_m'">
                          <do_if value="(((this.$ScannedShip.cargo.free.all)f/(this.$ScannedShip.cargo.capacity.all)f)*100)i le 35" comment="Has le than 35 percentage of storage free ">
                            <set_value name="$Ch2_TargetShip" exact="this.$ScannedShip"/>
                            <signal_cue cue="Ch2_2_Shakedown"/>
                          </do_if>
                          <do_else>
                            <signal_cue_instantly cue="Ch2_2_WrongShipSpeak" param="[[30252233]]" comment="Right ship type, no cargo"/>
                          </do_else>
                        </do_if>
                        <do_elseif value="this.$ScannedShip.primarypurpose == purpose.fight">
                          <signal_cue_instantly cue="Ch2_2_WrongShipSpeak" param="[[30252231]]" comment="Ship is a fighter"/>
                        </do_elseif>
                        <do_elseif value="this.$ScannedShip.isclass.[class.ship_l, class.ship_xl]">
                          <signal_cue_instantly cue="Ch2_2_WrongShipSpeak" param="[[30252234]]" comment="Ship too big"/>
                        </do_elseif>
                        <do_elseif value="this.$ScannedShip.isclass.[class.ship_s]">
                          <signal_cue_instantly cue="Ch2_2_WrongShipSpeak" param="[[30252235]]" comment="Ship too small"/>
                        </do_elseif>
                        <do_else>
                          <signal_cue_instantly cue="Ch2_2_WrongShipSpeak" param="[[30252232]]" comment="Ship too small"/>
                        </do_else>
                      </actions>
                      <delay exact="20s" comment="delayed reset to avoid instantiated scan spam"/>
                      <actions>
                        <reset_cue cue="this"/>
                      </actions>
                    </cue>

                    <cue name="Ch2_2_WrongShipSpeak" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="this.$speak" exact="event.param"/>
                      </actions>
                      <cues>

                        <!-- Ace gives the go ahead -->
                        <cue name="Ch2_2_AceScannedWrongShipType_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AceActor"/>
                          <param name="DelayInitial"      value="2s"/>
                          <param name="Lines"             value="parent.$speak"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            Oh, you would not want to mess with combat ships quite yet!/
                            This is a trader, but it isn't dealing in High-Tech wares. Keep looking./
                            This is the right type of ship, but the scan revealed it isn't carrying enough freight to be worth the trouble./
                            An L-size ship? Seriously? That is a bit ambitious. Let's keep looking!/
                            An S-size ship is hardly worth the trouble. Look for an L-size trader!
                           -->
                        </cue>

                      </cues>
                    </cue>


                  </cues>
                </cue>

                <cue name="Patch_Ch2_Completesignal" onfail="cancel">
                  <conditions>
                    <check_value value="$Ch2_2_CompleteFlag?"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch2_2_Completed_v2"/>
                  </actions>
                </cue>

                <cue name="Ch2_2_Shakedown" comment="Assumes $Ch2_TargetShip (=the scanned ship) is set" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="0.1s" comment="Delay to be able to signal sub-cue"/>
                  <actions>

                    <debug_text text="'ShakeDown %s'.[$Ch2_TargetShip]" chance="$DebugChance"/>

                    <find_station name="$ClosestStations" space="$Ch2_TargetShip.sector" sortbydistanceto="$Ch2_TargetShip">
                      <match_relation_to object="$Ch2_TargetShip" comparison="not" relation="enemy" />
                    </find_station>
                    <set_object_capturable object="$Ch2_TargetShip" capturable="true"/>
                    <!-- TODO: check if objectives work correctly, if TargetShip was destroyed (or if we get an ever-increasing list of objectives) -->
                    <set_value name="$ObjectiveStep_2" operation="add" exact="1"/>
                    <do_if value="$ClosestStations.bboxdistanceto.{$Ch2_TargetShip} ge 43km">
                      <set_value name="$Ch2_AttackLines" exact="[[30252241]]" comment="Let's go on the offensive!"/>
                      <signal_cue cue="Ch2_2_Shakedown_Attack"/>
                    </do_if>
                    <do_else>
                      <set_value name="$Ch2_AttackLines" exact="[[30252242]]" comment="Oh, you went ahead anyway? That is fine, we just have to move fast."/>
                      <signal_cue cue="Ch2_2_Shakedown_Follow"/>
                      <set_objective cue="$MissionCue_Ch2_CargoRobbery" action="objective.follow" step="$ObjectiveStep_2" object="$Ch2_TargetShip" updatebriefing="true"/>
                      <set_value name="$ObjectiveStep_2" operation="add" exact="1"/>
                    </do_else>

                  </actions>
                  <patch sinceversion="2" state="cancelled">
                    <do_if value="Ch2_Completed.state == cuestate.waiting">
                      <set_value name="$Ch2_2_CompleteFlag"/>
                    </do_if>
                  </patch>
                  <cues>

                    <cue name="Ch2_2_TargetFoundSpeak">
                      <cues>
                        <!-- Ace gives the go ahead -->
                        <cue name="Ch2_2_AceInitiatesRobbery_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AceActor"/>
                          <param name="DelayInitial"      value="1.5s"/>
                          <param name="Lines"             value="[[30252236]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            The scan confirms that this ship is carrying cargo. This is our mark!
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch2_2_MatchSpeedHint" checkinterval="3s" comment="Player just finished scan and Ace accepted it as a target, give a hint about matching speed" version="2">
                      <delay exact="5s"/>
                      <actions>
                        <do_if value="player.input.controller">
                          <show_help position="1" timeout="30s" force="true" log="true" line="27800" comment="To MATCH SPEED, select it via the INTERACT MENU ($INPUT_STATE_INTERACTION_MENU$)."/>
                        </do_if>
                        <do_else>
                          <show_help position="1" timeout="30s" force="true" log="true" line="27801" comment="Press $INPUT_STATE_MATCH_SPEED$ to start matching the speed of your current target."/>
                        </do_else>
                      </actions>
                      <patch sinceversion="2">
                        <remove_help all="true" />
                      </patch>
                    </cue>

                    <cue name="Ch2_2_ShipDestroyed_Precheck" onfail="cancel" comment="Ship could have been destroyed between Ch2_2_PlayerScannedShip and signalling Ch2_2_Shakedown">
                      <conditions>
                        <check_value value="not $Ch2_TargetShip.exists"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch2_2_ShipDestroyed"/>
                      </actions>
                    </cue>

                    <cue name="Ch2_2_ShipDestroyed">
                      <conditions>
                        <check_any>
                          <event_object_destroyed object="$Ch2_TargetShip"/>
                          <event_cue_signalled/>
                        </check_any>
                        <check_value value="not $CargoDropped?" comment="If cargo was already dropped, we don't care that it was destroyed"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Lost ship event=%s'.[event.name]" chance="$DebugChance"/>
                        <set_value name="$ResetVoiceline" exact="[[30252246],[30252247]]" comment="'We lost the ship. There is no way to get to the cargo now.' 'Try looking for another ship!'"/>
                        <signal_cue_instantly cue="Ch2_2_ShipDestructionReset" param="$ResetVoiceline"/>
                        <reset_cue cue="Ch2_2_ScanningShips"/>
                        <reset_cue cue="Ch2_2_Shakedown"/>
                      </actions>
                    </cue>

                    <cue name="Ch2_2_Shakedown_Follow">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>

                        <!-- Ace warns of the station nearby -->
                        <cue name="Ch2_2_AceStationWarning_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AceActor"/>
                          <param name="DelayInitial"      value="0.5s"/>
                          <param name="Lines"             value="[[30252237], [30252238], [30252239]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            Do not jump the gun, though! We are still close enough to allied stations for them to take notice!
                            We would not want to have the whole sector come down on us!
                            Just trail the ship, until it moves far enough away from allied stations so that it will not immediately be able to request back up.
                           -->
                        </cue>

                        <cue name="Ch2_2_Shakedown_Follow_Reminder">
                          <delay exact="1min"/>
                          <actions>
                            <do_if value="not $Ch2_SecondReminder?">
                              <set_value name="$FollowReminderLine" exact="[30252261]" comment="Still too close to stations for us to try anything."/>
                            </do_if>
                            <do_else>
                              <set_value name="$FollowReminderLine" exact="[30252262]" comment="Just be patient, that ship is about to head away from stations eventually."/>
                            </do_else>
                          </actions>
                          <cues>

                            <cue name="Ch2_2_ShakedownReminder_Reset">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <do_if value="not $Ch2_SecondReminder?">
                                  <set_value name="$Ch2_SecondReminder"/>
                                  <reset_cue cue="Ch2_2_Shakedown_Follow_Reminder"/>
                                </do_if>
                                <do_else>
                                  <remove_value name="$Ch2_SecondReminder"/>
                                  <cancel_cue cue="Ch2_2_Shakedown_Follow_Reminder"/>
                                </do_else>
                              </actions>
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Ch2_2_ShakedownReminder_SpeakTrigger">
                          <conditions>
                            <event_cue_completed cue="Ch2_2_Shakedown_Follow_Reminder"/>
                          </conditions>
                          <cues>

                            <!-- Ace assures the player it is still going -->
                            <cue name="Ch2_2_FollowReminder_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="DelayInitial"      value="0.5s"/>
                              <param name="Lines"             value="[$FollowReminderLine]"/>
                              <param name="EndSignalCue"      value="Ch2_2_ShakedownReminder_Reset"/>
                              <!--
                                    Do not jump the gun, though! We are still close enough to allied stations for them to take notice!
                                    We would not want to have the whole sector come down on us!
                                  -->
                            </cue>

                          </cues>
                        </cue>

                        <!-- Note: Almost no ship is ever completely out of all stations ranges, we try and mitigate this by finding stations at the edge of the sector, and making the targetship crawl to it -->
                        <cue name="Ch2_2_Shakedown_FollowCheck" checkinterval="5s" instantiate="true">
                          <conditions>
                            <check_value value="Ch2_2_Shakedown_Attack.state == cuestate.waiting"/>
                          </conditions>
                          <actions>
                            <!-- Trigger the attack when target outside of range of stations, not in a highway - and the player is relatively nearby -->
                            <do_if value="($ClosestStations.bboxdistanceto.{$Ch2_TargetShip} ge 43km) and (not $Ch2_TargetShip.zone.isclass.highway) and ($Ch2_TargetShip.sector == player.sector and $Ch2_TargetShip.distanceto.{player.entity} lt 50km)">
                              <set_value name="$Ch2_AttackLines" exact="[[30252240],[30252241]]" comment="The ship is quite far away from its allied stations. Any response will not be immediate. Let's go on the offensive!"/>
                              <signal_cue cue="Ch2_2_Shakedown_Attack"/>
                            </do_if>
                            <do_else>
                              <debug_text text="'Too close to station dist=%sm'.[$ClosestStations.bboxdistanceto.{$Ch2_TargetShip}]" chance="$DebugChance"/>
                            </do_else>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch2_2_Shakedown_Attack">
                      <conditions>
                        <check_any>
                          <event_object_attacked object="$Ch2_TargetShip"/>
                          <event_cue_signalled/>
                        </check_any>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch2_2_Shakedown_Follow_Reminder"/>
                        <do_if value="$AceShip.distanceto.{$Ch2_TargetShip} ge 15km" comment="Move Ace in closer if she strayed away for some reason">
                          <warp object="$AceShip" sector="player.ship.sector">
                            <safepos object="player.ship" x="1km" y="-1km" z="-1km" radius="400m"/>
                          </warp>
                        </do_if>
                        <cancel_all_orders object="$AceShip"/>
                        <create_order object="$AceShip" id="'Attack'" name="$attackorder" immediate="true">
                          <param name="primarytarget" value="$Ch2_TargetShip"/>
                          <param name="allowothertargets" value="false"/>
                          <param name="pursuetargets" value="true"/>
                          <param name="checkrelation" value="false"/>
                          <param name="forceprimarytarget" value="true"/>
                          <param name="debugchance" value="$DebugChance"/>
                        </create_order>

                        <set_objective cue="$MissionCue_Ch2_CargoRobbery" action="objective.attack" step="$ObjectiveStep_2" object="$Ch2_TargetShip" updatebriefing="true"/>
                      </actions>
                      <cues>

                        <!-- Ace gives the go ahead -->
                        <cue name="Ch2_2_AceAttackCommand_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AceActor"/>
                          <param name="DelayInitial"      value="2s"/>
                          <param name="Lines"             value="$Ch2_AttackLines"/>
                          <param name="EndSignalCue"      value="null"/>
                        </cue>

                        <cue name="Ch2_2_PlayerUnderFire">
                          <conditions>
                            <event_object_attacked_object object="$Ch2_TargetShip"/>
                            <check_value value="global.$PlayerOccupiedShipGroup.indexof.{event.param}"/>
                          </conditions>
                          <cues>

                            <!-- Ace warns the player to stay out of the firing line -->
                            <cue name="Ch2_2_PlayerShipShot_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="DelayInitial"      value="3s"/>
                              <param name="Lines"             value="[[30252245]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                Stay out of the turret's line of fire!
                              -->
                            </cue>

                          </cues>
                        </cue>

                        <!--TODO: Not how robbery currently works, player cannot (yet) comm a NPC he is engaged in combat with. Might need tweaking or removing depending on final state of mechanic -->
                        <cue name="Ch2_2_AceSurrenderHint" checkinterval="1s">
                          <conditions>
                            <check_value value="$Ch2_TargetShip.hullpercentage le 25 and $Ch2_TargetShip.isoperational"/>
                            <check_value value="Ch2_2_CargoDumped.state == cuestate.waiting"/>
                          </conditions>
                          <actions>
                            <!-- Avoid Ace accidentally killing the target while the player is comming -->
                            <cancel_all_orders object="$AceShip"/>
                            <create_order object="$AceShip" id="'Follow'">
                              <param name="target" value="player.ship"/>
                            </create_order>
                          </actions>
                          <cues>

                            <!-- Ace teaches the player to ask for surrender -->
                            <cue name="Ch2_2_AceSurrenderHint_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="Lines"             value="[[30252243],[30252244]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                You have inflicted a lot of damage to the ship's hull.
                                Comm the pilot and prompt them to surrender!
                              -->
                            </cue>

                          </cues>
                        </cue>

                        <!-- TODO: This might just be a temporary solution, depending on how/if cargo piracy is reworked -->
                        <cue name="Ch2_2_ForceCargoDrop" checkinterval="1s">
                          <conditions>
                            <check_any>
                              <check_value value="$Ch2_TargetShip.hullpercentage le 30"/>
                              <check_value value="(not $Ch2_TargetShip.assignedpilot) and $Ch2_TargetShip.isoperational"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <do_if value="$Ch2_TargetShip.assignedpilot">
                              <cease_fire object="$Ch2_TargetShip" />
                              <!-- Flee select some behaviour (like fly into highway, dock-at-station, ... ) but is not guaranteed to drop anything -->
                              <create_order id="'Flee'" object="$Ch2_TargetShip">
                                <param name="method" value="'boost'"/>
                                <param name="attacker" value="player.ship"/>
                                <param name="donotdrop" value="false"/>
                                <param name="deploydistraction" value="false"/>
                                <param name="log" value="false"/>
                                <param name="debugchance" value="$DebugChance"/>
                              </create_order>
                            </do_if>
                            <!-- Guarantee drop -->
                            <do_for_each name="this.$DropWare" in="$Ch2_TargetShip.cargo.list">
                              <drop_cargo object="$Ch2_TargetShip" ware="this.$DropWare" exact="$Ch2_TargetShip.cargo.{this.$DropWare}.max"/>
                            </do_for_each>
                          </actions>
                        </cue>

                        <cue name="Ch2_2_CargoDumped">
                          <conditions>
                            <event_object_dropped_objects object="$Ch2_TargetShip"/>
                            <check_value value="$Ch2_TargetShip.isoperational"/>
                            <check_any exact="event.param.count" counter="$i">
                              <check_value value="event.param.{$i}.isclass.{class.collectablewares}"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <create_list name="$PickedUpBy"/>
                            <set_value name="$CargoDropped"/>
                            <remove_value name="$NoPlayerShipCargoSpace" comment="remove in case of multiple attempts, will set again if needed in the below cues"/>
                            <add_to_group groupname="$DroppedCargo" list="event.param"/>
                            <set_value name="$ObjectiveStep_2" operation="add" exact="1"/>
                            <set_objective cue="$MissionCue_Ch2_CargoRobbery" action="objective.pickup" step="$ObjectiveStep_2" group="$DroppedCargo" updatebriefing="true"/>
                            <do_for_each name="$DropObject" in="$DroppedCargo">
                              <debug_text text="'Changing DropPersistence for Component = %s (name=`%s` macro=%s)'.[$DropObject, $DropObject.name, $DropObject.macro]" chance="$DebugChance"/>
                              <set_drop_persistence object="$DropObject" comment="see TOA-166"/>
                            </do_for_each>
                            <set_value name="$DropTime" exact="player.age" comment="get the time to allow the player a few secs to react and cease fire before triggering the hint"/>
                            <!-- Ace also stops firing on the target -->
                            <cancel_all_orders object="$AceShip"/>
                            <create_order object="$AceShip" id="'Wait'">
                              <param name="timeout" value="0s"/>
                              <param name="holdfire" value="true"/>
                              <param name="noattackresponse" value="true"/>
                            </create_order>

                            <!--Avoid the police dropping in with awkward timing -->
                            <run_actions ref="md.LIB_Generic.RequestEntityDoNotScan">
                              <param name="RequesterCue"      value="namespace"/>
                              <param name="DoNotScanSpaces"   value="[player.entity.sector]"/>
                              <param name="AddRequest"        value="true"/>
                              <param name="DebugChance"       value="$DebugChance"/>
                            </run_actions>
                          </actions>
                          <cues>

                            <!-- The player keeps attacking the Target Ship -->
                            <cue name="Ch2_2_ContinuedAttack">
                              <conditions>
                                <event_object_attacked_object group="global.$PlayerContainerGroup" attacked="$Ch2_TargetShip"/>
                                <check_value value="$Ch2_TargetShip.exists and (player.age gt ($DropTime + 5s))" comment="Avoid Ace telling 'not kill anyone', if the ship was already destroyed"/>
                              </conditions>
                              <actions>
                                <remove_value name="$DropTime"/>
                              </actions>
                              <cues>
                                <cue name="Ch2_2_ContinuedAttack_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$AceActor"/>
                                  <param name="DelayInitial"      value="1.5s"/>
                                  <param name="Lines"             value="[[30252250]]"/>
                                  <param name="EndSignalCue"      value="null"/>
                                  <!--
                                    Now leave the pilot be. No sense in killing anyone if we are not given cause.
                                  -->
                                </cue>
                              </cues>
                            </cue>

                            <!-- Ace points out the cargo dropped and asks the player to collect it -->
                            <cue name="Ch2_2_CargoDropped_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="DelayInitial"      value="1s"/>
                              <param name="Lines"             value="[[30252248], [30252251]]"/>
                              <param name="EndSignalCue"      value="Ch2_2_PlayerShipCheck"/>
                              <!--
                                There it is! The ship dropped it's cargo!
                                Help me collect the cargo!
                              -->
                            </cue>

                            <cue name="Ch2_2_PlayerShipCheck">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <!-- Check if the player can participate when stealing cargo -->
                                <set_value name="$Container" exact="$DroppedCargo.{1}"/>
                                <do_if value="player.ship.cargo.{$Container.wares.{1}}.max lt 1">
                                  <signal_cue cue="Ch2_2_CargoSpaceHint"/>
                                </do_if>
                                <do_else>
                                  <show_help position="1" force="true" line="14321" duration="15s" comment="Fly over an item or hold $INPUT_STATE_LOOTMAGNET$ to attract it."/>
                                  <!--<signal_cue cue="Ch2_2_AceCargoInteraction"/>-->
                                </do_else>
                              </actions>
                            </cue>

                            <cue name="Ch2_2_CargoSpaceHint">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>

                                <!-- TODO:  Ace asks the player to protect the drop -->
                                <cue name="Ch2_2_SmallCargoHold_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$AceActor"/>
                                  <param name="DelayInitial"      value="1s"/>
                                  <param name="Lines"             value="[[30252252], [30252253], [30252254]]"/>
                                  <param name="EndSignalCue"      value="Ch2_2_PostHint_Flag"/>
                                  <!--
                                        Oh, your ship's storage is too small?
                                        If you are going to rob someone, make sure to bring a suitable ship next time!
                                        Then just cover me while I pick it up!
                                      -->
                                </cue>
                                <cue name="Ch2_2_PostHint_Flag">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <set_value name="$NoPlayerShipCargoSpace" exact="true"/>
                                    <!--<signal_cue cue="Ch2_2_AceCargoInteraction"/>-->
                                  </actions>
                                </cue>

                              </cues>
                            </cue>

                            <!-- 
                              ware.microchips
                              $AceShip.cargo.{ware.microchips}.max    = 142
                              $AceShip.cargo.{ware.microchips}.free   = 0
                              $AceShip.macro.name                     = 'Magpie Sentinel'
                              $AceShip.macro                          = macro.ship_tel_s_trans_container_01_b_macro
                              
                              so Ace's ship is full to the brink, can't carry enough
                            -->
                            <cue name="Ch2_2_AceCargoInteraction">
                              <delay exact="5s"/>
                              <actions>
                                <debug_text text="'Ace collecting cargo'" chance="$DebugChance"/>
                                <do_all exact="$AceShip.cargo.count" counter="$i">
                                  <drop_cargo ware="$AceShip.cargo.{$i}" object="$AceShip" exact="$AceShip.cargo.{$AceShip.cargo.{$i}}.max"/>
                                </do_all>
                                <cancel_all_orders object="$AceShip"/>
                                <!-- TODO: Once the collect order finishes (can't pick up anything), it switches to default order (and Aces flies away to... patrol) -->
                                <create_order id="'Collect'" object="$AceShip" immediate="true">
                                  <param name="targetlist" value="$DroppedCargo.list"/>
                                  <param name="noattackresponse" value="true"/>
                                  <param name="debugchance" value="$DebugChance"/>
                                </create_order>
                              </actions>
                            </cue>

                            <cue name="Ch2_2_CargoContainerDestroyed" instantiate="true">
                              <conditions>
                                <check_any>
                                  <event_object_collected_ware object="$AceShip"/>
                                  <event_object_collected_ware group="global.$PlayerContainerGroup"/>
                                </check_any>
                                <check_value value="$DroppedCargo.indexof.{event.param3}"/>
                              </conditions>
                              <actions>
                                <do_if value="event.object.isplayerowned">
                                  <append_to_list name="$PickedUpBy" exact="'player'"/>
                                  <debug_text text="'Player picked up container %s'.[$PickedUpBy]" chance="$DebugChance"/>
                                </do_if>
                                <do_elseif value="event.object == $AceShip">
                                  <append_to_list name="$PickedUpBy" exact="'ace'"/>
                                  <debug_text text="'Ace picked up container %s'.[$PickedUpBy]" chance="$DebugChance"/>
                                  <do_if value="$NoPlayerShipCargoSpace?" comment="Ace picked up what she could, player has no cargospace -> we're done">
                                    <signal_cue cue="Ch2_2_Completed_v2"/>
                                  </do_if>
                                </do_elseif>
                                <do_if value="$PickedUpBy.count ge 2 or $NoPlayerShipCargoSpace?">
                                  <signal_cue cue="Ch2_2_Completed_v2" comment="TODO: Find a better way to check for pickups"/>
                                  <debug_text text="'ContainerDestroyed Other %s %s'.[$PickedUpBy, $NoPlayerShipCargoSpace?]" chance="$DebugChance"/>
                                </do_if>
                              </actions>
                            </cue>

                            <cue name="Ch2_2_ForcedContinue">
                              <delay exact="4min"/>
                              <actions>
                                <!-- To avoid blocking progress, continue after a generous amount of time even if no one picked up any cargo -->
                                <signal_cue cue="Ch2_2_Completed_v2"/>
                              </actions>
                            </cue>

                            <cue name="Ch2_2_CargoDestroyed">
                              <conditions>
                                <event_object_destroyed group="$DroppedCargo"/>
                                <check_value value="$DroppedCargo.count == 1"/>
                                <!--check_value value="$DroppedCargo.count == 1 and event.param2 != killmethod.collected and not $PickedUpBy.count" comment="Neither the player nor Ace picked up any cargo before it was destroyed"/-->
                              </conditions>
                              <actions>
                                <do_if value="$PickedUpBy.count" comment="If either Ace of Player picked up at least partially -> success">
                                  <signal_cue cue="Ch2_2_Completed_v2"/>
                                </do_if>
                                <do_else>
                                  <!-- No cargo remaining and neither Player nor Ace picked up a single container, back to scanning ships -->
                                  <set_value name="$ResetVoiceline" exact="[[30252249],[30252247]]" comment="'The cargo was destroyed.' 'Try looking for another ship!'"/>
                                  <signal_cue_instantly cue="Ch2_2_ShipDestructionReset" param="$ResetVoiceline"/>
                                  <reset_cue cue="Ch2_2_ScanningShips"/>
                                  <reset_cue cue="Ch2_2_Shakedown"/>
                                </do_else>
                              </actions>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch2_2_Completed_v2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$Ch2_TargetShip.assignedpilot and $Ch2_TargetShip.owner != faction.player">
                      <cancel_all_orders object="$Ch2_TargetShip"/>
                      <create_order object="$Ch2_TargetShip" id="'MoveDie'" immediate="true">
                        <param name="mintime" value="60s" comment="stay alive for specified time, after it docks"/>
                      </create_order>
                    </do_if>

                    <!-- remove the DoNotScanRequest again -->
                    <run_actions ref="md.LIB_Generic.RequestEntityDoNotScan">
                      <param name="RequesterCue"      value="namespace"/>
                      <param name="AddRequest"        value="false"/>
                      <param name="DebugChance"       value="$DebugChance"/>
                    </run_actions>

                    <cancel_cue cue="Ch2_2_Shakedown" comment="guarantee remainign containers won't reset the mission back to start"/>
                    <remove_from_list name="$Ch2_Missions" exact="$MissionCue_Ch2_CargoRobbery"/>
                    <remove_mission cue="$MissionCue_Ch2_CargoRobbery" type="completed"/>
                  </actions>
                  <cues>

                    <cue name="Ch2_AceOrders_v2">
                      <actions>
                        <!-- Ace returns to the AE -->
                        <do_if value="true">
                          <create_order id="'AssignCommander'" object="$AceShip" immediate="true">
                            <param name="commander" value="$RaiderHubShip"/>
                            <param name="assignment" value="assignment.defence"/>
                            <param name="cancelorders" value="true"/>
                            <param name="debugchance" value="$DebugChance"/>
                          </create_order>
                        </do_if>
                        <do_else>
                          <create_order id="'DockAndWait'" object="$AceShip" default="true" comment="stay docked">
                            <param name="destination" value="$RaiderHubShip" />
                            <param name="debugchance" value="$DebugChance"/>
                          </create_order>
                        </do_else>
                      </actions>
                    </cue>

                    <!-- Ace debriefs the player  -->
                    <cue name="Ch2_CargoRobberyFinished_Ref_v2" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$AceActor"/>
                      <param name="DelayInitial"      value="8s"/>
                      <param name="Lines"             value="[[30252255], [30252256], [if $PickedUpBy.indexof.{'player'} then 30252257 else null], [30252258]]"/>
                      <param name="EndSignalCue"      value="Ch2_FinishCheck" comment="All 3 submissions in Ch2 completed?"/>
                      <!--
                            Okay, we got what we needed. Let us depart!
                            I will return the booty to the Arcadian Endeavour.
                            Feel free to keep whatever you gathered as your cut.
                            Good work, Chipmunk!
                          -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch2_2_ShipDestructionReset" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <!-- Ace tells you to find another ship -->
                    <cue name="Ch2_2_AceReset_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$AceActor"/>
                      <param name="DelayInitial"      value="1s"/>
                      <param name="Lines"             value="$ResetVoiceline"/>
                      <param name="EndSignalCue"      value="Ch2_2_ResetSignal"/>
                    </cue>

                    <cue name="Ch2_2_ResetSignal">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep_2" exact="4"/>
                        <set_objective_from_briefing cue="$MissionCue_Ch2_CargoRobbery" step="$ObjectiveStep_2"/>
                        <signal_cue cue="Ch2_2_ScanningShips"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch2_3_HackStation">
              <conditions>
                <event_cue_completed cue="Ch2_Mission_Setup"/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep_3" exact="1"/>
                <set_value name="$MissionCue_Ch2_HackStation" exact="this"/>

                <create_mission cue="$MissionCue_Ch2_HackStation" name="{30252,2401}" description="{30252,2402}" rewardtext="{30252,2420}" type="missiontype.plot" faction="faction.civilian" difficulty="level.medium" abortable="false" icon="'briefing_axiom_01'" iconcaption="$AxiomActor.knownname" missionthread="$MissionCue" activate="false">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$AxiomActor" text="$AxiomActor.name"/>
                  </briefing>
                </create_mission>
                <set_objective_from_briefing cue="$MissionCue_Ch2_HackStation" step="$ObjectiveStep_3"/>

              </actions>
              <cues>

                <cue name="Ch2_3_Axiom_Conversation" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$AxiomActor"/>
                      <event_conversation_next_section actor="$AxiomActor" section="conv_questions"/>
                      <event_conversation_next_section actor="$AxiomActor" section="conv_continue"/>
                      <event_conversation_next_section actor="$AxiomActor" section="conv_decline"/>
                    </check_any>
                  </conditions>
                  <actions>

                    <debug_text text="'e.name=%s e.param=%s param2=%s'.[event.name, event.param, event.param2]" chance="0"/>

                    <do_if value="event.name == 'event_conversation_started'">
                      <allow_conversation_escape enabled="false"/>
                      <do_if value="not $Ch2_InitialAxiomConversation?">
                        <do_if value="player.module == 'x4ep1_gamestart_pirate2'">
                          <!-- Dialogue recognising Prison escape -->
                          <do_if value="md.GS_Pirate2.Start.$EscapeWithoutAxiom?">
                            <add_npc_line speaker="$AxiomActor" hidechoices="true">
                              <text line="30288146" comment="Surprised to see me, chosen one?"/>
                              <text line="30288147" comment="Well, as old Bashra used to say, our three-dimensional reality is a prison, and I'm its... I'm... eh, whatever."/>
                              <text line="30288148" comment="(3/3, deadpan)I ended up bribing a guard."/>
                              <text line="30252210" comment="Are you ready to have bestowed upon you, the divine knowledge of taking a station for all it is worth?"/>
                            </add_npc_line>
                          </do_if>
                          <do_else>
                            <do_if value="$Ch1_SmuggleCaught?">
                              <!-- add a jab at the player getting caught smuggling space weed -->
                              <add_npc_line speaker="$AxiomActor" hidechoices="true">
                                <text line="30252201" comment="There he is, my former cellmate! The chosen one!"/>
                                <text line="30252202" comment="t's good to see you have recovered from our arduous escape!"/>
                                <text line="30252206" comment="The Maestro said you performed well on your first smuggling run."/>
                                <text line="30252207" comment="Despite your most unfortunate run-in with the law."/>
                                <text line="if player.entity.race != race.paranid then 30252208 else 30252209" comment="That bodes well for the task at hand, my two-eyed apprentice!/That bodes well for the task at hand, my three-eyed apprentice!"/>
                                <text line="30252210" comment="Are you ready to have bestowed upon you, the divine knowledge of taking a station for all it is worth?"/>
                              </add_npc_line>
                            </do_if>
                            <do_else>
                              <add_npc_line speaker="$AxiomActor" hidechoices="true">
                                <text line="30252201" comment="There he is, my former cellmate! The chosen one!"/>
                                <text line="30252202" comment="t's good to see you have recovered from our arduous escape!"/>
                                <text line="30252206" comment="The Maestro said you performed well on your first smuggling run."/>
                                <text line="if player.entity.race != race.paranid then 30252208 else 30252209" comment="That bodes well for the task at hand, my two-eyed apprentice!/That bodes well for the task at hand, my three-eyed apprentice!"/>
                                <text line="30252210" comment="Are you ready to have bestowed upon you, the divine knowledge of taking a station for all it is worth?"/>
                              </add_npc_line>
                            </do_else>
                          </do_else>
                          <add_player_choice text="{30252,30252204}" section="conv_questions" comment="Hold on - What's with the 'chosen one/golden ticket'?" position="top_left"/>
                        </do_if>
                        <do_else>

                          <add_npc_line speaker="$AxiomActor" hidechoices="true">
                            <text line="30252203" comment="Ah, you must be the newest member of the Empyrean Curs! I am most pleased to make your acquaintance, fellow Cur!"/>
                            <text line="30252204" comment="I am the Axiom, but you can just call me Axiom! I'm called upon whenever the Maestro needs access to secured systems."/>
                            <text line="30252205" comment="Men of lesser understanding might call me a 'hacker', but I prefer the term 'Counter-Security Specialist'!"/>
                            <text line="30252206" comment="The Maestro said you performed well on your first smuggling run."/>
                            <text line="30252207" comment="Despite your most unfortunate run-in with the law."/>
                            <text line="if player.entity.race != race.paranid then 30252208 else 30252209" comment="That bodes well for the task at hand, my two-eyed apprentice!/That bodes well for the task at hand, my three-eyed apprentice!"/>
                            <text line="30252210" comment="Are you ready to have bestowed upon you the divine knowledge of taking a station for all it is worth?"/>
                          </add_npc_line>

                        </do_else>

                        <add_player_choice text="{30252,30252102}" section="conv_decline" comment="Not right now" position="bottom_left"/>
                        <add_player_choice text="{30252,30252205}" section="conv_continue" comment="Let's get hacking!" position="bottom_right" highlighted="true"/>
                        <set_value name="$Ch2_InitialAxiomConversation"/>
                      </do_if>
                      <do_elseif value="not $Ch2_AxiomHacking?">
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252210" comment="Are you ready to have bestowed upon you, the divine knowledge of taking a station for all it is worth?"/>
                        </add_npc_line>

                        <add_player_choice text="{30252,30252102}" section="conv_decline" comment="Not right now" position="bottom_left" highlighted="true"/>
                        <add_player_choice text="{30252,30252205}" section="conv_continue" comment="Let's get hacking!" position="bottom_right" highlighted="true"/>
                      </do_elseif>
                      <do_else>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252243" comment="Hast thou not yet seen to all the tasks appointed to you by the Maestro? Well, you probably ..."/>
                        </add_npc_line>
                      </do_else>
                    </do_if>
                    <do_else>

                      <do_if value="event.param == 'conv_questions'">
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252211" comment="Ah, yes... That was merely a ploy to get your attention!"/>
                          <text line="30252212" comment="I figured I would spin a yarn to get you animated, and invested in helping me break out."/>
                          <text line="30252213" comment="May the threepointedness forgive me for my transgression!"/>
                          <text line="30252214" comment="The boring truth is that breaking out of the prison was always part of the Maestro's plan to scout that station."/>
                          <text line="30252215" comment="I was to gather intelligence from the deepest bowels of the station, where it would be impossible to not get caught going in."/>
                          <text line="30252216" comment="The Maestro, quite creatively, figured that breaking out of jail would be safer bet, than to not get caught at all, and accounted for that."/>
                          <text line="30252217" comment="Due to a slight miscommunication, however, I was placed in the wrong cell!"/>
                          <text line="30252218" comment="And there I would have stayed, rotting away, if it weren't for the... well, chosen one who was put in the cell meant for me. Some luck."/>
                        </add_npc_line>
                      </do_if>
                      <do_elseif value="event.param == 'conv_decline'">
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252501" comment="Blessings"/>
                        </add_npc_line>
                      </do_elseif>
                      <do_elseif value="event.param == 'conv_continue'">
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252219" comment="Very well then, apprentice!"/>
                          <text line="30252220" comment="To access a station's security always requires a security device of some sort. Usually crafted out of three different materials!"/>
                        </add_npc_line>
                        <set_value name="$Ch2_AxiomHacking" exact="true"/>
                      </do_elseif>
                    </do_else>

                  </actions>
                  <cues>
                    <cue name="Ch2_3_Axiom_Conversation_Ended">
                      <conditions>
                        <event_conversation_finished actor="$AxiomActor"/>
                        <check_value value="$Ch2_AxiomHacking?"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch2_3_Axiom_Finished" check="false" comment="could already have fired with _line_finished 30252220"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_3_Axiom_Finished">
                  <conditions>
                    <check_any>
                      <event_cue_signalled comment="reliable, Axiom conversation finished and Axiom spoke about hacking"/>
                      <event_speak_line_finished actor="$AxiomActor" line="30252220" comment="unreliable"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="(player.entity.inventory.{ware.inv_securitydecryptionsystem}.count ge 1)">
                      <set_value name="$AlreadyOwnsHackdevice"/>
                      <signal_cue cue="Ch2_3_AxiomMaterialSkip"/>
                    </do_if>
                    <do_elseif value="(player.entity.inventory.{ware.inv_agidevice_02}.count ge 5) and (player.entity.inventory.{ware.inv_decryptionmodule}.count ge 1) and (player.entity.inventory.{ware.inv_interfaceunit}.count ge 1)">
                      <set_value name="$OwnsRecipeItems"/>
                      <signal_cue cue="Ch2_3_AcquireMaterials"/>
                    </do_elseif>
                    <do_else>
                      <signal_cue cue="Ch2_3_AcquireMaterials"/>
                    </do_else>
                    <activate_mission cue="$MissionCue_Ch2_HackStation"/>
                  </actions>
                </cue>

                <cue name="Ch2_3_Axiom_Decryption_DEBUG">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Note that Ch2_3_SlicerCrafted is signalled by add_inventory and it would signal the story to continue, but RML_Collect_Inventory 
                      would still listen to event_inventory_added/removed and mess up the objectives, so it's important Ch2_3_AcquireMaterials is cancelled" -->
                    <add_inventory entity="player.entity" ware="ware.inv_securitydecryptionsystem" exact="3"/>
                  </actions>
                  <delay exact="1s"/>
                  <actions>
                  </actions>
                </cue>

                <cue name="Ch2_3_Axiom_CraftingParts_DEBUG">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <add_inventory entity="player.entity" ware="ware.inv_agidevice_02" exact="5"/>
                    <add_inventory entity="player.entity" ware="ware.inv_decryptionmodule" exact="1"/>
                    <add_inventory entity="player.entity" ware="ware.inv_interfaceunit" exact="1"/>
                  </actions>
                </cue>

                <cue name="Ch2_3_AxiomMaterialSkip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch2_3_AcquireMaterials" comment="Already have the securitydecryptionsystem, avoid this from triggering if the player coincidentally gathers them parts later on"/>
                  </actions>
                  <cues>
                    <!--Axiom skips the Slicer acquisition -->
                    <cue name="Ch2_3_SkipToHack_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$AxiomActor"/>
                      <param name="DelayInitial"      value="1s"/>
                      <param name="Lines"             value="[[30252223]]"/>
                      <param name="Cutscene"          value="[$AxiomActor.room != player.room]" comment="no eventmonitor-scene, if player standing next to Axiom"/>
                      <param name="EndSignalCue"      value="Ch2_3_Hack"/>
                      <!--
                        What is that...? You're carrying a Security Decryption System already? Look at you coming well prepared!
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_3_AcquireMaterials">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep_3" operation="add" exact="1"/>
                    <set_value name="$InventoryTable" exact="table[{ware.inv_agidevice_02} = 5, {ware.inv_decryptionmodule} = 1, {ware.inv_interfaceunit} = 1]"/>
                  </actions>
                  <cues>

                    <cue name="Ch2_3_AcquireWares_Ref" ref="md.RML_Collect_Inventory.CollectInventory" comment="autocompletes if player already has all wares">
                      <param name="EndSignalCue" value="Ch2_3_CraftItemsAcquired"/>
                      <param name="MissionCue" value="$MissionCue_Ch2_HackStation"/>
                      <param name="StartStep" value="$ObjectiveStep_3"/>
                      <param name="Objective" value="objective.acquire_ware"/>
                      <param name="WaresParam" value="$InventoryTable"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </cue>

                    <cue name="Ch2_3_CraftItemsAcquired">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep_3" exact="4"/>
                      </actions>
                      <cues>

                        <cue name="Ch2_3_SelectStation_v2">
                          <actions>
                            <find_station name="$Ch2_3_CloseStation" active="true" space="player.sector" sortbydistanceto="player.entity" excluded="$Ch2_ExcludedStations">
                              <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                              <match_relation_to faction="faction.player" relation="dock"/>
                              <match trueowner="[faction.player]" negate="true"/>
                            </find_station>
                            <do_if value="not $Ch2_3_CloseStation.exists" comment="fallback">
                              <find_station name="$Ch2_3_CloseStation" active="true" space="player.galaxy" sortbygatedistanceto="player.entity" excluded="$Ch2_ExcludedStations">
                                <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                                <match_relation_to faction="faction.player" relation="dock"/>
                                <match trueowner="[faction.player]" negate="true"/>
                              </find_station>
                            </do_if>

                            <do_if value="$Ch2_3_CloseStation.sector.owner != faction.ownerless">
                              <do_if value="player.entity.inventory.illegalto.{$Ch2_3_CloseStation.sector.policefaction}">
                                <set_value name="$Ch2_3_isIllegal"/>
                              </do_if>
                            </do_if>
                            <add_to_group groupname="$Ch2_ExcludedStations" object="$Ch2_3_CloseStation"/>
                            <set_value name="$ObjectiveStep_3" operation="add" exact="1"/>
                            <set_objective cue="$MissionCue_Ch2_HackStation" step="$ObjectiveStep_3" action="objective.craft" object="$Ch2_3_CloseStation" text="{20201,11301}" updatebriefing="true"/>
                            <signal_cue cue="Ch2_3_Crafting"/>
                            <signal_cue cue="Ch2_3_AxiomSpeaks"/>
                          </actions>
                          <cues>
                            <cue name="Ch2_3_SelectStation_Destroyed_v2" version="2">
                              <conditions>
                                <event_object_destroyed object="$Ch2_3_CloseStation"/>
                                <check_value value="Ch2_3_SlicerCrafted.state != cuestate.complete" comment="ignore, if player already crafted the item"/>
                              </conditions>
                              <actions>
                                <reset_cue cue="Ch2_3_Crafting"/>
                                <reset_cue cue="Ch2_3_SelectStation_v2"/>
                                <signal_cue cue="Ch2_3_SelectStation_v2"/>
                              </actions>
                              <patch sinceversion="2" state="waiting">
                                <do_if value="(not $Ch2_3_CloseStation.exists) and (Ch2_3_SlicerCrafted.state != cuestate.complete)">
                                  <reset_cue cue="Ch2_3_Crafting"/>
                                  <reset_cue cue="Ch2_3_SelectStation_v2"/>
                                  <signal_cue cue="Ch2_3_SelectStation_v2"/>
                                </do_if>
                              </patch>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch2_3_AxiomSpeaks">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <!-- Axiom points towards crafting bench -->
                            <cue name="Ch2_3_PointTowardsBench_Ref_v2" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$AxiomActor"/>
                              <param name="DelayInitial"      value="1s"/>
                              <param name="Lines"             value="[[ if $OwnsRecipeItems? then 30252222 else 30252221], [30252224], [if player.entity.hascontext.{$Ch2_3_CloseStation} then null else 30252225 ], [if $Ch2_3_isIllegal? then 30252226 else null]]"/>
                              <param name="Cutscene"          value="[$AxiomActor.room != player.room]" comment="no eventmonitor-scene, if player standing next to Axiom and already had all required items"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                Excellent! You managed to gather all three of the elements required to assemble a Security Decryption System?/I can see you are already carrying all the items required to craft a Security Decryption System on you!
                                You can craft inventory items at Crafting Bench, which you can find at a station's trade corner.
                                I took the liberty of setting the closest station as your destination.
                                But apprentice, be wary of patrols! The closest station is planted firmly in law-abiding waters!
                               -->
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch2_3_Crafting">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>


                        <cue name="Ch2_3_OnStationCheck_v2" onfail="cancel">
                          <conditions>
                            <check_value value="player.entity.hascontext.{$Ch2_3_CloseStation}"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch2_3_ObjectiveCraftingBench2"/>
                          </actions>
                        </cue>

                        <cue name="Ch2_3_ObjectiveCraftingBench2">
                          <conditions>
                            <check_any>
                              <check_all>
                                <event_object_docked_at container="$Ch2_3_CloseStation"/>
                                <check_value value="event.param == player.ship"/>
                              </check_all>
                              <check_all>
                                <event_object_changed_object object="player.entity" newobject="$Ch2_3_CloseStation"/>
                              </check_all>
                              <event_cue_signalled/>
                            </check_any>
                          </conditions>
                          <actions>
                            <do_if value="true">
                              <find_room name="$Trader_room" object="$Ch2_3_CloseStation" multiple="false" macro="macro.corner_arg_standard_inventorytrader_01_macro"/>
                              <!--create_position name="$BenchOffset" space="$Trader_room" x="-3.67m" z=" 0.03m" y="6.71m"/-->
                              <create_position name="$BenchOffset" space="$Trader_room"  x="-2.733m" y="5.685m" z="6.297m"/>
                              <assert value="$Trader_room.exists" text="'Trader room not found?!'"/>
                            </do_if>
                            <do_else>
                              <find_object_component name="$traders" object="$Ch2_3_CloseStation" entitytype="entitytype.trader" multiple="true" comment="find trader-room via trader"/>
                              <do_if value="$traders.count">
                                <set_value name="$SelectedTrader" exact="$traders.random"/>
                                <set_value name="$Trader_room" exact="$SelectedTrader.room"/>
                              </do_if>
                              <do_if value="$Trader_room.macro == macro.corner_arg_standard_inventorytrader_01_macro" comment="in this specific room, the bench is at these coordinates">
                                <!--create_position name="$BenchOffset" space="$Trader_room" x="-3.67m" z=" 0.03m" y="6.71m"/-->
                                <create_position name="$BenchOffset" space="$Trader_room"  x="-2.733m" y="5.685m" z="6.297m"/>
                              </do_if>
                              <do_else>
                                <create_position name="$BenchOffset" space="$Trader_room" x="0m" z=" 0m" y="0m"/>
                              </do_else>
                            </do_else>
                            <set_objective cue="$MissionCue_Ch2_HackStation" step="$ObjectiveStep_3"  object="$Trader_room" offset="$BenchOffset" action="objective.craft" text="{20201,11301}" comment="Craft: Security Decryption System"/>
                          </actions>
                          <cues>

                            <cue name="Ch2_3_LeftStation_v2" checkinterval="5s">
                              <conditions>
                                <check_value value="not player.entity.hascontext.{$Ch2_3_CloseStation}"/>
                              </conditions>
                              <actions>
                                <set_objective cue="$MissionCue_Ch2_HackStation" step="$ObjectiveStep_3" action="objective.craft" object="$Ch2_3_CloseStation" text="{20201,11301}"/>
                                <reset_cue cue="Ch2_3_ObjectiveCraftingBench2"/>
                              </actions>
                            </cue>

                            <cue name="Ch2_3_OpenedCraftingMenu" instantiate="true">
                              <conditions>
                                <event_ui_triggered screen="'CraftingMenu'" control="''"/>
                              </conditions>
                              <actions>
                                <speak actor="$AxiomActor" line="30252244" broadcast="true" caninterrupt="true" comment="It is the Security Decryption System! Ignore the other items for now!"/>
                              </actions>
                            </cue>

                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch2_3_SlicerCrafted" version="2" comment="not instantiated, cue will only complete if a inv_securitydecryptionsystem was added (otherwise it keeps triggering!)">
                      <conditions>
                        <event_inventory_added object="player.entity"/>
                        <check_value value="event.param.{ware.inv_securitydecryptionsystem}?"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch2_3_SelectStation_v2"/>
                        <cancel_cue cue="Ch2_3_Crafting"/>
                        <set_objective cue="$MissionCue_Ch2_HackStation" action="objective.wait" comment="wait, during Axioms dialog"/>
                        <do_if value="$ObjectiveStep_3 lt 4">
                          <set_value name="$ObjectiveStep_3" exact="4"/>
                        </do_if>
                      </actions>
                      <patch sinceversion="2" state="complete">
                        <cancel_cue cue="Ch2_3_SelectStation_v2"/>
                      </patch>
                      <cues>

                        <cue name="Ch2_3_ReceivedHackingThings_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="DelayInitial"      value="1s"/>
                          <param name="Lines"             value="[[30252227],[30252228],[30252229, 1s],[30252230],]"/>
                          <param name="EndSignalCue"      value="Ch2_3_Hack"/>
                          <!--
                            Our next objective is to infiltrate a station which is worth hacking. Something that is producing wares of value.
                            The Maestro has already let me know which wares we require, so I took the liberty of identifying a suitable station for you to infiltrate.
                            And by infiltrate, I mean dock at. No need to be making things harder on yourself than they have to be!
                            But if you ever want to hack a station which won't allow you to dock, you can always make your way aboard a ship heading their way and circumvent that station's docking security that way.
                          -->
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch2_3_Hack">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch2_3_AcquireMaterials" comment="Avoid continuing with finding crafting parts, once we are in the 'hack' phase"/>
                    <set_value name="$ObjectiveStep_3" operation="add" exact="1"/>
                  </actions>
                  <cues>

                    <cue name="Ch2_3_FindStation" version="3">
                      <actions>
                        <find_station name="$PotentialHackStations" sortbygatedistanceto="$RaiderHubShip" space="player.galaxy" sortlimit="8" functional="true" multiple="true" excluded="$Ch2_ExcludedStations">
                          <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                          <match_relation_to faction="faction.player" relation="dock"/>
                          <match_products wares="[ware.quantumtubes, ware.microchips, ware.antimatterconverters]"/>
                          <match trueowner="[faction.player]" negate="true"/>
                        </find_station>
                        <set_value name="$LowestTravelTime" exact="1h"/>
                        <do_all exact="$PotentialHackStations.count" counter="$i">
                          <estimate_travel_time result="$EstimatedTravelTime" start="$PotentialHackStations.{$i}" ship="$RaiderHubShip" target="$RaiderHubShip"/>
                          <do_if value="$EstimatedTravelTime lt $LowestTravelTime">
                            <set_value name="$HackStation" exact="$PotentialHackStations.{$i}"/>
                            <set_value name="$LowestTravelTime" exact="$EstimatedTravelTime"/>
                          </do_if>
                        </do_all>
                        <remove_value name="$PotentialHackStations"/>
                        <do_if value="not $HackStation.exists">
                          <debug_text text="'No suitable station to hack found creating one'" chance="$DebugChance"/>
                          <create_station name="$NewHackStation" macro="macro.station_gen_factory_base_01_macro" owner="faction.teladi" sector="$18Bil_Sector" state="componentstate.operational" constructionplan="'tel_equipmentdock'">
                            <safepos x="250km" z="-200km" space="$18Bil_Sector"/>
                          </create_station>
                          <signal_objects object="player.galaxy" param="'init station'" param2="$NewHackStation" param3="false"/>
                          <add_cargo object="$NewHackStation" ware="ware.advancedcomposites" exact="98"/>
                          <add_cargo object="$NewHackStation" ware="ware.hullparts" exact="11000"/>
                          <add_cargo object="$NewHackStation" ware="ware.weaponcomponents" exact="1800"/>
                          <set_value name="$HackStation" exact="$NewHackStation"/>
                        </do_if>
                        <do_else>
                          <debug_text text="'shortest travel time: ' +  $LowestTravelTime + ' Station: ' + $HackStation.knownname" chance="$DebugChance"/>
                        </do_else>
                        <!--run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                          <param name="Object" value="$HackStation"/>
                          <param name="RequesterCue" value="Ch2_3_Hack"/>
                          <param name="DebugChance" value="$DebugChance"/>
                        </run_actions-->
                        <add_to_group groupname="$Ch2_ExcludedStations" object="$HackStation"/>
                        <set_objective cue="$MissionCue_Ch2_HackStation" step="$ObjectiveStep_3" action="objective.flyto" object="$HackStation" updatebriefing="true"/>

                      </actions>
                      <patch sinceversion="3">
                        <do_for_each name="$station" in="$HackPanelTargetsGroup">
                          <do_if value="$station.isplayerowned">
                            <clear_group group="$HackPanelTargetsGroup"/>
                            <reset_cue cue="Ch2_3_FindStation"/>
                            <reset_cue cue="Ch2_3_ProceedToHack"/>
                            <break/>
                          </do_if>
                        </do_for_each>
                      </patch>
                      <cues>
                        <cue name="Ch2_3_StationDestroyed">
                          <conditions>
                            <event_object_destroyed object="$HackStation"/>
                          </conditions>
                          <actions>
                            <reset_cue cue="Ch2_3_FindStation"/>
                            <reset_cue cue="Ch2_3_ProceedToHack"/>
                          </actions>
                        </cue>
                        <cue name="Ch2_3_RaiderHub_Approach_Order">
                          <actions>
                            <get_safe_pos result="$Ch2_3_WaitingPos" object="$HackStation" sector="$HackStation.sector" min="1km" max="2km"/>
                            <cancel_all_orders object="$RaiderHubShip"/>
                            <create_order object="$RaiderHubShip" id="'MoveWait'" immediate="true">
                              <param name="destination" value="[$HackStation.sector, $Ch2_3_WaitingPos]"/>
                              <param name="debugchance" value="$DebugChance"/>
                            </create_order>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch2_3_ProceedToHack">
                      <actions>
                        <find_room name="$PotentialHackRooms" object="$HackStation" roomtype="roomtype.security" multiple="true" />
                        <do_all exact="$PotentialHackRooms.count" counter="$r">
                          <set_dynamic_interior_private object="$HackStation" room="$PotentialHackRooms.{$r}" private="true"/>
                          <debug_text text="'Setting room `%s` to private'.[$PotentialHackRooms.{$r}]" chance="$DebugChance"/>
                        </do_all>
                        <add_to_group groupname="$HackPanelTargetsGroup" object="$HackStation" comment="RML_Hack_Object expects Targets_Param as a group"/>
                      </actions>
                      <cues>

                        <!--cue name="Ch2_3_FindAE_DEBUG">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_objective cue="$MissionCue_Ch2_HackStation" step="$ObjectiveStep_1" action="objective.dockat" object="$RaiderHubShip" updatebriefing="true"/>
                          </actions>
                        </cue-->

                        <cue name="Ch2_3_PlayerDocked_HackStation">
                          <conditions>
                            <event_object_docked_at container="$HackStation" />
                            <check_value value="global.$PlayerContainerGroup.indexof.{event.param}"/>
                          </conditions>
                          <cues>

                            <cue name="Ch2_3_Axiom_DockedAtStation_Ref" ref="md.LIB_Dialog.Speak_Actors">
                              <param name="Actor"             value="[$AxiomActor, $MaestroActor]"/>
                              <param name="Lines"             value="[[[30252231]],[[30252250]]]"/>
                              <param name="EndSignalCue"      value="[null, Ch2_3_RaiderHub_InPosition]"/>
                              <!--
                              Axiom:
                                Splendid! Now make your way into the  Engineering Section without attracting too much attention!
                              Maestro:
                                Can confirm Arcadian Endeavour is close by. Ready to grab spoils!
                              -->
                            </cue>

                            <cue name="Ch2_3_RaiderHub_InPosition">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <do_if value="$RaiderHubShip.distanceto.{[$HackStation.sector,$Ch2_3_WaitingPos]} gt 15km" comment="If AE is too far away, help out a bit">
                                  <debug_text text="'RaiderHub too far, warping to %s %s'.[$HackStation.sector.macro.name, $Ch2_3_WaitingPos]" chance="$DebugChance"/>
                                  <warp object="$RaiderHubShip" sector="$HackStation.sector">
                                    <safepos value="$Ch2_3_WaitingPos" min="1km" max="4km" />
                                  </warp>
                                </do_if>
                              </actions>
                            </cue>

                            <cue name="Ch2_3_InSecurityOffice" checkinterval="1s">
                              <conditions>
                                <check_value value="player.entity.hascontext.{$HackStation} and (player.entity.room.type == roomtype.infrastructure)"/>
                              </conditions>
                              <cues>

                                <cue name="Ch2_Axiom_InSecurityRoom_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$AxiomActor"/>
                                  <param name="Lines"             value="[[30252232], [30252233]]"/>
                                  <param name="EndSignalCue"      value="null"/>
                                  <!--
                                    Look for a terminal marked "Storage System Control Panel" and insert the Security Decryption System.
                                    These hacking devices are one-use only, so make sure you hack the correct terminal.
                                  -->
                                </cue>

                              </cues>
                            </cue>

                          </cues>
                        </cue>

                        <!-- Trigger the RML, which will check the win/lose conditions and report back -->
                        <cue name="Ch2_3_HackPanel_Ref" ref="md.RML_Hack_Object.HackObjects">
                          <!-- always pass these -->
                          <param name="EndSignalCue"      value="Ch2_3_Station_Hacked_v2"/>
                          <param name="MissionCue"        value="$MissionCue_Ch2_HackStation"/>
                          <param name="StartStep"         value="$ObjectiveStep_3" comment="Briefing step to start the mission on"/>
                          <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                          <param name="DebugChance"       value="$DebugChance"/>
                          <param name="Targets_Param"     value="$HackPanelTargetsGroup"/>
                          <param name="PanelType"         value="controlpaneltype.hack_storage"/>
                        </cue>

                        <cue name="Ch2_3_HackWarning_Signal">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch2_3_HackWarning" onfail="cancel">
                              <cues>
                                <cue name="Ch2_Axiom_WrongPanel_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$AxiomActor"/>
                                  <param name="Lines"             value="[[30252234]]"/>
                                  <param name="EndSignalCue"      value="Ch2_3_HackWarning_Reset"/>
                                  <!--
                                    Apprentice, that was not the right panel. We need to hack the storage!
                                  -->
                                </cue>
                              </cues>
                            </cue>
                            <cue name="Ch2_3_HackWarning_Reset">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <delay exact="60s"/>
                              <actions>
                                <reset_cue cue="Ch2_3_HackWarning_Signal"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>


                        <cue name="Ch2_3_Hacked" instantiate="true" comment="we check in parallel with the RML, to see if containers dropped because of the player-hack (event_object_dropped_objects can't filter for 'reason')">
                          <conditions>
                            <event_player_hacked_object/>
                            <!--debug_text text="'Hacked: %s(%s) Hacker:%s Controlpanel-Type:%s'.[event.param, event.param.knownname, event.param2, event.param3]"/-->
                            <check_value value="(player.entity.hascontext.{$HackStation}) and ((event.param.container == $HackStation) or (event.param == $HackStation))"/>
                          </conditions>
                          <actions>
                            <do_if value="(event.param3 == controlpaneltype.hack_storage)">
                              <set_value name="$Ch2_StorageHacked" exact="true"/>
                              <debug_text text="'ObserveCargo'" chance="$DebugChance"/>
                              <cancel_cue cue="Ch2_3_HackWarning_Signal"/>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Ch2_3_HackWarning_Signal" check="false"/>
                            </do_else>
                          </actions>
                          <cues>
                            <cue name="Ch2_3_PickUpCargo_v2">
                              <conditions>
                                <event_object_dropped_objects object="$HackStation" comment="No way to filter for 'dropped-reason', so parent-cue checking for event_player_hacked_object"/>
                                <check_value value="$Ch2_StorageHacked?"/>
                              </conditions>
                              <actions>
                                <add_to_group groupname="$PickupGroup" list="event.param"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch2_3_Station_Hacked_v2" comment="signalled by md.RML_Hack_Object.HackObjects">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="this.$EndFeedbackValue ge 1">
                              <set_value name="$SignalStation" exact="$HackStation"/>
                              <do_if value="$PotentialHackRooms?">
                                <do_all exact="$PotentialHackRooms.count" counter="$r">
                                  <set_dynamic_interior_private object="$SignalStation" room="$PotentialHackRooms.{$r}" private="false"/>
                                </do_all>
                              </do_if>
                              <cancel_cue cue="Ch2_3_StationDestroyed" comment="Ignore station destruction from this point (containers dropped, success, irrelevant of wether player/AE actually picks up any containers)"/>
                              <signal_cue cue="Ch2_3_PickupAndReturnToS1a"/>
                            </do_if>
                            <do_else>
                              <assert value="false" text="'Ch2_3_HackPanel_Ref failed, this should not happen'"/>
                              <reset_cue cue="Ch2_3_FindStation"/>
                              <reset_cue cue="Ch2_3_ProceedToHack"/>
                            </do_else>
                          </actions>
                          <delay exact="1s"/>
                          <actions>
                            <do_if value="this.$EndFeedbackValue ge 1">
                              <signal_cue cue="Ch2_3_Station_Hacked_Dialogue"/>
                            </do_if>
                            <do_else>
                              <reset_cue cue="Ch2_3_ProceedToHack"/>
                            </do_else>
                          </actions>
                          <cues>

                            <cue name="Ch2_3_Station_Hacked_Dialogue">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch2_3_UndockStation"/>
                              </actions>
                              <cues>
                                <cue name="Ch2_3_StationHacked_Cutscene_v2">
                                  <actions>
                                    <play_cutscene result="this.$CutsceneID" key="'Story_criminal_ch2_storagehack'">
                                      <param name="target_container"      object="$PickupGroup.{1}"/>
                                      <param name="target_station"        object="$AxiomActor"/>
                                      <param name="target_raiderhubship"  object="$RaiderHubShip"/>
                                    </play_cutscene>
                                  </actions>
                                </cue>

                                <cue name="Ch2_3_StationHacked_Ref" ref="md.LIB_Dialog.Speak_Actors">
                                  <param name="Actor"             value="[$AxiomActor, $MaestroActor]"/>
                                  <param name="Cutscene"          value="[false, false]" comment="no eventmonitor-scene, cutscene playing"/>
                                  <param name="Lines"             value="[[[30252235],[30252236]],[[30252249],[30252247]]]"/>
                                  <param name="EndSignalCue"      value="[null, null]"/>
                                  <!--
                                  Axiom
                                    I can see you compromised their system. The station is ejecting wares into space.
                                    Well done, Chipmunk!
                                  Maestro
                                    Moving in, now!
                                    Chipmunk, back to your ship, grab what you can!
                                  -->
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch2_3_PickupAndReturnToS1a">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$Ch2_RaiderHubContainerCount" exact="0"/>
                            <set_value name="$Ch2_PlayerContainerCount" exact="0"/>
                            <cancel_all_orders object="$RaiderHubShip"/>
                            <!-- If this order fails, check if the AE has cargospace and/or drones
                              $RaiderHubShip.cargo.capacity.all
                              $RaiderHubShip.cargo.free.all
                              $RaiderHubShip.availableunits.{unitcategory.transport}.count
                            -->
                            <create_order id="'Collect'" object="$RaiderHubShip" immediate="true" comment="order.collect.ship">
                              <param name="targetlist" value="$PickupGroup.list"/>
                              <param name="debugchance" value="$DebugChance"/>
                            </create_order>
                            <debug_text text="'AE Gather Containers at t=%s'.[player.age]" chance="$DebugChance"/>
                          </actions>
                          <cues>



                            <cue name="Ch2_3_AE_Retreat_Timeout">
                              <!-- relatively large timeout, because sending drones over a few km's takes time to get there and back) -->
                              <delay exact="7 * 60s" comment="Definitely retreat on timeout (possibly earlier, if crates were collected)"/>
                              <actions>
                                <signal_cue cue="Ch2_3_AE_Retreat"/>
                              </actions>
                            </cue>

                            <cue name="Ch2_3_AE_Retreat_Delayed">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <delay exact="30s"/>
                              <actions>
                                <signal_cue cue="Ch2_3_AE_Retreat"/>
                              </actions>
                            </cue>

                            <cue name="Ch2_3_AE_Retreat">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <debug_text text="'Retreat, AE Collected %s containers t=%s'.[$Ch2_RaiderHubContainerCount, player.age]" chance="$DebugChance"/>
                                <signal_cue cue="Arcadian_Endeavour_Retreat_Order"/>
                              </actions>
                              <cues>
                                <!-- Axiom (note the DelayInitial, after which we assume AE collected something)  -->
                                <cue name="Ch2_StationHackFinished_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$AxiomActor"/>
                                  <param name="DelayInitial"      value="40s"/>
                                  <param name="Lines"             value="[[30252240],[30252241],[30252242]]"/>
                                  <param name="EndSignalCue"      value="Ch2_3_Completed_v2"/>
                                  <!--
                                      We have collected all we can. This certainly was a very successful incursion.
                                      Chipmunk, oh chosen one! You executed your function flawlessly!
                                      Allow yourself be proud of your achievements!
                                    -->
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Ch2_3_AttackAE_Timeout">
                              <delay exact=" 3 * 60s"/>
                              <actions>
                                <signal_cue cue="Ch2_3_StationLaunchFighters" check="false"/>
                              </actions>
                            </cue>

                            <cue name="Ch2_3_StationLaunchFighters">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <delay exact="10s"/>
                              <actions>
                                <set_value name="this.$HackStationFighterMacro" exact="macro.ship_tel_s_fighter_01_a_macro"/>
                                <debug_text text="'Hackstation Launching Fighter 1'" chance="$DebugChance"/>
                                <find_dockingbay name="this.$HackStationDockInternal" object="$HackStation">
                                  <match_dock size="this.$HackStationFighterMacro.docksize" free="true" storage="true" />
                                </find_dockingbay>
                                <do_if value="this.$HackStationDockInternal">
                                  <create_ship name="$HackStationFighter1" groupname="$HackStationFighters" missioncue="namespace" macro="this.$HackStationFighterMacro" dock="this.$HackStationDockInternal" capturable="false" commandeerable="false">
                                    <pilot ref="fighter_teladi_random_rookie"/>
                                    <owner exact="$HackStation.owner"/>
                                    <loadout>
                                      <level exact="1.0"/>
                                    </loadout>
                                  </create_ship>
                                  <create_order object="$HackStationFighter1" id="'Undock'" immediate="true"/>
                                  <create_order object="$HackStationFighter1" id="'Attack'">
                                    <param name="primarytarget" value="$RaiderHubShip"/>
                                    <param name="allowothertargets" value="false"/>
                                    <param name="pursuetargets" value="true"/>
                                    <param name="checkrelation" value="false"/>
                                    <param name="forceprimarytarget" value="true"/>
                                  </create_order>
                                </do_if>
                              </actions>
                              <delay exact="40s"/>
                              <actions>
                                <find_dockingbay name="this.$HackStationDockInternal" object="$HackStation">
                                  <match_dock size="this.$HackStationFighterMacro.docksize" free="true" storage="true" />
                                </find_dockingbay>
                                <do_if value="this.$HackStationDockInternal">
                                  <create_ship name="$HackStationFighter2" groupname="$HackStationFighters" missioncue="namespace" macro="this.$HackStationFighterMacro" dock="this.$HackStationDockInternal" capturable="false" commandeerable="false">
                                    <owner exact="$HackStation.owner"/>
                                    <pilot ref="fighter_teladi_random_rookie"/>
                                    <loadout>
                                      <level exact="1"/>
                                    </loadout>
                                  </create_ship>
                                  <create_order object="$HackStationFighter2" id="'Undock'" immediate="true"/>
                                  <create_order object="$HackStationFighter2" id="'Attack'">
                                    <param name="primarytarget" value="$RaiderHubShip"/>
                                    <param name="allowothertargets" value="false"/>
                                    <param name="pursuetargets" value="true"/>
                                    <param name="checkrelation" value="false"/>
                                    <param name="forceprimarytarget" value="true"/>
                                  </create_order>
                                </do_if>
                              </actions>
                            </cue>

                            <cue name="Ch2_3_PickupCrate" instantiate="true">
                              <conditions>
                                <check_any>
                                  <event_object_collected_ware object="$RaiderHubShip"/>
                                  <event_object_collected_ware group="global.$PlayerControlledGroup"/>
                                </check_any>
                              </conditions>
                              <actions>
                                <debug_text text="'AE/player collected, p= p2=%s p3=%s t=%s'.[event.param, event.param2, event.param3, player.age]" chance="$DebugChance"/>
                                <do_if value="event.object == $RaiderHubShip">
                                  <set_value name="$Ch2_RaiderHubContainerCount" operation="add"/>
                                  <signal_cue cue="Ch2_3_AE_Retreat_Delayed" check="false" comment="move out in 30 seconds - still gives the other dones a chance to return"/>
                                  <signal_cue cue="Ch2_3_StationLaunchFighters" check="false" comment="At this point the station knows the AE was involved"/>
                                </do_if>
                                <do_else>
                                  <set_value name="$Ch2_PlayerContainerCount" operation="add"/>
                                  <do_if value="(player.ship.cargo.free.all lt 50) and (Ch2_3_Completed_v2.state == cuestate.waiting)" comment="not enough cargo space left in playership, defend AE if mission still ongoing">
                                    <set_value name="$ObjectiveStep_4" operation="add" exact="1"/>
                                    <set_objective step="$ObjectiveStep_3" cue="$MissionCue_Ch2_HackStation" action="objective.custom" customaction="{30252, 2430}" object="$RaiderHubShip" updatebriefing="true" comment="Defend Arcadian Endeavour while drones are underway"/>
                                  </do_if>
                                </do_else>
                                <cancel_cue cue="Ch2_3_Pickup_Destroyed_Axiom_Comments"/>
                              </actions>
                            </cue>

                            <!--cue name="Ch2_3_Pickup_Destroyed_DEBUG">
                              <conditions>
                                <event_object_destroyed group="$PickupGroup"/>
                              </conditions>
                              <actions>
                                <debug_text text="'Crate destroyed: event.param=%s event.param2=%s event.param3=%s AEContainer=%s PlayerContainer=%s'.[event.param, event.param2, event.param3, $Ch2_RaiderHubContainerCount, $Ch2_PlayerContainerCount]" chance="$DebugChance"/>
                              </actions>
                            </cue-->

                            <cue name="Ch2_3_Pickup_Destroyed_Axiom_Comments">
                              <conditions>
                                <event_object_destroyed group="$PickupGroup"/>
                                <check_value value="($PickupGroup.count == 1) and ($Ch2_RaiderHubContainerCount == 0) and ($Ch2_PlayerContainerCount == 0)" comment="last container destroyed and none picked up by AE/PlayerOwned"/>
                              </conditions>
                              <actions>
                                <debug_text text="'Last Crate destroyed: event.param=%s event.param2=%s event.param3=%s AEContainer=%s PlayerContainer=%s'.[event.param, event.param2, event.param3, $Ch2_RaiderHubContainerCount, $Ch2_PlayerContainerCount]" chance="$DebugChance"/>
                              </actions>
                              <cues>
                                <cue name="Ch2_3_Pickup_Destroyed_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$AxiomActor"/>
                                  <param name="Lines"             value="[[30252238]]"/>
                                  <param name="EndSignalCue"      value="Ch2_3_Completed_v2" comment="Story continues"/>
                                  <!--
                                    <t id="30252238">The cargo crates were destroyed! Very unfortunate. We'll have to make do without them.(when the cargo crates were destroyed before pick up)</t>
                                    -->
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Ch2_3_Pickup_Stolen_Axiom_Comments">
                              <conditions>
                                <event_object_destroyed group="$PickupGroup" method="killmethod.collected"/>
                                <check_all>
                                  <check_value value="not ((event.param == $RaiderHubShip) or (global.$PlayerControlledGroup.indexof.{event.param}))" comment="collected by anyone besides AE/player (probably pirates)"/>
                                  <check_value value="not (event.param == $HackStation)" comment="station which was hacked might instantly pick up 1 container, ignore that"/>
                                </check_all>
                              </conditions>
                              <actions>
                                <debug_text text="'ContainerCollected-other event.param=%s(macro=%s name=%s) event.param2=%s event.param3=%s object=%s from $PickUpGroup=%s raiderhub=%s playergroup=%s indexpg=%s'.[event.param, event.param.macro, event.param.macro.name, event.param2, event.param3, event.object, $PickupGroup, $RaiderHubShip, global.$PlayerControlledGroup, global.$PlayerControlledGroup.indexof.{event.param} ]" chance="$DebugChance"/>
                              </actions>
                              <cues>
                                <!-- Axiom  -->
                                <cue name="Ch2_3_Pickup_Stolen_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$AxiomActor"/>
                                  <param name="Lines"             value="[[30252239]]"/>
                                  <param name="EndSignalCue"      value="null"/>
                                  <!--
                                    <t id="30252239">Someone else interfered and took the spoils that were rightfully ours! Those miscreants!(when someone not from the pirate crew collects cargo)</t>
                                    -->
                                </cue>
                              </cues>
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Ch2_3_UndockStation">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$ObjectiveStep_3" operation="add" exact="1"/>
                            <set_objective step="$ObjectiveStep_3" cue="$MissionCue_Ch2_HackStation" action="objective.pickup" group="$PickupGroup" updatebriefing="true"/>
                          </actions>
                          <cues>

                            <cue name="Ch2_3_CheckStationContext" checkinterval="1s">
                              <conditions>
                                <check_value value="not player.entity.hascontext.{$HackStation}"/>
                              </conditions>
                              <cues>
                              </cues>
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Ch2_3_Completed_v2">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <remove_from_list name="$Ch2_Missions" exact="$MissionCue_Ch2_HackStation"/>
                            <remove_mission cue="$MissionCue_Ch2_HackStation" type="completed"/>
                            <signal_cue cue="Ch2_FinishCheck" comment="All 3 submissions in Ch2 completed?"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch2_Missions_SetUp">
              <conditions>
                <check_any>
                  <event_cue_completed cue="Ch2_1_BlackMarket"/>
                  <event_cue_completed cue="Ch2_2_CargoRobbery"/>
                  <event_cue_completed cue="Ch2_3_HackStation"/>
                </check_any>
                <check_value value="Ch2_1_BlackMarket.state == cuestate.complete and Ch2_2_CargoRobbery.state == cuestate.complete and Ch2_3_HackStation.state == cuestate.complete"/>
              </conditions>
              <actions>
                <set_value name="$Ch2_Missions" exact="[$MissionCue_Ch2_BlackMarket, $MissionCue_Ch2_CargoRobbery, $MissionCue_Ch2_HackStation]"/>
              </actions>
            </cue>

            <cue name="Ch2_FinishCheck" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'FinishCheck %s'.[$Ch2_Missions.count]" chance="$DebugChance"/>
                <do_if value="$Ch2_Missions.count == 0">
                  <signal_cue cue="Ch2_Completed"/>
                </do_if>
                <do_else>
                  <set_value name="$NextMissionCue" exact="$Ch2_Missions.{1}"/>
                  <activate_mission cue="$NextMissionCue"/>
                </do_else>
              </actions>
            </cue>

            <cue name="Ch2_Completed">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Chapter 2 completed'" chance="$DebugChance"/>
                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.player" title="{30252,2121}" text="{30252,2122}" comment="You have met all the members of the Empyrean Curs, and gained insights..."/>
              </actions>
              <delay exact="1min"/>
              <actions>
                <signal_cue cue="Ch3_Piracy_Targeted"/>
                <cancel_cue cue="Ch2_Piracy_Induction"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch3_Force">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch3_Piracy_Targeted">
            <signal_cue_instantly cue="Ch2_PlaceAxiomActor"/>
            <signal_cue_instantly cue="Ch3_PlaceAceActor"/>

            <!-- Cancelling Previous Chapters -->
            <set_value name="$CurrentChapter" exact="Ch3_Piracy_Targeted"/>
            <do_for_each in="$Chapters" name="$Chapter">
              <do_if value="$Chapter == $CurrentChapter">
                <signal_cue cue="$CurrentChapter"/>
                <break/>
              </do_if>
              <cancel_cue cue="$Chapter"/>
            </do_for_each>
            <!--<find_station name="$BlackMarketStation" space="player.galaxy" sortbygatedistanceto="player.entity">
              <match_relation_to faction="faction.player" relation="dock"/>
              <match_content controlpost="controlpost.shadyguy"/>
              <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true">
            </find_station>
            <do_if value="not $BlackMarketStation.isoperational">
              <find_station name="$BlackMarketStation" space="player.galaxy" sortbygatedistanceto="player.entity">
                <match_relation_to faction="faction.player" relation="dock"/>
                <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
              </find_station>
              <signal_cue_instantly cue="NPC_ShadyGuy.AddShadyGuys" param="table[$stations = [$BlackMarketStation]]"/>
            </do_if>-->
          </force>
        </cue>

        <!-- Chapter 3:
              - Blueprint Hack
              - Board Trade Ship
              - Engage Patrol
        -->

        <cue name="Ch3_PlaceAceActor">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- Ace's ship exists from the start, docked at the AE, if we force this cue we only need to set Ace as pilot and give an order -->
            <assign_control_entity object="$AceShip" actor="$AceActor" post="controlpost.aipilot" transfer="true" init="true"/>
            <signal_objects object="$AceActor" param="'npc_state_reinit'"/>
            <create_order id="'AssignCommander'" object="$AceShip" immediate="true">
              <param name="commander" value="$RaiderHubShip"/>
              <param name="assignment" value="assignment.defence"/>
              <param name="cancelorders" value="true"/>
            </create_order>
          </actions>
        </cue>

        <cue name="Ch3_PlaceAxiomActor" instantiate="true" comment="Signalled whenever Axiom has to move back to the ship.">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <create_position name="$AxiomPos" x="0.09" y="0.05" z="-13.325" space="$RaiderHubShip_GeneratorRoom"/>
            <create_rotation name="$AxiomRot" yaw="-180deg"/>
            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor,
                                                                                              table[
                                                                                              $requestercue = $MissionCue,
                                                                                              $location = $RaiderHubShip_GeneratorRoom,
                                                                                              $priority = 100,
                                                                                              $rotation = $AxiomRot,
                                                                                              $position = $AxiomPos,
                                                                                              $debugchance = $DeepDebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                              ]"/>

          </actions>
        </cue>

        <cue name="Ch3_Piracy_Targeted">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <create_group groupname="$Ch3_ExcludedStations"/>
            <add_to_group groupname="$Ch3_ExcludedStations" object="$PrisonStation"/>
            <create_mission_thread cue="$MissionCue" name="{30252,3001}" description="{30252,3002}"
                                   type="missiontype.plot" faction="faction.civilian" difficulty="level.medium" abortable="false" icon="'briefing_maestro_01'" iconcaption="$MaestroActor.knownname" threadtype="parallel"/>

          </actions>
          <cues>

            <cue name="Ch3_Introduction_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$MaestroActor"/>
              <param name="Lines"             value="[[30252301],[30252302],[30252303],[30252304],[30252305],[30252306]]"/>
              <param name="EndSignalCue"      value="null"/>
              <!--
                Chipmunk! Your contributions make a difference!
                The Empyrean Curs' funds have grown, everyone involved is putting in work!
                While you, Ace and Axiom have been out raiding, I started putting together multistep plan.
                This requires more funds and working on groundwork.
                Also, plan not yet final. Still worked on!
                Talk to crew to see how you can contribute further!
              -->
            </cue>

            <!-- WARNING: THESE LINES HAVEN'T MADE IT INTO THE TEXTDB, CUE MUST REMAIN COMMENTED OUT -->
            <!-- Have Mellerd formally introduce herself in the story -->
            <!--<cue name="Ch3_MellerdIntroduction">
              <conditions>
                <event_object_changed_sector group="global.$PlayerContainerGroup" sector="$PrisonStation.sector"/>
              </conditions>
              <cues>
                <cue name="Ch3_Mellerd_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$KrissMellerdActor"/>
                  <param name="DelayInitial"      value="6s"/>
                  <param name="Lines"             value="[[30252301],[30252302],[30252303],[30252304]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  -->
            <!--
                    Attention, all ships!
                    As you all know the Ministry of Finance has been wary of the sorts of people that travel into our system ever since the connection to Windfall was first established.
                    Now, we are receiving reports of an acute increase in piracy activity which can be traced back to a fringe criminal element.
                    Stay alert and report any potential criminal activity immediately!
                  -->
            <!--
                </cue>
              </cues>
            </cue>-->

            <cue name="Ch3_1_BlueprintTheft">
              <actions>
                <signal_cue cue="Ch3_PlaceAxiomActor"/>

                <set_value name="$ObjectiveStep_1" exact="1"/>
                <set_value name="$MissionCue_Ch3_Blueprint" exact="this"/>

                <create_mission cue="$MissionCue_Ch3_Blueprint" name="{30252,3201}" description="{30252,3202}" rewardtext="{30252,3220}" type="missiontype.plot" faction="faction.civilian" difficulty="level.medium" abortable="false" icon="'briefing_axiom_01'" iconcaption="$AxiomActor.knownname" missionthread="$MissionCue">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$AxiomActor" text="$AxiomActor.name"/>
                  </briefing>
                </create_mission>
                <set_objective_from_briefing cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1"/>
              </actions>
              <cues>

                <cue name="Ch3_1_Axiom_Conversation" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$AxiomActor"/>
                      <event_conversation_next_section actor="$AxiomActor" section="conv_questions"/>
                      <event_conversation_next_section actor="$AxiomActor" section="conv_continue"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="event.name == 'event_conversation_started'">

                      <do_if value="Ch3_1_Axiom_Finished.state == cuestate.waiting">
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252301" comment="Ah, Chipmunk! Good to see you!"/>
                          <text line="30252302" comment="I see you have recovered from our first lesson! Magnificent!"/>
                          <text line="30252303" comment="The Maestro probably already told you that he is currently hatching a plan."/>
                          <text line="30252304" comment="It is shaping up to be a plan of unprecedented proportions, for which I have been asked to provide blueprints for."/>
                          <text line="30252305" comment="If we were on good standings with the Teladi people, we could buy the required blueprint."/>
                          <text line="30252306" comment="But they are expensive, and we are pirates..."/>
                          <text line="30252307" comment="So I have decided to turn this into another lesson!"/>
                        </add_npc_line>
                        <add_player_choice text="{30252,30252301}" section="conv_questions" comment="" position="top_left"/>
                        <add_player_choice text="{30252,30252302}" section="conv_continue" comment="" position="bottom_right" highlighted="true"/>
                      </do_if>
                      <do_else>

                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252375" comment="You have to be careful handling any type of explosive. You wouldn't want to blow yourself up!"/>
                        </add_npc_line>
                        <do_if value="not $Ch3_AxiomExposition?">
                          <add_player_choice text="{30252,30252301}" section="conv_questions" comment="" position="top_left"/>
                          <add_player_choice text="{1002,2}" section="section_exit" position="bottom_right" comment="Goodbye"/>
                        </do_if>

                      </do_else>
                    </do_if>
                    <do_else>

                      <do_if value="event.param == 'conv_questions'">
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252308" comment="Because I don't take myself too seriously?"/>
                          <text line="30252309" comment="Or rather, because I do not take the Paranid faith too serious?"/>
                          <text line="30252310" comment="Well, it is quite simple, actually. I do not believe like the others do."/>
                          <text line="30252311" comment="You see, even a Paranid is not born religious."/>
                          <text line="30252312" comment="That zeal is the result of a lengthy indoctrination which occurs right after a Paranid leaves the cocoon it develops in."/>
                          <text line="30252313" comment="It is not uncommon in Paranid society to store unhatched cocoons in stasis pods, to access them when a specific kind of Paranid is required."/>
                          <text line="30252314" comment="My cocoon was stored on a Paranid station in Windfall before the Jump Gates shut down."/>
                          <text line="30252315" comment="As the connections between systems slowly grew unstable, the Pontifex decreed that all Paranid stored outside of Paranid space should be transported to the nearest Paranid system in order to shore up the supply of Paranid progeny."/>
                          <text line="30252316" comment="I never made it outside of the Windfall system."/>
                          <text line="30252317" comment="A marauding group of Pirates attacked the vessel in which my pod was transported in."/>
                          <text line="30252318" comment="My pod drifted through space for a time, until I was picked up by a group of merchants that happened by."/>
                          <text line="30252319" comment="They weren't familiar with Paranid technology, so they activated the pod and hatched me by accident."/>
                          <text line="30252320" comment="With the Windfall system cut off from Paranid society I was not able to receive the customary indoctrination. And the window in which a Paranid is receptive to the religious teachings is limited."/>
                          <text line="30252321" comment="Now, I can fake being religious well enough if the situation calls for it, but it is an act."/>
                          <text line="30252322" comment="Merely a part I play."/>
                          <text line="30252323" comment="And I do not wish to hide."/>
                          <text line="30252324" comment="The way I am there is a good chance I'd be shunned by my Paranid brethren. Or even killed."/>
                          <text line="30252325" comment="I am the victim of a frustrating situation that was born through no fault of my own."/>
                          <text line="30252326" comment="But I refuse to let the weight of it all break me, and humor helps. I make light of the Paranid customs sometimes, and in my special sort of way it helps me cope. And in my defense, these customs can appear quite funny."/>
                        </add_npc_line>
                        <set_value name="$Ch3_AxiomExposition"/>
                        <add_player_choice text="{30252,30252301}" section="conv_questions" comment="" position="top_left"/>
                        <add_player_choice text="{30252,30252302}" section="conv_continue" comment="" position="bottom_right" highlighted="true"/>
                      </do_if>
                      <do_elseif value="event.param == 'conv_continue'">
                        <set_value name="$EMP_BombCount" exact="player.entity.inventory.{ware.bomb_player_limpet_emp_01_mk1}.count"/>

                        <add_npc_line speaker="$AxiomActor" line="30252327" hidechoices="true" comment="Very well, then. As with all Counter-Security operations, success depends heavily on preparation."/>

                        <!-- Extreme edge case where the player already owns all blueprints. Skip the mission in this case. -->
                        <set_value name="$BaseGameConnectionModulesList" exact="[
                          ware.module_arg_conn_base_01, ware.module_arg_conn_base_02, ware.module_arg_conn_base_03,
                          ware.module_arg_conn_cross_01,
                          ware.module_arg_conn_vertical_01, ware.module_arg_conn_vertical_02,
                          ware.module_par_conn_base_01, ware.module_par_conn_base_02, ware.module_par_conn_base_03,
                          ware.module_par_conn_cross_01, ware.module_par_conn_cross_02, ware.module_par_conn_cross_03,
                          ware.module_par_conn_vertical_01, ware.module_par_conn_vertical_02,
                          ware.module_tel_conn_base_01, ware.module_tel_conn_base_02, ware.module_tel_conn_base_03,
                          ware.module_tel_conn_cross_01,
                          ware.module_tel_conn_vertical_01, ware.module_tel_conn_vertical_02 ]"/>
                        <set_value name="$PlayerOwnsAllBaseGameConnectionModuleBlueprints"/>
                        <do_for_each in="$BaseGameConnectionModulesList" name="$Module">
                          <do_if value="not player.blueprints.{$Module}.any.exists">
                            <set_value name="$PlayerOwnsAllBaseGameConnectionModuleBlueprints" exact="false"/>
                            <break/>
                          </do_if>
                        </do_for_each>
                        <do_if value="$PlayerOwnsAllBaseGameConnectionModuleBlueprints">
                          <add_npc_line speaker="$AxiomActor" line="30252353" hidechoices="true" comment="It actually seems like you are already way ahead of me on that one. Incredible; the disciple is teaching the master for once!"/>
                          <add_npc_line speaker="$AxiomActor" line="30252374" hidechoices="true" comment="But now, at least, we have the blueprint we need to gain an insight into internal station geometry!"/>
                        </do_if>

                        <!-- Much more likely case where the player still has a few blueprints missing. -->
                        <do_else>
                          <!-- Dialog about EMP bombs -->
                          <do_if value="$EMP_BombCount ge 1">
                            <add_npc_line speaker="$AxiomActor" line="30252328" hidechoices="true" comment="A lesson which clearly my disciple has taken to heart! I can see you are already carrying an EMP bomb!"/>
                          </do_if>
                          <do_else>
                            <add_npc_line speaker="$AxiomActor" line="30252329" hidechoices="true" comment="You need to acquire an EMP bomb, which you can do by crafting or by buying them from a Black Marketeer."/>

                            <do_if value="(player.entity.inventory.{ware.inv_magneticmaterial}.count ge 1) and 
                                          (player.entity.inventory.{ware.inv_remotedetonator}.count ge 1) and 
                                          (player.entity.inventory.{ware.inv_securecontainer}.count ge 1)">
                              <add_npc_line speaker="$AxiomActor" line="30252334" hidechoices="true" comment="But you already possess all the materials you require to craft an EMP bomb, so you do not have to buy one!"/>
                            </do_if>
                            <do_else>
                              <add_npc_line speaker="$AxiomActor" line="30252333" hidechoices="true" comment="Should you want to save some credits, you can of course also craft the bomb instead."/>
                            </do_else>
                          </do_else>

                          <!-- Dialog about the bomb launcher -->
                          <add_npc_line speaker="$AxiomActor" line="30252330" hidechoices="true" comment="You will also need a Bomb Launcher to attach the bombs to the station."/>

                          <do_if value="player.entity.inventory.{ware.weapon_gen_spacesuit_demolition_01_mk1}.count ge 1">
                            <add_npc_line speaker="$AxiomActor" line="30252331" hidechoices="true" comment="And I can see you already own a Bomb Launcher!"/>
                          </do_if>

                          <!-- Extra dialog if the player is still missing any of the required items -->
                          <do_if value="($EMP_BombCount lt 1) or (player.entity.inventory.{ware.weapon_gen_spacesuit_demolition_01_mk1}.count lt 1)">
                            <add_npc_line speaker="$AxiomActor" line="30252332" hidechoices="true" comment="I have marked a black market from which I know that the required items are in stock."/>
                          </do_if>

                          <add_npc_line speaker="$AxiomActor" line="30252335" hidechoices="true" comment="Now, let us set out on our quest to steal classified blueprints!"/>
                        </do_else>
                      </do_elseif>

                    </do_else>
                  </actions>
                  <cues>
                    <cue name="Ch3_1_Axiom_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$AxiomActor"/>
                        <check_value value="$PlayerOwnsAllBaseGameConnectionModuleBlueprints?" comment="set in the 'continue' part of the conversation"/>
                      </conditions>
                      <actions>
                        <do_if value="$PlayerOwnsAllBaseGameConnectionModuleBlueprints">
                          <signal_cue cue="Ch3_1_Axiom_Finished_Shortcut" check="false"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch3_1_Axiom_Finished" check="false"/>
                        </do_else>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch3_1_Axiom_Finished">
                  <conditions>
                    <check_any>
                      <event_cue_signalled comment="reliable, triggers at the end of the AxiomConversation (if other conditions are met)"/>
                      <event_speak_line_finished actor="$AxiomActor" line="30252335" comment="unreliable"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="(player.entity.inventory.{ware.bomb_player_limpet_emp_01_mk1}.count ge 1 and player.entity.inventory.{ware.weapon_gen_spacesuit_demolition_01_mk1}.count ge 1)">
                      <set_value name="$AlreadyOwnsEMPBomb"/>
                      <signal_cue cue="Ch3_1_TowardsEMP_Station"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch3_1_AcquireEMPMaterials"/>
                    </do_else>
                    <activate_mission cue="$MissionCue_Ch3_Blueprint"/>
                  </actions>
                </cue>

                <cue name="Ch3_1_Axiom_Finished_Shortcut">
                  <conditions>
                    <check_any>
                      <event_cue_signalled comment="reliable, triggers at the end of the AxiomConversation (if other conditions are met)"/>
                      <event_speak_line_finished actor="$AxiomActor" line="30252374" comment="unreliable"/>
                    </check_any>
                    <check_value value="Ch3_1_Axiom_Finished.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch3_1_Cleanup_v2"/>
                  </actions>
                </cue>

                <cue name="Ch3_1_AcquireEMPMaterials_Reset_Helper" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue cue="Ch3_1_AcquireEMPMaterials"/>
                  </actions>
                </cue>

                <cue name="Ch3_1_AcquireEMPMaterials">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>

                    <find_station name="$PotentialBlackMarketStations" space="player.galaxy" sortbygatedistanceto="player.entity" multiple="true">
                      <match_relation_to faction="faction.player" relation="dock"/>
                      <match_content controlpost="controlpost.shadyguy" />
                      <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                      <match trueowner="[faction.player]" negate="true"/>
                    </find_station>

                    <do_all exact="$PotentialBlackMarketStations.count" counter="$i">
                      <set_value name="$ShadyGuy" exact="$PotentialBlackMarketStations.{$i}.shadyguy"/>
                      <do_if value="$ShadyGuy.tradesvisible">
                        <!-- We found a shady guy selling wares -->
                        <add_inventory entity="$ShadyGuy" ware="ware.bomb_player_limpet_emp_01_mk1" exact="3"/>
                        <set_value name="$Ch3_BlackMarketStation" exact="$PotentialBlackMarketStations.{$i}"/>
                        <break/>
                      </do_if>
                    </do_all>

                    <do_if value="not $Ch3_BlackMarketStation?">
                      <sort_list list="$PotentialBlackMarketStations" sortbyvalue="loop.element.gatedistance.{player.entity}"/>
                      <set_value name="$Ch3_BlackMarketStation" exact="$PotentialBlackMarketStations.{1}"/>
                      <set_value name="$ShadyGuy" exact="$Ch3_BlackMarketStation.shadyguy"/>
                      <do_if value="$ShadyGuy">
                        <add_inventory entity="$ShadyGuy" ware="ware.bomb_player_limpet_emp_01_mk1" exact="3"/>
                        <set_entity_traits entity="$ShadyGuy" tradesvisible="true"/>
                        <do_if value="not $ShadyGuy.$InstantiationRequesters?">
                          <set_value name="$ShadyGuy.$InstantiationRequesters" exact="[]"/>
                        </do_if>
                        <append_to_list name="$ShadyGuy.$InstantiationRequesters" exact="$MissionCue"/>
                        <signal_objects object="$Ch3_BlackMarketStation" param="'npc_instantiation__mission'" comment="Make sure the shady guy is actually properly instantiated on the station" />
                        <set_known object="$Ch3_BlackMarketStation" known="true" updatesnapshot="true"/>
                      </do_if>
                    </do_if>

                    <find_object_component name="$Ch3_BlackMarketStationDock" object="$Ch3_BlackMarketStation" checkoperational="true" class="class.walkablemodule" haswalkableroom="true"/>

                    <set_value name="$ObjectiveStep_1" exact="2"/>
                    <update_mission cue="$MissionCue_Ch3_Blueprint">
                      <briefing replace="true">
                        <objective step="1" action="objective.talkto" object="$AxiomActor" text="$AxiomActor.name"/>
                        <objective step="2" action="objective.acquire_ware" text="ware.bomb_player_limpet_emp_01_mk1.name" object="$Ch3_BlackMarketStation.shadyguy"/>
                        <objective step="3" action="objective.acquire_ware" text="ware.weapon_gen_spacesuit_demolition_01_mk1.name" object="$Ch3_BlackMarketStation.shadyguy"/>
                      </briefing>
                    </update_mission>
                    <set_objective_from_briefing cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1"/>
                  </actions>
                  <cues>

                    <cue name="Ch3_1_Shady_Guy_Station_Dock_Destroyed">
                      <conditions>
                        <event_object_hull_below_function_threshold object="$Ch3_BlackMarketStationDock"/>
                        <check_value value="Ch3_1_TowardsEMP_Station.state == cuestate.waiting"/>
                      </conditions>
                      <actions>
                        <reset_cue cue="Ch3_1_AcquireEMPMaterials"/>
                        <signal_cue cue="Ch3_1_AcquireEMPMaterials_Reset_Helper"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_1_CheckForEMP" onfail="cancel">
                      <conditions>
                        <check_value value="player.entity.inventory.{ware.bomb_player_limpet_emp_01_mk1}.count ge 1"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch3_1_AcquiredEMP"/>
                      </actions>
                    </cue>

                    <!-- TODO: Test if this condition works -->
                    <cue name="Ch3_1_AcquiredEMP">
                      <conditions>
                        <check_any>
                          <check_all>
                            <event_inventory_added object="player.entity"/>
                            <check_value value="event.param.{ware.bomb_player_limpet_emp_01_mk1}?"/>
                          </check_all>
                          <event_cue_signalled/>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_if value="Ch3_1_AcquiredBombLauncher.state == cuestate.complete">
                          <signal_cue cue="Ch3_1_Complete"/>
                        </do_if>
                        <do_else>
                          <set_value name="$ObjectiveStep_1" operation="add" exact="1"/>
                          <set_objective_from_briefing cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch3_1_CheckForLauncher" onfail="cancel">
                      <conditions>
                        <check_value value="player.entity.inventory.{ware.weapon_gen_spacesuit_demolition_01_mk1}.count ge 1"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch3_1_AcquiredBombLauncher"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_1_AcquiredBombLauncher">
                      <conditions>
                        <check_any>
                          <check_all>
                            <event_inventory_added object="player.entity"/>
                            <check_value value="event.param.{ware.weapon_gen_spacesuit_demolition_01_mk1}?"/>
                          </check_all>
                          <event_cue_signalled/>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_if value="Ch3_1_AcquiredEMP.state == cuestate.complete">
                          <signal_cue cue="Ch3_1_Complete"/>
                        </do_if>
                        <do_else>
                          <update_mission cue="$MissionCue_Ch3_Blueprint">
                            <briefing>
                              <objective step="2" action="objective.acquire_ware" text="ware.bomb_player_limpet_emp_01_mk1.name"/>
                              <objective step="3" action="objective.acquire_ware" text="ware.weapon_gen_spacesuit_demolition_01_mk1.name" completed="true"/>
                            </briefing>
                          </update_mission>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch3_1_Complete">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep_1" operation="add"/>
                        <set_objective step="$ObjectiveStep_1" cue="$MissionCue_Ch3_Blueprint" action="objective.wait" updatebriefing="true" silent="true"/>
                      </actions>
                      <cues>

                        <cue name="Ch3_1_AcquiredEMP_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="Lines"             value="[[30252336],[30252337],[30252338]]"/>
                          <param name="CutsceneKey"       value="[null]" comment="No cutscene to hide the fact that the Axiom has not yet moved from the AE"/>
                          <param name="EndSignalCue"      value="Ch3_1_TowardsEMP_Station"/>
                          <!--
                            Chipmunk! You have acquired everything you need steal the blueprint!
                            I have identified a suitable station. The Ace was courteous enough to drop me off there already so that I can monitor things from the ground.
                            I'm sending you the station's location!
                          -->
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_1_TowardsEMP_Station_Reset_Helper">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue cue="Ch3_1_TowardsEMP_Station"/>
                  </actions>
                </cue>

                <cue name="Ch3_1_TowardsEMP_Station">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <find_station_by_true_owner name="$BlueprintHackStation" space="player.galaxy" sortbygatedistanceto="player.entity" faction="faction.ministry" excluded="$Ch3_ExcludedStations">
                      <match_content class="class.connectionmodule" checkoperational="true"/>
                      <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true" comment="down below we search for this component, let's make sure the station has it"/>
                    </find_station_by_true_owner>

                    <add_to_group groupname="$Ch3_ExcludedStationss" object="$BlueprintHackStation"/>
                    <set_value name="$ObjectiveStep_1" operation="add" exact="1"/>
                    <set_objective step="$ObjectiveStep_1" cue="$MissionCue_Ch3_Blueprint" action="objective.flyto" text="$BlueprintHackStation.knownname" object="$BlueprintHackStation" updatebriefing="true" radius="6km"/>
                  </actions>
                  <cues>

                    <!-- If the station gets destroyed before the player has picked up Axiom, reset the entire mission to this point. -->
                    <cue name="Ch3_1_Station_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$BlueprintHackStation"/>
                        <check_value value="Ch3_1_ReturnToAE.state == cuestate.waiting"/>
                      </conditions>
                      <actions>
                        <reset_cue cue="Ch3_1_TowardsEMP_Station"/>
                        <signal_cue cue="Ch3_1_TowardsEMP_Station_Reset_Helper"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_1_Place_Axiom_On_Station" checkinterval="2s">
                      <conditions>
                        <check_value value="player.sector? and (player.sector == $BlueprintHackStation.sector)"/>
                        <check_value value="player.entity.distanceto.{$BlueprintHackStation} le 100km"/>
                        <check_value value="not player.entity.hascontext.{$RaiderHubShip}"/>
                      </conditions>
                      <actions>
                        <find_object_component name="$BlueprintHackStationDock" object="$BlueprintHackStation" checkoperational="true" class="class.walkablemodule" haswalkableroom="true"/>

                        <do_if value="$BlueprintHackStationDock">
                          <find_npc_slot name="$BlueprintHackStationSlot" excludeblocked="false" excludefilled="false" object="$BlueprintHackStationDock" tags="tag.stand"/>
                          <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor,
                                                                                                  table[
                                                                                                  $requestercue = $MissionCue,
                                                                                                  $location = $BlueprintHackStationSlot,
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]"/>
                          <do_if value="Ch3_1_AcquiredEMP_Ref.state != cuestate.cancelled">
                            <signal_cue cue="Ch3_1_AxiomOnStation_Dialog"/>
                          </do_if>
                        </do_if>
                        <!-- If anything goes wrong, don't panick, Axiom is still alive on the Arcadian Endeavour. Retry after a while. -->
                      </actions>
                      <delay exact="1min"/>
                      <actions>
                        <do_if value="not $BlueprintHackStationDock and (Ch3_1_ReturnToAE.state == cuestate.waiting)">
                          <reset_cue cue="this"/>
                        </do_if>
                      </actions>
                      <cues>

                        <cue name="Ch3_1_Dock_Destroyed">
                          <conditions>
                            <event_object_hull_below_function_threshold object="$BlueprintHackStationDock"/>
                            <check_value value="Ch3_1_ReturnToAE.state == cuestate.waiting"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch3_PlaceAxiomActor"/>
                            <reset_cue cue="parent"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch3_1_AxiomOnStation_Dialog">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>

                        <cue name="Ch3_1_AxiomOnStation_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="Lines"             value="[[30252337]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            I have identified a suitable station. The Ace was courteous enough to drop me off there already so that I can monitor things from the ground.
                          -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch3_1_DistanceCheck" checkinterval="1s">
                      <conditions>
                        <check_value value="player.entity.distanceto.{$BlueprintHackStation} le 6km"/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep_1" operation="add" exact="1"/>
                        <find_object_component name="$ConnectionModule" object="$BlueprintHackStation" class="class.connectionmodule"/>
                        <set_objective step="$ObjectiveStep_1" cue="$MissionCue_Ch3_Blueprint" action="objective.flyto" text="{20104,59901}" object="$ConnectionModule" updatebriefing="true" radius="500m"/>
                      </actions>
                      <cues>

                        <!-- If the connection module gets destroyed before the player has scanned the leaks, reset the entire mission to this point. -->
                        <cue name="Ch3_1_ConnectionModule_Destroyed">
                          <conditions>
                            <event_object_destroyed object="$ConnectionModule"/>
                            <check_value value="Ch3_1_HackStation_Hack_Finished.state == cuestate.waiting"/>
                          </conditions>
                          <actions>
                            <reset_cue cue="Ch3_1_DistanceCheck"/>
                          </actions>
                        </cue>

                        <cue name="Ch3_1_PointTowardsStation" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="Lines"             value="[[30252339],[30252340]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            Hey, I can see your vessel approaching!
                            Now fly to the connection module I have highlighted for you.
                          -->
                        </cue>

                        <cue name="Ch3_1_ModuleDistanceCheck" checkinterval="1s">
                          <conditions>
                            <check_value value="(player.sector == $ConnectionModule.sector) and (player.entity.distanceto.{$ConnectionModule} le 500m)"/>
                          </conditions>
                          <cues>

                            <cue name="Ch3_1_GetOutOfSpacesuit" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$AxiomActor"/>
                              <param name="Lines"             value="[[30252341]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                In order to place an EMP bomb you'll have to change into your space suit.
                              -->
                            </cue>

                            <cue name="Ch3_1_UseSpacesuit">
                              <actions>
                                <do_if value="player.ship.isclass.spacesuit">
                                  <find_ship name="$PlayerShip" space="player.galaxy" sortbydistanceto="player.entity" owner="faction.player" class="class.ship"/>
                                  <signal_cue cue="Ch3_Create_Leak_Setup"/>
                                </do_if>
                                <do_else>
                                  <find_player_transporter_slot name="$TransporterSlot" object="player.entity.room"/>
                                  <set_value name="$ObjectiveStep_1" exact="1" operation="add"/>
                                  <set_objective cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1" action="objective.usespacesuit" slot="$TransporterSlot" updatebriefing="true" insert="true" comment="Use Spacesuit"/>
                                  <signal_cue cue="Ch3_1_HackStation_Activate_Spacesuit_Check"/>
                                </do_else>
                              </actions>
                            </cue>

                            <cue name="Ch3_1_HackStation_Activate_Spacesuit_Check">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>
                                <cue name="Ch3_1_HackStation_Spacesuit_Check">
                                  <conditions>
                                    <event_object_changed_room object="player.entity"/>
                                    <check_value value="player.ship.isclass.spacesuit"/>
                                  </conditions>
                                  <actions>
                                    <set_value name="$PlayerShip" exact="event.param2.container"/>
                                    <signal_cue cue="Ch3_Create_Leak_Setup"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Ch3_Create_Leak_Setup">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <create_group groupname="$ConnectionModuleSignalLeaks"/>
                              </actions>
                              <cues>
                                <cue name="HackStation_EMP_AxiomSpeak">
                                  <actions>
                                    <set_value name="$SpeakInProgress"/>
                                  </actions>
                                  <cues>
                                    <cue name="Ch3_Speak_Axiom330_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                      <param name="Actor"             value="$AxiomActor"/>
                                      <param name="Lines"             value="[[30252342]]"/>
                                      <param name="EndSignalCue"      value="null"/>
                                      <!--
                                        Good! Now attach an EMP bomb to the module that I highlighted for you and then detonate it!
                                      -->
                                    </cue>
                                    <cue name="HackStation_EMP_Axiom_Speak_Finished">
                                      <actions>
                                        <remove_value name="$SpeakInProgress"/>
                                        <signal_cue cue="HackStation_EMP_Update_Objective"/>
                                      </actions>
                                    </cue>
                                  </cues>
                                </cue>

                                <cue name="HackStation_EMP_Update_Objective">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <set_value name="$ObjectiveStep_1" exact="1" operation="add"/>
                                    <set_objective cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1" action="objective.launch" object="$ConnectionModule" text="{30220,3007}" updatebriefing="true" insert="true" comment="Launch: EMP to Create Signal Leak"/>
                                    <add_to_group groupname="$PlayerWeaponsGroup" list="player.ship.weapons.operational.list"/>

                                    <remove_help all="true"/>
                                    <!-- Note: 865 will only be displayed if the player is using Mouse & Keyboard as input -->
                                    <show_help_multi log="true" position="1" force="true" allowclose="true">
                                      <text line="861" comment="How to launch a Spacesuit EMP."/>
                                      <text line="862"/>
                                      <text line="863"/>
                                      <text line="864"/>
                                      <text line="865"/>
                                    </show_help_multi>
                                  </actions>
                                  <cues>

                                    <cue name="HackStation_Detonation_Hint">
                                      <conditions>
                                        <event_player_bomb_attached/>
                                        <check_value value="event.param.macro == macro.bomb_player_limpet_emp_01_mk1_macro"/>
                                        <check_value value="event.param.hascontext.{$ConnectionModule}"/>
                                      </conditions>
                                      <actions>
                                        <remove_help all="true"/>
                                        <show_help_multi log="true" width="220" position="1" force="true" allowclose="true">
                                          <text line="866" comment="How to detonate a Spacesuit EMP."/>
                                          <text line="867"/>
                                        </show_help_multi>
                                        <set_value name="$ObjectiveStep_1" exact="1" operation="add"/>
                                        <set_objective cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1" action="objective.trigger" object="event.param" updatebriefing="true" insert="true" comment="Trigger: EMP to Create Signal Leak"/>
                                      </actions>
                                    </cue>

                                    <cue name="HackStation_Wrong_Ammo">
                                      <conditions>
                                        <event_player_bomb_attached/>
                                        <check_value value="event.param.macro != macro.bomb_player_limpet_emp_01_mk1_macro"/>
                                        <check_value value="event.param.hascontext.{$ConnectionModule}"/>
                                      </conditions>
                                      <cues>
                                        <cue name="Ch3_Speak_Axiom_WrongAmmo_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                          <param name="Actor" value="$AxiomActor"/>
                                          <param name="Lines" value="[[30252343],[30252344]]"/>
                                          <param name="EndSignalCue"      value="HackStation_Wrong_Ammo_Delay"/>
                                          <!--
                                            That was the wrong type of bomb! We are not looking for structural damage.
                                            Change to EMP bombs, then try again.
                                          -->
                                        </cue>
                                        <cue name="HackStation_Wrong_Ammo_Delay">
                                          <conditions>
                                            <event_cue_signalled/>
                                          </conditions>
                                          <delay exact="20s"/>
                                          <actions>
                                            <reset_cue cue="HackStation_Wrong_Ammo"/>
                                          </actions>
                                        </cue>
                                      </cues>
                                    </cue>

                                  </cues>
                                </cue>

                                <cue name="HackStation_EMP_Check_For_WrongModule">
                                  <conditions>
                                    <event_player_created_signal_leaks/>
                                    <check_value value="event.param.{1}.parent != $ConnectionModule"/>
                                  </conditions>
                                  <cues>


                                    <cue name="Ch3_Speak_Axiom_WrongModule_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                      <param name="Actor" value="$AxiomActor"/>
                                      <param name="Lines" value="[[30252376]]"/>
                                      <param name="EndSignalCue"      value="WrongModuleReset"/>
                                      <!--
                                        Chipmunk, you need to attach the EMP to the correct module! Check your radar to see which one I highlighted for you!
                                      -->
                                    </cue>

                                    <cue name="WrongModuleReset">
                                      <conditions>
                                        <event_cue_signalled/>
                                      </conditions>
                                      <delay exact="1s"/>
                                      <actions>
                                        <reset_cue cue="HackStation_EMP_Check_For_WrongModule"/>
                                      </actions>
                                    </cue>

                                  </cues>
                                </cue>

                                <cue name="HackStation_EMP_Check_For_Breach">
                                  <conditions>
                                    <event_player_created_signal_leaks/>
                                    <check_value value="event.param.{1}.parent == $ConnectionModule"/>
                                  </conditions>
                                  <actions>
                                    <remove_help all="true"/>
                                    <cancel_cue cue="HackStation_Wrong_Ammo"/>
                                    <do_for_each in="event.param" name="$CurrentElement">
                                      <add_to_group groupname="$ConnectionModuleSignalLeaks" object="$CurrentElement"/>
                                    </do_for_each>
                                    <set_value name="$MaxLeaksCount" exact="$ConnectionModuleSignalLeaks.count"/>
                                    <set_value name="$ObjectiveStep_1" exact="1" operation="add"/>
                                    <set_value name="$ScannedCount" exact="0"/>
                                    <set_value name="$ObjectiveStep_1" exact="1" operation="add"/>
                                    <set_objective cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1" action="objective.scan" group="$ConnectionModuleSignalLeaks" text="{30220,3008}" silent="true" updatebriefing="true" comment="Scan: Signal Leak">
                                      <progress progress="$ScannedCount" max="$MaxLeaksCount"/>
                                    </set_objective>
                                  </actions>
                                  <cues>

                                    <cue name="Ch3_Axiom_ApproachLeaksHint_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                      <param name="Actor" value="$AxiomActor"/>
                                      <param name="Lines" value="[[30252345],[30252346],[30252347]]"/>
                                      <param name="EndSignalCue"      value="null"/>
                                      <!--
                                        There is nothing quite as satisfying as triggering an EMP bomb!
                                        You will see that the detonation tore created signal leaks that you can scan.
                                        Change into scan mode and approach the leak to intercept the data leaking out.
                                      -->
                                    </cue>

                                    <cue name="HackStation_Surveillance_EMP_Check_For_Further_Breaches" instantiate="true">
                                      <conditions>
                                        <event_player_created_signal_leaks/>
                                        <check_value value="event.param.{1}.hascontext.{$ConnectionModule}"/>
                                      </conditions>
                                      <actions>
                                        <do_for_each in="event.param" name="$CurrentElement">
                                          <add_to_group groupname="$ConnectionModuleSignalLeaks" object="$CurrentElement"/>
                                        </do_for_each>
                                        <set_value name="$ObjectiveStep_1" exact="1" operation="add"/>
                                        <set_objective cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1" action="objective.scan" group="$ConnectionModuleSignalLeaks" text="{30220,3008}" silent="true" updatebriefing="true" comment="Scan: Signal Leak">
                                          <progress progress="$ScannedCount" max="$MaxLeaksCount"/>
                                        </set_objective>
                                      </actions>
                                    </cue>

                                    <cue name="HackStation_Surveillance_EMP_Leaks_Destroyed">
                                      <conditions>
                                        <check_any>
                                          <check_all>
                                            <event_object_destroyed group="$ConnectionModuleSignalLeaks"/>
                                            <check_value value="$ConnectionModuleSignalLeaks.count == 1"/>
                                          </check_all>
                                          <check_all>
                                            <event_player_repaired_signal_leak/>
                                            <check_value value="$ConnectionModuleSignalLeaks.indexof.{event.param}"/>
                                          </check_all>
                                        </check_any>
                                      </conditions>
                                      <actions>
                                        <set_value name="$ObjectiveStep_1" exact="1" operation="add"/>
                                        <set_objective cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1" action="objective.launch" object="$ConnectionModule" text="{30220,3007}" updatebriefing="true" comment="Launch: EMP to Create Signal Leak"/>
                                        <reset_cue cue="HackStation_EMP_Check_For_Breach"/>
                                      </actions>
                                    </cue>

                                  </cues>
                                </cue>

                                <cue name="Ch3_1_HackStation_Signal_Unlocked" instantiate="true">
                                  <conditions>
                                    <event_player_signal_unlock_finished/>
                                    <check_value value="$ConnectionModuleSignalLeaks.indexof.{event.param} and player.ship.isclass.spacesuit"/>
                                  </conditions>
                                  <delay exact="1s"/>
                                  <actions>
                                    <do_if value="player.blueprints.{$ConnectionModule.macro.ware}.any.exists">
                                      <signal_cue cue="Ch3_1_HackStation_Hack_Finished"/>
                                    </do_if>
                                    <do_else>
                                      <set_value name="$ScannedCount" operation="add" exact="1"/>
                                      <set_objective cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1" action="objective.scan" group="$ConnectionModuleSignalLeaks" text="{30220,3008}" silent="true" updatebriefing="true" comment="Scan: Signal Leak">
                                        <progress progress="$ScannedCount" max="$MaxLeaksCount"/>
                                      </set_objective>
                                    </do_else>
                                  </actions>
                                </cue>

                                <cue name="Ch3_1_HackStation_Hack_Finished">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <cancel_cue cue="Ch3_1_HackStation_Signal_Unlocked"/>
                                    <cancel_cue cue="HackStation_Surveillance_EMP_Leaks_Destroyed" comment="If we don't cancel the check for the leaks to be destroyed, that check will trigger when they despawn later."/>
                                    <set_value name="$ObjectiveStep_1" exact="1" operation="add"/>
                                    <set_objective cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1" action="objective.wait" updatebriefing="true"/>
                                    <do_if value="ware.research_module_production.research.unlocked or ware.research_module_storage.research.unlocked or ware.research_module_dock.research.unlocked
                                           or ware.research_module_habitation.research.unlocked or  ware.research_module_build.research.unlocked">
                                      <set_value name="$BlueprintResearchCompleted"/>
                                    </do_if>
                                  </actions>
                                  <cues>

                                    <cue name="Ch3_SignalLeakExposition_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                      <param name="Actor" value="$AxiomActor"/>
                                      <param name="Lines" value="[[30252348],[30252349],[30252350],[30252351],[if $BosoTa? then null else 30252352]]"/>
                                      <param name="EndSignalCue"      value="if $BosoTa? then Ch3_1_AdditionalComment else Ch3_1_StationPatrolEncounter"/>
                                      <!--
                                        You'll notice that you now own the blueprint to this specific station module.
                                        That module can now be used in the construction of your own station.
                                        And we can also analyse the blueprint to gain a better understanding of our heist target!
                                        Unfortunately, we can currently only steal the blueprints of non-vital Connection modules this way.
                                        With enough time and resources, maybe someone could find a way to circumvent that limitation. (If no Boso)
                                      -->
                                    </cue>

                                    <cue name="Ch3_1_AdditionalComment">
                                      <conditions>
                                        <event_cue_signalled/>
                                      </conditions>
                                      <cues>

                                        <cue name="Ch3_1_ResearchComplete" onfail="cancel">
                                          <conditions>
                                            <check_value value="$BlueprintResearchCompleted?"/>
                                          </conditions>
                                          <cues>
                                            <!-- Axiom admires the player's research -->
                                            <cue name="Ch3_AxiomResearchAdmiration_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                              <param name="Actor" value="$AxiomActor"/>
                                              <param name="DelayInitial"      value="1.5s"/>
                                              <param name="Lines" value="[[30252353]]"/>
                                              <param name="EndSignalCue"      value="Ch3_1_StationPatrolEncounter"/>
                                              <!--
                                                But it actually seems like you are already way ahead of me on that one. Incredible, the disciple is teaching the master for once!
                                              -->
                                            </cue>
                                          </cues>
                                        </cue>

                                        <cue name="Ch3_1_ResearchAvailable" onfail="cancel">
                                          <conditions>
                                            <check_value value="not $BlueprintResearchCompleted?"/>
                                          </conditions>
                                          <cues>
                                            <!-- Boso points out the research potential to the player -->
                                            <cue name="Ch3_Boso_ResearchComment_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                              <param name="Actor"             value="$BosoTa"/>
                                              <param name="DelayInitial"      value="1s"/>
                                              <param name="Lines"             value="[[30252301],[30252302]]"/>
                                              <param name="EndSignalCue"      value="Ch3_1_StationPatrolEncounter"/>
                                              <!--
                                                Assistant! I might have found a way to rectify this issue!
                                                Given the right research I could probably enhance the range of module blueprints you could steal.
                                              -->
                                            </cue>
                                          </cues>
                                        </cue>


                                      </cues>
                                    </cue>

                                  </cues>
                                </cue>

                              </cues>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <!-- The player is confronted by a station patrol. A little bit of funny dialogue back and forth-->
                <cue name="Ch3_1_StationPatrolEncounter">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <!-- Axiom warns the player of incoming patrol -->
                    <cue name="Ch3_PatrolWarning_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor" value="$AxiomActor"/>
                      <param name="Lines" value="[[30252354], [30252355]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                        Curses! The security breach seems to have triggered a silent alarm on the station.
                        Someone is headed your way!
                      -->
                    </cue>

                    <cue name="Ch3_Patrol_Setup">
                      <delay exact="6s"/>
                      <actions>
                        <create_cue_actor name="$StationPatrolActor" cue="namespace">
                          <select race="race.teladi" faction="faction.teladi" />
                          <page exact="10560"/>
                          <owner exact="$BlueprintHackStation.owner"/>
                          <skills>
                            <skill type="management"  exact="4"/>
                            <skill type="morale"      exact="8"/>
                            <skill type="piloting"    exact="14"/>
                            <skill type="engineering" exact="12"/>
                            <skill type="boarding"    exact="8"/>
                          </skills>
                        </create_cue_actor>
                        <set_entity_traits entity="$StationPatrolActor" missionactor="true" customhandler="true" subtitlename="true"/>
                        <set_value name="$StationPatrolActorCutsceneKey"   exact="table[ $key = 'ShowNPCFace']"/>
                        <set_value name="$StationPatrolActor.$cutscenekey" exact="table[ $key = 'ShowNPCFace']"/>


                        <get_ship_definition reference="$PatrolShipDef" size="class.ship_s" faction="faction.teladi" tags="tag.military"/>

                        <create_ship name="$StationPatrolShip" sector="$BlueprintHackStation.sector" commandeerable="false" capturable="false" missioncue="namespace" ref="$PatrolShipDef">
                          <owner exact="$BlueprintHackStation.owner" overridenpc="true"/>
                          <pilot actor="$StationPatrolActor"/>
                          <safepos object="player.entity" min="1km" max="2.4km" radius="200m"/>
                        </create_ship>

                        <create_position name="$PlayerProximitySafePos" object="$PlayerShip" y="80m" z="30m" space="$PlayerShip.sector"/>

                        <create_position name="$PlayerSpacesuitPosition" space="$BlueprintHackStation.sector" object="player.container"/>

                        <cancel_all_orders object="$StationPatrolShip"/>

                        <create_order id="'MoveGeneric'" object="$StationPatrolShip">
                          <param name="destination" value="player.entity.sector"/>
                          <param name="position" value="$PlayerProximitySafePos"/>
                          <param name="lookat" value="$PlayerSpacesuitPosition"/>
                          <param name="noboost" value="true"/>
                          <param name="precise" value="true"/>
                        </create_order>
                        <create_order object="$StationPatrolShip" id="'Wait'"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_PatrolInteraction">
                      <conditions>
                        <event_cue_completed cue="Ch3_Patrol_Setup"/>
                      </conditions>
                      <delay exact="3s"/>
                      <actions>
                        <fade_screen fadeout="0.5s" fadein="0s" realtime="true"/>
                      </actions>
                      <delay exact="0.5s"/>
                      <actions>
                        <!-- Cutscene for added dramatic flair, and to rotate the player -->
                        <set_value name="$PlayerSpacesuit" exact="player.container"/>
                        <fade_screen fadeout="0s" fadein="1.5s" realtime="true"/>
                        <play_cutscene result="parent.$CutsceneID" key="'Story_Criminal_Ch3_Station_Patrol'" targetmonitor="false" abortable="true">
                          <param name="target_ship" object="$StationPatrolShip"/>
                          <param name="player_spacesuit" object="$PlayerSpacesuit"/>
                        </play_cutscene>
                        <force_player_speed speed="0"/>
                      </actions>
                      <cues>

                        <cue name="Ch3_1_CutsceneStarted">
                          <conditions>
                            <event_cutscene_started key="'Story_Criminal_Ch3_Station_Patrol'"/>
                          </conditions>
                          <delay exact="5s"/>
                          <actions>
                            <warp object="$PlayerSpacesuit" zone="$PlayerShip.zone">
                              <orientation orientation="look_at" refobject="$PlayerShip"/>
                              <position value="$PlayerSpacesuit.position"/>
                            </warp>
                          </actions>
                          <cues>

                            <cue name="Ch3_1_CutsceneEnded">
                              <conditions>
                                <event_cutscene_stopped key="'Story_Criminal_Ch3_Station_Patrol'"/>
                              </conditions>
                              <actions>
                                <warp object="$PlayerSpacesuit" zone="player.entity.zone">
                                  <orientation orientation="look_at" refobject="$StationPatrolShip"/>
                                  <position value="$PlayerSpacesuit.position"/>
                                </warp>
                                <remove_value name="$PlayerSpacesuit"/>
                                <set_value name="$ObjectiveStep_1" exact="1" operation="add"/>
                                <set_objective cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1" action="objective.observe" object="$StationPatrolShip" updatebriefing="true"/>
                              </actions>
                            </cue>

                          </cues>
                        </cue>

                        <!-- Station Guard calls out to player, Axiom responds -->
                        <!-- TODO: Line timing very important here to allow the player to follow along -->
                        <cue name="Ch3_1_StationPatrol_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$StationPatrolActor, $AxiomActor,$AxiomActor, $StationPatrolActor, $AxiomActor]"/>
                          <param name="Lines"             value="[[[30252301],[30252302]],
                                                                  [[30252356],[30252357, 1s],[30252358],[30252359, 1.5s]],
                                                                  [[30252360],[30252361],[30252362],[30252363],[30252364],[30252365],[30252366]],
                                                                  [[30252303],[30252304]],
                                                                  [[30252367],[30252368, 1s],[30252369]]]"/>
                          <param name="EndSignalCue"      value="[null, null, Ch3_1_PatrolDisengages, Ch3_1_EmbarkShip, null]"/>
                          <!--
                          Guard
                            You! Stop right there! What are you doing here?
                            There has been a breach in security! Explain yourself!
                          Axiom
                            Oh, that is not good at all. Hold on, I am trying something...
                            Accessing the station mainframe... running counter-security routine... entering...
                            *** Incoherent mumbling ***
                            Yeah!
                          Axiom
                            Salutations, station patrol!
                            I am Aimanckuvaik, evangelist diplomat in the services of the Holy Godrealm of the Paranid!
                            I shall forward you the identification issued by the hallowed authority presently!
                            Why in the name of the holy three-dimensionality are you accosting my personal escort?
                            I sent for transportation to take me off of your heathen station!
                            Talks between our peoples have not gone well at all already.
                            By the divine triangle, do not turn this into a full-blown diplomatic incident just because in your endless incompetence you held up the wrong chauffeur!
                          Guard
                            Um, very well then... The identification checks out.
                            Your pilot may move on! Apologies for the inconvenience!
                          Axiom
                            *** Sigh of relief ***
                            That was too close to comfort!
                            Better pick me up and take me off this station right away, that identification will not hold up to any scrutiny.
                          -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch3_1_PatrolDisengages">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="5s"/>
                      <actions>
                        <cancel_all_orders object="$StationPatrolShip"/>
                        <create_order object="$StationPatrolShip" id="'MoveDie'" immediate="true">
                          <param name="mintime" value="60s" comment="stay alive for specified time, after it docks"/>
                        </create_order>
                      </actions>
                    </cue>

                    <cue name="Ch3_1_EmbarkShip">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="@player.controlled.isclass.spacesuit">
                          <set_value name="$ObjectiveStep_1" exact="1" operation="add"/>
                          <set_objective cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1" action="objective.embark" object="$PlayerShip" text="$PlayerShip.name" updatebriefing="true"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch3_1_PickUpAxiom"/>
                          <cancel_cue cue="Ch3_1_EmbarkShip"/>
                        </do_else>
                      </actions>
                      <cues>
                        <cue name="Ch3_1_ShipEmbarked">
                          <conditions>
                            <event_object_changed_object object="player.entity"/>
                            <check_value value="event.param.isclass.ship and (event.param.owner == faction.player)"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch3_1_PickUpAxiom"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch3_1_PickUpAxiom">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep_1" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1" action="objective.dockat" object="$BlueprintHackStation" updatebriefing="true"/>
                      </actions>
                      <cues>

                        <cue name="Ch3_1_Docked">
                          <conditions>
                            <event_object_docked_at container="$BlueprintHackStation" />
                            <check_value value="global.$PlayerContainerGroup.indexof.{event.param}"/>
                            <check_value value="event.param.isclass.ship"/>
                          </conditions>
                          <actions>
                            <set_value name="$AxiomTaxiShip" exact="event.param"/>
                            <set_value name="$TaxiFailsafeDelay" exact="1min"/>

                            <set_value name="$ObjectiveStep_1" exact="1" operation="add"/>
                            <set_objective cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1" action="objective.await" object="$AxiomActor" endtime="player.age + $TaxiFailsafeDelay" updatebriefing="true"/>
                          </actions>
                          <cues>

                            <!-- Axiom tells the player to get out of there -->
                            <cue name="Ch3_AxiomPickUp_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor" value="$AxiomActor"/>
                              <param name="Lines" value="[[30252370]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                There you are!
                              -->
                            </cue>

                            <!-- Move Axiom to the player's ship. -->
                            <cue name="Ch3_1_Move_Axiom_To_Ship">
                              <conditions>
                                <event_npc_slots_validated object="$BlueprintHackStation"/>
                              </conditions>
                              <actions>
                                <!-- Make NPC walk to selected ship. As their destination slot is a NPC transport slot, they will become 'hidden' on arrival. They will continue to exist. -->
                                <find_npc_waypoint name="this.$DespawnWaypoints" object="$AxiomTaxiShip" tags="tag.npctransport" multiple="true"/>
                                <assert value="this.$DespawnWaypoints.count" text="'No waypoints on ' + $AxiomTaxiShip + ' ' + $AxiomTaxiShip.knownname + ' tagged ' + tag.npctransport + '. No place to despawn passengers.'"/>
                                <do_if value="$AxiomTaxiShip.people.free">
                                  <debug_text text="'Attempting to add ' + $AxiomActor + ' to ' + $AxiomTaxiShip + ' ' +$AxiomTaxiShip.knownname + ' as a passenger'" chance="$DebugChance"/>
                                  <create_npc_template name="$AxiomPassengerTemplate" object="$AxiomTaxiShip" entity="$AxiomActor" role="entityrole.passenger"/>
                                  <assert value="$AxiomPassengerTemplate" text="'Attempted to add Axiom to the selected ship but it failed.'"/>
                                </do_if>
                                <do_else>
                                  <debug_text text="$AxiomTaxiShip + ' ' +$AxiomTaxiShip.knownname + ' does not have free passenger slots. Pretend that Axiom gets on it anyway.'" chance="$DebugChance"/>
                                </do_else>

                                <!-- Make Axiom despawn, no matter if a template got created or not. -->
                                <do_if value="this.$DespawnWaypoints.count">
                                  <set_value name="$MovementTable" exact="table[$slot = this.$DespawnWaypoints.random]" />
                                  <signal_objects object="$AxiomActor" param="'npc_move_to'" param2="$MovementTable.clone"/>
                                </do_if>
                                <do_else>
                                  <assert value="this.$DespawnWaypoints.count" text="'No despawn waypoint for Axiom was found on the selected ship ' + $AxiomTaxiShip + ' ' + $AxiomTaxiShip.macro.id + '. Mission will continue after timer runs out.'"/>
                                  <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $AxiomActor, $MissionCue]"/>
                                </do_else>
                              </actions>
                            </cue>

                            <cue name="Ch3_1_Axiom_On_Board">
                              <conditions>
                                <event_object_changed_object object="$AxiomActor" newobject="$AxiomTaxiShip"/>
                                <check_value value="Ch3_1_ReturnToAE.state == cuestate.waiting"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch3_1_ReturnToAE"/>
                              </actions>
                            </cue>

                            <!-- After a few seconds, progress the mission, because Axiom apparently hasn't managed to get on the ship. -->
                            <cue name="Ch3_1_Taxi_Failsafe_Delay">
                              <delay exact="$TaxiFailsafeDelay"/>
                              <actions>
                                <do_if value="Ch3_1_ReturnToAE.state == cuestate.waiting">
                                  <signal_cue cue="Ch3_1_ReturnToAE"/>
                                </do_if>
                              </actions>
                            </cue>

                            <!-- If the player undocks, progress the mission, even if Axiom hasn't made it to the ship. The script would get messy otherwise, and we don't have the voice lines needed. -->
                            <cue name="Ch3_1_Taxi_Failsafe_Undock">
                              <conditions>
                                <event_object_undocked_from container="$BlueprintHackStation"/>
                                <check_value value="global.$PlayerContainerGroup.indexof.{event.param}"/>
                                <check_value value="event.param.isclass.ship"/>
                                <check_value value="Ch3_1_ReturnToAE.state == cuestate.waiting"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch3_1_ReturnToAE"/>
                              </actions>
                            </cue>
                            
                            <cue name="Ch3_1_Taxi_Destroyed" version="2">
                              <conditions>
                                <check_any>
                                  <event_object_destroyed object="$AxiomTaxiShip"/>
                                  <event_object_changed_true_owner object="$AxiomTaxiShip"/>
                                </check_any>
                                <check_value value="Ch3_1_DockedAtAE.state == cuestate.waiting"/>
                              </conditions>
                              <actions>
                                <remove_npc_template template="$AxiomPassengerTemplate" object="$AxiomTaxiShip"/>
                                <signal_cue cue="Ch3_1_DockedAtAE"/>
                              </actions>
                              <patch sinceversion="2">
                                <signal_cue cue="Ch3_1_DockedAtAE"/>
                              </patch>
                            </cue>

                            <cue name="Ch3_1_ReturnToAE">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_value name="$ObjectiveStep_1" exact="1" operation="add"/>
                                <set_objective cue="$MissionCue_Ch3_Blueprint" step="$ObjectiveStep_1" action="objective.dockat" object="$RaiderHubShip" updatebriefing="true"/>
                              </actions>
                              <cues>

                                <!-- Ships M and up cannot actually dock at the specified ship, so we have to add additional handling (sends a transfer pod when in range) -->
                                <cue name="Ch3_1_ShipSizeCheck" onfail="cancel">
                                  <conditions>
                                    <check_value value="not $AxiomTaxiShip.isclass.ship_s"/>
                                  </conditions>
                                  <cues>
                                    
                                    <cue name="Ch3_1_ProximityChecks" checkinterval="1s">
                                      <conditions>
                                        <check_value value="player.ship == $AxiomTaxiShip"/>
                                        <check_value value="$AxiomTaxiShip.sector == $RaiderHubShip.sector and player.ship.distanceto.{$RaiderHubShip} le 6km"/>
                                      </conditions>
                                      <actions>
                                        <create_ship name="$TransferPod" sector="$AxiomTaxiShip.sector" macro="ship_gen_xs_escapepod_01_a_macro" >
                                          <owner exact="faction.civilian"/>
                                          <pilot>
                                            <select race="race.argon" tags="tag.aipilot"/>
                                          </pilot>
                                          <safepos object="$AxiomTaxiShip" y="-1km"/>
                                        </create_ship>
                                        <set_object_name object="$TransferPod" page="20101" line="110301"/>
                                        <set_objective cue="$MissionCue_Ch3_Blueprint" action="objective.wait" object="$TransferPod"/>

                                        <cancel_all_orders object="$TransferPod"/>
                                        <create_order id="'DockAndWait'" object="$TransferPod" immediate="true">
                                          <param name="destination" value="$RaiderHubShip" comment="stay docked"/>
                                        </create_order>
                                        <set_object_min_hull object="$TransferPod" exact="100"/>
                                        <signal_cue_instantly cue="Ch3_1_CapsuleListener"/>
                                      </actions>
                                      <!-- This all is purely cosmetic, so add a fallback that signals either way, and cleans up the pod -->
                                      <delay exact="120s"/>
                                      <actions>
                                        <destroy_object object="$TransferPod" explosion="false"/>
                                        <do_if value="Ch3_1_DockedAtAE.state == cuestate.waiting">
                                          <signal_cue cue="Ch3_1_DockedAtAE"/>
                                        </do_if>
                                      </actions>
                                    </cue>

                                    <cue name="Ch3_1_CapsuleListener">
                                      <conditions>
                                        <event_cue_signalled/>
                                      </conditions>
                                      <cues>
                                        <cue name="Ch3_CapsuleDocked">
                                          <conditions>
                                            <event_object_docked_at container="$RaiderHubShip"/>
                                            <check_value value="event.param == $TransferPod"/>
                                          </conditions>
                                          <actions>
                                            <signal_cue cue="Ch3_1_DockedAtAE"/>
                                          </actions>
                                        </cue>
                                      </cues>
                                    </cue>
                                    
                                  </cues>
                                </cue>

                                <cue name="Ch3_AxiomOnBoard_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor" value="$AxiomActor"/>
                                  <param name="Lines" value="[[30252371]]"/>
                                  <param name="Cutscene"          value="false"/>
                                  <param name="EndSignalCue"      value="null"/>
                                  <!--
                                    Let's get out of here! I feel like our little performance could catch up to us any second!
                                  -->
                                </cue>

                                <cue name="Ch3_1_DockedAtAE">
                                  <conditions>
                                    <check_any>
                                      <check_all>
                                        <event_object_docked_at container="$RaiderHubShip" />
                                        <check_value value="global.$PlayerContainerGroup.indexof.{event.param}"/>
                                        <check_value value="event.param.isclass.ship"/>
                                      </check_all>
                                      <event_cue_signalled/>
                                    </check_any>
                                  </conditions>
                                  <actions>
                                    <do_if value="(event.param == $AxiomTaxiShip) and $AxiomPassengerTemplate?">
                                      <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $AxiomActor, $MissionCue]"/>
                                      <signal_cue_instantly cue="md.NPC_Missions.Disembark_Passenger" param="table[ $passenger = $AxiomActor,
                                                                                                                    $object = $AxiomTaxiShip,
                                                                                                                    $debugchance = 0]"/>
                                    </do_if>

                                    <do_else>
                                      <do_if value="$AxiomTaxiShip.isoperational and $AxiomPassengerTemplate?">
                                        <remove_npc_template template="$AxiomPassengerTemplate" object="$AxiomTaxiShip"/>
                                      </do_if>
                                      <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $AxiomActor, $MissionCue]"/>
                                      <signal_objects object="$AxiomActor" param="'npc_state_reinit'"/>
                                      <signal_cue cue="Ch3_PlaceAxiomActor"/>
                                    </do_else>

                                    <set_entity_traits entity="$AxiomActor" hidden="false"/>
                                  </actions>
                                  <cues>

                                    <!-- Axiom thanks the player for the lift -->
                                    <cue name="Ch3_AxiomThanks_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                      <param name="Actor" value="$AxiomActor"/>
                                      <param name="Lines" value="[[30252372], [30252373], [30252374]]"/>
                                      <param name="EndSignalCue"      value="Ch3_1_Cleanup_v2"/>
                                      <!--
                                        Thank you for the lift!
                                        That was quite an exciting turn of events.
                                        But now at least we have the blueprint we need gain an insight into internal  station geometry!
                                      -->
                                    </cue>

                                  </cues>
                                </cue>

                              </cues>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_1_Cleanup_v2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch3_PlaceAxiomActor"/>

                    <!-- Clean up police ship. -->
                    <do_if value="$StationPatrolShip? and $StationPatrolShip.isoperational">
                      <cancel_all_orders object="$StationPatrolShip"/>
                      <find_dockingbay groupname="$BlueprintHackStationDockingAreas" object="$BlueprintHackStation" checkoperational="true" multiple="true">
                        <match_dock size="tag.dock_s"/>
                      </find_dockingbay>
                      <do_if value="$BlueprintHackStationDockingAreas.count">
                        <create_order id="'MoveDie'" object="$StationPatrolShip">
                          <param name="atstation" value="$BlueprintHackStation"/>
                        </create_order>
                      </do_if>
                      <do_else>
                        <create_order id="'MoveDie'" object="$StationPatrolShip"/>
                      </do_else>
                    </do_if>

                    <remove_mission cue="$MissionCue_Ch3_Blueprint" type="completed"/>
                    <remove_from_list name="$Ch3_Missions" exact="$MissionCue_Ch3_Blueprint"/>

                    <signal_cue cue="Ch3_FinishCheck"/>
                    <cancel_cue cue="Ch3_1_BlueprintTheft"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch3_2_BoardTradeShip">
              <actions>
                <set_value name="$ObjectiveStep_2" exact="1"/>
                <set_value name="$MissionCue_Ch3_Boarding" exact="this"/>

                <set_value name="$RequiredMarineCount" exact="2" comment="The smallest ships have a crew capacity of 2."/>

                <create_mission cue="$MissionCue_Ch3_Boarding" name="{30252,3301}" description="{30252,3302}" rewardtext="{30252,3320}" type="missiontype.plot" faction="faction.civilian" difficulty="level.medium" abortable="false" icon="'briefing_ace_01'" iconcaption="$AceActor.knownname" missionthread="$MissionCue" activate="false">
                  <briefing>
                    <objective step="1" action="objective.comm" object="$AceActor.ship" text="$AceActor.name"/>
                  </briefing>
                </create_mission>
                <set_objective_from_briefing cue="$MissionCue_Ch3_Boarding" step="1"/>
              </actions>
              <cues>

                <cue name="Ch3_2_Comm_Hint">
                  <conditions>
                    <event_player_changed_target target="$AceActor.ship"/>
                    <check_value value="not $Ch3_AceBriefing?"/>
                  </conditions>
                  <actions>
                    <show_help line="841" log="true" position="1" force="true" comment="To talk to a ship's pilot, right click on the ship and select COMM from the context menu.('Comm' same as {1010,4})" allowclose="true" timeout="false"/>
                  </actions>
                </cue>

                <cue name="Ch3_2_Ace_Conversation" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$AceActor"/>
                      <event_conversation_next_section actor="$AceActor" section="conv_continue"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="event.name == 'event_conversation_started'">
                      <remove_help all="true"/>
                      <do_if value="@player.ship.trueowner == faction.player">
                        <set_value name="$PlayerShipMarinesCount" exact="player.ship.people.{entityrole.marine}.count"/>
                      </do_if>
                      <do_else>
                        <set_value name="$PlayerShipMarinesCount" exact="0"/>
                      </do_else>

                      <do_if value="not $Ch3_AceBriefing?">
                        <add_npc_line speaker="$AceActor" hidechoices="true">
                          <text line="30252301" comment="Chipmunk! Jolly good to see you!"/>
                          <text line="30252302" comment="The Maestro has already let you know that everyone is now working on a bigger heist, right?"/>
                          <text line="30252303" comment="Well, it falls on us to procure an inconspicuous trade ship."/>
                          <text line="30252304" comment="You probably already figured out what comes next..."/>
                          <text line="30252305" delay="1s" comment="Boarding!"/>
                          <text line="30252306" delay="1s" comment="In order to efficiently conduct a boarding operation, you need marines aboard your ship."/>
                        </add_npc_line>

                        <do_if value="$PlayerShipMarinesCount ge $RequiredMarineCount" comment="Player's marines are strong enough.">
                          <add_npc_line line="30252308" delay="1s" comment="I can see that you already have a group of capable pirates in your employ!"/>

                          <add_player_choice text="{30252,30252303}" section="conv_continue" comment="" position="bottom_right" highlighted="true"/>
                        </do_if>
                        <do_else>
                          <add_npc_line line="30252307" comment="Return to me once you have hired a contingent of capable marines!"/>
                        </do_else>

                        <set_value name="$Ch3_AceBriefing"/>
                      </do_if>
                      <do_else>
                        <do_if value="Ch3_2_BoardShip.state == cuestate.waiting">
                          <do_if value="$PlayerShipMarinesCount ge $RequiredMarineCount" comment="Player's marines are strong enough.">
                            <add_npc_line speaker="$AceActor" hidechoices="true">
                              <text line="30252301" comment="Chipmunk! Jolly good to see you!"/>
                              <text line="30252310" comment="Did you manage to assemble an outfit of marines?"/>
                            </add_npc_line>

                            <add_player_choice text="{30252,30252303}" section="conv_continue" comment="" position="bottom_right" highlighted="true"/>
                          </do_if>
                          <do_else>
                            <add_npc_line speaker="$AceActor" hidechoices="true">
                              <text line="30252301" comment="Chipmunk! Jolly good to see you!"/>
                              <text line="30252306" comment="In order to efficiently conduct a boarding operation, you need marines aboard your ship."/>
                              <text line="30252307" comment="Return to me once you have hired a contingent of capable marines!"/>
                            </add_npc_line>
                          </do_else>
                        </do_if>
                        <do_elseif value="event.param != 'DeliverFleet_TransferOwnership'">
                          <add_npc_line speaker="$AceActor" hidechoices="true">
                            <text line="30252329" comment="Yo, ho! Yo, ho! A pirate's life for me!"/>
                          </add_npc_line>
                        </do_elseif>
                      </do_else>
                    </do_if>
                    <do_else comment="event_conversation_next_section">
                      <add_npc_line speaker="$AceActor" hidechoices="true">
                        <text line="30252311" comment="Excellent. Let's go!"/>
                      </add_npc_line>
                      <signal_cue cue="Ch3_2_BoardShip"/>
                      <activate_mission cue="$MissionCue_Ch3_Boarding"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch3_2_Ace_Marine_Hint">
                  <conditions>
                    <event_speak_line_finished actor="$AceActor" line="30252307" comment="unreliable but the conversation can be restarted"/>
                  </conditions>
                  <actions>
                    <remove_help all="true" />
                    <show_help line="851" position="1" allowclose="true" force="true" log="true" timeout="false" comment="Your mission briefing now contains information about hiring Marines." />

                    <!-- Stitch together original briefing with required marine count and hints about hiring marines. -->
                    <substitute_text text="$Ch3_2_MarineRequirementText" source="readtext.{30252}.{3305}">
                      <replace string="'$COUNT$'" with="$RequiredMarineCount"/>
                    </substitute_text>
                    <set_value name="$Ch3_2_Description" exact="{30252,3302} + '\n\n' + $Ch3_2_MarineRequirementText + '\n\n' + {30252,3303} + ' ' + {30252,3304}"/>
                    <update_mission cue="$MissionCue_Ch3_Boarding" description="$Ch3_2_Description"/>

                    <substitute_text text="$Ch3_2_HireMarinesObjectiveText" source="readtext.{30252}.{3310}">
                      <replace string="'$COUNT$'" with="$RequiredMarineCount"/>
                    </substitute_text>
                    <set_value name="$ObjectiveStep_2" operation="add" exact="1"/>
                    <set_objective step="$ObjectiveStep_2" cue="$MissionCue_Ch3_Boarding" action="objective.custom" customaction="$Ch3_2_HireMarinesObjectiveText" object="$AceActor.ship" updatebriefing="true"/>
                  </actions>
                </cue>

                <cue name="Ch3_2_BoardShip_Reset_Helper" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue cue="Ch3_2_BoardShip"/>
                  </actions>
                </cue>

                <cue name="Ch3_2_BoardShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch3_2_CreateTarget">
                      <actions>
                        <create_loadout result="$Ch3_BoardShip_Loadout">
                          <macros>
                            <engine macro="engine_tel_l_allround_01_mk1_macro" path="../con_engine_03"/>
                            <engine macro="engine_tel_l_allround_01_mk1_macro" path="../con_engine_02"/>
                            <engine macro="engine_tel_l_allround_01_mk1_macro" path="../con_engine_01"/>
                            <!--<shield macro="shield_tel_l_standard_01_mk1_macro" path="../con_shield_l_001"/>
                            <shield macro="shield_tel_l_standard_01_mk1_macro" path="../con_shield_l_003"/>
                            <shield macro="shield_tel_l_standard_01_mk1_macro" path="../con_shield_l_002"/>-->
                          </macros>
                          <groups>
                            <turrets macro="turret_tel_m_laser_02_mk1_macro" path=".." group="group_back_top_right"/>
                            <turrets macro="turret_tel_m_laser_02_mk1_macro" path=".." group="group_back_top_left"/>
                            <turrets macro="turret_tel_m_laser_02_mk1_macro" path=".." group="group_back_bottom_center"/>
                          </groups>
                          <ammunition>
                            <unit macro="ship_gen_xs_cargodrone_empty_01_a_macro" exact="2"/>
                          </ammunition>
                          <software>
                            <software ware="software_dockmk1"/>
                            <software ware="software_flightassistmk1"/>
                            <software ware="software_scannerlongrangemk1"/>
                            <software ware="software_scannerobjectmk1"/>
                            <software ware="software_trademk1"/>
                          </software>
                          <virtualmacros>
                            <thruster macro="thruster_gen_l_allround_01_mk1_macro"/>
                          </virtualmacros>
                        </create_loadout>

                        <create_ship name="$Ch3_BoardShip" capturable="false" missioncue="$MissionCue" macro="ship_tel_l_trans_container_01_a_macro" sector="$18Bil_Sector" commandeerable="false">
                          <owner exact="faction.teladi" overridenpc="true"/>
                          <loadout loadout="$Ch3_BoardShip_Loadout"/>
                          <pilot ref="fighter_teladi_random_rookie"/>
                          <people>
                            <fillpercent exact="1"/>
                            <person role="service" ref="service_teladi_random_rookie"/>
                          </people>
                          <safepos object="$18Bil_Sector" value="position.[-95764.445313m, -80km, -15492.912109m]"/>
                        </create_ship>
                        <set_object_name object="$Ch3_BoardShip" page="30252" line="207" comment="Iron Vulture"/>
                        <set_value name="$Ch3_BoardShip.pilot.$donotscan" comment="prevents police from scanning the ship"/>
                        <set_value name="$Ch3_BoardShip.pilot.$donotplunder" comment="prevents police from scanning the ship"/>

                        <set_object_min_hull object="$Ch3_BoardShip" exact="10"/>

                        <create_order id="'Wait'" object="$Ch3_BoardShip" default="true">
                          <param name="fidget" value="true"/>
                          <param name="noattackresponse" value="true"/>
                        </create_order>

                        <create_order object="$AceShip" id="'Follow'" immediate="true">
                          <param name="target" value="$Ch3_BoardShip"/>
                        </create_order>
                      </actions>
                      <cues>

                        <!-- If the ship gets destroyed before the player has successfully boarded and delivered it, reset the entire mission to this point. -->
                        <cue name="Ch3_2_Ship_Destroyed">
                          <conditions>
                            <event_object_destroyed object="$Ch3_BoardShip"/>
                            <check_value value="Ch3_2_CleanUp.state == cuestate.waiting"/>
                          </conditions>
                          <actions>
                            <reset_cue cue="Ch3_2_BoardShip"/>
                            <signal_cue cue="Ch3_2_BoardShip_Reset_Helper"/>
                          </actions>
                        </cue>

                        <!-- Prevent relation drop for this specific boarding operation. One of the hints explains that it's an exception. -->
                        <cue name="Ch3_2_Prevent_Relation_Drop">
                          <conditions>
                            <event_object_attacked object="$Ch3_BoardShip"/>
                            <check_value value="event.param.trueowner == faction.player"/>
                            <check_value value="Ch3_2_ShipBoarded_Player.state == cuestate.waiting"/>
                          </conditions>
                          <actions>
                            <set_relation_boost object="$Ch3_BoardShip" faction="faction.player" value="-1" decay="0"/>
                            <set_object_relation_behaviour object="$Ch3_BoardShip" disable="true"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch3_2_BoardShipObjective">
                      <conditions>
                        <event_cue_completed cue="Ch3_2_CreateTarget"/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep_2" operation="add" exact="1"/>
                        <set_objective step="$ObjectiveStep_2" cue="$MissionCue_Ch3_Boarding" action="objective.flyto" object="$Ch3_BoardShip" updatebriefing="true"/>
                      </actions>
                      <cues>

                        <cue name="Ch3_2_BoardShip_DistanceCheck" checkinterval="1s">
                          <conditions>
                            <check_value value="(player.sector == $Ch3_BoardShip.sector) and (player.entity.distanceto.{$Ch3_BoardShip} le 6km)"/>
                          </conditions>
                          <actions>
                            <set_object_capturable object="$Ch3_BoardShip" capturable="true"/>
                            <set_object_hull_unrepairable object="$Ch3_BoardShip" unrepairable="true"/>
                            <find_object_component groupname="$RepairableComponents" object="$Ch3_BoardShip" class="[class.turret, class.engine]" multiple="true"/>
                            <do_for_each in="$RepairableComponents" name="$Component">
                              <set_object_hull_unrepairable object="$Component" unrepairable="true"/>
                            </do_for_each>

                            <set_value name="$ObjectiveStep_2" operation="add" exact="1"/>
                            <set_objective step="$ObjectiveStep_2" cue="$MissionCue_Ch3_Boarding" action="objective.scan" object="$Ch3_BoardShip" updatebriefing="true"/>
                          </actions>
                          <cues>

                            <cue name="Ch3_Ace_Boardship_Proximity_ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor" value="$AceActor"/>
                              <param name="Lines" value="[[30252312],[30252313],[30252314]]"/>
                              <param name="EndSignalCue"      value="Ch3_BoardShip_Scan_Hint"/>
                              <!--
                                That is the ship the Maestro picked out as suitable.
                                How about you fly closer and scan it?
                                That way we can get a better idea of what we are dealing with here!
                              -->
                            </cue>

                            <cue name="Ch3_BoardShip_Scan_Hint">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <remove_help all="true" />
                                <show_help_multi allowclose="true" position="1" log="true" force="true">
                                  <text line="15101" comment="Target the ship and activate SCAN MODE."/>
                                  <text line="15112" comment="Fly close to the target and select SCAN from the context menu."/>
                                  <text line="if player.input.controller then 2122 else 2121" comment="Interact menus can be opened by pressing X on the gamepad. / Interact menus can be opened by clicking with the Right Mouse Button."/>
                                  <text line="15111" comment="Keep ship close and in front to succeed."/>
                                  <text line="15114" comment="If the ship is moving away from you, press $INPUT_STATE_MATCH_SPEED$ to match speed with the ship you are pursuing."/>
                                </show_help_multi>
                              </actions>
                            </cue>

                            <cue name="Ch3_2_Boarding_Started_Prematurely">
                              <conditions>
                                <event_boarding_triggered faction="faction.player" target="$Ch3_BoardShip"/>
                              </conditions>
                              <cues>

                                <cue name="Ch3_Ace_Boarding_Started_Prematurely_ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor" value="$AceActor"/>
                                  <param name="Lines" value="[[30252320]]"/>
                                  <param name="EndSignalCue"      value="null"/>
                                  <!--
                                    Oh! You want to send your marines without weakening the trader first? Okay then...
                                  -->
                                </cue>

                              </cues>
                            </cue>

                            <cue name="Ch3_2_BoardShip_Scanned">
                              <conditions>
                                <event_scan_finished scanned="$Ch3_BoardShip" scanner="player.ship"/>
                              </conditions>
                              <actions>
                                <remove_help all="true"/>
                              </actions>
                              <cues>

                                <cue name="Ch3_Ace_Boardship_ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor" value="$AceActor"/>
                                  <param name="Lines" value="[[30252315],[30252316],[30252317]]"/>
                                  <param name="EndSignalCue"      value="Ch3_2_DestroyTurrets"/>
                                  <!--
                                    After the scan you see how many crew members are aboard the ship.
                                    That, and the ship's general state will give you a good idea of how much of a challenge boarding will be.
                                    This trader her looks to be sufficiently weak. We will not need too many marines to make it ours!
                                  -->
                                </cue>

                              </cues>
                            </cue>

                            <cue name="Ch3_2_DestroyTurrets">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <delay exact="0.1s"/>
                              <actions>
                                <!-- The ship only has 3 turrets and 3 engines right now. If you change the loadout, consider adjusting the "sortlimit" attribute. -->
                                <find_object_component groupname="$TargetComponents" object="$Ch3_BoardShip" class="class.turret" multiple="true" sortlimit="3" sortbydistanceto="player.ship"/>
                                <find_object_component groupname="$TargetComponents" object="$Ch3_BoardShip" class="class.engine" multiple="true" sortlimit="3" sortbydistanceto="player.ship"/>
                                <set_value name="$ObjectiveStep_2" operation="add" exact="1"/>
                                <set_objective step="$ObjectiveStep_2" cue="$MissionCue_Ch3_Boarding" action="objective.destroy" group="$TargetComponents" updatebriefing="true"/>
                              </actions>
                              <cues>

                                <cue name="Ch3_Ace_DestroyTurrets_ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor" value="$AceActor"/>
                                  <param name="Lines" value="[[30252318],[30252319]]"/>
                                  <param name="EndSignalCue"      value="null"/>
                                  <!--
                                    First of all, we need to disable the engines and turrets, so that the trader is completely at our mercy!
                                    The worse off the trader, the better your chances at a successful boarding!
                                  -->
                                </cue>

                                <cue name="Ch3_2_DestroyTurretsRML">
                                  <conditions>
                                    <event_cue_completed cue="Ch3_2_DestroyTurrets"/>
                                  </conditions>
                                  <cues>

                                    <cue name="Ch3_2_DestroyComponentsRef" ref="md.RML_Destroy_Components.DestroyComponents">
                                      <param name="EndSignalCue" value="Ch3_2_BoardingShip" />
                                      <param name="MissionCue" value="$MissionCue_Ch3_Boarding" />

                                      <param name="Targets_Param" value="$TargetComponents" />
                                      <param name="AllowCapture" value="true" />
                                      <param name="AllowDestroy" value="true" />
                                      <param name="ObjectiveIsGroup" value="true" />

                                      <param name="DebugChance" value="$DebugChance"/>
                                    </cue>

                                  </cues>
                                </cue>

                              </cues>
                            </cue>

                            <cue name="Ch3_2_BoardingShip">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_value name="$ObjectiveStep_2" operation="add" exact="1"/>
                                <set_objective step="$ObjectiveStep_2" cue="$MissionCue_Ch3_Boarding" action="objective.board" object="$Ch3_BoardShip" updatebriefing="true"/>
                              </actions>
                              <cues>

                                <cue name="Ch3_Ace_InitiateBoarding_ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor" value="$AceActor"/>
                                  <param name="Lines" value="[[30252321],[30252322]]"/>
                                  <param name="EndSignalCue"      value="Ch3_2_BoardingShip_Hint_ContextMenu"/>
                                  <!--
                                    That is quite enough!
                                    You can send your marines over to board the ship now!
                                  -->
                                </cue>

                                <cue name="Ch3_2_BoardingShip_Hint_ContextMenu">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <do_if value="not $BoardingInstructionsShown?">
                                      <remove_help all="true" />
                                      <show_help line="15123" position="1" allowclose="true" force="true" log="true" comment="Stay close to the target and select BOARD from the context menu." timeout="false"/>
                                    </do_if>
                                  </actions>
                                </cue>

                                <cue name="Ch3_2_BoardingShip_Hint_BoardingMenu" instantiate="true">
                                  <conditions>
                                    <event_ui_triggered screen="'InteractMenu'" control="'board'"/>
                                    <check_value value="Ch3_2_ShipBoarded_Player.state == cuestate.waiting" comment="To prevent it from firing in freeplay."/>
                                    <check_value value="Ch3_2_Boarding_Started.state == cuestate.waiting" comment="To prevent it from firing when the player checks the boarding progress."/>
                                  </conditions>
                                  <actions>
                                    <remove_help_overlay all="true"/>
                                    <remove_help all="true" />
                                  </actions>
                                  <delay exact="0.5s"/>
                                  <actions>
                                    <set_value name="$BoardingInstructionsShown"/>
                                    <show_help_multi log="true" position="13" force="true" allowclose="true" width="280">
                                      <text line="858" comment="This menu may look overwhelming at first glance, but these hint boxes will do their best to walk you through it." />
                                      <text line="859" comment="Remember that you can pause the game at any time with $INPUT_ACTION_PAUSE$, so that nothing unexpected happens in the background while you read." />
                                      <text line="849" comment="All of these messages will be added to your log in case you wish to review them later." />
                                      <text line="850" comment="Whenever you are ready for the next set of explanations, close the currently displayed hint box." />
                                    </show_help_multi>
                                    <show_help_multi log="true" position="13" force="true" allowclose="true" width="280">
                                      <text line="15205" comment="This menu helps you prepare a boarding mission. You can see how many MARINES you have available in total." />
                                      <text line="15206" comment="Marines can also come from SUBORDINATE ships. These are ships working for the leader of the boarding operation." />
                                      <text line="15204" comment="Assign MARINES to this boarding task by dragging the quantity bars." />
                                      <text line="15300" comment="Your combined BOARDING STRENGTH increases the more MARINES are assigned." />
                                      <text line="15313" comment="The more skilled a marine is the more he is going to contribute to the BOARDING STRENGTH. Marines learn and get better the more often they survive fights or boarding." />
                                    </show_help_multi>
                                    <show_help_multi log="true" position="13" force="true" allowclose="true" width="280">
                                      <text line="15211" comment="Boarding happens in three stages." />
                                      <text line="15312" comment="The menu shows your chances PER STAGE." />
                                      <text line="15322" comment="Stage 1 - Approach: Marines deploy in pods and move towards the target." />
                                      <text line="15323" comment="Stage 1 starts after the target defence was reduced. If the ship is equipped with turrets, destroy them to improve the chances of your marines arriving safely." />
                                      <text line="15324" comment="You can manually set the timing for when to deploy the pods by determening at what combat effectiveness they should launch." />
                                      <text line="855" comment="Set '{1001,9521}' to '{1037,5001}' before moving on to the next set of instructions." />
                                    </show_help_multi>
                                    <show_help_multi log="true" position="13" force="true" allowclose="true" width="280">
                                      <text line="15332" comment="Stage 2 - Infiltration: Marines start cutting through the ship hull to gain entry." />
                                      <text line="15333" comment="The marines will have an easier time infiltrating if the hull has been weakened. Damage the hull to reduce the time needed complete stage 2." />
                                      <text line="15334" comment="Similarly to setting the timing for launching the pods you can also determine at what point stage 2 should be initiated. If you rush it and attack when the hull is still strong it will take your marines longer and put them at risk, but if you wait too long to make it easier for them you run the risk of destroying your target ship." />
                                      <text line="856" comment="Set '{1001,9522}' to '{1037,5005}' before moving on to the next set of instructions." />
                                    </show_help_multi>
                                    <show_help_multi log="true" position="13" force="true" allowclose="true" width="280">
                                      <text line="15342" comment="Stage 3 - Assault: Marines fight against the target ship crew." />
                                      <text line="15343" comment="You cannot influence the outcome of this stage through combat. It is entirely determined by the number and competence of your marines." />
                                    </show_help_multi>
                                    <show_help_multi log="true" position="13" force="true" allowclose="true" width="280">
                                      <text line="845" comment="Without the Maestro's careful planning, boarding would be an illegal act of aggression and would significantly impact your reputation with the faction whose ship you board." />
                                      <text line="846" comment="When working alone, you can lessen this impact by engaging your target far enough away from its allies, or better yet, in a lawless sector." />
                                    </show_help_multi>
                                    <show_help line="847" log="true" position="13" force="true" allowclose="true" width="280" comment="Start the boarding operation once you have committed all available marines to the attack." timeout="false"/>
                                  </actions>
                                  <cues>

                                    <cue name="Ch3_2_BoardingShip_Hint_BoardingMenu_Overlay_0">
                                      <conditions>
                                        <event_ui_triggered screen="'hintclosed'" control="'858'"/>
                                      </conditions>
                                      <!--<delay exact="1s"/>-->
                                      <actions>
                                        <show_help_overlay id="'boarding_selectmarines'" highlightonly="true"/>
                                      </actions>
                                    </cue>

                                    <cue name="Ch3_2_BoardingShip_Hint_BoardingMenu_Overlay_1">
                                      <conditions>
                                        <event_ui_triggered screen="'hintclosed'" control="'15205'"/>
                                      </conditions>
                                      <!--<delay exact="1s"/>-->
                                      <actions>
                                        <remove_help_overlay id="'boarding_selectmarines'"/>
                                        <show_help_overlay id="'boarding_stage1'" highlightonly="true"/>
                                      </actions>
                                    </cue>

                                    <cue name="Ch3_2_BoardingShip_Hint_BoardingMenu_Overlay_2">
                                      <conditions>
                                        <event_ui_triggered screen="'hintclosed'" control="'15211'"/>
                                      </conditions>
                                      <actions>
                                        <remove_help_overlay id="'boarding_stage1'"/>
                                        <!--</actions>
                                      <delay exact="1s"/>
                                      <actions>-->
                                        <show_help_overlay id="'boarding_stage2'" highlightonly="true"/>
                                      </actions>
                                    </cue>

                                    <cue name="Ch3_2_BoardingShip_Hint_BoardingMenu_Overlay_3">
                                      <conditions>
                                        <event_ui_triggered screen="'hintclosed'" control="'15332'"/>
                                      </conditions>
                                      <actions>
                                        <remove_help_overlay id="'boarding_stage2'"/>
                                        <!--</actions>
                                      <delay exact="1s"/>
                                      <actions>-->
                                        <show_help_overlay id="'boarding_stage3'" highlightonly="true"/>
                                      </actions>
                                    </cue>

                                    <cue name="Ch3_2_BoardingShip_Hint_BoardingMenu_Overlay_4">
                                      <conditions>
                                        <event_ui_triggered screen="'hintclosed'" control="'15342'"/>
                                      </conditions>
                                      <actions>
                                        <remove_help_overlay id="'boarding_stage3'"/>
                                      </actions>
                                    </cue>

                                    <cue name="Ch3_2_BoardingShip_Hint_BoardingMenu_Overlay_5">
                                      <conditions>
                                        <event_ui_triggered screen="'hintclosed'" control="'845'"/>
                                      </conditions>
                                      <!--<delay exact="1s"/>-->
                                      <actions>
                                        <show_help_overlay id="'boarding_selectmarines'" highlightonly="true"/>
                                        <!--</actions>
                                      <delay exact="5s"/>
                                      <actions>-->
                                        <do_if value="Ch3_2_Boarding_Started.state == cuestate.waiting">
                                          <show_help_overlay id="'boarding_operation_start'" highlightonly="true"/>
                                        </do_if>
                                      </actions>
                                    </cue>
                                  </cues>
                                </cue>

                                <cue name="Ch3_2_Boarding_Started">
                                  <conditions>
                                    <event_ui_triggered screen="'MapMenu'" control="'startboarding'"/>
                                  </conditions>
                                  <actions>
                                    <remove_help_overlay id="'boarding_selectmarines'"/>
                                    <remove_help_overlay id="'boarding_operation_start'"/>
                                    <show_help_overlay id="'boarding_operation_cancel'" highlightonly="true"/>
                                    <remove_help all="true" />
                                    <show_help line="857" log="true" position="13" force="true" allowclose="true" width="280" comment="Close the boarding menu and wait for the operation to unfold." timeout="false"/>
                                  </actions>
                                  <cues>

                                    <cue name="Ch3_2_Boarding_Menu_Closed">
                                      <conditions>
                                        <event_ui_triggered screen="'MapMenu'" control="'cancelboarding'"/>
                                      </conditions>
                                      <actions>
                                        <remove_help_overlay id="'boarding_operation_cancel'"/>
                                        <remove_help all="true" />
                                        <show_help_multi log="true" position="13" force="true" allowclose="true" width="280">
                                          <text line="848" comment="You can keep opening the boarding menu at your convenience to monitor the progress of the operation." />
                                          <text line="860" comment="If you find that your Marines are stuck at stage 2 of the boarding operation, remember to support them by damaging the ship's hull." />
                                        </show_help_multi>
                                      </actions>
                                    </cue>

                                  </cues>
                                </cue>

                                <cue name="Ch3_2_Boarding_Failed">
                                  <conditions>
                                    <event_object_signalled object="player.entity" param="'boarding_failed'" param2="$Ch3_BoardShip"/>
                                    <check_value value="Ch3_2_ShipBoarded_Player.state == cuestate.waiting"/>
                                  </conditions>
                                  <actions>
                                    <run_actions ref="md.LIB_Generic.TransferShipOwnership">
                                      <param name="Ship" value="$Ch3_BoardShip"/>
                                      <param name="Faction" value="faction.player"/>
                                    </run_actions>
                                  </actions>
                                </cue>

                              </cues>
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Ch3_2_ShipBoarded_Player">
                          <conditions>
                            <event_object_changed_owner object="$Ch3_BoardShip" owner="faction.player"/>
                          </conditions>
                          <actions>
                            <remove_help_overlay all="true"/>
                            <set_object_hull object="$Ch3_BoardShip" exact="100"/>
                            <set_object_min_hull object="$Ch3_BoardShip" exact="0"/>
                            <do_for_each in="$Ch3_BoardShip.engines.all.list" name="$Engine">
                              <set_object_hull_unrepairable object="$Engine" unrepairable="false"/>
                              <restore_object object="$Engine" hull="100"/>
                            </do_for_each>
                            <do_for_each in="$Ch3_BoardShip.turrets.all.list" name="$Turret">
                              <set_object_hull_unrepairable object="$Turret" unrepairable="false"/>
                            </do_for_each>
                            <add_ammo object="$Ch3_BoardShip" macro="macro.ship_gen_xs_repairdrone_01_a_macro" amount="8"/>
                            <set_object_relation_behaviour object="$Ch3_BoardShip" disable="false"/>
                            <set_object_hull_unrepairable object="$Ch3_BoardShip" unrepairable="false"/>
                            <!-- If the ship was boarded legitimately, there's no pilot on it anymore, so we can't revert the scan and plunder blockers.-->
                            <do_if value="$Ch3_BoardShip.pilot">
                              <set_value name="$Ch3_BoardShip.pilot.$donotscan" exact="false"/>
                              <set_value name="$Ch3_BoardShip.pilot.$donotplunder" exact="false"/>
                            </do_if>
                          </actions>
                          <cues>

                            <cue name="Ch3_AceCongratulates_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor" value="$AceActor"/>
                              <param name="Lines" value="[[30252323],[30252324],[30252325],[30252326]]"/>
                              <param name="EndSignalCue"      value="Ch3_2_Boarding_Objective_Complete"/>
                              <!--
                                Well done, Chipmunk!
                                Claiming your first price under the flag of the Empyrean Curs!
                                I bet that must have felt exhilarating!
                                Now you just need to order the ship back to the Arcadian Endeavour, so that we can take it off your hands!
                              -->
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Ch3_2_Boarding_Objective_Complete">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <activate_mission cue="$MissionCue_Ch3_Boarding"/>
                            <do_if value="not $Ch3_BoardShip.pilot">
                              <signal_cue cue="Ch3_2_Assign_Pilot"/>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Ch3_2_DeliverShip"/>
                            </do_else>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_2_Assign_Pilot">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep_2" operation="add"/>
                    <set_objective step="$ObjectiveStep_2" cue="$MissionCue_Ch3_Boarding" action="objective.custom" customaction="{30252,3311}" object="$Ch3_BoardShip" updatebriefing="true"/>

                    <show_help_multi log="true" position="13" force="true" allowclose="true" width="280">
                      <text line="852" comment="To assign a pilot to your newly captured ship, open the Crew tab of its Ship Information menu and select '{1001,9432} {1001,4848}'." />
                      <text line="853" comment="Keep in mind that once you transfer it to the Empyrean Curs, any crew members left on the ship will leave your employment. Hiring fees will not be refunded." />
                      <text line="854" comment="If you wish to keep these crew members, first select the ship, then open the context menu on one of your other ships with $INPUT_STATE_INTERACTION_MENU$, and select '{1001,7880}'." />
                    </show_help_multi>
                  </actions>
                  <cues>

                    <cue name="Ch3_2_Player_Takes_Helm">
                      <conditions>
                        <event_player_started_control/>
                        <check_value value="global.$PlayerContainerGroup.indexof.{$Ch3_BoardShip}"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch3_2_Pilot_Assigned"/>
                        <signal_cue cue="Ch3_2_DeliverShip"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_2_Pilot_Assigned" checkinterval="1s">
                      <conditions>
                        <check_value value="$Ch3_BoardShip.pilot"/>
                        <check_value value="$Ch3_BoardShip.pilot != player.entity"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch3_2_Player_Takes_Helm"/>
                        <signal_cue cue="Ch3_2_DeliverShip"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_2_DeliverShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch3_2_DeployShip_Setup">
                      <delay exact="2s"/>
                      <actions>
                        <set_value name="$ObjectiveStep_2" operation="add" exact="1"/>

                        <set_value name="$Fleet" exact="[
                          table[
                            $macro = $Ch3_BoardShip.macro,
                            $amount = 1
                          ],
                         ]"/>

                        <run_actions ref="md.GM_GetExactFleet.ConstructFleetRequirementsText" result="$FleetText">
                          <param name="Fleet" value="$Fleet"/>
                        </run_actions>
                        <set_value name="this.$TextTable" exact="table[]"/>
                        <update_mission cue="$MissionCue_Ch3_Boarding" description="{30252,3302} + '\n' + $FleetText"/>

                        <set_value name="this.$TextTable.$objective"           exact="{30252,3330}"/>
                        <set_value name="this.$TextTable.$objective_transfer"  exact="{30252,3330}"/>
                        <set_value name="this.$TextTable.$progressbar"         exact="{30252,3331}"/>
                        <set_value name="this.$TextTable.$accept_transfer"     exact="{30252,3332}"/>
                        <set_value name="this.$TextTable.$reject_transfer"     exact="{1001,64}"/>

                        <create_position name="$DeliveryOffset" object="$RaiderHubShip" space="$RaiderHubShip.sector" min="5km" max="15km"/>
                        <set_value name="$DeliveryOffset" exact="position.[$DeliveryOffset.x, 0, $DeliveryOffset.z]" comment="Keep it on the ecliptic to make it easier."/>
                        <signal_cue cue="Ch3_2_DeliverFleet"/>

                        <create_order id="'AssignCommander'" object="$AceShip" immediate="true">
                          <param name="commander" value="$RaiderHubShip"/>
                          <param name="assignment" value="assignment.defence"/>
                          <param name="cancelorders" value="true"/>
                        </create_order>
                      </actions>
                    </cue>

                    <cue name="Ch3_2_DeliverFleet">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch_3_2_Deliver_Fleet_Ref" ref="md.RML_Deliver_Fleet.DeliverFleet">
                          <param name="EndSignalCue"            value="Ch3_2_CleanUp"/>
                          <param name="MissionCue"              value="$MissionCue_Ch3_Boarding"/>
                          <param name="StartStep"               value="$ObjectiveStep_2"                comment="Briefing step to start the mission on"/>
                          <param name="UpdateBriefing"          value="true"                            comment="Update the briefing objective step when the objective is updated"/>
                          <param name="DebugChance"             value="$DebugChance"/>

                          <param name="Text_MissionName"        value="{30252,3301}"/>
                          <param name="Text_Objective_Get"      value="Ch3_2_DeployShip_Setup.$TextTable.$objective"           comment="Objective text to get ships"/>
                          <param name="Text_Objective_Transfer" value="Ch3_2_DeployShip_Setup.$TextTable.$objective_transfer"  comment="Objective text to transfer ownership"/>
                          <param name="Text_AcceptTransfer"     value="Ch3_2_DeployShip_Setup.$TextTable.$accept_transfer"     comment="Player choice text to initiate transfer"/>
                          <param name="Text_RejectTransfer"     value="Ch3_2_DeployShip_Setup.$TextTable.$reject_transfer"     comment="Player choice text to reject transfer"/>
                          <param name="Text_ProgressBar"        value="Ch3_2_DeployShip_Setup.$TextTable.$progressbar"         comment="Progress bar text for multiple ships"/>
                          <param name="Fleet"                   value="$Fleet"                          comment="The specific fleet we are looking for"/>
                          <param name="Transfer"                value="true"                            comment="Mission ends with a transfer of ownership to $Faction. Otherwise ends when ships are in position."/>
                          <param name="Faction"                 value="faction.civilian"                comment="The faction to which it needs to be delivered. Required if $Transfer is true"/>
                          <param name="Client"                  value="$AceActor"                    comment="client who wants the fleet. Required if $Transfer is true"/>
                          <param name="TargetSector"            value="$RaiderHubShip.sector"                   comment="Sector to which to deliver the fleet"/>
                          <param name="TargetOffset"            value="$DeliveryOffset"                   comment="Location to which to deliver the fleet"/>
                          <param name="TargetRadius"            value="10km"                             comment="Radius around location in which we need to put the fleet"/>
                          <param name="CriteriaResultCue"       value="null"                            comment="Cue to signal with a table of ships with the result of the most recent processing of 'CheckMissionStatus'"/>
                          <param name="AdditionCheckCue"        value="null"                            comment="Cue to signal instantly to run additional checks on the object. event.param = [namespace, $ship]. Result saved to namespace.$CheckCueResult"/>
                          <param name="ReturnFleetShips"        value="true"/>
                          <param name="VoiceTable"              value="table[$CustomNotification = 30252327]"/>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_2_CleanUp">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="this.$EndFeedbackValue" min="1">
                      <remove_from_list name="$Ch3_Missions" exact="$MissionCue_Ch3_Boarding"/>
                      <remove_mission cue="$MissionCue_Ch3_Boarding" type="completed"/>
                    </do_if>
                    <do_else>
                      <reset_cue cue="this"/>
                      <reset_cue cue="Ch_3_2_Deliver_Fleet_Ref"/>
                    </do_else>
                  </actions>
                  <cues>

                    <!-- Ace thanks the player -->
                    <cue name="Ch3_BoardingMissionFinished_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$AceActor"/>
                      <param name="DelayInitial"      value="3s"/>
                      <param name="Lines"             value="[[30252328]]"/>
                      <param name="EndSignalCue"      value="Ch3_FinishCheck"/>
                      <!--
                        Much appreciated!
                      -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch3_3_Diversion">
              <actions>
                <set_value name="$ObjectiveStep_3" exact="1"/>
                <set_value name="$MissionCue_Ch3_Diversion" exact="this"/>

                <write_incoming_message title="{30252,10001}" text="{30252,10002}" source="{30252,10003}" highpriority="false" comment="worldbuilding inrease in piracy email"/>
                <create_mission cue="$MissionCue_Ch3_Diversion" name="{30252,3401}" description="{30252,3402}" rewardtext="{30252,3420}" type="missiontype.plot" faction="faction.civilian" difficulty="level.medium" abortable="false" icon="'briefing_maestro_01'" iconcaption="{30252,101}" missionthread="$MissionCue" activate="false">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$MaestroActor" text="$MaestroActor.name"/>
                  </briefing>
                </create_mission>
                <set_objective_from_briefing cue="$MissionCue_Ch3_Diversion" step="1"/>
              </actions>
              <cues>


                <cue name="Ch3_3_Maestro_Conversation" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$MaestroActor"/>
                      <event_conversation_next_section actor="$MaestroActor" section="conv_continue"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="event.name == 'event_conversation_started'">

                      <allow_conversation_escape enabled="false"/>
                      <do_if value="not (Ch3_3_Maestro_ConversationFinished.state == cuestate.complete)">
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252307" comment="Straight to the point:"/>
                          <text line="30252308" comment="We need to raid station for specific supplies, but station well-guarded."/>
                          <text line="30252309" comment="Ministry of finance very vigilant when it comes to pirate activity."/>
                          <text line="30252310" comment="If we go in guns blazing, we will be picked apart by Ministry patrols."/>
                          <text line="30252311" comment="So instead, you and the Ace will create a diversion."/>
                          <text line="30252312" comment="You attack Ministry fleet head on, draw away from station!"/>
                          <text line="30252313" comment="Chipmunk, make sure to stay alive! "/>
                          <text line="30252314" comment="Not a good distraction if you get blown to bits!"/>
                        </add_npc_line>
                        <add_player_choice text="{30252,30252304}" section="conv_continue" comment="Umm... okay...?" position="bottom_right" highlighted="true"/>
                      </do_if>
                      <do_else>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252315" comment="Very well then. Plan is agreed upon!"/>
                        </add_npc_line>
                      </do_else>

                    </do_if>
                    <do_else>

                      <allow_conversation_escape enabled="false"/>
                      <add_npc_line speaker="$MaestroActor" hidechoices="true">
                        <text line="30252315" comment="Very well then. Plan is agreed upon!"/>
                        <text line="30252316" comment="If you are fast enough you will stay out of their guns' range, so do not worry!"/>
                      </add_npc_line>

                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch3_3_Maestro_ConversationFinished">
                  <conditions>
                    <event_speak_line_finished actor="$MaestroActor" line="30252316" comment="unreliable, but you can start the conversation again"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch3_3_StationSetup"/>
                    <activate_mission cue="$MissionCue_Ch3_Diversion"/>
                  </actions>
                  <cues>

                    <cue name="Ch3_3_Player_Undocked_From_Raider_Hub">
                      <conditions>
                        <event_object_changed_object previous="$RaiderHubShip" object="player.entity"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch3_3_Ace_Handler"/>
                      </actions>
                      <cues>

                        <!-- Ace gives some hot takes on the MIN to avoid dead air -->
                        <cue name="Ch3_3_HotTakes_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AceActor"/>
                          <param name="DelayInitial"      value="8s"/>
                          <param name="Lines"             value="[[30252330],[30252331],[30252332],[30252333],[30252334],[30252335],[30252336],[30252337],[30252338]]"/>
                          <param name="EndSignalCue"      value="Ch3_3_AttackFleet"/>
                          <!--
                            So, we are going to engage the Ministry, I hear?
                            Good! People say that I have a very chipper disposition, but the Ministry of Finance makes me sick to my stomach.
                            Teladi are not naturally combatative. We all have a natural instinct to avoid conflict.
                            Very rarely will you find skilled combat pilot material among us.
                            Naturally, the Ministry needed skilled pilots and marines, so they devised a very unique training regimen for their cadets.
                            It is an intense and gruelling process, meant to completely strip a Teladi from their natural escape reflex.
                            When it is so easy to turn that instinct into an advantage!
                            Not only is the Ministry oppressively policing which goods are and are not allowed, but they are also bending and breaking Teladi to enforce their arbitrary rules!
                            So yeah, I do not mind tangling with those guys.
                          -->
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>


                <cue name="Ch3_3_StationSetup">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <find_station_by_true_owner name="$DiversionStation" space="player.galaxy" faction="faction.ministry" sortbygatedistanceto="$RaiderHubShip" excluded="$Ch3_ExcludedStations"/>
                    <do_if value="not $DiversionStation">
                      <create_station name="$DiversionStation" macro="macro.station_gen_factory_base_01_macro" sector="$RaiderHubShip.sector" state="componentstate.operational" owner="faction.ministry" constructionplan="'TODO'">
                        <safepos allowyaxis="false" min="50km" max="150km"/>
                      </create_station>
                      <signal_objects object="player.galaxy" param="'init station'" param2="$DiversionStation" param3="false" comment="Add control entities."/>
                    </do_if>
                    <set_object_min_hull object="$DiversionStation" exact="100"/>

                    <get_safe_pos result="$Ch3_3_WaitingPos" object="$DiversionStation" sector="$DiversionStation.sector" min="10km" max="16km" radius="4km"/>
                    <cancel_all_orders object="$RaiderHubShip"/>
                    <create_order object="$RaiderHubShip" id="'MoveWait'" default="true">
                      <param name="destination" value="[$DiversionStation.sector, $Ch3_3_WaitingPos]"/>
                      <param name="debugchance" value="$DebugChance"/>
                    </create_order>
                    <add_to_group groupname="$Ch3_ExcludedStations" object="$DiversionStation"/>
                  </actions>
                </cue>

                <cue name="Ch3_3_SetUpFleets">
                  <conditions>
                    <event_cue_completed cue="Ch3_3_StationSetup"/>
                  </conditions>
                  <actions>
                    <get_safe_pos result="$MINFleetPos" sector="$DiversionStation.sector" object="$DiversionStation" min="41km" max="45km" radius="5km"/>

                    <create_loadout result="$MINFlagshipLoadout">
                      <macros>
                        <engine macro="engine_tel_l_allround_01_mk1_macro" path="../con_engine_03"/>
                        <engine macro="engine_tel_l_allround_01_mk1_macro" path="../con_engine_02"/>
                        <engine macro="engine_tel_l_allround_01_mk1_macro" path="../con_engine_01"/>
                        <weapon macro="weapon_tel_l_destroyer_01_mk1_macro" path="../con_weapon_01"/>
                        <weapon macro="weapon_tel_l_destroyer_01_mk1_macro" path="../con_weapon_02"/>
                        <shield macro="shield_tel_l_standard_01_mk1_macro" path="../con_shield_l_03"/>
                        <shield macro="shield_tel_l_standard_01_mk1_macro" path="../con_shield_l_02"/>
                        <shield macro="shield_tel_l_standard_01_mk1_macro" path="../con_shield_l_01"/>
                      </macros>
                      <groups>
                        <shields macro="shield_tel_m_standard_02_mk1_macro" group="group_back_mid_mid" exact="3"/>
                        <shields macro="shield_tel_m_standard_02_mk1_macro" group="group_front_down_mid"/>
                        <shields macro="shield_tel_m_standard_02_mk1_macro" group="group_center_top_center"/>
                        <shields macro="shield_tel_m_standard_02_mk1_macro" group="group_center_bottom_right"/>
                        <shields macro="shield_tel_m_standard_02_mk1_macro" group="group_center_bottom_left"/>
                        <shields macro="shield_tel_m_standard_02_mk1_macro" group="group_front_top_left"/>
                        <shields macro="shield_tel_m_standard_02_mk1_macro" group="group_front_top_right"/>
                        <shields macro="shield_tel_m_standard_02_mk1_macro" group="group_center_bottom_right2"/>
                        <shields macro="shield_tel_m_standard_02_mk1_macro" group="group_center_bottom_left2"/>
                        <turrets macro="turret_tel_m_plasma_02_mk1_macro" group="group_front_down_mid"/>
                        <turrets macro="turret_tel_m_plasma_02_mk1_macro" group="group_center_top_center" exact="2"/>
                        <turrets macro="turret_tel_m_plasma_02_mk1_macro" group="group_center_bottom_right" exact="2"/>
                        <turrets macro="turret_tel_m_plasma_02_mk1_macro" group="group_center_bottom_left" exact="2"/>
                        <turrets macro="turret_tel_m_plasma_02_mk1_macro" group="group_front_top_left"/>
                        <turrets macro="turret_tel_m_plasma_02_mk1_macro" group="group_front_top_right"/>
                        <turrets macro="turret_tel_l_plasma_01_mk1_macro" group="group_center_bottom_right2"/>
                        <turrets macro="turret_tel_l_plasma_01_mk1_macro" group="group_center_bottom_left2"/>
                      </groups>
                      <software>
                        <software ware="software_flightassistmk1"/>
                        <software ware="software_scannerlongrangemk1"/>
                        <software ware="software_scannerobjectmk1"/>
                        <software ware="software_targetmk1"/>
                      </software>
                      <virtualmacros>
                        <thruster macro="thruster_gen_l_allround_01_mk3_macro"/>
                      </virtualmacros>
                    </create_loadout>

                    <create_ship name="$MINFlagship" macro="ship_tel_l_destroyer_02_a_macro" commandeerable="false" capturable="false" sector="$DiversionStation.sector">
                      <owner exact="faction.ministry" overridenpc="true"/>
                      <pilot>
                        <select faction="faction.ministry" tags="tag.fighterpilot"/>
                      </pilot>
                      <loadout loadout="$MINFlagshipLoadout"/>
                      <people ref="teladi_elite_military_crew"/>
                      <position value="$MINFleetPos"/>
                    </create_ship>

                    <create_order object="$MINFlagship" id="'Wait'" immediate="true">
                      <param name="fidget" value="true"/>
                    </create_order>

                    <create_group groupname="$MinistryFleet"/>
                    <add_to_group groupname="$MinistryFleet" object="$MINFlagship"/>

                    <create_group groupname="$MinistryWingCommanders"/>

                    <set_value name="$MinistryFleetComposition"   exact="[
                                                [ macro.ship_tel_m_bomber_01_b_macro, macro.ship_tel_s_fighter_01_b_macro, macro.ship_tel_s_fighter_01_b_macro],
                                                [ macro.ship_tel_m_bomber_01_b_macro, macro.ship_tel_s_fighter_01_b_macro, macro.ship_tel_s_fighter_01_b_macro],
                                                ]" />

                    <do_for_each in="$MinistryFleetComposition" name="$CurrentWing" counter="$w">
                      <do_for_each in="$CurrentWing" name="$CurrentMacro" counter="$i">
                        <create_ship name="$CurrentShip" macro="$CurrentMacro" commandeerable="false" capturable="false" sector="$DiversionStation.sector">
                          <owner exact="faction.ministry" overridenpc="true" />
                          <pilot>
                            <select faction="faction.ministry" tags="tag.fighterpilot"/>
                          </pilot>
                          <loadout>
                            <!-- Try to prevent missile launchers by setting a low level. -->
                            <level exact="0.1"/>
                          </loadout>
                          <safepos value="$MINFleetPos" min="2m" max="4km" radius="600m"/>
                        </create_ship>

                        <add_to_group groupname="$MinistryFleet" object="$CurrentShip"/>

                        <do_if value="$i == 1">
                          <add_to_group groupname="$MinistryWingCommanders" object="$CurrentShip"/>
                          <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                            <param name="commander" value="$MINFlagship"/>
                            <param name="assignment" value="assignment.defence"/>
                            <param name="cancelorders" value="true"/>
                          </create_order>
                        </do_if>
                        <do_else>
                          <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                            <param name="commander" value="$MinistryWingCommanders.{$w}"/>
                            <param name="assignment" value="assignment.attack"/>
                            <param name="cancelorders" value="true"/>
                          </create_order>
                        </do_else>
                      </do_for_each>
                    </do_for_each>
                    <set_value name="$ObjectiveStep_3" operation="add" exact="1"/>
                    <set_objective step="$ObjectiveStep_3" cue="$MissionCue_Ch3_Diversion" action="objective.flyto" object="$MINFlagship" updatebriefing="true"/>
                  </actions>
                </cue>

                <cue name="Ch3_3_Ace_Handler">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="player.sector and player.sector == $DiversionStation.sector">
                      <create_order id="'ProtectShip'" object="$AceShip" default="true">
                        <param name="target" value="player.ship"/>
                      </create_order>
                    </do_if>
                    <set_object_hull object="$AceShip" exact="100"/>
                    <warp object="$AceShip" sector="$RaiderHubShip.sector">
                      <safepos object="$RaiderHubShip" min="500m" max="1km"/>
                      <rotation value="$RaiderHubShip.rotation"/>
                    </warp>
                  </actions>
                  <cues>

                    <cue name="Ch3_3_Ace_Handler_Player_Left_Sector" instantiate="true">
                      <conditions>
                        <event_object_changed_sector object="player.entity" previous="$DiversionStation.sector"/>
                      </conditions>
                      <actions>
                        <!-- If Ace is at the same time also supposed to follow the to-be-boarded ship from her own mission, send her back there. -->
                        <do_if value="(Ch3_2_CreateTarget.state == cuestate.complete) and (Ch3_2_ShipBoarded_Player.state == cuestate.waiting)">
                          <cancel_all_orders object="$AceShip"/>
                          <create_order object="$AceShip" id="'Follow'" immediate="true">
                            <param name="target" value="$Ch3_BoardShip"/>
                          </create_order>
                        </do_if>
                        <!-- Otherwise, send her to the Arcadian Endeavour until the player returns. -->
                        <do_else>
                          <create_order id="'ProtectShip'" object="$AceShip" default="true">
                            <param name="target" value="$RaiderHubShip"/>
                          </create_order>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch3_3_Ace_Handler_Player_Entered_Sector" instantiate="true">
                      <conditions>
                        <event_object_changed_sector object="player.entity" sector="$DiversionStation.sector"/>
                        <check_value value="event.param != null" comment="Superhighways"/>
                        <check_value value="event.param == $DiversionStation.sector"/>
                      </conditions>
                      <actions>
                        <warp object="$AceShip" sector="$DiversionStation.sector">
                          <safepos object="player.ship" min="500m" max="1km"/>
                          <rotation value="player.ship.rotation"/>
                        </warp>
                        <cancel_all_orders object="$AceShip"/>
                        <create_order id="'ProtectShip'" object="$AceShip" default="true">
                          <param name="target" value="player.ship"/>
                          <param name="debugchance" value="100"/>
                        </create_order>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_3_AttackFleet">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep_3" operation="add" exact="1"/>
                    <set_objective step="$ObjectiveStep_3" cue="$MissionCue_Ch3_Diversion" action="objective.attack" object="$MINFlagship" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <!-- TODO: I have not yet had the chance to implement any kind of Ace behaviour, but she should:
                     - support the player who is trying to stay alive (draw some fire away)
                     - head for the anomaliy later on -->

                    <cue name="Ch3_3_ProximityCheck" checkinterval="2s">
                      <conditions>
                        <check_value value="(player.sector == $MINFlagship.sector) and ($MINFlagship.distanceto.{player.entity} lt 60km)"/>
                      </conditions>
                      <cues>
                        <!-- Some more flavour from Maestro and Ace, telling the player to attack-->
                        <cue name="Ch3_3_GettingIntoProximity_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$MaestroActor, $AceActor]"/>
                          <param name="Lines"             value="[[[30252317],[30252318]],[[30252339],[30252340]]]"/>
                          <param name="EndSignalCue"      value="[null, null]"/>
                          <!--
                            Maestro:
                              Arcadian Endeavour in close proximity to station.
                              Commence attack whenever ready!
                            Ace:
                              Do not worry! I will be right beside you.
                              Amazing how huge ships can seem like up close!
                          -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch3_3_AttackFleet_Registered">
                      <conditions>
                        <event_object_attacked object="$MINFlagship"/>
                        <check_value value="event.param.isplayerowned"/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep_3" operation="add" exact="1"/>
                        <set_value name="$DivertTime" exact="120s"/>
                        <set_value name="$DivertRadius" exact="15km"/>
                        <set_value name="$ResetRadius" exact="16km"/>

                        <do_for_each name="$ship" in="$MinistryFleet">
                          <set_relation_boost object="$ship" faction="faction.player" value="-1" silent="true" decay="0" comment="Ensure the fleet is always angry at the player"/>
                          <set_relation_boost object="$ship" otherobject="$AceShip" value="-1" silent="true" decay="1" delay="5min" comment="Ensure the fleet is always angry at the player"/>
                          <do_if value="$ship.commander">
                            <create_order object="$ship" id="'Attack'" chance="50" immediate="true">
                              <param name="primarytarget" value="$AceShip"/>
                              <param name="allowothertargets" value="false"/>
                              <param name="pursuetargets" value="true"/>
                              <param name="checkrelation" value="false"/>
                              <param name="forceprimarytarget" value="true"/>
                            </create_order>
                          </do_if>
                        </do_for_each>

                        <cancel_all_orders object="$AceShip"/>
                        <create_order object="$AceShip" id="'Follow'" immediate="true">
                          <param name="target" value="player.ship"/>
                        </create_order>
                      </actions>
                      <cues>

                        <!-- lets the player know they need to stay alive  -->
                        <cue name="Ch3_SurviveAttack_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$MaestroActor"/>
                          <param name="DelayInitial"      value="3s"/>
                          <param name="Lines"             value="[[30252319],[30252320]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            Chipmunk! Lead them away from station!
                            Elude fire but do not escape completely!
                          -->
                        </cue>

                        <cue name="Ch3_FlagShipDestroyed">
                          <conditions>
                            <event_object_destroyed object="$MINFlagship"/>
                          </conditions>
                          <actions>
                            <cancel_cue cue="Ch3_3_Countdown_Trigger" comment="at this point cancel the actual diversion gameplay"/>

                            <set_value name="$ObjectiveStep_3" operation="add" exact="1"/>

                            <do_if value="$MinistryFleet.count ge 1">
                              <set_objective step="$ObjectiveStep_3" cue="$MissionCue_Ch3_Diversion" action="objective.destroy" group="$MinistryFleet" updatebriefing="true"/>
                            </do_if>
                            <do_else>
                              <set_objective step="$ObjectiveStep_3" cue="$MissionCue_Ch3_Diversion" action="objective.wait" updatebriefing="true"/>
                            </do_else>
                          </actions>
                          <cues>

                            <cue name="Ch3_DestroyedMinShip_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$MaestroActor"/>
                              <param name="DelayInitial"      value="3s"/>
                              <param name="Lines"             value="[[30252326],[30252327],[30252328]]"/>
                              <param name="EndSignalCue"      value="Ch3_3_Check_MIN_Fleet_Remaining"/>
                              <!--
                                Decided to dispatch with Ministry fleet upfront?
                                Surprising. Split did not foresee this.
                                Suppose final result identical no matter the approach.
                              -->
                            </cue>

                            <cue name="Ch3_3_Check_MIN_Fleet_Remaining">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <do_if value="not $MinistryFleet.count">
                                  <signal_cue cue="Ch3_3_Raiding_Dialog"/>
                                </do_if>
                              </actions>
                              <cues>

                                <cue name="Ch3_3_MIN_Fleet_Destroyed">
                                  <conditions>
                                    <event_object_destroyed group="$MinistryFleet"/>
                                    <check_value value="$MinistryFleet.count le 1"/>
                                  </conditions>
                                  <actions>
                                    <signal_cue cue="Ch3_3_Raiding_Dialog"/>
                                  </actions>
                                </cue>

                              </cues>
                            </cue>

                            <cue name="Ch3_3_Raiding_Dialog">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>

                                <cue name="Ch3_DestroyedMinFleet_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$MaestroActor"/>
                                  <param name="DelayInitial"      value="3s"/>
                                  <param name="Lines"             value="[[30252329]]"/>
                                  <param name="EndSignalCue"      value="Ch3_3_Station_Raid"/>
                                  <!--
                                    Moving in to raid station now!
                                  -->
                                </cue>

                              </cues>
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Ch3_3_PlayerChangedObject" instantiate="true">
                          <conditions>
                            <event_object_changed_object object="player.entity"/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <!-- attack player spacesuit -->
                            <do_if value="player.entity.distanceto.{$MINFlagship} le $ResetRadius">
                              <cancel_all_orders object="$MINFlagship"/>
                              <create_order id="'Attack'" object="$MINFlagship" immediate="true">
                                <param name="primarytarget" value="player.container"/>
                                <param name="checkrelation" value="false"/>
                                <param name="pursuetargets" value="false"/>
                                <param name="debugchance" value="$DebugChance"/>
                                <!--<param name="allowothertargets" value="false"/>-->
                              </create_order>
                            </do_if>
                            <do_else>
                              <cancel_all_orders object="$MINFlagship"/>
                              <create_order object="$MINFlagship" id="'Wait'" immediate="true">
                                <param name="fidget" value="true"/>
                              </create_order>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Ch3_3_Countdown_Trigger" checkinterval="1s">
                          <conditions>
                            <check_value value="player.sector and (player.sector == $MINFlagship.sector) and (player.entity.distanceto.{$MINFlagship} le ($ResetRadius))"/>
                          </conditions>
                          <actions>
                            <set_value name="$EndTime" exact="player.age + $DivertTime"/>
                            <set_objective step="$ObjectiveStep_3" cue="$MissionCue_Ch3_Diversion" action="objective.custom" customaction="{30252,3432}" object="$MINFlagship" radius="$DivertRadius" updatebriefing="true" endtime="$EndTime"/>
                            <cancel_all_orders object="$MINFlagship"/>

                            <create_order id="'Attack'" object="$MINFlagship" immediate="true">
                              <param name="primarytarget" value="player.ship"/>
                              <param name="secondarytargets" value="$AceShip"/>
                              <param name="allowothertargets" value="false"/>
                              <param name="checkrelation" value="false"/>
                              <param name="pursuetargets" value="true"/>
                              <!--<param name="allowothertargets" value="false"/>-->
                            </create_order>
                          </actions>
                          <cues>

                            <cue name="Ch3_3_Countdown">
                              <delay exact="$DivertTime"/>
                              <actions>
                                <reset_cue cue="Ch3_LeftRadius"/>
                                <signal_cue cue="Ch3_3_CountdownDone"/>
                              </actions>
                            </cue>

                            <cue name="Ch3_3_CountdownDone">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch3_3_Station_Raid"/>
                                <cancel_cue cue="Ch3_LeftRadius"/>
                              </actions>
                              <cues>

                                <cue name="Ch3_ReinforcementsArriving_Ref" ref="md.LIB_Dialog.Speak_Actors">
                                  <param name="Actor"             value="[$AceActor, $MaestroActor,$AceActor,$MaestroActor]"/>
                                  <param name="Lines"             value="[[[30252344]],[[30252332],[30252333],[30252334],[30252335]], [[30252345]], [[30252336]]]"/>
                                  <param name="EndSignalCue"      value="[null, null, null, Ch3_3_EscapeThroughAnomaly]"/>
                                  <!--
                                  Ace
                                    We are taking a lot of heat!
                                  Maestro
                                    What is that?
                                    Another Ministry fleet is rapidly approaching your location!
                                    Highly unexpected. Fast fighters heading your way!
                                    Probably dedicated anti-piracy taskforce.
                                  Ace
                                    We need to get out of here, right now!
                                  Maestro
                                    They are heading you off!
                                  -->
                                </cue>

                              </cues>
                            </cue>

                            <cue name="Ch3_LeftRadius" checkinterval="1s">
                              <conditions>
                                <check_value value="(player.sector == $MINFlagship.sector) and (player.entity.distanceto.{$MINFlagship} gt $DivertRadius)"/>
                              </conditions>
                              <actions>
                                <set_value name="$DivertTime" exact="$EndTime - player.age"/>
                                <set_objective step="$ObjectiveStep_3" cue="$MissionCue_Ch3_Diversion" action="objective.custom" customaction="{30252,3433}" object="$MINFlagship" radius="$DivertRadius" updatebriefing="true" silent="true" />
                              </actions>
                              <cues>

                                <cue name="Ch3_LeftRadius_Returned" checkinterval="1s">
                                  <conditions>
                                    <check_value value="(player.sector == $MINFlagship.sector) and (player.entity.distanceto.{$MINFlagship} le $DivertRadius)"/>
                                  </conditions>
                                  <actions>
                                    <cancel_all_orders object="$MINFlagship"/>
                                    <create_order id="'Attack'" object="$MINFlagship" immediate="true">
                                      <param name="primarytarget" value="player.ship"/>
                                      <param name="checkrelation" value="false"/>
                                      <param name="pursuetargets" value="true"/>
                                      <param name="debugchance" value="$DebugChance"/>
                                      <!--<param name="allowothertargets" value="false"/>-->
                                    </create_order>
                                    <set_objective step="$ObjectiveStep_3" cue="$MissionCue_Ch3_Diversion" action="objective.custom" customaction="{30252,3432}" object="$MINFlagship" radius="$DivertRadius" updatebriefing="true" endtime="$EndTime"/>
                                    <reset_cue cue="parent"/>
                                  </actions>
                                </cue>

                                <cue name="Ch3_LeftRadius_Entirely" checkinterval="1s">
                                  <conditions>
                                    <check_value value="(player.sector != $MINFlagship.sector) or (player.entity.distanceto.{$MINFlagship} gt $ResetRadius)"/>
                                  </conditions>
                                  <actions>
                                    <signal_cue cue="Ch3_3_LeavingDialogueTrigger"/>
                                    <reset_cue cue="Ch3_3_Countdown_Trigger"/>
                                  </actions>
                                </cue>

                              </cues>
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Ch3_3_LeavingDialogueTrigger" instantiate="true">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>

                            <!-- Maestro points player back to fleet  -->
                            <cue name="Ch3_PlayerLEft_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$MaestroActor"/>
                              <param name="DelayInitial"      value="3s"/>
                              <param name="Lines"             value="[[30252323],[30252324],[30252325]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                They have lost you! 
                                They will  return to our mark if you too far away.
                                It is crucial you return immediately!
                              -->
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_3_Setup_Anomaly">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!--<create_position name="$AnomalyFallbackPosition" x="$MINFleetPos.x" y="$MINFleetPos.y" z="$MINFleetPos.z - 30km" space="$DiversionStation.sector"/>-->
                    <get_safe_pos result="$AnomalyFallbackPosition" object="$MINFlagship" sector="$DiversionStation.sector" min="30km" max="40km" radius="25km"/>

                    <do_if value="player.ship and (player.ship.sector == $DiversionStation.sector)">
                      <!--<create_position name="$PlayerShipPosition" space="$DiversionStation.sector" object="player.ship"/>-->

                      <create_object name="$OriginAnomaly" macro="macro.wormhole_v1_macro" sector="$DiversionStation.sector">
                        <safepos object="player.ship" x="5km" y="3km" z="14km"/>
                        <!--<safepos x="$PlayerShipPosition.x" y="$PlayerShipPosition.x + 10km" z="$PlayerShipPosition.z"/>-->
                      </create_object>
                    </do_if>
                    <do_else>
                      <create_object name="$OriginAnomaly" macro="macro.wormhole_v1_macro" sector="$DiversionStation.sector">
                        <safepos value="$AnomalyFallbackPosition" allowyaxis="false"/>
                      </create_object>
                    </do_else>


                    <create_object name="$DestinationAnomaly" macro="macro.wormhole_v1_macro" sector="$SilentWitness1_Sector">
                      <safepos object="$SilentWitness1_Sector" min="80km" max="$SilentWitness1_Sector.coresize/2m" radius="40km"/>
                    </create_object>

                    <debug_text text="player.age + ' created detination anomaly ' + $DestinationAnomaly" chance="$DebugChance"/>

                    <add_anomaly_destination anomaly="$OriginAnomaly" destination="$DestinationAnomaly"/>
                  </actions>
                </cue>

                <cue name="Ch3_3_Setup_Second_Fleet">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep_3" operation="add"/>

                    <!-- If the player teleports away at the worst moment, there's nothing we can do to eyeball a realistic spawn position for the fleet, so let's skip the spawn in that case. -->
                    <do_if value="player.ship and (player.ship.sector == $DiversionStation.sector)">
                      <create_position name="$PlayerShipPosition" space="$DiversionStation.sector" object="player.ship"/>

                      <set_value name="$SecondFleetComposition" exact="[
                                                [ macro.ship_tel_s_fighter_02_b_macro, macro.ship_tel_s_fighter_01_b_macro, macro.ship_tel_s_fighter_01_b_macro],
                                                [ macro.ship_tel_s_fighter_02_b_macro, macro.ship_tel_s_fighter_01_b_macro, macro.ship_tel_s_fighter_01_b_macro],
                                                [ macro.ship_tel_s_fighter_02_b_macro, macro.ship_tel_s_fighter_01_b_macro, macro.ship_tel_s_fighter_01_b_macro],
                                                [ macro.ship_tel_s_fighter_02_b_macro, macro.ship_tel_s_fighter_01_b_macro, macro.ship_tel_s_fighter_01_b_macro],
                                                [ macro.ship_tel_s_fighter_02_b_macro, macro.ship_tel_s_fighter_01_b_macro, macro.ship_tel_s_fighter_01_b_macro],
                                                [ macro.ship_tel_s_fighter_02_b_macro, macro.ship_tel_s_fighter_01_b_macro, macro.ship_tel_s_fighter_01_b_macro],
                                                [ macro.ship_tel_s_fighter_02_b_macro, macro.ship_tel_s_fighter_01_b_macro, macro.ship_tel_s_fighter_01_b_macro],
                                                [ macro.ship_tel_s_fighter_02_b_macro, macro.ship_tel_s_fighter_01_b_macro, macro.ship_tel_s_fighter_01_b_macro],
                                                ]" />

                      <!-- TODO: Spawn positions that are less perfectly geometrical and look more natural. -->
                      <set_value name="$SecondFleetCoordinates" exact="[
                                                [ -20.5km, 0km, 41km],
                                                [ 20.5km, 0km, 41km],
                                                [ 41km, 0km, 0km],
                                                [ 20.5km, 0km, -41km],
                                                [ -20.5km, 0km, -41km],
                                                [ -41km, 0km, 0km],
                                                [ 0km, -41km, 0km],
                                                [ 0km, 41km, 0km],
                                                ]" />

                      <do_for_each in="$SecondFleetComposition" name="$CurrentWing" counter="$w">
                        <create_position name="$CurrentWingPosition" space="$DiversionStation.sector" x="$PlayerShipPosition.x + $SecondFleetCoordinates.{$w}.{1}" y="$PlayerShipPosition.y + $SecondFleetCoordinates.{$w}.{2}" z="$PlayerShipPosition.z + $SecondFleetCoordinates.{$w}.{3}"/>

                        <do_for_each in="$CurrentWing" name="$CurrentMacro" counter="$i">
                          <create_ship name="$CurrentShip" macro="$CurrentMacro" commandeerable="false" capturable="true" sector="$DiversionStation.sector">
                            <owner exact="faction.ministry" overridenpc="true" />
                            <pilot>
                              <select faction="faction.ministry" tags="tag.fighterpilot"/>
                            </pilot>
                            <loadout>
                              <level exact="1.0"/>
                            </loadout>
                            <safepos value="$CurrentWingPosition"/>
                          </create_ship>

                          <add_to_group groupname="$SecondFleet" object="$CurrentShip"/>

                          <do_if value="$i == 1">
                            <set_relation_boost object="$CurrentShip" silent="true" faction="faction.player" value="-1.0" decay="0"/>
                            <add_to_group groupname="$SecondFleetWingCommanders" object="$CurrentShip"/>
                            <create_order id="'ProtectPosition'" object="$CurrentShip" default="true">
                              <param name="destination" value="[$DiversionStation.sector, $PlayerShipPosition]"/>
                            </create_order>
                            <create_order id="'Attack'" object="$CurrentShip" immediate="true">
                              <param name="primarytarget" value="player.ship"/>
                              <param name="pursuetargets" value="true"/>
                              <param name="allowothertargets" value="false"/>
                              <param name="checkrelation" value="false"/>
                            </create_order>
                          </do_if>
                          <do_else>
                            <do_any>
                              <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true" weight="1">
                                <param name="commander" value="$SecondFleetWingCommanders.{$w}"/>
                                <param name="assignment" value="assignment.attack"/>
                                <param name="cancelorders" value="true"/>
                              </create_order>
                              <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true" weight="2">
                                <param name="commander" value="$SecondFleetWingCommanders.{$w}"/>
                                <param name="assignment" value="assignment.defence"/>
                                <param name="cancelorders" value="true"/>
                              </create_order>
                            </do_any>
                          </do_else>
                        </do_for_each>
                      </do_for_each>

                      <set_objective cue="$MissionCue_Ch3_Diversion" action="objective.custom" customaction="{30252,3434}" step="$ObjectiveStep_3" updatebriefing="true"/>
                    </do_if>
                    <do_else>
                      <set_objective cue="$MissionCue_Ch3_Diversion" action="objective.wait" step="$ObjectiveStep_3" updatebriefing="true"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch3_3_Station_Raid">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Actually dropping crates from the station and having the ship pick them up would probably be overkill, since the player isn't even there to watch. -->
                    <create_order id="'MoveToObject'" object="$RaiderHubShip" immediate="true">
                      <param name="destination" value="$DiversionStation"/>
                      <param name="noattackresponse" value="true"/>
                    </create_order>

                    <signal_cue cue="Ch3_3_Setup_Second_Fleet"/>
                  </actions>
                </cue>

                <cue name="Ch3_3_EscapeThroughAnomaly">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="Ch3_3_Setup_Anomaly"/>
                    <cancel_cue cue="Ch3_FlagShipDestroyed" comment="Don't need to account for player destroying the fleet anymore"/>

                    <set_value name="$ObjectiveStep_3" operation="add" exact="1"/>
                    <!-- If the player has already left the sector, set $SkippedAnomaly and account for it in all following cues that progress the mission. -->
                    <do_if value="not player.sector or (player.sector != $OriginAnomaly.sector)">
                      <set_value name="$SkippedAnomaly"/>
                      <set_objective step="$ObjectiveStep_3" cue="$MissionCue_Ch3_Diversion" action="objective.wait" updatebriefing="true"/>
                      <signal_cue cue="Ch3_3_CleanUp"/>
                    </do_if>
                    <do_else>
                      <set_objective step="$ObjectiveStep_3" cue="$MissionCue_Ch3_Diversion" action="objective.custom" customaction="{30252,3431}" text="$OriginAnomaly.knownname" object="$OriginAnomaly" updatebriefing="true"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Ch3_3_Anomaly_Skip">
                      <conditions>
                        <event_object_changed_sector object="player.entity" previous="$OriginAnomaly.sector"/>
                        <check_value value="event.param != $DestinationAnomaly.sector"/>
                        <check_value value="not $SkippedAnomaly?" comment="The player could ALREADY be outside of the sector."/>
                      </conditions>
                      <actions>
                        <set_value name="$SkippedAnomaly"/>
                        <signal_cue cue="Ch3_3_CleanUp"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_3_Ace_Anomaly_Orders" onfail="cancel">
                      <conditions>
                        <check_value value="not $SkippedAnomaly?"/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.GetPositionBetweenObjects" result="$LocationTable">
                          <param name="FromObject"  value="$AceShip"/>
                          <param name="ToObject"    value="$OriginAnomaly"/>
                          <param name="Distance01"  value="100" comment="A really high number to account for a potentially short distance to the anomaly. We want the target to lie far behind the anomaly."/>
                        </run_actions>
                        <create_position name="$AnomalyWaitPos" object="$AceShip" value="$LocationTable.$position" space="$AceShip.sector"/>
                        <create_order id="'MoveWait'" object="$AceShip">
                          <param name="destination" value="[$AceShip.sector, $AnomalyWaitPos]"/>
                          <param name="precise" value="true"/>
                          <param name="noattackresponse" value="true"/>
                        </create_order>
                      </actions>
                      <delay exact="30s"/>
                      <actions>
                        <!-- Failsafe -->
                        <signal_cue cue="Ch3_3_Warp_Ace" check="false"/>
                      </actions>
                      <cues>

                        <!-- Ace lets the player know to follow them through the anomaly -->
                        <cue name="Ch3_EscapingIntoAnomaly_v2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AceActor"/>
                          <param name="DelayInitial"      value="2s"/>
                          <param name="Lines"             value="[[30252346],[30252347],[30252348],[30252349]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            I have an idea. Follow me!
                            Head for that tear there!
                            Accelerate! Do not slow down!
                            See you on the other side!
                          -->
                        </cue>

                        <cue name="Ch3_3_Ace_Reached_Anomaly" checkinterval="1s">
                          <conditions>
                            <check_value value="($AceShip.sector == $OriginAnomaly.sector) and ($AceShip.distanceto.{$OriginAnomaly} lt 5km)"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch3_3_Warp_Ace" check="false"/>
                          </actions>
                        </cue>

                        <cue name="Ch3_3_Warp_Ace">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <cancel_cue cue="Ch3_3_Ace_Handler"/>
                            <cancel_cue cue="Ch3_3_Ace_Reached_Anomaly"/>
                            <cancel_all_orders object="$AceShip"/>
                            <warp object="$AceShip" sector="$DestinationAnomaly.sector">
                              <safepos object="$DestinationAnomaly" min="500m" max="1km"/>
                              <orientation orientation="look_at" refobject="$DestinationAnomaly"/>
                            </warp>
                            <!-- Super failsafe. -->
                            <signal_objects object="$AceActor" param="'npc_state_reinit'"/>
                            <create_order id="'Wait'" object="$AceShip" default="true">
                              <param name="noattackresponse" value="true"/>
                            </create_order>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch3_3_ThroughAnomaly">
                      <conditions>
                        <event_player_entered_anomaly entry="$OriginAnomaly"/>
                        <check_value value="not $SkippedAnomaly?" comment="To prevent it from firing after the skip."/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch3_3_Warp_Ace" check="false"/>

                        <!-- Pursuing Ministry Fleet stops coming after player -->
                        <reset_relation_boost object="$MINFlagship" faction="faction.player"/>
                        <cancel_all_orders object="$MINFlagship"/>
                        <create_order object="$MINFlagship" id="'Patrol'" default="true">
                          <param name="space" value="$DiversionStation.zone"/>
                        </create_order>
                        <do_for_each in="$SecondFleetWingCommanders" name="$CurrentShip">
                          <reset_relation_boost object="$CurrentShip" faction="faction.player"/>
                          <cancel_all_orders object="$CurrentShip"/>
                          <create_order object="$CurrentShip" id="'Patrol'" default="true">
                            <param name="space" value="$DiversionStation.zone"/>
                          </create_order>
                        </do_for_each>

                        <set_objective cue="$MissionCue_Ch3_Diversion" action="objective.wait"/>
                        <!-- Set up Single Patrol to follow through the anomaly -->
                        <create_cue_actor name="$AnomalyPatrolActor" cue="namespace">
                          <select race="race.teladi" faction="faction.teladi" />
                          <page exact="10559"/>
                          <owner exact="faction.ministry"/>
                          <skills>
                            <skill type="management"  exact="7"/>
                            <skill type="morale"      exact="4"/>
                            <skill type="piloting"    exact="9"/>
                            <skill type="engineering" exact="5"/>
                            <skill type="boarding"    exact="7"/>
                          </skills>
                        </create_cue_actor>
                        <set_entity_traits entity="$AnomalyPatrolActor" missionactor="true" customhandler="true" subtitlename="true"/>
                        <set_value name="$AnomalyPatrolActor.$cutscenekey" exact="table[ $key = 'ShowNPCFace']"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <stop_player_autopilot />
                        <force_player_speed speed="30"/>
                      </actions>
                      <delay exact="1.2s"/>
                      <actions>
                        <force_player_speed speed="0"/>
                      </actions>
                      <cues>

                        <!-- Ace asks if the player came through alright -->
                        <cue name="Ch3_Escaped_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AceActor"/>
                          <param name="DelayInitial"      value="1.5s"/>
                          <param name="Lines"             value="[[30252350],[30252351, 2s],[30252352]]"/>
                          <param name="EndSignalCue"      value="Ch3_3_PatrolFollows"/>
                          <!--
                            Did you make it?
                            Great!
                            But it seems like jumping through that tear separated...
                          -->
                        </cue>

                        <cue name="Ch3_3_PatrolFollows">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <create_ship name="$AnomalyShip" macro="macro.ship_tel_s_fighter_01_b_macro" sector="$DestinationAnomaly.sector" commandeerable="false" capturable="false" missioncue="namespace">
                              <owner exact="faction.ministry" overridenpc="true" />
                              <pilot actor="$AnomalyPatrolActor"/>
                              <loadout>
                                <level exact="1.0"/>
                              </loadout>
                              <!--<orientation orientation="look_at" refobject="$AceShip"/>-->
                              <safepos object="$DestinationAnomaly" z="100m"/>
                            </create_ship>
                            <set_relation_boost object="$AnomalyShip" silent="true" otherobject="player.ship" value="-1.0" decay="0"/>

                            <cancel_all_orders object="$AnomalyShip"/>
                            <create_order id="'Wait'" object="$AnomalyShip" immediate="true">
                              <param name="timeout" value="0s" comment="with 0s this will be infinite" />
                              <param name="holdfire" value="true"/>
                              <param name="noattackresponse" value="true"/>
                            </create_order>

                            <add_effect object="$AnomalyShip.zone" effect="'jump_jumpin_khaak'">
                              <position object="$AnomalyShip"/>
                            </add_effect>

                            <set_value name="$ObjectiveStep_3" operation="add" exact="1"/>
                            <set_objective cue="$MissionCue_Ch3_Diversion" action="objective.custom" object="$AnomalyShip" customaction="{30252,3435}" step="$ObjectiveStep_3" updatebriefing="true"/>
                          </actions>
                        </cue>

                        <cue name="Ch3_3_AnomalyPatrolConversation">
                          <conditions>
                            <event_cue_completed cue="Ch3_3_PatrolFollows"/>
                          </conditions>
                          <actions>
                            <fade_screen fadeout="1.5s" fadein="1.5s" realtime="true"/>
                          </actions>
                          <delay exact="1.5s"/>
                          <actions>
                            <!-- We want the cutscene camera to be above the player ship, so that the player can see where the MIN ship is in relation to them. -->
                            <play_cutscene result="this.$CutsceneID" key="'Story_Criminal_Ch3_Anomaly'" abortable="true">
                              <param name="PlayerShip" object="if player.ship then player.ship else $AceShip"/>
                              <param name="MINShip" object="$AnomalyShip"/>
                            </play_cutscene>
                          </actions>
                          <cues>

                            <cue name="Ch3_3_Conversation_Lines_During_Cutscene">
                              <cues>
                                <cue name="Ch3_3_Anomaly_Ship_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$AnomalyPatrolActor"/>
                                  <param name="DelayInitial"      value="2s"/>
                                  <param name="Lines"             value="[[30252301],[30252302]]"/>
                                  <param name="Cutscene"          value="false"/>
                                  <param name="WaitForFullscreen" value="false"/>
                                  <param name="EndSignalCue"      value="Ch3_3_Conversation_Trigger"/>
                                  <!--
                                      (1/2)Stop right there! Nowhere to run now, criminal!(very righteous)
                                      (2/2)Prepare to be met with all the might of the Ministry of Finance!(earnest but over the top)
                                    -->
                                </cue>
                                <cue name="Ch3_3_Conversation_Lines_During_Cutscene_Trigger_Closeup">
                                  <conditions>
                                    <event_speak_finished actor="$AnomalyPatrolActor" line="30252301"/>
                                  </conditions>
                                  <actions>
                                    <cutscene_event key="'Story_Criminal_Ch3_Anomaly'" event="'Trigger_ShowMINPilot'"/>
                                  </actions>
                                </cue>
                                <cue name="Ch3_3_Conversation_Lines_During_Cutscene_Finished">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <signal_cue cue="Ch3_3_Conversation_Trigger"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Ch3_3_Conversation_Trigger">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <delay exact="1s"/>
                              <actions>
                                <stop_cutscene cutscene="parent.$CutsceneID"/>
                                <start_conversation actor="$AnomalyPatrolActor" conversation="anomaly_encounter" priority="100"/>
                              </actions>
                            </cue>

                            <cue name="Ch3_3_Conversation_1">
                              <conditions>
                                <event_conversation_started actor="$AnomalyPatrolActor" conversation="anomaly_encounter"/>
                              </conditions>
                              <actions>
                                <allow_conversation_escape enabled="false"/>
                                <add_player_choice section="anomaly_continue" position="bottom_right" text="{30252, 30252305}" comment="Where is your back up?"/>
                              </actions>
                              <cues>
                                <cue name="Ch3_3_Conversation_2">
                                  <conditions>
                                    <event_conversation_next_section actor="$AnomalyPatrolActor" section="anomaly_continue"/>
                                  </conditions>
                                  <actions>
                                    <allow_conversation_escape enabled="false"/>
                                    <add_npc_line speaker="$AnomalyPatrolActor" hidechoices="true">
                                      <text line="30252303" comment="What? Oh no!"/>
                                      <text line="30252304" comment="I have been separated from my squad!"/>
                                      <text line="30252305" comment="Abort mission, abort mission!"/>
                                      <text line="30252306" comment="Just let me get out of here!"/>
                                    </add_npc_line>
                                  </actions>
                                </cue>
                                <cue name="Ch3_3_Conversation_1_Ended">
                                  <conditions>
                                    <event_conversation_finished actor="$AnomalyPatrolActor"/>
                                  </conditions>
                                  <actions>
                                    <signal_cue cue="Ch3_3_Ending"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Ch3_3_Ending">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_objective cue="$MissionCue_Ch3_Diversion" action="objective.wait" silent="true"/>
                                <reset_relation_boost object="$AnomalyShip" otherobject="player.entity"/>
                                <create_order id="'MoveToObject'" object="$AnomalyShip" immediate="true">
                                  <param name="destination" value="$DiversionStation"/>
                                  <param name="noattackresponse" value="true"/>
                                </create_order>
                                <create_order object="$AnomalyShip" id="'MoveDie'">
                                  <param name="mintime" value="60s" comment="stay alive for specified time, after it docks"/>
                                </create_order>
                              </actions>
                              <cues>

                                <!-- Ace comments on the patrol fleeing -->
                                <cue name="Ch3_AnomalyFleeing_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$AceActor"/>
                                  <param name="DelayInitial"      value="2s"/>
                                  <param name="Lines"             value="[[30252353]]"/>
                                  <param name="EndSignalCue"      value="Ch3_3_CleanUp"/>
                                  <!--
                                    Yeah, that is right! Run along now! All hiss and no bite!
                                  -->
                                </cue>

                              </cues>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_3_CleanUp" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch3_3_Anomaly_Skip"/>
                    <cancel_cue cue="Ch3_3_PlayerChangedObject"/>
                    <signal_cue cue="Arcadian_Endeavour_Retreat_Order"/>
                    <!-- remove the anomaly link to make it a generic one -->
                    <remove_anomaly_destination anomaly="$OriginAnomaly" destination="$DestinationAnomaly"/>
                    <!-- If the boarding mission is also running, send Ace back to the to-be-boarded ship. -->
                    <do_if value="(Ch3_2_BoardShip.state == cuestate.complete) and (Ch3_2_ShipBoarded_Player.state == cuestate.waiting)">
                      <create_order object="$AceShip" id="'Follow'" immediate="true">
                        <param name="target" value="$Ch3_BoardShip"/>
                      </create_order>
                    </do_if>
                    <!-- Otherwise, send her back to the Arcadian Endeavour. -->
                    <do_else>
                      <create_order id="'ProtectShip'" object="$AceShip" immediate="true">
                        <param name="target" value="$RaiderHubShip"/>
                      </create_order>
                    </do_else>
                    <do_all exact="$MinistryFleet.count" counter="$i">
                      <reset_relation_boost object="$MinistryFleet.{$i}" faction="faction.player"/>
                      <reset_relation_boost object="$MinistryFleet.{$i}" otherobject="$AceShip"/>
                      <create_order object="$MinistryFleet.{$i}" id="'MoveDie'" immediate="true"/>
                    </do_all>
                    <do_for_each in="$SecondFleet" name="$CurrentShip">
                      <reset_relation_boost object="$CurrentShip" faction="faction.player"/>
                      <create_order object="$CurrentShip" id="'MoveDie'" immediate="true"/>
                    </do_for_each>
                    <set_object_min_hull object="$DiversionStation" exact="0"/>
                    <remove_from_list name="$Ch3_Missions" exact="$MissionCue_Ch3_Diversion"/>
                    <remove_mission cue="$MissionCue_Ch3_Diversion" type="completed"/>
                  </actions>
                  <patch sinceversion="2">
                    <cancel_cue cue="Ch3_3_PlayerChangedObject"/>
                  </patch>
                  <cues>

                    <cue name="Ch3_3_Debrief_Boso" onfail="cancel">
                      <conditions>
                        <check_value value="$BosoTa?"/>
                        <check_value value="not $SkippedAnomaly?"/>
                      </conditions>
                      <cues>

                        <!-- Station Plunder debrief (with Boso) -->
                        <cue name="Ch3_DistractionSuccessful_Boso_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$AceActor, $BosoTa, $MaestroActor]"/>
                          <param name="DelayInitial"      value="[5s, 3s, 3s]"/>
                          <param name="Lines"             value="[[[30252354],[30252355],[30252356],[30252357]],
                                                             [[30252303]],
                                                             [[30252337],[30252338],[30252339]]]"/>
                          <param name="EndSignalCue"      value="[null, null, Ch3_FinishCheck]"/>
                          <!--
                          Ace
                            You are probably wondering what allowed us two the dramatic exit, right? 
                            Well, some time back the Maestro came across these weird phenomena, kind of like tears in space.
                            You can use them to jump between systems, and we use them for a quick getaway.
                            But only if absolutely necessary! There is no way to control your destination, so with a bit of bad luck you can find yourself in a system overrun with Xenon.
                          Boso
                            How very interesting! While this group of ne'er-do-wells has also stumbled upon the anomalies, they are content with making use of them without questioning them too much! 
                          Maestro
                            While you two kept Ministry forces busy, we took station for all it is worth!
                            Did not go as smoothly as anticipated on your end, but handled well.
                            Good work, Chipmunk!
                          -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch3_3_Debrief_WithoutBoso" onfail="cancel">
                      <conditions>
                        <check_value value="not $BosoTa?"/>
                        <check_value value="not $SkippedAnomaly?"/>
                      </conditions>
                      <cues>

                        <!-- Station Plunder debrief (without Boso) -->
                        <cue name="Ch3_DistractionSuccessful_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$AceActor,$MaestroActor]"/>
                          <param name="DelayInitial"      value="[5s, 3s]"/>
                          <param name="Lines"             value="[[[30252354],[30252355],[30252356],[30252357],[30252358]],
                                                                 [[30252337],[30252338],[30252339]]]"/>
                          <param name="EndSignalCue"      value="[null, Ch3_FinishCheck]"/>
                          <!--
                          Ace
                            You are probably wondering what allowed us two the dramatic exit, right? 
                            Well, some time back the Maestro came across these weird phenomena, kind of like tears in space.
                            You can use them to jump between systems, and we use them for a quick getaway.
                            But only if absolutely necessary! There is no way to control your destination, so with a bit of bad luck you can find yourself in a system overrun with Xenon.
                            I am sure someone with more scientific acumen might be able to study these things and get more out of them, but that is certainly not us!
                          Maestro
                            While you two kept Ministry forces busy, we took station for all it is worth!
                            Did not go as smoothly as anticipated on your end, but handled well.
                            Good work, Chipmunk!
                          -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch3_3_Debrief_SkippedAnomaly" onfail="cancel">
                      <conditions>
                        <check_value value="$SkippedAnomaly?"/>
                      </conditions>
                      <cues>

                        <cue name="Ch3_DistractionSuccessful_Skip_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$MaestroActor"/>
                          <param name="DelayInitial"      value="5s"/>
                          <param name="Lines"             value="[[30252337],[30252338],[30252339]]"/>
                          <param name="EndSignalCue"      value="Ch3_FinishCheck"/>
                          <!--
                          Maestro
                            While you two kept Ministry forces busy, we took station for all it is worth!
                            Did not go as smoothly as anticipated on your end, but handled well.
                            Good work, Chipmunk!
                                  -->
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch3_Missions_SetUp">
              <conditions>
                <check_any>
                  <event_cue_completed cue="Ch3_1_BlueprintTheft"/>
                  <event_cue_completed cue="Ch3_2_BoardTradeShip"/>
                  <event_cue_completed cue="Ch3_3_Diversion"/>
                </check_any>
                <check_value value="Ch3_1_BlueprintTheft.state == cuestate.complete and Ch3_2_BoardTradeShip.state == cuestate.complete and Ch3_3_Diversion.state == cuestate.complete"/>
              </conditions>
              <actions>
                <set_value name="$Ch3_Missions" exact="[$MissionCue_Ch3_Blueprint, $MissionCue_Ch3_Diversion, $MissionCue_Ch3_Boarding]"/>
              </actions>
            </cue>

            <cue name="Ch3_FinishCheck" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="$Ch3_Missions.count == 0">
                  <signal_cue cue="Ch3_ThreadCompleted"/>
                </do_if>
                <do_else>
                  <set_value name="$NextMissionCue" exact="$Ch3_Missions.{1}"/>
                  <activate_mission cue="$NextMissionCue"/>
                </do_else>
              </actions>
            </cue>

            <cue name="Ch3_ThreadCompleted">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <!-- Chapter 3 debrief -->
                <cue name="Ch3_Completed_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$MaestroActor"/>
                  <param name="DelayInitial"      value="1min"/>
                  <param name="Lines"             value="[[30252340],[30252341],[30252342]]"/>
                  <param name="EndSignalCue"      value="Ch3_Cleanup"/>
                  <!--
                    Now all current preparation is complete.
                    Everything is taking shape.
                    Return so you can receive instructions on how to continue.
                  -->
                </cue>

                <cue name="Ch3_Cleanup">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Chapter 3 completed'" chance="$DebugChance"/>
                    <remove_mission cue="$MissionCue" type="completed"/>
                    <write_to_logbook category="missions" faction="faction.player" title="{30252,3121}" text="{30252,3122}" comment="You helped all three Empyrean Curs with tasks that will ultimately..."/>
                    <signal_cue cue="Ch4_Mellerds_Trust"/>
                    <cancel_cue cue="Ch3_Piracy_Targeted"/>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>

        </cue>

        <cue name="Ch4_Force">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch4_MellerdsJob">
            <!-- Cancelling Previous Chapters -->
            <set_value name="$CurrentChapter" exact="Ch4_Mellerds_Trust"/>
            <do_for_each in="$Chapters" name="$Chapter">
              <do_if value="$Chapter == $CurrentChapter">
                <signal_cue cue="$CurrentChapter"/>
                <break/>
              </do_if>
              <cancel_cue cue="$Chapter"/>
            </do_for_each>

            <!-- Custom Setup -->
            <do_if value="player.ship">
              <warp object="player.ship" sector="$RaiderHubShip.sector" zone="$RaiderHubShip.zone"/>
            </do_if>
          </force>
        </cue>

        <cue name="Ch4_Mellerds_Trust">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <!--  4_1 - briefing about exploiting former business partner for revenge and profit
                4_2 - bar, find shady person with mellerd's job offer
                4_3 - abduct passenger rml
                4_4 - mellerds office switch  -->
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$ObjectiveStep" exact="1"/>

            <create_mission cue="$MissionCue" name="{30252,4101}" description="{30252,4102}"
                            type="missiontype.plot" faction="faction.player" difficulty="level.medium"
                            abortable="false" icon="'briefing_maestro_01'" iconcaption="{30252,101}"
                            rewardtext="{30252,4120}">
              <briefing>
                <objective step="$ObjectiveStep" action="objective.talkto" object="$MaestroActor"/>
              </briefing>
            </create_mission>
            <set_objective_from_briefing cue="$MissionCue" step="$ObjectiveStep"/>
          </actions>
          <cues>

            <cue name="Ch4_1">
              <!-- Briefing about exploiting former business partner for revenge and profit -->
              <!-- To achieve the heist, the player has to flip a switch in their office -->
              <!-- To get into their office, the player has to gain their trust by finding a job offer and completing it -->
              <cues>

                <cue name="Ch4_1_Conversation">
                  <cues>

                    <!-- Maestro -->
                    <cue name="Ch4_1_Conv_Maestro_Started" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$MaestroActor"/>
                        <check_value value="not $Ch4_BriefingDone?"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252401" comment="readtext.{10453}.{30252401} (QuickLookup)"/>
                          <text line="30252402" comment="readtext.{10453}.{30252402} (QuickLookup)"/>
                          <text line="30252403" comment="readtext.{10453}.{30252403} (QuickLookup)"/>
                          <text line="30252404" comment="readtext.{10453}.{30252404} (QuickLookup)"/>
                          <text line="30252405" comment="readtext.{10453}.{30252405} (QuickLookup)"/>
                        </add_npc_line>
                        <set_value name="$Ch4_1_Achievement_Wildcard"/>
                        <signal_cue cue="Ch4_1_Conv_Maestro_Choices"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_1_Wildcard_Achievement">
                      <conditions>
                        <check_any>
                          <event_speak_line_finished actor="$MaestroActor" line="30252404"/>
                          <event_speak_finished actor="$MaestroActor" line="30252401"/>
                          <check_all>
                            <event_conversation_finished actor="$MaestroActor"/>
                            <check_value value="$Ch4_1_Achievement_Wildcard?"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <unlock_achievement name="TOA_PLOT_CRIMINAL_2" comment="The Wildcard"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_1_Conv_Maestro_Choices" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_conversation_next_section actor="$MaestroActor" section="ch4_main_choices"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <add_player_choice text="readtext.{30252}.{30252401}" section="ch4_rob_who"/>
                        <add_player_choice text="readtext.{30252}.{30252402}" section="ch4_steal_what" highlighted="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_1_Conv_Maestro_Rob_Who" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$MaestroActor" section="ch4_rob_who"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252410" comment="readtext.{10453}.{30252410} (QuickLookup)"/>
                          <text line="30252411" comment="readtext.{10453}.{30252411} (QuickLookup)"/>
                          <text line="30252412" comment="readtext.{10453}.{30252412} (QuickLookup)"/>
                          <text line="30252413" comment="readtext.{10453}.{30252413} (QuickLookup)"/>
                        </add_npc_line>
                        <do_if value="player.module == 'x4ep1_gamestart_pirate2'" comment="Prison GS">
                          <add_npc_line speaker="$MaestroActor" hidechoices="true">
                            <text line="30252420" comment="readtext.{10453}.{30252420} (QuickLookup)"/>
                          </add_npc_line>
                        </do_if>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252414" comment="readtext.{10453}.{30252414} (QuickLookup)"/>
                          <text line="30252415" comment="readtext.{10453}.{30252415} (QuickLookup)"/>
                          <text line="30252416" comment="readtext.{10453}.{30252416} (QuickLookup)"/>
                        </add_npc_line>

                        <add_player_choice text="readtext.{30252}.{30252403}" section="ch4_revenge"/>
                        <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="ch4_main_choices"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_1_Conv_Maestro_Plan_Revenge" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$MaestroActor" section="ch4_revenge"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252417" comment="readtext.{10453}.{30252417} (QuickLookup)"/>
                          <text line="30252418" comment="readtext.{10453}.{30252418} (QuickLookup)"/>
                          <text line="30252419" comment="readtext.{10453}.{30252419} (QuickLookup)"/>
                        </add_npc_line>
                        <signal_cue cue="Ch4_1_Conv_Maestro_Choices"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_1_Conv_Maestro_Steal_What" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$MaestroActor" section="ch4_steal_what"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252428" comment="readtext.{10453}.{30252428} (QuickLookup)"/>
                          <text line="30252429" comment="readtext.{10453}.{30252429} (QuickLookup)"/>
                          <text line="30252431" comment="readtext.{10453}.{30252431} (QuickLookup)"/>
                          <text line="30252432" comment="readtext.{10453}.{30252432} (QuickLookup)"/>
                        </add_npc_line>
                        <add_player_choice text="readtext.{30252}.{30252404}" section="ch4_get_it" highlighted="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_1_Conv_Maestro_Get_It" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$MaestroActor" section="ch4_get_it"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252433" comment="readtext.{10453}.{30252433} (QuickLookup)"/>
                          <text line="30252434" comment="readtext.{10453}.{30252434} (QuickLookup)"/>
                          <text line="30252435" comment="readtext.{10453}.{30252435} (QuickLookup)"/>
                        </add_npc_line>
                        <add_player_choice text="readtext.{30252}.{30252405}" section="ch4_get_in" highlighted="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_1_Conv_Maestro_Get_In" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$MaestroActor" section="ch4_get_in"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252440" comment="readtext.{10453}.{30252440} (QuickLookup)"/>
                          <text line="30252441" comment="readtext.{10453}.{30252441} (QuickLookup)"/>
                          <text line="30252442" comment="readtext.{10453}.{30252442} (QuickLookup)"/>
                          <text line="30252443" comment="readtext.{10453}.{30252443} (QuickLookup)"/>
                          <text line="30252444" comment="readtext.{10453}.{30252444} (QuickLookup)"/>
                        </add_npc_line>
                        <add_player_choice text="readtext.{30252}.{30252406}" section="ch4_office" highlighted="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_1_Conv_Maestro_Office" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$MaestroActor" section="ch4_office"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252450" comment="readtext.{10453}.{30252450} (QuickLookup)"/>
                          <text line="30252451" comment="readtext.{10453}.{30252451} (QuickLookup)"/>
                          <text line="30252452" comment="readtext.{10453}.{30252452} (QuickLookup)"/>
                          <text line="30252453" comment="readtext.{10453}.{30252453} (QuickLookup)"/>
                          <text line="30252454" comment="readtext.{10453}.{30252454} (QuickLookup)"/>
                        </add_npc_line>
                        <set_value name="$Ch4_BriefingDone"/>
                        <add_player_choice text="readtext.{30252}.{30252406}" section="ch4_plan"/>
                        <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="g_cancel" highlighted="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_1_Conv_Maestro_Plan" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_conversation_next_section actor="$MaestroActor" section="ch4_plan"/>
                          <check_all>
                            <event_conversation_started actor="$MaestroActor"/>
                            <check_value value="$Ch4_BriefingDone?"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="true"/>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252460" comment="readtext.{10453}.{30252460} (QuickLookup)"/>
                          <text line="30252461" comment="readtext.{10453}.{30252461} (QuickLookup)"/>
                          <text line="30252462" comment="readtext.{10453}.{30252462} (QuickLookup)"/>
                          <text line="30252463" comment="readtext.{10453}.{30252463} (QuickLookup)"/>
                        </add_npc_line>
                      </actions>
                    </cue>

                    <cue name="Ch4_1_Conv_Maestro_Completed">
                      <conditions>
                        <event_conversation_finished actor="$MaestroActor"/>
                        <check_value value="$Ch4_BriefingDone?"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch4_1_Complete"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_1_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <update_mission cue="$MissionCue" description="{30252,4103} + '\n\n' + {30252,4105}"/>
                    <cancel_cue cue="parent"/>
                    <signal_cue cue="Ch4_2"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch4_2">
              <!-- Bar Conversation -->
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" exact="1" operation="add"/>
              </actions>
              <cues>

                <cue name="Ch4_2_Speech_BosoDal_Commentary">
                  <cues>

                    <cue name="Ch4_2_Speech_BosoDal_Check">
                      <actions>
                        <do_if value="$DalBusta?">
                          <signal_cue cue="Ch4_2_Speech_Dal"/>
                        </do_if>
                        <do_elseif value="$BosoTa?">
                          <signal_cue cue="Ch4_2_Speech_Boso"/>
                        </do_elseif>
                      </actions>
                    </cue>

                    <cue name="Ch4_2_Speech_Dal">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_2_Speech_Dal_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="Lines"             value="[[30252401]]" comment="x"/>
                          <param name="EndSignalCue"      value="Ch4_2_Speech_Boso"/>
                          <!--
                          <t id="	30252401	">	Wildcard, eh? Now we're getting somewhere!	</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_2_Speech_Boso">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$BosoTa?"/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_2_Speech_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="Lines"             value="[[30252411],[30252412],[30252413]]" comment="x"/>
                          <!--
                          <t id="	30252411	">	Just be wary that the place you are heading to does not end up being a prison cell.	</t>
                          <t id="	30252412	">	As far as I know the Ministry Science division, any technology they produce is greatly unimaginative and pragmatic.	</t>
                          <t id="	30252413	">	Let us remain curious, but prepare for a sincere lack of admiration for intricacy in their work.	</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_2_FindStation">
                  <actions>
                    <!-- find station / dockable, preference list -->
                    <!-- listen for "destroyed", reset objective + station room / npc setup -->
                    <!-- fallback if no suitable stations exist  (wait for faction to have stations) -->

                    <reset_cue cue="Ch4_2_SetupBar"/>
                    <reset_cue cue="Ch4_2_PlaceNPCs"/>
                    <reset_cue cue="Ch4_2_Conversation"/>
                    <reset_cue cue="Ch4_2_ObjectiveUpdate"/>

                    <!-- find station:
                          - aurora? 
                          - vig docking?
                          - rip docking?
                          - vig? -> gain reputation
                          - rip? -> gain reputation
                          - none? -> wait for faction to have stations (await: faction ?)                    
                    -->

                    <remove_value name="$BarStation"/>
                    <do_all exact="1" comment="break cases instead of do_if">
                      <!-- Aurora Casino & Player can dock at VIG -->
                      <do_if value="$PirateLandmark02.exists
                                and $PirateLandmark02.isoperational
                                and $PirateLandmark02.owner.relationto.{faction.player} gt faction.player.relation.dock.min">
                        <remove_value name="$docks"/>
                        <find_dockingbay name="$docks" object="$PirateLandmark02" checkoperational="true" multiple="true" walkable="true"/>
                        <do_if value="$docks.count">
                          <set_value name="$BarStation" exact="$PirateLandmark02"/>
                          <break/>
                        </do_if>
                      </do_if>

                      <!-- VIG owned with docking permission -->
                      <find_station name="$PossibleBarContainers" space="player.galaxy" multiple="true" tradestation="false" sortbydistanceto="player.entity" owner="faction.loanshark">
                        <match_dock size="tag.dock_s" walkable="true"/>
                        <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                      </find_station>
                      <do_if value="$PossibleBarContainers.count and ($PossibleBarContainers.{1} != $PrisonStation)">
                        <set_value name="$BarStation" exact="$PossibleBarContainers.{1}"/>
                        <break/>
                      </do_if>
                      <do_elseif value="$PossibleBarContainers.count ge 2">
                        <set_value name="$BarStation" exact="$PossibleBarContainers.{2}"/>
                        <break/>
                      </do_elseif>
                      <!-- RIP owned with docking permission -->
                      <find_station name="$PossibleBarContainers" space="player.galaxy" multiple="true" tradestation="false" sortbydistanceto="player.entity" owner="faction.scavenger">
                        <match_dock walkable="true"/>
                        <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                      </find_station>
                      <do_if value="$PossibleBarContainers.count and ($PossibleBarContainers.{1} != $PrisonStation)">
                        <set_value name="$BarStation" exact="$PossibleBarContainers.{1}"/>
                        <break/>
                      </do_if>
                      <do_elseif value="$PossibleBarContainers.count ge 2">
                        <set_value name="$BarStation" exact="$PossibleBarContainers.{2}"/>
                        <break/>
                      </do_elseif>

                      <!-- VIG owned without docking permission -->
                      <find_station name="$PossibleBarContainers" space="player.galaxy" multiple="true" tradestation="false" sortbydistanceto="player.entity" owner="faction.loanshark">
                        <match_dock walkable="true"/>
                      </find_station>
                      <do_if value="$PossibleBarContainers.count and ($PossibleBarContainers.{1} != $PrisonStation)">
                        <set_value name="$BarStation" exact="$PossibleBarContainers.{1}"/>
                        <break/>
                      </do_if>
                      <do_elseif value="$PossibleBarContainers.count ge 2">
                        <set_value name="$BarStation" exact="$PossibleBarContainers.{2}"/>
                        <break/>
                      </do_elseif>
                      <!-- RIP owned without  docking permission -->
                      <find_station name="$PossibleBarContainers" space="player.galaxy" multiple="true" tradestation="false" sortbydistanceto="player.entity" owner="faction.scavenger">
                        <match_dock walkable="true"/>
                      </find_station>
                      <do_if value="$PossibleBarContainers.count and ($PossibleBarContainers.{1} != $PrisonStation)">
                        <set_value name="$BarStation" exact="$PossibleBarContainers.{1}"/>
                        <break/>
                      </do_if>
                      <do_elseif value="$PossibleBarContainers.count ge 2">
                        <set_value name="$BarStation" exact="$PossibleBarContainers.{2}"/>
                        <break/>
                      </do_elseif>

                      <!-- If we did not break until here we did not find a walkable VIG/RIP station in the universe -->
                      <assert value="not ($BarStation? and $BarStation.exists)" text="'[Heinrich] BarStation exists unexpectedly.'"/>
                      <run_actions ref="md.LIB_Generic.WaitForFactionsToHaveStations">
                        <param name="Factions"  value="[faction.loanshark, faction.scavenger]"/>
                        <param name="SignalCue" value="Ch4_2_FactionsHaveStations_Success"/>
                        <!--<param name="CheckInterval" value="30s" comment="temp"/>-->
                      </run_actions>
                      <debug_text text="'Waiting for Factions to have stations'" chance="$DebugChance"/>
                      <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.await" text="{20203,3301}" updatebriefing="true"/>

                      <!-- Else Create a station ? Could have failed due to docking relations  -->
                      <!--<create_station macro="macro.station_gen_factory_base_01_macro" name="$RelayStation" owner="faction.antigone" sector="$AntigoneMemorialSector" state="componentstate.operational" constructionplan="'arg_defence'">
                        <safepos space="$AntigoneMemorial" min="30km" max="80km" radius="80km" allowyaxis="false"/>
                      </create_station>
                      <signal_objects object="player.galaxy" param="'init station'" param2="$RelayStation" param3="false" comment="Add control entities."/>-->
                    </do_all>
                  </actions>
                  <cues>
                    <!-- Station Not Found -->
                    <cue name="Ch4_2_FactionsHaveStations_Success">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="0.01s" comment="preventing loop freezes, though that shouldn't be possible in the current implementation"/>
                      <actions>
                        <debug_text text="'Found Faction Station'" chance="$DebugChance"/>
                        <reset_cue cue="parent"/>
                      </actions>
                    </cue>

                    <!-- Station Found -->
                    <cue name="Ch4_2_StationFound" onfail="cancel">
                      <conditions>
                        <check_value value="$BarStation? and $BarStation.exists"/>
                      </conditions>
                      <cues>
                        <!-- Reputation Objective Handling -->
                        <cue name="Ch4_2_BarStationReputation">
                          <actions>
                            <do_if value="$BarStation.owner.relationto.{faction.player} gt faction.player.relation.dock.min">
                              <signal_cue cue="Ch4_2_SetupBar"/>
                              <cancel_cue cue="this"/>
                            </do_if>
                            <do_else>
                              <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.gain_reputation" text="$BarStation.owner.name" updatebriefing="true"/>
                            </do_else>
                          </actions>
                          <cues>
                            <cue name="Ch4_2_BarStationReputation_Success">
                              <conditions>
                                <event_player_relation_changed faction="$BarStation.owner"/>
                                <check_value value="not event.object" comment="only permanent changes are relevant"/>
                                <check_value value="(event.param2.{1} gt faction.player.relation.dock.min) and (event.param2.{2} le faction.player.relation.dock.min)"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch4_2_SetupBar"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <!-- Station Destroyed Handling -->
                        <cue name="Ch4_2_Station_Destroyed">
                          <conditions>
                            <event_object_destroyed object="$BarStation"/>
                          </conditions>
                          <actions>
                            <reset_cue cue="parent.parent"/>
                          </actions>
                        </cue>
                        <cue name="Debug_DestroyBarStation">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_for_each name="$Module" in="$BarStation.modules.all.list">
                              <destroy_object object="$Module" explosion="true"/>
                            </do_for_each>
                          </actions>
                        </cue>
                        <cue name="Debug_DestroyAllStations">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <find_station name="$RIPStations" space="player.galaxy" multiple="true" sortbydistanceto="player.entity" owner="faction.scavenger"/>
                            <do_for_each in="$RIPStations" name="$s">
                              <destroy_object object="$s"/>
                            </do_for_each>
                            <find_station name="$VIGStations" space="player.galaxy" multiple="true" sortbydistanceto="player.entity" owner="faction.loanshark"/>
                            <do_for_each in="$VIGStations" name="$s">
                              <destroy_object object="$s"/>
                            </do_for_each>
                          </actions>
                        </cue>
                        <cue name="Debug_SpawnStation">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <create_station macro="macro.station_gen_factory_base_01_macro" name="$RelayStation" owner="faction.loanshark" sector="player.sector" state="componentstate.operational" constructionplan="'arg_defence'">
                              <safepos space="player.sector" min="10km" max="30km" radius="80km" allowyaxis="false"/>
                            </create_station>
                            <signal_objects object="player.galaxy" param="'init station'" param2="$RelayStation" param3="false" comment="Add control entities."/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_2_SetupBar">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Determine interior macros -->
                    <get_room_definition macro="$BarCorridorMacro" doors="$BarDoors" race="$BarStation.owner.primaryrace" tags="tag.corridor" />
                    <get_room_definition macro="$BarRoomMacro" tags="tag.bar" />
                    <!-- Create persistent interior. -->
                    <create_dynamic_interior     roomname="$BarRoom"         room="$BarRoomMacro"
                                             corridorname="$BarCorridor" corridor="$BarCorridorMacro"
                                             interiorname="$BarInterior"
                                             name="'{20007,1031}'" comment="Bar"
                                             object="$BarStation" persistent="true"/>


                    <!-- Mute bar music, because it's otherwise audible from the customs office, despite being on a different floor (overlap issue). -->
                    <do_if value="player.room.dynamicinterior != $BarRoom.dynamicinterior">
                      <debug_text text="'Setting bar music volume to 0 initially.'" chance="$DebugChance"/>
                      <set_object_sound_override object="$BarRoom" volume="0" type="ambient"/>
                    </do_if>
                    <do_else>
                      <debug_text text="'Setting bar music volume to 0.2 initially.'" chance="$DebugChance"/>
                      <set_object_sound_override object="$BarRoom" volume="0.2" type="ambient"/>
                    </do_else>

                    <signal_cue cue="Ch4_2_PlaceNPCs"/>
                  </actions>
                  <cues>

                    <cue name="Ch4_2_Adjust_Bar_Ambience" instantiate="true">
                      <conditions>
                        <event_object_changed_room object="player.entity"/>
                        <check_value value="$BarRoom"/>
                      </conditions>
                      <actions>
                        <do_if value="(event.param2.dynamicinterior != $BarRoom.dynamicinterior) and (event.param.dynamicinterior == $BarRoom.dynamicinterior)">
                          <debug_text text="'Player entered bar room dynamic interior. Resetting bar music volume to make it audible through the wall.'" chance="$DebugChance"/>
                          <clear_object_sound_override object="$BarRoom" type="ambient"/>
                        </do_if>
                        <do_if value="(event.param2.dynamicinterior == $BarRoom.dynamicinterior) and (event.param.dynamicinterior != $BarRoom.dynamicinterior)">
                          <debug_text text="'Player left bar room dynamic interior. Setting bar music volume to 0 because of potential space overlap.'" chance="$DebugChance"/>
                          <set_object_sound_override object="$BarRoom" volume="0" type="ambient"/>
                        </do_if>
                        <do_elseif value="event.param == $BarRoom">
                          <debug_text text="'Player entered bar. Setting bar music volume to 0.2.'" chance="$DebugChance"/>
                          <set_object_sound_override object="$BarRoom" volume="0.2" type="ambient"/>
                        </do_elseif>
                        <do_elseif value="event.param2 == $BarRoom and event.param != $BarRoom">
                          <debug_text text="'Player left bar. Resetting bar music volume.'" chance="$DebugChance"/>
                          <clear_object_sound_override object="$BarRoom" type="ambient"/>
                        </do_elseif>
                      </actions>
                    </cue>

                  </cues>
                </cue>
                <cue name="Debug_RemoveNPCs">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $ShadyBarContactActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $ShadyBarDecoyActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $StevLuccaActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                    <!--<remove_actor_from_room actor="$ShadyBarContactActor"/>
                    <remove_actor_from_room actor="$ShadyBarDecoyActor"/>
                    <remove_actor_from_room actor="$StevLuccaActor"/>
                    <destroy_object object="$ShadyBarContactActor"/>
                    <destroy_object object="$ShadyBarDecoyActor"/>
                    <destroy_object object="$StevLuccaActor"/>-->
                  </actions>
                </cue>

                <cue name="Ch4_2_PlaceNPCs">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Find specific slot to place actors on. -->
                    <find_npc_slot name="$PotentialBarSlots" excludefilled="false" object="$BarRoom" multiple="true"/>

                    <do_for_each in="$PotentialBarSlots" name="$Slot" reverse="true">
                      <do_if value="$Slot.name == 'con_npc_lean_rail14'">
                        <set_value         name="$BarContactSlot" exact="$Slot"/>
                        <remove_from_list exact="$BarContactSlot" name="$PotentialBarSlots"/>
                      </do_if>
                      <do_if value="$Slot.name == 'con_npc_lean_rail09'">
                        <set_value         name="$BarDecoySlot" exact="$Slot"/>
                        <remove_from_list exact="$BarDecoySlot" name="$PotentialBarSlots"/>
                      </do_if>
                      <do_if value="$Slot.name == 'con_npc_lean_rail00'">
                        <set_value         name="$BarPassengerSlot" exact="$Slot"/>
                        <remove_from_list exact="$BarPassengerSlot" name="$PotentialBarSlots"/>
                      </do_if>
                    </do_for_each>
                    <!-- Slot failsafes. -->
                    <do_if value="not $BarContactSlot?">
                      <set_value exact="$PotentialBarSlots.random" name="$BarContactSlot"/>
                      <remove_from_list name="$PotentialBarSlots" exact="$BarContactSlot"/>
                    </do_if>
                    <do_if value="not $BarDecoySlot?">
                      <set_value exact="$PotentialBarSlots.random" name="$BarDecoySlot"/>
                      <remove_from_list name="$PotentialBarSlots" exact="$BarDecoySlot"/>
                    </do_if>
                    <do_if value="not $BarPassengerSlot?">
                      <set_value exact="$PotentialBarSlots.random" name="$BarPassengerSlot"/>
                      <remove_from_list name="$PotentialBarSlots" exact="$BarPassengerSlot"/>
                    </do_if>

                    <!-- Place actors -->
                    <!-- Contact Actor -->
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $ShadyBarContactActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $BarContactSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                    <add_to_group groupname="$ConversationPuzzleActors" object="$ShadyBarContactActor"/>

                    <!-- Decoy Actor -->
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $ShadyBarDecoyActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $BarDecoySlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                    <add_to_group groupname="$ConversationPuzzleActors" object="$ShadyBarDecoyActor"/>

                    <!-- Passenger Actor -->
                    <set_value name="$StevLuccaActor.$PassengerConvHandlerExists" exact="true" comment="Validation blackboard variable so the RML can know something is looking after the conversation."/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $StevLuccaActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $BarPassengerSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                    <add_to_group groupname="$ConversationPuzzleActors" object="$StevLuccaActor"/>
                  </actions>
                </cue>

                <cue name="Ch4_2_ObjectiveUpdate">
                  <conditions>
                    <event_cue_completed cue="Ch4_2_PlaceNPCs"/>
                  </conditions>
                  <cues>

                    <cue name="Ch4_2_Objective_InvestigateRoom">
                      <actions>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.investigate" object="$BarRoom" text="{20007,1031}" updatebriefing="true"/>
                      </actions>
                      <cues>
                        <cue name="Ch4_2_Objective_InvestigatePeople">
                          <conditions>
                            <event_object_changed_object object="player.entity" newobject="$BarRoom"/>
                          </conditions>
                          <actions>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" group="$ConversationPuzzleActors" customaction="{30226,2014}" updatebriefing="true" silent="true"/>
                          </actions>
                          <cues>
                            <cue name="Ch4_2_Objective_ResetRoomObjective">
                              <conditions>
                                <event_object_changed_object object="player.entity" previous="$BarRoom"/>
                              </conditions>
                              <actions>
                                <reset_cue cue="Ch4_2_Objective_InvestigateRoom"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_2_BarDecoy_Ship">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$Bought_Ch4_2_BarDecoy_Ship"/>

                    <find_dockingbay name="$DecoyShipDock" object="$ShadyBarDecoyActor.station" checkoperational="true" multiple="false">
                      <match_dock size="tag.dock_s" storage="true"/>
                    </find_dockingbay>

                    <create_loadout result="$loadout">
                      <macros>
                        <engine macro="engine_par_s_combat_01_mk1_macro" path="../con_engine_02"/>
                        <engine macro="engine_par_s_combat_01_mk1_macro" path="../con_engine_01"/>
                        <weapon macro="weapon_tel_s_charge_01_mk1_macro" path="../con_weapon_01"/>
                        <shield macro="shield_tel_s_standard_01_mk1_macro" path="../con_shield_02"/>
                      </macros>
                      <software>
                        <software ware="software_flightassistmk1"/>
                        <software ware="software_scannerlongrangemk1"/>
                        <software ware="software_scannerobjectmk1"/>
                        <software ware="software_trademk1"/>
                      </software>
                      <virtualmacros>
                        <thruster macro="thruster_gen_s_allround_01_mk1_macro"/>
                      </virtualmacros>
                    </create_loadout>
                    <create_ship name="$BarDecoy_SoldShip" dock="$DecoyShipDock"
                                 macro="ship_tel_s_trans_container_01_a_macro" missioncue="namespace">
                      <people>
                        <fillpercent exact="0"/>
                      </people>
                      <loadout loadout="$loadout"/>
                      <owner exact="$DecoyShipDock.owner" comment="pitfall: needs to be dock owner to not fail if player is not at docking relations"/>
                      <!-- Disposal Unit 3 -->
                      <paint ware="ware.paintmod_0072"/>
                      <pilot actor="null" />
                    </create_ship>
                    <set_owner object="$BarDecoy_SoldShip" faction="faction.player" comment="pitfall: needs to be done after creation to avoid spawn failure cases due to relations"/>

                  </actions>
                </cue>

                <cue name="Ch4_2_Conversation">
                  <cues>

                    <!-- Decoy NPC -->
                    <cue name="Ch4_2_Conversation_BarDecoy">
                      <cues>

                        <cue name="Ch4_2_Conv_BarDecoy_Started" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$ShadyBarDecoyActor"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                              <text line="30252404" comment="readtext.{10559}.{30252404} (QuickLookup)"/>
                            </add_npc_line>

                            <do_if value="not $DecoySaid.indexof.{30252405}">
                              <append_to_list name="$DecoySaid" exact="30252405"/>
                              <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                                <text line="30252405" comment="readtext.{10559}.{30252405} (QuickLookup)"/>
                              </add_npc_line>
                            </do_if>
                            <do_elseif value="not $Ch4_2_Bought?">
                              <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                                <text line="30252435" comment="readtext.{10559}.{30252435} (QuickLookup)"/>
                              </add_npc_line>
                            </do_elseif>

                            <signal_cue cue="Ch4_2_Conv_BarDecoy_MainChoices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_MainChoices" instantiate="true">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_decoy_mainchoices"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <add_player_choice text="readtext.{1002}.{20}" position="bottom_right" section="g_cancel"/>
                            <do_if value="not $Ch4_2_DecoyWorking?">
                              <add_player_choice text="readtext.{30252}.{30252410}" section="ch4_decoy_workfor"/>
                            </do_if>
                            <do_else>
                              <add_player_choice text="readtext.{30252}.{30252411}" section="ch4_decoy_else"/>
                            </do_else>
                            <add_player_choice text="readtext.{30252}.{30252412}" section="ch4_decoy_selling" selectable="not $Ch4_2_Bought?"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_Workfor" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_decoy_workfor"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                              <text line="30252406" comment="readtext.{10559}.{30252406} (QuickLookup)"/>
                            </add_npc_line>
                            <set_value name="$Ch4_2_DecoyWorking"/>
                            <signal_cue cue="Ch4_2_Conv_BarDecoy_MainChoices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_Else" instantiate="true">
                          <conditions>
                            <check_any>
                              <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_decoy_else"/>
                              <event_conversation_next_section actor="$ShadyBarDecoyActor" section="g_cancel"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <do_if value="$Ch4_2_Bought?">
                              <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                                <text line="2007" comment="readtext.{10559}.{2007} (QuickLookup)"/>
                              </add_npc_line>
                            </do_if>
                            <do_else>
                              <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                                <text line="30252407" comment="readtext.{10559}.{30252407} (QuickLookup)"/>
                              </add_npc_line>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_Selling" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_decoy_selling"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                              <text line="30252410" comment="readtext.{10559}.{30252410} (QuickLookup)"/>
                              <text line="30252411" comment="readtext.{10559}.{30252411} (QuickLookup)"/>
                            </add_npc_line>
                            <add_player_choice text="readtext.{30252}.{30252413}" section="ch4_decoy_ship"/>
                            <add_player_choice text="readtext.{1002}.{20}" position="bottom_right" section="ch4_decoy_mainchoices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_Ship" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_decoy_ship"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                              <text line="30252412" comment="readtext.{10559}.{30252412} (QuickLookup)"/>
                              <text line="30252413" comment="readtext.{10559}.{30252413} (QuickLookup)"/>
                              <text line="30252414" comment="readtext.{10559}.{30252414} (QuickLookup)"/>
                              <text line="30252415" comment="readtext.{10559}.{30252415} (QuickLookup)"/>
                            </add_npc_line>
                            <add_player_choice text="readtext.{30252}.{30252414}" section="ch4_decoy_see"/>
                            <add_player_choice text="readtext.{1002}.{20}" position="bottom_right" section="ch4_decoy_mainchoices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_See" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_decoy_see"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                              <text line="30252420" comment="readtext.{10559}.{30252420} (QuickLookup)"/>
                              <text line="30252421" comment="readtext.{10559}.{30252421} (QuickLookup)"/>
                            </add_npc_line>
                            <signal_cue cue="Ch4_2_Conv_BarDecoy_ShipQuery"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_ShipQuery" instantiate="true">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_decoy_querysection"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <add_player_choice text="readtext.{30252}.{30252415}" section="ch4_decoy_engine1"/>
                            <add_player_choice text="readtext.{30252}.{30252417}" section="ch4_decoy_weapons"/>
                            <add_player_choice text="readtext.{30252}.{30252418}" section="ch4_decoy_shields"/>
                            <add_player_choice text="readtext.{30252}.{30252420}" section="ch4_offer_payment" selectable="not $Ch4_2_Bought?"/>
                            <add_player_choice text="readtext.{1002}.{20}" position="bottom_right" section="ch4_decoy_mainchoices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_OfferPayment" instantiate="true">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_offer_payment"/>
                            </check_any>
                            <check_value value="not $Ch4_2_Bought?"/>
                          </conditions>
                          <actions>
                            <add_player_choice text="readtext.{1002}.{20}" position="bottom_right" section="ch4_decoy_querysection"/>

                            <!-- Choice 1 -->
                            <set_value name="$Cr_Amount" exact="(50 * 1000)"/>
                            <substitute_text text="$OfferCredits" source="{30221,3280}">
                              <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                            </substitute_text>
                            <set_value name="$Cr_Amount_Converted" exact="($Cr_Amount)Cr"/>
                            <add_player_choice section="ch4_decoy_insult"
                                               text="$OfferCredits" comment="Offer Cr"
                                               selectable="(player.money ge $Cr_Amount_Converted)"
                                               tooltip="if (player.money ge $Cr_Amount_Converted) then '' else {30221,3271}"/>
                            <!-- Choice 2 -->
                            <set_value name="$Cr_Amount" exact="(100 * 1000)"/>
                            <substitute_text text="$OfferCredits" source="{30221,3280}">
                              <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                            </substitute_text>
                            <set_value name="$Cr_Amount_Converted" exact="($Cr_Amount)Cr"/>
                            <add_player_choice section="ch4_decoy_insult"
                                               text="$OfferCredits" comment="Offer Cr"
                                               selectable="(player.money ge $Cr_Amount_Converted)"
                                               tooltip="if (player.money ge $Cr_Amount_Converted) then '' else {30221,3271}"/>
                            <!-- Choice 3 -->
                            <set_value name="$Cr_Amount" exact="(150 * 1000)"/>
                            <substitute_text text="$OfferCredits" source="{30221,3280}">
                              <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                            </substitute_text>
                            <set_value name="$Cr_Amount_Converted" exact="($Cr_Amount)Cr"/>
                            <add_player_choice section="ch4_decoy_insult"
                                               text="$OfferCredits" comment="Offer Cr"
                                               selectable="(player.money ge $Cr_Amount_Converted)"
                                               tooltip="if (player.money ge $Cr_Amount_Converted) then '' else {30221,3271}"/>
                            <!-- Choice 4 -->
                            <set_value name="$Cr_Amount" exact="(200 * 1000)"/>
                            <substitute_text text="$OfferCredits" source="{30221,3280}">
                              <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                            </substitute_text>
                            <set_value name="$Cr_Amount_Converted" exact="($Cr_Amount)Cr"/>
                            <add_player_choice section="ch4_decoy_deal"
                                               text="$OfferCredits" comment="Offer Cr"
                                               selectable="(player.money ge $Cr_Amount_Converted)"
                                               tooltip="if (player.money ge $Cr_Amount_Converted) then '' else {30221,3271}"/>
                            <!-- Choice 5 -->
                            <set_value name="$Cr_Amount" exact="(250 * 1000)"/>
                            <substitute_text text="$OfferCredits" source="{30221,3280}">
                              <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                            </substitute_text>
                            <set_value name="$Cr_Amount_Converted" exact="($Cr_Amount)Cr"/>
                            <add_player_choice section="ch4_decoy_deal"
                                               text="$OfferCredits" comment="Offer Cr"
                                               selectable="(player.money ge $Cr_Amount_Converted)"
                                               tooltip="if (player.money ge $Cr_Amount_Converted) then '' else {30221,3271}"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_Engine1" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_decoy_engine1"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                              <text line="30252422" comment="readtext.{10559}.{30252422} (QuickLookup)"/>
                              <text line="30252423" comment="readtext.{10559}.{30252423} (QuickLookup)"/>
                            </add_npc_line>
                            <add_player_choice text="readtext.{30252}.{30252416}" section="ch4_decoy_engine2"/>
                            <add_player_choice text="readtext.{1002}.{20}" position="bottom_right" section="ch4_decoy_querysection"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_Engine2" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_decoy_engine2"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                              <text line="30252430" comment="readtext.{10559}.{30252430} (QuickLookup)"/>
                              <text line="30252431" comment="readtext.{10559}.{30252431} (QuickLookup)"/>
                            </add_npc_line>
                            <signal_cue cue="Ch4_2_Conv_BarDecoy_ShipQuery"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_Weapons" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_decoy_weapons"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                              <text line="30252432" comment="readtext.{10559}.{30252432} (QuickLookup)"/>
                              <text line="30252433" comment="readtext.{10559}.{30252433} (QuickLookup)"/>
                            </add_npc_line>
                            <signal_cue cue="Ch4_2_Conv_BarDecoy_ShipQuery"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_Shields" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_decoy_shields"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                              <text line="30252434" comment="readtext.{10559}.{30252434} (QuickLookup)"/>
                              <text line="30252435" comment="readtext.{10559}.{30252435} (QuickLookup)"/>
                            </add_npc_line>
                            <signal_cue cue="Ch4_2_Conv_BarDecoy_ShipQuery"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_Deal" instantiate="false" comment="once">
                          <conditions>
                            <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_decoy_deal"/>
                          </conditions>
                          <actions>
                            <set_value name="$Ch4_2_Bought"/>
                            <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                              <text line="30252436" comment="readtext.{10559}.{30252436} (QuickLookup)"/>
                              <text line="30252439" comment="readtext.{10559}.{30252439} (QuickLookup)"/>
                              <text line="30252440" comment="readtext.{10559}.{30252440} (QuickLookup)"/>
                            </add_npc_line>

                            <signal_cue cue="Ch4_2_BarDecoy_Ship"/>

                            <signal_cue cue="Ch4_2_Conv_BarDecoy_MainChoices"/>

                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_BarDecoy_Insult" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$ShadyBarDecoyActor" section="ch4_decoy_insult"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$ShadyBarDecoyActor" hidechoices="true">
                              <text line="30252437" comment="readtext.{10559}.{30252437} (QuickLookup)"/>
                            </add_npc_line>
                            <signal_cue cue="Ch4_2_Conv_BarDecoy_OfferPayment"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <!-- Lucca -->
                    <cue name="Ch4_2_Conversation_Passenger">
                      <cues>

                        <cue name="Ch4_2_Conv_Lucca_Started" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$StevLuccaActor"/>
                          </conditions>
                          <actions>
                            <do_if value="not $LuccaSaid.indexof.{30252402}">
                              <append_to_list name="$LuccaSaid" exact="30252402"/>
                              <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                                <text line="30252401" comment="readtext.{10454}.{30252401} (QuickLookup)"/>
                                <text line="30252402" comment="readtext.{10454}.{30252402} (QuickLookup)"/>
                              </add_npc_line>
                            </do_if>
                            <do_else>
                              <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                                <text line="30252410" comment="readtext.{10454}.{30252410} (QuickLookup)"/>
                              </add_npc_line>
                            </do_else>

                            <signal_cue cue="Ch4_2_Conv_Lucca_MainChoices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_MainChoices" instantiate="true">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <event_conversation_next_section actor="$StevLuccaActor" section="ch4_lucca_mainchoices"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <add_player_choice text="readtext.{1002}.{20}" position="bottom_right" section="g_cancel"/>

                            <add_player_choice text="readtext.{30252}.{30252435}" section="ch4_lucca_history"/>


                            <do_if value="$Ch4_2_TargetKnown?">
                              <add_player_choice text="readtext.{30252}.{30252444}" section="ch4_lucca_transport" highlighted="true"/>
                            </do_if>
                            <do_else>
                              <do_if value="not $Ch4_2_LuccaWorking?">
                                <add_player_choice text="readtext.{30252}.{30252410}" section="ch4_lucca_workfor"/>
                              </do_if>
                              <do_else>
                                <add_player_choice text="readtext.{30252}.{30252411}" section="ch4_lucca_else"/>
                              </do_else>
                            </do_else>

                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_WorkFor" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$StevLuccaActor" section="ch4_lucca_workfor"/>
                          </conditions>
                          <actions>
                            <set_value name="$Ch4_2_LuccaWorking"/>

                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                              <text line="30252403" comment="readtext.{10454}.{30252403} (QuickLookup)"/>
                            </add_npc_line>

                            <signal_cue cue="Ch4_2_Conv_Lucca_MainChoices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_Else" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$StevLuccaActor" section="ch4_lucca_else"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                              <text line="2008" comment="readtext.{10454}.{2008} (QuickLookup)"/>
                            </add_npc_line>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_History" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$StevLuccaActor" section="ch4_lucca_history"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                              <text line="30252412" comment="readtext.{10454}.{30252412} (QuickLookup)"/>
                            </add_npc_line>

                            <signal_cue cue="Ch4_2_Conv_Lucca_HistoryChoices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_HistoryChoices" instantiate="true">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <event_conversation_next_section actor="$StevLuccaActor" section="ch4_lucca_historychoices"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <add_player_choice text="readtext.{30252}.{30252436}" section="ch4_lucca_family"/>
                            <add_player_choice text="readtext.{30252}.{30252437}" section="ch4_lucca_targetlocation"/>
                            <add_player_choice text="readtext.{1002}.{20}" position="bottom_right" section="ch4_lucca_mainchoices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_Family" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$StevLuccaActor" section="ch4_lucca_family"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                              <text line="30252413" comment="readtext.{10454}.{30252413} (QuickLookup)"/>
                              <text line="30252414" comment="readtext.{10454}.{30252414} (QuickLookup)"/>
                              <text line="30252415" comment="readtext.{10454}.{30252415} (QuickLookup)"/>
                              <text line="30252416" comment="readtext.{10454}.{30252416} (QuickLookup)"/>
                            </add_npc_line>
                            <signal_cue cue="Ch4_2_Conv_Lucca_HistoryChoices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_TargetLocation_DLCCheck" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$StevLuccaActor" section="ch4_lucca_targetlocation"/>
                          </conditions>
                          <actions>
                            <find_sector name="$SplitSectors" multiple="true" extension="'ego_dlc_split'"/>
                            <do_if value="$SplitSectors.count">
                              <signal_cue cue="Ch4_2_Conv_Lucca_TargetLocation_SplitDLC"/>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Ch4_2_Conv_Lucca_TargetLocation_Base"/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_TargetLocation_SplitDLC" instantiate="true">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                              <text line="30252420" comment="readtext.{10454}.{30252420} (QuickLookup)"/>
                              <text line="30252421" comment="readtext.{10454}.{30252421} (QuickLookup)"/>
                            </add_npc_line>
                            <signal_cue cue="Ch4_2_Conv_Lucca_TargetLocation_SplitDLC_Choices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_TargetLocation_SplitDLC_Choices" instantiate="true">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <add_player_choice text="readtext.{1002}.{20}" position="bottom_right" section="ch4_lucca_historychoices"/>

                            <do_if value="md.Story_Split.Sink_Effect_Curbs_Stage3_NewPatriarchy.state == cuestate.waiting">
                              <add_player_choice text="readtext.{30252}.{30252438}" section="ch4_lucca_zya"/>
                            </do_if>
                            <do_else>
                              <add_player_choice text="readtext.{30252}.{30252439}" section="ch4_lucca_rha"/>
                            </do_else>

                            <do_if value="(md.Story_Split.Sink_Effect_Zyarth_Stage1_NewFaction.state != cuestate.waiting) or
                                          (md.Story_Split.Sink_Effect_Curbs_Stage1_NewFaction.state != cuestate.waiting)">
                              <add_player_choice text="readtext.{30252}.{30252440}" section="ch4_lucca_cub"/>
                            </do_if>

                            <add_player_choice text="readtext.{30252}.{30252441}" section="ch4_lucca_frf"/>
                            <add_player_choice text="readtext.{30252}.{30252442}" section="ch4_lucca_faf"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_ZYA" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$StevLuccaActor" section="ch4_lucca_zya"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                              <text line="30252422" comment="readtext.{10454}.{30252422} (QuickLookup)"/>
                            </add_npc_line>
                            <signal_cue cue="Ch4_2_Conv_Lucca_TargetLocation_SplitDLC_Choices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_RHA" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$StevLuccaActor" section="ch4_lucca_rha"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                              <text line="30252423" comment="readtext.{10454}.{30252423} (QuickLookup)"/>
                            </add_npc_line>
                            <signal_cue cue="Ch4_2_Conv_Lucca_TargetLocation_SplitDLC_Choices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_CUB" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$StevLuccaActor" section="ch4_lucca_cub"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                              <text line="30252424" comment="readtext.{10454}.{30252424} (QuickLookup)"/>
                            </add_npc_line>
                            <signal_cue cue="Ch4_2_Conv_Lucca_TargetLocation_SplitDLC_Choices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_FRF" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$StevLuccaActor" section="ch4_lucca_frf"/>
                          </conditions>
                          <actions>
                            <do_if value="(md.Story_Split.Sink_Effect_Zyarth_Stage1_NewFaction.state != cuestate.waiting) or
                                          (md.Story_Split.Sink_Effect_Curbs_Stage1_NewFaction.state != cuestate.waiting)">
                              <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                                <text line="30252429" comment="readtext.{10454}.{30252429} (QuickLookup)"/>
                              </add_npc_line>
                            </do_if>
                            <do_else>
                              <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                                <text line="30252425" comment="readtext.{10454}.{30252425} (QuickLookup)"/>
                              </add_npc_line>
                            </do_else>

                            <signal_cue cue="Ch4_2_Conv_Lucca_TargetLocation_SplitDLC_Choices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_FAF" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$StevLuccaActor" section="ch4_lucca_faf"/>
                          </conditions>
                          <actions>
                            <do_if value="player.entity.race == race.split">
                              <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                                <text line="30252427" comment="readtext.{10454}.{30252427} (QuickLookup)"/>
                              </add_npc_line>
                            </do_if>
                            <do_else>
                              <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                                <text line="30252426" comment="readtext.{10454}.{30252426} (QuickLookup)"/>
                              </add_npc_line>
                            </do_else>
                            <signal_cue cue="Ch4_2_Conv_Lucca_TargetLocation_SplitDLC_Choices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_TargetLocation_Base" instantiate="true">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                              <text line="30252430" comment="readtext.{10454}.{30252430} (QuickLookup)"/>
                              <text line="30252431" comment="readtext.{10454}.{30252431} (QuickLookup)"/>
                              <text line="30252432" comment="readtext.{10454}.{30252432} (QuickLookup)"/>
                              <text line="30252433" comment="readtext.{10454}.{30252433} (QuickLookup)"/>
                              <text line="30252434" comment="readtext.{10454}.{30252434} (QuickLookup)"/>
                              <text line="30252435" comment="readtext.{10454}.{30252435} (QuickLookup)"/>
                            </add_npc_line>
                            <signal_cue cue="Ch4_2_Conv_Lucca_HistoryChoices"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Lucca_Transport" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$StevLuccaActor" section="ch4_lucca_transport"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true">
                              <text line="30252436" comment="readtext.{10454}.{30252436} (QuickLookup)"/>
                              <text line="30252437" comment="readtext.{10454}.{30252437} (QuickLookup)"/>
                            </add_npc_line>
                            <do_if value="cuestate.waiting == Ch4_2_PassengerHandling.state">
                              <add_player_choice section="passenger_onboard" position="bottom_right" text="readtext.{1002}.{3015}" comment="Come on board"/>
                            </do_if>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conversation_Started_NextSection_SelectShip" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$StevLuccaActor" section="passenger_onboard"/>
                          </conditions>
                          <actions>
                            <open_conversation_menu menu="PlatformUndockMenu" param="[0, 0, $StevLuccaActor.container, 'movepassenger']" />
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conversation_Check_Ship" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$StevLuccaActor" />
                            <check_value value="event.param == 'c_movepassenger_destinationselected'" />
                          </conditions>
                          <actions>
                            <do_if value="event.param2.people.free">
                              <signal_cue_instantly cue="Ch4_2_PassengerHandling" param="event.param2"/>
                            </do_if>
                            <do_else>
                              <add_npc_line speaker="$StevLuccaActor" line="30252438" comment="readtext.{10454}.{30252438} (No room on player ship)" />
                            </do_else>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <!-- Bar Contact -->
                    <cue name="Ch4_2_Conversation_BarContact">
                      <cues>
                        <cue name="Ch4_2_Conv_Contact_Started" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$ShadyBarContactActor"/>
                          </conditions>
                          <actions>
                            <do_if value="$Ch4_2_TargetKnown?">
                              <add_npc_line speaker="$ShadyBarContactActor" hidechoices="true">
                                <text line="30252420" comment="readtext.{10175}.{30252420} (QuickLookup)"/>
                              </add_npc_line>
                            </do_if>
                            <do_else>
                              <add_npc_line speaker="$ShadyBarContactActor" hidechoices="true">
                                <text line="30252401" comment="readtext.{10175}.{30252401} (QuickLookup)"/>
                              </add_npc_line>
                              <add_player_choice text="readtext.{30252}.{30252410}" section="ch4_contact_workfor"/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Contact_WorkFor" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$ShadyBarContactActor" section="ch4_contact_workfor"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$ShadyBarContactActor" hidechoices="true">
                              <text line="30252402" comment="readtext.{10175}.{30252402} (QuickLookup)"/>
                              <text line="30252403" comment="readtext.{10175}.{30252403} (QuickLookup)"/>
                            </add_npc_line>
                            <add_player_choice text="readtext.{30252}.{30252433}" section="ch4_contact_meet"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Contact_Meet" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$ShadyBarContactActor" section="ch4_contact_meet"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>
                            <add_npc_line speaker="$ShadyBarContactActor" hidechoices="true">
                              <text line="30252410" comment="readtext.{10175}.{30252410} (QuickLookup)"/>
                              <text line="30252411" comment="readtext.{10175}.{30252411} (QuickLookup)"/>
                              <text line="30252412" comment="readtext.{10175}.{30252412} (QuickLookup)"/>
                              <text line="30252414" comment="readtext.{10175}.{30252414} (QuickLookup)"/>
                              <text line="30252415" comment="readtext.{10175}.{30252415} (QuickLookup)"/>
                              <text line="30252416" comment="readtext.{10175}.{30252416} (QuickLookup)"/>
                              <text line="30252420" comment="readtext.{10175}.{30252420} (QuickLookup)"/>
                            </add_npc_line>
                            <set_value name="$Ch4_2_TargetKnown"/>
                            <!--<do_if value="$Ch4_2_TargetKnown?">
                              <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                              <set_entity_overrides entity="$StevLuccaActor" icon="'shadyguy'" title="'{30252,153}'"/>                              
                            </do_if>-->
                          </actions>
                        </cue>

                        <cue name="Ch4_2_Conv_Contact_Ended" instantiate="false">
                          <conditions>
                            <event_conversation_finished actor="$ShadyBarContactActor"/>
                            <check_value value="$Ch4_2_TargetKnown?"/>
                            <cue_is_waiting cue="Ch4_2_PassengerHandling"/>
                          </conditions>
                          <actions>
                            <do_if value="$ObjectiveStep == 2" comment ="bad but required to catch case where the iteration happened in _Meet in a previous version">
                              <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                            </do_if>
                            <set_entity_overrides entity="$StevLuccaActor" icon="'shadyguy'" title="'{30252,153}'"/>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" object="$StevLuccaActor" updatebriefing="true"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_2_PassengerHandling">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$PassengerShip"    exact="event.param"/>
                  </actions>
                  <cues>
                    <cue name="Ch4_2_Passenger_Ref" ref="md.LIB_Generic.TransportStoryPassenger">
                      <param name="Passenger"                  value="$StevLuccaActor"/>
                      <param name="PassengerShip"              value="$PassengerShip"/>
                      <param name="PassengerTarget"            value="$PrisonStation"/>
                      <param name="SignalCueSuccess"           value="Ch4_2_Complete"/>
                      <param name="SignalCuePassengerEmbark"   value="Ch4_2_PassengerEmbarked" comment="NPC entered ship"/>
                      <param name="SignalCueDestroyedTarget"   value="Ch4_2_PassengerShipDestroyed"/>
                      <param name="SignalCueDestroyedShip"     value="Ch4_2_Complete"/>
                      <param name="DebugChance"                value="100"/>
                      <param name="MissionName"                value="{30252,4101}"/>
                      <param name="MissionCue"                 value="$MissionCue"/>
                      <param name="ObjectiveStep"              value="$ObjectiveStep"/>
                      <param name="DisconnectPassenger"        value="true"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_2_PassengerEmbarked">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="180s"/>
                  <actions>
                    <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                      <param name="Actor"             value="$StevLuccaActor"/>
                      <param name="Lines"             value="[[30252450],[30252451]]"/>
                      <!--
                      <t id="	30252450	">Split still on your ship.
                      <t id="	30252451	">Try travel drive.
                      -->
                    </run_actions>
                  </actions>
                </cue>

                <cue name="Ch4_2_PassengerShipDestroyed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                      <param name="Actor"             value="$StevLuccaActor"/>
                      <param name="Lines"             value="[[30252452]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                      <t id="	30252452	">You horrible pilot. Go to flight school, then pick Split up again.
                      -->
                    </run_actions>
                  </actions>
                </cue>

                <cue name="Ch4_2_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="parent"/>
                    <signal_cue cue="Ch4_3"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_3">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch4_3_Thug">
                  <cues>

                    <cue name="Ch4_3_WoodwormCutscene" onfail="cancel">
                      <conditions>
                        <cue_is_waiting cue="Ch4_3_DockMeeting_PlacePlayer"/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_3_CutscenePlay">
                          <actions>
                            <play_cutscene result="parent.$CutsceneID" key="'OrbitPrisonStation'" targetmonitor="false" abortable="true">
                              <param name="targetobject" object="$PrisonStation"/>
                            </play_cutscene>
                          </actions>
                        </cue>
                        <cue name="Ch4_3_CutsceneStarted">
                          <conditions>
                            <event_cutscene_started cutscene="parent.$CutsceneID"/>
                          </conditions>
                          <delay exact="3s" comment="Wait for the mission completed and 'successfully docked' betty sounds to finish playing"/>
                          <actions>
                            <speak actor="$StevLuccaActor" priority="90" voiceover="true">
                              <text line="30252440" comment="readtext.{10454}.{30252440} (QuickLookup)"/>
                            </speak>
                          </actions>
                          <cues>
                            <cue name="Ch4_3_Cutscene_End">
                              <conditions>
                                <event_speak_finished actor="$StevLuccaActor" line="30252440" comment="first line of the speak, catch interruptions"/>
                              </conditions>
                              <actions>
                                <set_value name="$CutsceneEndDelay" exact="2.5s"/>
                                <do_if value="(event.name == 'event_speak_finished') and (event.param3 != 0)" comment="interrupted">
                                  <set_value name="$CutsceneInterrupted"/>
                                  <set_value name="$CutsceneEndDelay" exact="0.5s"/>
                                </do_if>
                              </actions>
                              <delay exact="$CutsceneEndDelay"/>
                              <actions>
                                <fade_screen fadeout="0.5s" fadein="0.5s" chance="if $CutsceneInterrupted? then 0 else 100" realtime="true"/>
                              </actions>
                              <delay exact="0.5s"/>
                              <actions>
                                <stop_cutscene cutscene="parent.parent.$CutsceneID"/>
                              </actions>
                            </cue>
                            <cue name="Ch4_3_Cutscene_Ended">
                              <conditions>
                                <event_cutscene_stopped cutscene="parent.parent.$CutsceneID"/>
                              </conditions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_3_DockMeeting_Setup">
                      <actions>
                        <find_dockingbay name="$ExternalDocks" object="$PrisonStation" checkoperational="true" multiple="true">
                          <match_dock size="tag.dock_s" storage="false"/>
                        </find_dockingbay>

                        <set_value name="$Dock" exact="$ExternalDocks.random"/>
                        <do_if value="$ExternalDocks.indexof.{$PassengerShip.dock}">
                          <set_value name="$Dock" exact="$PassengerShip.dock"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch4_3_DockMeeting_PlaceActors">
                      <conditions>
                        <event_cue_completed cue="Ch4_3_DockMeeting_Setup"/>
                      </conditions>
                      <actions>
                        <!-- $StevLuccaActor -->
                        <create_position name="$Pos" x="-9.31" z="19.580"/>
                        <create_rotation name="$Rot" yaw="-36.0deg"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $StevLuccaActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Dock,
                                                                                                      $rotation = $Rot,
                                                                                                      $position = $Pos,
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                        <!-- $MellerdsThugActor -->
                        <create_position name="$Pos" x="-13.1" z="21.291"/>
                        <create_rotation name="$Rot" yaw="120.0deg"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MellerdsThugActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Dock,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $Rot,
                                                                                                      $position = $Pos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                        <!-- Marine 1 Actor -->
                        <create_position name="$Pos" x="-2.9" z="18.93"/>
                        <create_rotation name="$Rot" yaw="-90.0deg"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MellerdsMarine1Actor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Dock,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $Rot,
                                                                                                      $position = $Pos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                        <!-- Marine 2 Actor -->
                        <create_position name="$Pos" x="-1.7" z="18.94"/>
                        <create_rotation name="$Rot" yaw="-90.0deg"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MellerdsMarine2Actor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Dock,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $Rot,
                                                                                                      $position = $Pos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                      </actions>
                    </cue>
                    <cue name="Ch4_3_DockMeeting_PlaceActors_Thug">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- $MellerdsThugActor -->
                        <create_position name="$Pos" x="-9.85" z="20.1"/>
                        <create_rotation name="$Rot" yaw="120.0deg"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MellerdsThugActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Dock,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $Rot,
                                                                                                      $position = $Pos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                      </actions>
                    </cue>
                    <cue name="Ch4_3_DockMeeting_PlaceActors_Marines">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- Marine 1 Actor -->
                        <create_position name="$Pos" x="-9.45" z="18.675"/>
                        <create_rotation name="$Rot" yaw="-9.0deg"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MellerdsMarine1Actor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Dock,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $Rot,
                                                                                                      $position = $Pos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                        <!-- Marine 2 Actor -->
                        <create_position name="$Pos" x="-8.45" z="19.16"/>
                        <create_rotation name="$Rot" yaw="-60.0deg"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MellerdsMarine2Actor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Dock,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $Rot,
                                                                                                      $position = $Pos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                      </actions>
                    </cue>
                    <cue name="Ch4_3_DockMeeting_PlaceActors_Escort">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MellerdsMarine2Actor,
                                                      table[
                                                      $requestercue = namespace,
                                                      $location = 'disconnect',
                                                      $priority = 100,
                                                      $debugchance = $DeepDebugChance,
                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                      ]"/>
                      </actions>
                      <delay exact="0.3s"/>
                      <actions>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $StevLuccaActor,
                                                      table[
                                                      $requestercue = namespace,
                                                      $location = 'disconnect',
                                                      $priority = 100,
                                                      $debugchance = $DeepDebugChance,
                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                      ]"/>
                      </actions>
                      <delay exact="0.5s"/>
                      <actions>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MellerdsMarine1Actor,
                                                      table[
                                                      $requestercue = namespace,
                                                      $location = 'disconnect',
                                                      $priority = 100,
                                                      $debugchance = $DeepDebugChance,
                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                      ]"/>
                      </actions>
                    </cue>
                    <cue name="Ch4_3_DockMeeting_RemoveThug">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MellerdsThugActor,
                                                      table[
                                                      $requestercue = namespace,
                                                      $location = 'disconnect',
                                                      $priority = 100,
                                                      $debugchance = $DeepDebugChance,
                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                      ]"/>
                      </actions>
                    </cue>

                    <!-- Player Placement -->
                    <cue name="Ch4_3_PlayerLeaveChair">
                      <actions>
                        <do_if value="player.controlled">
                          <leave_control_position/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch4_3_PlayerDismissedEvent"/>
                        </do_else>
                      </actions>
                    </cue>
                    <cue name="Ch4_3_PlayerDismissedEvent">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_player_stopped_control/>
                          <check_all>
                            <event_object_changed_object object="player.entity"/>
                            <check_value value="not event.param.isclass.ship"/>
                          </check_all>
                        </check_any>
                        <!-- add_actor_to_room for player.entity breaks the game if the player is sitting in their pilot seat 
                         dismiss_control_entity / remove_from_room did not resolve it, but leave_control_position kicks them off their chair
                    -->
                      </conditions>
                    </cue>
                    <cue name="Ch4_3_DockMeeting_PlacePlayer">
                      <conditions>
                        <check_any>
                          <event_cue_completed cue="Ch4_3_PlayerDismissedEvent"/>
                          <event_cue_completed cue="Ch4_3_DockMeeting_PlaceActors"/>
                          <event_cue_completed cue="Ch4_3_Cutscene_Ended"/>
                        </check_any>
                        <cue_is_complete cue="Ch4_3_PlayerDismissedEvent"/>
                        <cue_is_complete cue="Ch4_3_DockMeeting_PlaceActors"/>
                        <cue_is_complete cue="Ch4_3_Cutscene_Ended"/>
                      </conditions>
                      <actions>
                        <add_actor_to_room actor="player.entity" object="$Dock">
                          <position x="-8.78m" y="player.entity.race.height" z="20.605m"/>
                          <rotation yaw="-154.0deg"/>
                        </add_actor_to_room>
                      </actions>
                    </cue>

                    <cue name="Ch4_3_DockMeeting_Conversation">
                      <conditions>
                        <event_cue_completed cue="Ch4_3_DockMeeting_PlacePlayer"/>
                      </conditions>
                      <actions>
                        <!--<fade_screen fadeout="0.0s" fadein="0.5s"/>-->
                      </actions>
                      <cues>
                        <cue name="Ch4_3_DockMeeting_StartConversation">
                          <actions>
                            <start_conversation actor="$StevLuccaActor" conversation="ch4_3_thug1"/>
                            <signal_cue cue="Ch4_3_DockMeeting_PlaceActors_Thug"/>
                            <!-- 
                            Lucca	          <t id="	30252	440	">				Where did you bring me?(angry)		</t>
                            Mellerd's Thug	<t id="	30252	431	">	(	1/7	)	Our boss wants a chat with you.	(addressing male Split)	</t>
                            Lucca	          <t id="	30252	441	">				Kriss' station?	(angry)	</t>
                            Lucca	          <t id="	30252	442	">				This Curs business?	(angry, Empyrean Curs same as {30252,10})	</t>
                            Mellerd's Thug	<t id="	30252	432	">	(	2/7	)	Do not worry. You will be out in no time.	(addressing male Split)	</t>
                            Lucca	          <t id="	30252	443	">				Split done with Curs!	(angry, Empyrean Curs same as {30252,10})	</t>
                            Lucca	          <t id="	30252	444	">				Split make you pay!	(angry)	</t>
                            Mellerd's Thug	<t id="	30252	433	">	(	3/7	)	And now to you.	(addressing player)	</t>
                            Mellerd's Thug	<t id="	30252	434	">	(	4/7	)	What reward did you agree to?	(addressing player)	</t>
                            Mellerd's Thug	<t id="	30252	435	">	(	5/7	)	Ah, right. Talking to Mellerd. Sure.		</t>
                            Mellerd's Thug	<t id="	30252	437	">	(	6/7	)	You have clearance to meet her in her office.	(addressing player)	</t>
                            Mellerd's Thug	<t id="	30252	438	">	(	7/7	)	Right ahead.		</t>
                            -->
                          </actions>
                        </cue>

                        <cue name="Ch4_3_DockMeeting_Conversation_Thug1_Started">
                          <conditions>
                            <event_conversation_started actor="$StevLuccaActor" conversation="ch4_3_thug1"/>
                          </conditions>
                          <actions>
                            <start_actor_sequence type="'conversation'" behavior="'stand'" transition="false" immediate="true" actor="$StevLuccaActor" />

                            <allow_conversation_escape enabled="false"/>
                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true" recipient="player.entity" lookat="player.entity">
                              <!--<text line="30252440" comment="readtext.{10454}.{30252440}"/>-->
                              <text line="30252441" comment="readtext.{10454}.{30252441}"/>
                            </add_npc_line>
                          </actions>
                          <cues>
                            <cue name="Ch4_3_DockMeeting_Conversation_Thug1_Finished">
                              <conditions>
                                <event_conversation_finished actor="$StevLuccaActor"/>
                              </conditions>
                              <actions>
                                <start_conversation actor="$MellerdsThugActor" conversation="ch4_3_thug2"/>
                                <signal_cue cue="Ch4_3_DockMeeting_PlaceActors_Marines"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch4_3_DockMeeting_Conversation_Thug2_Started">
                          <conditions>
                            <event_conversation_started actor="$MellerdsThugActor" conversation="ch4_3_thug2"/>
                          </conditions>
                          <actions>
                            <start_actor_sequence type="'conversation'" behavior="'stand'" transition="false" immediate="true" actor="$StevLuccaActor" />
                            <start_actor_sequence type="'conversation'" behavior="'stand'" transition="false" immediate="true" actor="$MellerdsThugActor"/>

                            <allow_conversation_escape enabled="false"/>
                            <add_npc_line speaker="$MellerdsThugActor" hidechoices="true" recipient="$StevLuccaActor" lookat="$StevLuccaActor">
                              <text line="30252431" comment="readtext.{10174}.{30252431}"/>
                            </add_npc_line>
                          </actions>
                          <cues>
                            <cue name="Ch4_3_DockMeeting_Conversation_Thug2_Finished">
                              <conditions>
                                <event_conversation_finished actor="$MellerdsThugActor"/>
                              </conditions>
                              <actions>
                                <start_conversation actor="$StevLuccaActor" conversation="ch4_3_thug3"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch4_3_DockMeeting_Conversation_Thug3_Started">
                          <conditions>
                            <event_conversation_started actor="$StevLuccaActor" conversation="ch4_3_thug3"/>
                          </conditions>
                          <actions>
                            <start_actor_sequence type="'conversation'" behavior="'stand'" transition="false" immediate="true" actor="$StevLuccaActor" />
                            <start_actor_sequence type="'conversation'" behavior="'stand'" transition="false" immediate="true" actor="$MellerdsThugActor"/>

                            <allow_conversation_escape enabled="false"/>
                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true" recipient="$MellerdsThugActor" lookat="$MellerdsThugActor">
                              <!--<text line="30252441" comment="readtext.{10454}.{30252441}"/>-->
                              <text line="30252442" comment="readtext.{10454}.{30252442}"/>
                            </add_npc_line>
                          </actions>
                          <cues>
                            <cue name="Ch4_3_DockMeeting_Conversation_Thug3_Finished">
                              <conditions>
                                <event_conversation_finished actor="$StevLuccaActor"/>
                              </conditions>
                              <actions>
                                <start_conversation actor="$MellerdsThugActor" conversation="ch4_3_thug4"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch4_3_DockMeeting_Conversation_Thug4_Started">
                          <conditions>
                            <event_conversation_started actor="$MellerdsThugActor" conversation="ch4_3_thug4"/>
                          </conditions>
                          <actions>
                            <start_actor_sequence type="'conversation'" behavior="'stand'" transition="false" immediate="true" actor="$StevLuccaActor" />
                            <start_actor_sequence type="'conversation'" behavior="'stand'" transition="false" immediate="true" actor="$MellerdsThugActor"/>

                            <allow_conversation_escape enabled="false"/>
                            <add_npc_line speaker="$MellerdsThugActor" hidechoices="true" recipient="$StevLuccaActor" lookat="$StevLuccaActor">
                              <text line="30252432" comment="readtext.{10174}.{30252432}"/>
                            </add_npc_line>
                          </actions>
                          <cues>
                            <cue name="Ch4_3_DockMeeting_Conversation_Thug4_Finished">
                              <conditions>
                                <event_conversation_finished actor="$MellerdsThugActor"/>
                              </conditions>
                              <actions>
                                <start_conversation actor="$StevLuccaActor" conversation="ch4_3_thug5"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch4_3_DockMeeting_Conversation_Thug5_Started">
                          <conditions>
                            <event_conversation_started actor="$StevLuccaActor" conversation="ch4_3_thug5"/>
                          </conditions>
                          <actions>
                            <start_actor_sequence type="'conversation'" behavior="'stand'" transition="false" immediate="true" actor="$StevLuccaActor" />
                            <start_actor_sequence type="'conversation'" behavior="'stand'" transition="false" immediate="true" actor="$MellerdsThugActor"/>

                            <allow_conversation_escape enabled="false"/>
                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true" recipient="$MellerdsThugActor" lookat="$MellerdsThugActor">
                              <text line="30252443" comment="readtext.{10454}.{30252443}"/>
                            </add_npc_line>
                            <add_npc_line speaker="$StevLuccaActor" hidechoices="true" recipient="player.entity" lookat="player.entity">
                              <text line="30252444" comment="readtext.{10454}.{30252444}"/>
                            </add_npc_line>
                          </actions>
                          <cues>
                            <cue name="Ch4_3_DockMeeting_Conversation_Thug5_Finished">
                              <conditions>
                                <event_conversation_finished actor="$StevLuccaActor"/>
                              </conditions>
                              <actions>
                                <start_conversation actor="$MellerdsThugActor" conversation="ch4_3_thug6_meet"/>
                                <signal_cue cue="Ch4_3_DockMeeting_PlaceActors_Escort"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch4_3_DockMeeting_Conversation_Thug6">
                          <conditions>
                            <event_conversation_started actor="$MellerdsThugActor" conversation="ch4_3_thug6_meet"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>
                            <add_npc_line speaker="$MellerdsThugActor" hidechoices="true" recipient="player.entity" lookat="player.entity">
                              <text line="30252433" comment="readtext.{10174}.{30252433}"/>
                              <text line="30252434" comment="readtext.{10174}.{30252434}"/>
                              <text line="30252435" comment="readtext.{10174}.{30252435}"/>
                              <text line="30252437" comment="readtext.{10174}.{30252437}"/>
                              <text line="30252438" comment="readtext.{10174}.{30252438}"/>
                            </add_npc_line>
                          </actions>
                          <cues>
                            <cue name="Ch4_3_DockMeeting_Conversation_Thug6_Finished">
                              <conditions>
                                <event_conversation_finished actor="$MellerdsThugActor"/>
                              </conditions>
                              <actions>
                                <start_conversation actor="$MellerdsThugActor" conversation="ch4_3_thug_meet"/>
                                <signal_cue cue="Ch4_3_DockMeeting_RemoveThug"/>
                                <signal_cue cue="Ch4_3_Complete"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_3_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="parent"/>
                    <signal_cue cue="Ch4_4"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_4">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <!-- Office Conversation -->
              <cues>

                <cue name="Ch4_4_Remove_ManagerOffice">
                  <actions>
                    <find_room name="this.$Room" object="$PrisonStation" roomtype="roomtype.manager" multiple="false"/>
                    <do_if value="this.$Room">
                      <set_value name="this.$Interior" exact="this.$Room.dynamicinterior"/>
                      <remove_dynamic_interior object="$PrisonStation" interior="this.$Interior" />
                      <!-- Manager todo @Owen "Was in an interior which was to be removed. Rescue them!" -->
                      <set_value name="this.$manager" exact="$PrisonStation.assignedcontrolentity.{controlpost.manager}"/>
                      <do_if value="this.$manager">
                        <!--<add_actor_to_post_location actor="this.$manager" />-->
                        <!--<remove_actor_from_room actor="this.$manager"/>-->
                      </do_if>
                    </do_if>
                  </actions>
                  <cues>
                    <cue name="Ch4_4_Remove_ManagerOffice_Reset">
                      <conditions>
                        <event_object_changed_object object="player.entity" newobject="$PrisonStation"/>
                      </conditions>
                      <delay exact="0.01s"/>
                      <actions>
                        <reset_cue cue="parent"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_4_SetupOffice" version="2">
                  <actions>
                    <!-- Determine interior macros -->
                    <get_room_definition macro="$PrisonOfficeCorridorMacro" doors="$PrisonOfficeDoors" race="$PrisonStation.owner.primaryrace" tags="tag.corridor" />
                    <set_value name="$PrisonOfficeRoomMacro" exact="macro.room_gen_managersoffice_01_macro"/>
                    <!-- Create persistent interior -->
                    <create_dynamic_interior     roomname="$PrisonOfficeRoom"             room="$PrisonOfficeRoomMacro"
                                             corridorname="$PrisonOfficeCorridor"     corridor="$PrisonOfficeCorridorMacro"
                                             interiorname="$PrisonOfficeInterior"
                                             name="'{20007,1001}'"
                                             object="$PrisonStation" persistent="true"/>


                    <signal_cue cue="Ch4_4_PlaceNPC"/>
                  </actions>
                  <patch sinceversion="2">
                    <do_if value="$PrisonOfficeRoomMacro != macro.room_gen_managersoffice_01_macro">

                      <!-- save old office values -->
                      <set_value name="$PrisonOfficeRoom_OLD"           exact="$PrisonOfficeRoom"/>
                      <set_value name="$PrisonOfficeRoomMacro_OLD"      exact="$PrisonOfficeRoomMacro"/>
                      <set_value name="$PrisonOfficeInterior_OLD"       exact="$PrisonOfficeInterior"/>
                      <set_value name="$ControlSlot_OLD"                exact="$ControlSlot"/>
                      <remove_value name="$ControlSlot"/>

                      <!-- Create New Office -->
                      <set_value name="$PrisonOfficeRoomMacro" exact="macro.room_gen_managersoffice_01_macro"/>
                      <!-- Create persistent interior -->
                      <create_dynamic_interior     roomname="$PrisonOfficeRoom"             room="$PrisonOfficeRoomMacro"
                                               corridorname="$PrisonOfficeCorridor"     corridor="$PrisonOfficeCorridorMacro"
                                               interiorname="$PrisonOfficeInterior"
                                               name="'{20007,1001}'"
                                               object="$PrisonStation" persistent="true"/>

                      <!-- clean up old office -->
                      <run_actions ref="md.LIB_Generic.Cleanup_Mission_Interior_Call">
                        <param name="Object"      value="$PrisonStation"/>
                        <param name="Interior"    value="$PrisonOfficeInterior_OLD"/>
                        <param name="DebugChance" value="$DebugChance"/>
                      </run_actions>

                      <!-- Place Actors -->

                      <!-- find new chair position -->
                      <!-- Find specific slot to place actor on. -->
                      <find_npc_slot name="$PotentialOfficeSlots" excludefilled="false" object="$PrisonOfficeRoom" multiple="true"/>
                      <do_for_each in="$PotentialOfficeSlots" name="$Slot">
                        <do_if value="$Slot.name == 'con_control01'">
                          <set_value name="$ControlSlot" exact="$Slot"/>
                        </do_if>
                      </do_for_each>
                      <!-- Slot failsafes. -->
                      <do_if value="not $ControlSlot?">
                        <set_value name="$ControlSlot" exact="$PotentialOfficeSlots.random"/>
                      </do_if>

                      <!-- Hack Case -->
                      <do_if value="(cuestate.complete == Ch4_4_Objective_PullSwitch.state)
                                and (cuestate.waiting == Ch4_4_Cutscene_AirlockOpens.state)">
                        <!-- reset event to correct room -->
                        <reset_cue cue="Ch4_4_Cutscene_AirlockOpens"/>
                        <!-- move Kriss to window -->
                        <signal_cue_instantly cue="Ch4_4_PlaceNPC_MoveToWindow"/>

                        <!-- enable terminal hacking & guidance -->
                        <set_objective cue="$MissionCue" action="objective.activate" text="{20109,11401}" object="$PrisonOfficeRoom" offset="position.[-4.3,1.0,-6.1]" step="$ObjectiveStep" updatebriefing="true"/>
                        <set_triggers_locked object="$PrisonOfficeRoom" group="tag.terminal_01" locked="false"/>
                      </do_if>
                      <do_else>
                        <!-- place kriss in chair -->

                        <!-- Actor -->
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $KrissMellerdActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $ControlSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                      </do_else>
                    </do_if>
                  </patch>
                </cue>

                <cue name="Ch4_4_PlaceNPC">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Find specific slot to place actor on. -->
                    <find_npc_slot name="$PotentialOfficeSlots" excludefilled="false" object="$PrisonOfficeRoom" multiple="true"/>
                    <do_for_each in="$PotentialOfficeSlots" name="$Slot">
                      <do_if value="$Slot.name == 'con_control01'">
                        <set_value name="$ControlSlot" exact="$Slot"/>
                      </do_if>
                    </do_for_each>
                    <!-- Slot failsafes. -->
                    <do_if value="not $ControlSlot?">
                      <set_value name="$ControlSlot" exact="$PotentialOfficeSlots.random"/>
                    </do_if>

                    <!-- Actor -->
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $KrissMellerdActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $ControlSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                    <signal_cue cue="Ch4_4_Objective" check="false"/>
                  </actions>
                </cue>

                <cue name="Ch4_4_PlaceNPC_MoveToWindow" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Mellerd -->
                    <create_position name="$Pos" x="-0.2273" z="-10.321"/>
                    <create_rotation name="$Rot" yaw="152.45256deg"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $KrissMellerdActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $PrisonOfficeRoom,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $Rot,
                                                                                                      $position = $Pos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                  </actions>
                </cue>
                <cue name="Ch4_4_PlaceNPC_SitDown">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Actor -->
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $KrissMellerdActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $ControlSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                  </actions>
                </cue>

                <cue name="Ch4_4_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                    <set_objective cue="$MissionCue" action="objective.talkto" object="$KrissMellerdActor" updatebriefing="true" step="$ObjectiveStep"/>
                  </actions>
                </cue>

                <cue name="Ch4_4_Objective_PullSwitch">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                    <set_objective cue="$MissionCue" action="objective.activate" text="{20109,11401}" object="$PrisonOfficeRoom" offset="position.[-4.3,1.0,-6.1]" step="$ObjectiveStep" updatebriefing="true"/>
                    <set_triggers_locked object="$PrisonOfficeRoom" group="tag.terminal_01" locked="false"/>
                  </actions>
                </cue>

                <cue name="Ch4_4_Conversations">
                  <cues>
                    <cue name="Ch4_4_Conversation_Mellerd_Started">
                      <conditions>
                        <event_conversation_started actor="$KrissMellerdActor"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <set_value name="$Flag_BetrayedMaestro" exact="false"/>

                        <!-- Greetings by GS -->
                        <!-- Readtext is not reliable, so we need to include a fallback in any case -->
                        <do_if value="player.name == readtext.{1021}.{102}" comment="Didn't rename from Val Selton.">
                          <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                            <text line="30252402" comment="readtext.{10188}.{30252402} (QuickLookup)"/>
                          </add_npc_line>
                        </do_if>
                        <do_elseif value="player.name == readtext.{1021}.{402}" comment="Didn't rename from Selaia Tarren.">
                          <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                            <text line="30252403" comment="readtext.{10188}.{30252403} (QuickLookup)"/>
                          </add_npc_line>
                        </do_elseif>
                        <do_elseif value="player.name == readtext.{1021}.{802}" comment="Didn't rename from Dr Selaia Tarren.">
                          <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                            <text line="30252404" comment="readtext.{10188}.{30252404} (QuickLookup)"/>
                          </add_npc_line>
                        </do_elseif>
                        <do_elseif value="player.name == readtext.{1021}.{202}" comment="Didn't rename from Yololios Sanduras Rusiris XI.">
                          <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                            <text line="30252405" comment="readtext.{10188}.{30252405} (QuickLookup)"/>
                          </add_npc_line>
                        </do_elseif>
                        <do_elseif value="player.name == readtext.{1021}.{302}" comment="Didn't rename from Amanckalat.">
                          <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                            <text line="30252406" comment="readtext.{10188}.{30252406} (QuickLookup)"/>
                          </add_npc_line>
                        </do_elseif>
                        <do_elseif value="player.name == readtext.{1021}.{602}" comment="Didn't rename from Zuus t'Fnk.">
                          <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                            <text line="30252407" comment="readtext.{10188}.{30252407} (QuickLookup)"/>
                          </add_npc_line>
                        </do_elseif>
                        <do_elseif value="player.name == readtext.{1021}.{702}" comment="Didn't rename from Rael t'Nru.">
                          <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                            <text line="30252408" comment="readtext.{10188}.{30252408} (QuickLookup)"/>
                          </add_npc_line>
                        </do_elseif>
                        <do_elseif value="player.name == readtext.{1021}.{902}" comment="Didn't rename from Raibu Hariken.">
                          <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                            <text line="30252409" comment="readtext.{10188}.{30252409} (QuickLookup)"/>
                          </add_npc_line>
                        </do_elseif>
                        <do_elseif value="player.name == readtext.{1021}.{1002}" comment="Didn't rename from Najia Takio.">
                          <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                            <text line="30252410" comment="readtext.{10188}.{30252410} (QuickLookup)"/>
                          </add_npc_line>
                        </do_elseif>
                        <do_else comment="Other GS">
                          <!--<add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                            <text line="30252401" comment="readtext.{10188}.{30252401} (QuickLookup)"/>
                          </add_npc_line>-->
                        </do_else>


                        <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                          <text line="30252411" comment="readtext.{10188}.{30252411} (QuickLookup)"/>
                        </add_npc_line>
                        <do_if value="player.module == 'x4ep1_gamestart_pirate2'" comment="Prison GS">
                          <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                            <text line="30252412" comment="readtext.{10188}.{30252412} (QuickLookup)"/>
                          </add_npc_line>
                        </do_if>

                        <!-- History and Incentive -->
                        <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                          <text line="30252420" comment="readtext.{10188}.{30252420} (QuickLookup)"/>
                          <text line="30252421" comment="readtext.{10188}.{30252421} (QuickLookup)"/>
                          <text line="30252422" comment="readtext.{10188}.{30252422} (QuickLookup)"/>
                          <text line="30252423" comment="readtext.{10188}.{30252423} (QuickLookup)"/>
                          <text line="30252424" comment="readtext.{10188}.{30252424} (QuickLookup)"/>
                          <text line="30252425" comment="readtext.{10188}.{30252425} (QuickLookup)"/>
                          <text line="30252426" comment="readtext.{10188}.{30252426} (QuickLookup)"/>
                          <text line="30252427" comment="readtext.{10188}.{30252427} (QuickLookup)"/>
                        </add_npc_line>

                        <signal_cue_instantly cue="Ch4_4_Conv_Mellerd_WhatNow"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_4_Conv_Mellerd_WhatNow" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                          <text line="30252430" comment="readtext.{10188}.{30252430} (QuickLookup)"/>
                          <text line="30252431" comment="readtext.{10188}.{30252431} (QuickLookup)"/>
                        </add_npc_line>
                        <signal_cue_instantly cue="Ch4_4_Conv_Mellerd_Choices"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_4_Conv_Mellerd_Choices" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$MonetaryReward" exact="(2 * 1000 * 1000)Cr"/>
                        <do_if value="player.module == 'x4ep1_gamestart_pirate2'" comment="Prison GS">
                          <add_player_choice text="readtext.{30252}.{30252450}" section="ch4_mel_file" tooltip="readtext.{30252}.{4150}"/>
                        </do_if>
                        <add_player_choice text="readtext.{30252}.{30252451}" section="ch4_mel_employ"/>
                        <add_player_choice text="readtext.{30252}.{30252452}" section="ch4_mel_maestro"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_4_Conv_Mellerd_File" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$KrissMellerdActor" section="ch4_mel_file"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                          <text line="30252440" comment="readtext.{10188}.{30252440} (QuickLookup)"/>
                          <text line="30252441" comment="readtext.{10188}.{30252441} (QuickLookup)"/>
                          <text line="30252442" comment="readtext.{10188}.{30252442} (QuickLookup)"/>
                          <text line="30252443" comment="readtext.{10188}.{30252443} (QuickLookup)"/>
                          <text line="30252444" comment="readtext.{10188}.{30252444} (QuickLookup)"/>
                          <!--<text line="30252445" comment="readtext.{10188}.{30252445} (QuickLookup)"/>-->
                          <text line="30252446" comment="readtext.{10188}.{30252446} (QuickLookup)"/>
                        </add_npc_line>
                        <set_value name="$CallFile"/>
                        <signal_cue_instantly cue="Ch4_4_Conv_Mellerd_Call"/>
                      </actions>
                    </cue>
                    <cue name="Ch4_4_Conv_Mellerd_Job" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$KrissMellerdActor" section="ch4_mel_employ"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                          <text line="30252461" comment="readtext.{10188}.{30252461} (QuickLookup)"/>
                          <text line="30252463" comment="readtext.{10188}.{30252463} (QuickLookup)"/>
                          <text line="30252462" comment="readtext.{10188}.{30252462} (QuickLookup)"/>
                        </add_npc_line>
                        <signal_cue_instantly cue="Ch4_4_Conv_Mellerd_Call"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_4_Conv_Mellerd_Call">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_4_Conv_Mellerd_File_Call_Start">
                          <conditions>
                            <event_conversation_finished actor="$KrissMellerdActor"/>
                          </conditions>
                          <actions>
                            <!-- Mellerd moves to speak with someone, changing the objective to flip the switch -->
                            <signal_cue cue="Ch4_4_PlaceNPC_MoveToWindow"/>
                            <signal_cue cue="Ch4_4_Speak_Mellerd_Call_Part1"/>

                            <!-- Switch Objective -->
                            <signal_cue_instantly cue="Ch4_4_Switch_Complete_Check" param="Ch4_4_Speak_Mellerd_Call_Part2"/>

                            <signal_cue cue="Ch4_4_Objective_PullSwitch"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_4_Speak_Mellerd_Call_Part1">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="$CallFile?" comment="Player Asked for MIN Reputation">
                          <set_value name="$lines" exact="[[30252450],
                                                        [30252451],
                                                        [30252452],
                                                        [30252453],
                                                        [30252456]]"/>
                        </do_if>
                        <do_else comment="Player Asked for Work">
                          <set_value name="$lines" exact="[[30252450],
                                                        [30252451],
                                                        [30252454],
                                                        [30252455],
                                                        [30252456]]"/>
                        </do_else>
                      </actions>
                      <cues>
                        <cue name="Ch4_4_Speak_Mellerd_Call_Part1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$KrissMellerdActor"/>
                          <param name="DelayInitial"      value="3s"/>
                          <param name="Lines"             value="$lines"/>
                          <!--
                          <t id="	30252	450	">	(	1/9	)	(On a call)Hello.		</t>
                          <t id="	30252	451	">	(	2/9	)	(On a call)Yes, I need to call in a favour.		</t>
                          <t id="	30252	452	">	(	3/9	)	(On a call)A former customer needs to disappear from our systems.		</t>
                          <t id="	30252	453	">	(	4/9	)	(On a call)I've sent you the file.		</t>
                          <t id="	30252	454	">	(	3/9	)	(On a call)I have a criminal element looking for employment.		</t>
                          <t id="	30252	455	">	(	4/9	)	(On a call)Surely eager to work, but not much of a profile yet.		</t>
                          <t id="	30252	456	">	(	5/9	)	(On a call)Sure, I wait.		</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_4_Switch_Complete_Check">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$Ch4_SignalCue" exact="event.param"/>

                        <find_station name="$PrisonStation" space="$EighteenBillionSector" godstationentry="'story_prison_station_id'" required="true"/>
                        <find_object_component name="$PrisonModule"   object="$PrisonStation"  macro="macro.landmarks_gen_prison_01_macro" recursive="true"/>
                        <find_object_component name="$PrisonCorridor" object="$PrisonModule"      macro="macro.prison_escape_v2_macro" recursive="true"/>
                      </actions>
                      <cues>
                        <cue name="Ch4_4_Mellerd_Rotatebacktowindow" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$KrissMellerdActor"/>
                            <cue_is_waiting cue="$Ch4_SignalCue"/>
                            <check_value value="not $Flag_BetrayedMaestro"/>
                          </conditions>
                          <actions>
                            <do_any>
                              <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                                <text line="30252474" comment="readtext.{10188}.{30252474} (QuickLookup)"/>
                              </add_npc_line>
                              <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                                <text line="30252456" comment="readtext.{10188}.{30252456} (QuickLookup)"/>
                              </add_npc_line>
                            </do_any>
                            <signal_cue cue="Ch4_4_PlaceNPC_MoveToWindow"/>
                          </actions>
                          <cues>
                            <cue name="Ch4_4_Mellerd_Rotatebacktowindow_Finished">
                              <conditions>
                                <event_conversation_finished actor="$KrissMellerdActor"/>
                              </conditions>
                              <delay exact="1s"/>
                              <actions>
                                <do_if value="$Ch4_SignalCue.state == cuestate.waiting">
                                  <signal_cue_instantly cue="Ch4_4_PlaceNPC_MoveToWindow"/>
                                </do_if>
                              </actions>
                              <delay exact="1s"/>
                              <actions>
                                <do_if value="$Ch4_SignalCue.state == cuestate.waiting">
                                  <signal_cue_instantly cue="Ch4_4_PlaceNPC_MoveToWindow"/>
                                </do_if>
                              </actions>
                              <delay exact="1s"/>
                              <actions>
                                <do_if value="$Ch4_SignalCue.state == cuestate.waiting">
                                  <signal_cue_instantly cue="Ch4_4_PlaceNPC_MoveToWindow"/>
                                </do_if>
                              </actions>
                              <delay exact="1s"/>
                              <actions>
                                <do_if value="$Ch4_SignalCue.state == cuestate.waiting">
                                  <signal_cue_instantly cue="Ch4_4_PlaceNPC_MoveToWindow"/>
                                </do_if>
                              </actions>
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Ch4_4_Cutscene_AirlockOpens">
                          <conditions>
                            <check_any>
                              <event_player_deactivated_platform_trigger component="$PrisonOfficeRoom" group="tag.terminal_01"/>
                              <event_player_activated_platform_trigger component="$PrisonOfficeRoom" group="tag.terminal_01"/>
                              <!--<event_player_unlocked_platform_trigger component="$PrisonCorridor" group="tag.upperlock"/>-->
                            </check_any>
                          </conditions>
                          <actions>
                            <!-- Lock Switch -->
                            <set_value name="$Ch4_SwitchPulled"/>
                            <set_triggers_locked object="$PrisonOfficeRoom" group="tag.terminal_01" locked="true"/>

                            <!-- Setup Cutscene -->
                            <trigger_animation object="$PrisonCorridor" group="tag.upperlock" trigger="activate" comment="this should not be necessary"/>
                            <find_object_component name="$PrisonModule"   object="$PrisonStation"  macro="macro.landmarks_gen_prison_01_macro" recursive="true"/>
                            <find_object_component name="$PrisonMarker_22" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy22_macro"  required="true" comment="Airlock-tower Floor 1"/>

                            <play_cutscene result="this.$CutsceneID" key="'Story_Criminal_Ch4_Airlock'" abortable="true" targetmonitor="true">
                              <param name="SphereRoom" object="$PrisonMarker_22"/>
                            </play_cutscene>
                          </actions>
                          <delay exact="5s"/>
                          <actions>
                            <signal_cue cue="Ch4_4_Cutscene_AirlockOpens_Completed" comment="continue conversation"/>
                          </actions>
                          <delay exact="5s"/>
                          <actions>
                            <!-- Open Lock -->
                            <trigger_animation object="$PrisonCorridor" group="tag.upperlock" trigger="deactivate" comment="open large airlock to the next set of riddles"/>
                          </actions>
                          <cues>
                            <cue name="Ch4_4_Cutscene_AirlockOpens_Completed">
                              <conditions>
                                <check_any>
                                  <event_cue_signalled/>
                                  <event_cutscene_stopped cutscene="parent.$CutsceneID"/>
                                </check_any>
                              </conditions>
                              <actions>
                                <!-- Continue Conversation -->
                                <signal_cue cue="$Ch4_SignalCue"/>
                                <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                                <set_objective cue="$MissionCue" action="objective.await" text="$KrissMellerdActor.name" step="$ObjectiveStep" updatebriefing="true"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_4_Speak_Mellerd_Call_Part2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                          <param name="Actor"             value="$KrissMellerdActor"/>
                          <param name="DelayInitial"      value="3s"/>
                          <param name="Lines"             value="[[30252457, 0s, Ch4_4_PlaceNPC_SitDown],
                                                                  [30252458],
                                                                  [30252459],
                                                                  [30252460]]"/>
                          <param name="EndSignalCue"      value="Ch4_4_Conv_Mellerd_Call_Done"/>
                          <!--
                          <t id="	30252	457	">	(	6/9	)	(On a call)All done? Wonderful.		</t>
                          <t id="	30252	458	">	(	7/9	)	(On a call)Yes, it is, yeah.		</t>
                          <t id="	30252	459	">	(	8/9	)	(On a call)I'll call you later about that other case.		</t>
                          <t id="	30252	460	">	(	9/9	)	(On a call)Brilliant.		</t>
                          -->
                        </run_actions>
                      </actions>
                    </cue>

                    <cue name="Ch4_4_Conv_Mellerd_Call_Done" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="$CallFile?">
                          <start_conversation actor="$KrissMellerdActor" conversation="Ch4_4_Conv_Mellerd_File_Call_Done" priority="100"/>
                        </do_if>
                        <do_else>
                          <start_conversation actor="$KrissMellerdActor" conversation="Ch4_4_Conv_Mellerd_Job_Call_Done" priority="100"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch4_4_Conv_Mellerd_File_Call_Done" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$KrissMellerdActor" conversation="Ch4_4_Conv_Mellerd_File_Call_Done"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <signal_cue_instantly cue="Ch4_4_Conv_Mellerd_Goodbye"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_4_Conv_Mellerd_Job_Call_Done" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$KrissMellerdActor" conversation="Ch4_4_Conv_Mellerd_Job_Call_Done"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                          <text line="30252464" comment="readtext.{10188}.{30252464} (QuickLookup)"/>
                          <text line="30252465" comment="readtext.{10188}.{30252465} (QuickLookup)"/>
                          <text line="30252466" comment="readtext.{10188}.{30252466} (QuickLookup)"/>
                        </add_npc_line>
                        <signal_cue_instantly cue="Ch4_4_Conv_Mellerd_Goodbye"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_4_Conv_Mellerd_Betray_Maestro1" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$KrissMellerdActor" section="ch4_mel_maestro"/>
                      </conditions>
                      <actions>
                        <set_value name="$Flag_BetrayedMaestro" exact="true"/>

                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                          <text line="30252470" comment="readtext.{10188}.{30252470} (QuickLookup)"/>
                          <text line="30252471" comment="readtext.{10188}.{30252471} (QuickLookup)"/>
                          <text line="30252472" comment="readtext.{10188}.{30252472} (QuickLookup)"/>
                          <text line="30252473" comment="readtext.{10188}.{30252473} (QuickLookup)"/>
                        </add_npc_line>
                        <add_player_choice text="readtext.{30252}.{30252453}" section="ch4_mel_maestro_stealing"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_4_Conv_Mellerd_Betray_Maestro2" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$KrissMellerdActor" section="ch4_mel_maestro_stealing"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                          <text line="30252474" comment="readtext.{10188}.{30252474} (QuickLookup)"/>
                          <text line="30252475" comment="readtext.{10188}.{30252475} (QuickLookup)"/>
                          <text line="30252479" comment="readtext.{10188}.{30252479} (QuickLookup)"/>
                        </add_npc_line>
                        <add_player_choice text="readtext.{30252}.{30252454}" section="ch4_mel_maestro_sure"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_4_Conv_Mellerd_Betray_Maestro3" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$KrissMellerdActor" section="ch4_mel_maestro_sure"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                          <text line="30252480" comment="readtext.{10188}.{30252480} (QuickLookup)"/>
                          <text line="30252481" comment="readtext.{10188}.{30252481} (QuickLookup)"/>
                          <text line="30252482" comment="readtext.{10188}.{30252482} (QuickLookup)"/>
                          <text line="30252483" comment="readtext.{10188}.{30252483} (QuickLookup)"/>
                          <text line="30252484" comment="readtext.{10188}.{30252484} (QuickLookup)"/>
                          <text line="30252485" comment="readtext.{10188}.{30252485} (QuickLookup)"/>
                          <text line="30252486" comment="readtext.{10188}.{30252486} (QuickLookup)"/>
                          <text line="30252487" comment="readtext.{10188}.{30252487} (QuickLookup)"/>
                          <!-- ship reward line, likely comment out if only the blueprint is given -->
                          <text line="30252488" comment="readtext.{10188}.{30252488} (QuickLookup)"/>
                          <text line="30252489" comment="readtext.{10188}.{30252489} (QuickLookup)"/>
                        </add_npc_line>
                        <signal_cue_instantly cue="Ch4_4_Switch_Complete_Check" param="Ch4_4_Conv_Mellerd_Betray_Maestro_SwitchComplete"/>
                      </actions>
                      <cues>
                        <cue name="Ch4_4_Conv_Mellerd_Betray_SwitchObjective">
                          <conditions>
                            <event_conversation_finished actor="$KrissMellerdActor"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch4_4_Objective_PullSwitch"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_4_Conv_Mellerd_PullSwitchAlready" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$KrissMellerdActor"/>
                            <check_value value="not $Ch4_SwitchPulled?"/>
                          </conditions>
                          <actions>
                            <do_any>
                              <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                                <text line="30252476" comment="readtext.{10188}.{30252476} (QuickLookup)"/>
                              </add_npc_line>
                              <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                                <text line="30252489" comment="readtext.{10188}.{30252489} (QuickLookup)"/>
                              </add_npc_line>
                            </do_any>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_4_Conv_Mellerd_Betray_Maestro_SwitchComplete" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <start_conversation actor="$KrissMellerdActor" conversation="ch4_mel_goodbye"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_4_Conv_Mellerd_Goodbye" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_conversation_started actor="$KrissMellerdActor" conversation="ch4_mel_goodbye"/>
                          <event_conversation_next_section actor="$KrissMellerdActor" section="ch4_mel_goodbye"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                          <text line="30252467" comment="readtext.{10188}.{30252467} (QuickLookup)"/>
                          <text line="30252490" comment="readtext.{10188}.{30252490} (QuickLookup)"/>
                        </add_npc_line>
                      </actions>
                      <cues>
                        <cue name="Ch4_4_Mellerd_Godbye_Finished">
                          <conditions>
                            <event_conversation_finished actor="$KrissMellerdActor"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch4_4_Complete"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_4_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- move rewards here as this is the end -->
                    <do_if value="$Flag_BetrayedMaestro">
                      <!-- Money Reward -->
                      <transfer_money from="faction.ministry" to="faction.player" amount="$MonetaryReward"/>
                    </do_if>
                    <do_elseif value="$CallFile?">
                      <!-- Reputation Reward -->
                      <set_value name="$RelationUpToZero" exact="0"/>
                      <do_if value="faction.player.relationto.{faction.ministry} lt 0">
                        <set_value name="$RelationUpToZero" exact="-1 * (faction.player.relationto.{faction.ministry})"/>
                      </do_if>
                      <do_if value="$RelationUpToZero lt 0.0032" comment="minimum reward">
                        <set_value name="$RelationUpToZero" exact="0.0032"/>
                      </do_if>
                      <add_faction_relation faction="faction.player" otherfaction="faction.ministry" value="$RelationUpToZero" reason="relationchangereason.missioncompleted" />
                    </do_elseif>
                    <do_else>
                      <!-- Money Reward -->
                      <transfer_money from="faction.ministry" to="faction.player" amount="$MonetaryReward"/>
                    </do_else>

                    <cancel_cue cue="parent"/>
                    <signal_cue cue="Ch4_Complete"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_Complete">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <remove_mission cue="$MissionCue" type="completed"/>
                <do_if value="$Flag_BetrayedMaestro">
                  <write_to_logbook category="missions" faction="faction.player" title="{30252,4131}" text="{30252,4132}"/>
                </do_if>
                <do_else>
                  <write_to_logbook category="missions" faction="faction.player" title="{30252,4121}" text="{30252,4122}"/>
                </do_else>
                <run_actions ref="md.LIB_Generic.Cleanup_Mission_Interior_Call">
                  <param name="Object"      value="$PrisonStation"/>
                  <param name="Interior"    value="$PrisonOfficeInterior"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </run_actions>

                <signal_cue cue="Ch5_Preparations"/>
                <cancel_cue cue="parent" />
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="Ch5_Force">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch5_Preparations">
            <!-- Cancelling Previous Chapters -->
            <set_value name="$CurrentChapter" exact="Ch5_Preparations"/>
            <do_for_each in="$Chapters" name="$Chapter">
              <do_if value="$Chapter == $CurrentChapter">
                <signal_cue cue="$CurrentChapter"/>
                <break/>
              </do_if>
              <cancel_cue cue="$Chapter"/>
            </do_for_each>

            <!-- Custom Setup -->
          </force>
        </cue>

        <cue name="Ch5_Preparations">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$ObjectiveStep" exact="1"/>


            <create_mission cue="$MissionCue" name="{30252,5101}" description="{30252,5102}"
                            type="missiontype.plot" faction="faction.player" difficulty="level.medium"
                            abortable="false" icon="'briefing_maestro_01'" iconcaption="{30252,101}"
                            rewardtext="{30252,5120}">
              <briefing>
                <objective step="$ObjectiveStep" action="objective.talkto" object="$MaestroActor"/>
              </briefing>
            </create_mission>
            <set_objective_from_briefing cue="$MissionCue" step="$ObjectiveStep"/>
          </actions>
          <cues>

            <cue name="Ch5_1_Conv_Mellerd">
              <cues>
                <cue name="Ch5_1_Conv_Mellerd_Space" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$KrissMellerdActor"/>
                  </conditions>
                  <actions>
                    <do_any>
                      <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                        <text line="30252490" comment="readtext.{10188}.{30252490} (QuickLookup)"/>
                      </add_npc_line>
                      <!--<add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                        <text line="30252491" comment="readtext.{10188}.{30252491} (QuickLookup)"/>
                      </add_npc_line>-->
                      <add_npc_line speaker="$KrissMellerdActor" hidechoices="true">
                        <text line="30252492" comment="readtext.{10188}.{30252492} (QuickLookup)"/>
                      </add_npc_line>
                    </do_any>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch5_Setup_DockAceShip">
              <actions>
                <cancel_all_orders object="$AceShip"/>
                <create_order id="'DockAndWait'" object="$AceShip" default="true" comment="stay docked">
                  <param name="destination" value="$RaiderHubShip" />
                  <param name="debugchance" value="$DebugChance"/>
                </create_order>
              </actions>
            </cue>

            <cue name="Ch5_1">
              <!-- Briefing -->
              <actions>
                <create_position name="$Pos" x="1.247" z="-3.73" space="$RaiderHubShip.controlroom"/>
                <create_rotation name="$Rot" yaw="60.0deg"/>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MaestroActor,
                                                                                              table[
                                                                                              $requestercue = namespace,
                                                                                              $location = $RaiderHubShip.controlroom,
                                                                                              $priority = 100,
                                                                                              $rotation = $Rot,
                                                                                              $position = $Pos,
                                                                                              $debugchance = $DeepDebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                              ]"/>
              </actions>
              <cues>

                <cue name="Ch5_1_Enter_Check" onfail="cancel">
                  <conditions>
                    <check_value value="player.entity.room == $RaiderHubShip.controlroom"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch5_1_Enter"/>
                  </actions>
                </cue>
                <cue name="Ch5_1_Enter">
                  <conditions>
                    <check_any>
                      <event_object_changed_room object="player.entity" room="$RaiderHubShip.controlroom"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <fade_screen fadeout="0.0s" fadein="1.5s" realtime="true"/>
                    <add_actor_to_room actor="player.entity" object="$RaiderHubShip.controlroom">
                      <position x="3.51" y="player.entity.race.height" z="-2.77"/>
                      <rotation yaw="-112.0deg"/>
                    </add_actor_to_room>

                    <start_conversation actor="$MaestroActor" conversation="ch5_1_abduction"/>
                  </actions>
                </cue>

                <cue name="Ch5_1_Conversations">
                  <cues>
                    <!-- Maestro -->
                    <cue name="Ch5_1_Conv_Maestro_Started">
                      <conditions>
                        <event_conversation_started actor="$MaestroActor" conversation="ch5_1_abduction"/>
                      </conditions>
                      <actions>

                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252501" comment="readtext.{10453}.{30252501} (QuickLookup)"/>
                        </add_npc_line>
                        <add_player_choice text="readtext.{30252}.{30252501}" section="ch5_maestro_jobdone"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Maestro_JobDone" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$MaestroActor" section="ch5_maestro_jobdone"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252502" comment="readtext.{10453}.{30252502} (QuickLookup)"/>
                          <text line="30252503" comment="readtext.{10453}.{30252503} (QuickLookup)"/>
                        </add_npc_line>
                        <add_player_choice text="readtext.{30252}.{30252502}" section="ch5_maestro_abduction"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Maestro_Abduction" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$MaestroActor" section="ch5_maestro_abduction"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252504" comment="readtext.{10453}.{30252504} (QuickLookup)"/>
                        </add_npc_line>
                        <add_player_choice text="readtext.{30252}.{30252503}" section="ch5_maestro_abduction_who"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Maestro_Abduction2" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$MaestroActor" section="ch5_maestro_abduction_who"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch5_Place_CrewActors_InitialPosition"/>

                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252505" comment="readtext.{10453}.{30252505} (QuickLookup)"/>
                        </add_npc_line>
                        <add_player_choice text="readtext.{30252}.{30252504}" section="ch5_maestro_abduction_brother"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Maestro_Angry" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$MaestroActor" section="ch5_maestro_abduction_brother"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch5_Place_CrewActors_ConversationPosition"/>

                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true">
                          <text line="30252540" comment="readtext.{10453}.{30252540} (QuickLookup)"/>
                          <text line="30252541" comment="readtext.{10453}.{30252541} (QuickLookup)"/>
                        </add_npc_line>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true"
                                      recipient="$MaestroActor" lookat="$MaestroActor">
                          <text line="30252515" comment="readtext.{10356}.{30252515} (QuickLookup)"/>
                        </add_npc_line>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true"
                                      recipient="$AxiomActor" lookat="$AxiomActor">
                          <text line="30252542" comment="readtext.{10453}.{30252542} (QuickLookup)"/>
                          <text line="30252543" comment="readtext.{10453}.{30252543} (QuickLookup)"/>
                          <text line="30252544" comment="readtext.{10453}.{30252544} (QuickLookup)"/>
                          <text line="30252545" comment="readtext.{10453}.{30252545} (QuickLookup)"/>
                        </add_npc_line>
                        <add_npc_line speaker="$AceActor" hidechoices="true"
                                      recipient="$MaestroActor" lookat="$MaestroActor">
                          <text line="30252580" comment="readtext.{10558}.{30252580} (QuickLookup)"/>
                        </add_npc_line>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true"
                                      recipient="$AceActor" lookat="$AceActor">
                          <text line="30252546" comment="readtext.{10453}.{30252546} (QuickLookup)"/>
                          <text line="30252547" comment="readtext.{10453}.{30252547} (QuickLookup)"/>
                          <text line="30252548" comment="readtext.{10453}.{30252548} (QuickLookup)"/>
                        </add_npc_line>
                        <do_if value="(player.module == 'x4ep1_gamestart_pirate2')" comment="changed dialogue to refer to GS">
                          <add_npc_line speaker="$AceActor" hidechoices="true" recipient="$MaestroActor" lookat="$MaestroActor">
                            <text line="30252581" comment="readtext.{10558}.{30252581} (QuickLookup)"/>
                            <text line="30252582" comment="readtext.{10558}.{30252582} (QuickLookup)"/>
                            <text line="30252583" comment="readtext.{10558}.{30252583} (QuickLookup) - Axiom and Wildcard know that prison (GS2/Stranded)"/>
                          </add_npc_line>
                        </do_if>
                        <do_else>
                          <add_npc_line speaker="$AceActor" hidechoices="true" recipient="$MaestroActor" lookat="$MaestroActor">
                            <text line="30252581" comment="readtext.{10558}.{30252581} (QuickLookup)"/>
                            <text line="30252582" comment="readtext.{10558}.{30252582} (QuickLookup)"/>
                          </add_npc_line>
                        </do_else>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true"
                                      recipient="$MaestroActor" lookat="$MaestroActor">
                          <text line="30252516" comment="readtext.{10356}.{30252516} (QuickLookup)"/>
                        </add_npc_line>
                        <add_npc_line speaker="$AceActor" hidechoices="true"
                                      recipient="$MaestroActor" lookat="$MaestroActor">
                          <text line="30252584" comment="readtext.{10558}.{30252584} (QuickLookup)"/>
                          <text line="30252585" comment="readtext.{10558}.{30252585} (QuickLookup)"/>
                        </add_npc_line>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true"
                                      recipient="$MaestroActor" lookat="$MaestroActor">
                          <text line="30252513" comment="readtext.{10356}.{30252513} (QuickLookup)"/>
                        </add_npc_line>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true"
                                      recipient="$AxiomActor" lookat="$AxiomActor">
                          <text line="30252550" comment="readtext.{10453}.{30252550} (QuickLookup)"/>
                        </add_npc_line>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true"
                                      recipient="$MaestroActor" lookat="$MaestroActor">
                          <text line="30252514" comment="readtext.{10356}.{30252514} (QuickLookup)"/>
                        </add_npc_line>
                        <add_npc_line speaker="$AceActor" hidechoices="true"
                                      recipient="$MaestroActor" lookat="$MaestroActor">
                          <text line="30252587" comment="readtext.{10558}.{30252587} (QuickLookup)"/>
                          <text line="30252588" comment="readtext.{10558}.{30252588} (QuickLookup)"/>
                        </add_npc_line>
                        <add_npc_line speaker="$MaestroActor" hidechoices="true"
                                      recipient="player.entity" lookat="player.entity">
                          <text line="30252551" comment="readtext.{10453}.{30252551} (QuickLookup)"/>
                        </add_npc_line>
                      </actions>
                    </cue>

                    <cue name="Ch5_Place_CrewActors_InitialPosition">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <create_position name="$Pos" x="-3.558" z="6.289" y="-0.9876" space="$RaiderHubShip.controlroom"/>
                        <create_rotation name="$Rot" yaw="180.00deg"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AceActor,
                                                                                              table[
                                                                                              $requestercue = $MissionCue,
                                                                                              $location = $RaiderHubShip.controlroom,
                                                                                              $priority = 100,
                                                                                              $rotation = $Rot,
                                                                                              $position = $Pos,
                                                                                              $debugchance = $DeepDebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                              ]"/>
                        <create_position name="$Pos" x="-0.03" z="-11.66" space="$RaiderHubShip.controlroom"/>
                        <create_rotation name="$Rot" yaw="-2.70deg"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor,
                                                                                              table[
                                                                                              $requestercue = $MissionCue,
                                                                                              $location = $RaiderHubShip.controlroom,
                                                                                              $priority = 100,
                                                                                              $rotation = $Rot,
                                                                                              $position = $Pos,
                                                                                              $debugchance = $DeepDebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                              ]"/>

                        <create_group groupname="$Ch5MissionActorsGroup"/>
                        <add_to_group groupname="$Ch5MissionActorsGroup" object="$AceActor"/>
                        <add_to_group groupname="$Ch5MissionActorsGroup" object="$AxiomActor"/>

                      </actions>
                    </cue>

                    <cue name="Ch5_Place_CrewActors_ConversationPosition">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <create_position name="$Pos" x="0.99" z="-2.3" space="$RaiderHubShip.controlroom"/>
                        <create_rotation name="$Rot" yaw="140.00deg"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AceActor,
                                                                                              table[
                                                                                              $requestercue = $MissionCue,
                                                                                              $location = $RaiderHubShip.controlroom,
                                                                                              $priority = 100,
                                                                                              $rotation = $Rot,
                                                                                              $position = $Pos,
                                                                                              $debugchance = $DeepDebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                              ]"/>
                        <create_position name="$Pos" x="2.232" z="-4.86" space="$RaiderHubShip.controlroom"/>
                        <create_rotation name="$Rot" yaw="-2.70deg"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor,
                                                                                              table[
                                                                                              $requestercue = $MissionCue,
                                                                                              $location = $RaiderHubShip.controlroom,
                                                                                              $priority = 100,
                                                                                              $rotation = $Rot,
                                                                                              $position = $Pos,
                                                                                              $debugchance = $DeepDebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                              ]"/>

                        <create_group groupname="$Ch5MissionActorsGroup"/>
                        <add_to_group groupname="$Ch5MissionActorsGroup" object="$AceActor"/>
                        <add_to_group groupname="$Ch5MissionActorsGroup" object="$AxiomActor"/>

                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Maestro_Completed">
                      <conditions>
                        <event_conversation_finished actor="$MaestroActor"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MaestroActor,
                                                      table[
                                                      $requestercue = namespace,
                                                      $location = 'disconnect',
                                                      $priority = 100,
                                                      $debugchance = $DeepDebugChance,
                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                      ]"/>

                        <set_value name="$BriefingsUnlocked"/>
                        <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                        <update_mission cue="$MissionCue" description="{30252,5103}"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" group="$Ch5MissionActorsGroup" text="{30252,5250}" updatebriefing="true"/>
                      </actions>
                    </cue>


                    <!-- Ace -->
                    <cue name="Ch5_1_Conv_Ace_Started" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$AceActor"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$AceActor" hidechoices="true">
                          <text line="30252501" comment="readtext.{10558}.{30252501} (QuickLookup)"/>
                        </add_npc_line>

                        <do_if value="$BriefingsUnlocked?">
                          <add_npc_line speaker="$AceActor" hidechoices="true">
                            <text line="30252502" comment="readtext.{10558}.{30252502} (QuickLookup)"/>
                            <text line="30252503" comment="readtext.{10558}.{30252503} (QuickLookup)"/>
                          </add_npc_line>
                          <signal_cue_instantly cue="Ch5_1_Conv_Ace_MainChoices"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Ace_MainChoices" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_conversation_next_section actor="$AceActor" section="ch5_ace_mainchoices"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <add_player_choice text="readtext.{30252}.{30252512}" section="ch5_ace_help" highlighted="true"/>
                        <add_player_choice text="readtext.{30252}.{30252510}" section="ch5_ace_lucca"/>
                        <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="g_cancel"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Ace_Lucca1" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$AceActor" section="ch5_ace_lucca"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$AceActor" hidechoices="true">
                          <text line="30252504" comment="readtext.{10558}.{30252504} (QuickLookup)"/>
                          <text line="30252505" comment="readtext.{10558}.{30252505} (QuickLookup)"/>
                          <text line="30252506" comment="readtext.{10558}.{30252506} (QuickLookup)"/>
                        </add_npc_line>
                        <add_player_choice text="readtext.{30252}.{30252511}" section="ch5_ace_lucca2"/>
                        <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="ch5_ace_mainchoices"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Ace_Lucca2" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$AceActor" section="ch5_ace_lucca2"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$AceActor" hidechoices="true">
                          <text line="30252507" comment="readtext.{10558}.{30252507} (QuickLookup)"/>
                        </add_npc_line>
                        <signal_cue_instantly cue="Ch5_1_Conv_Ace_MainChoices"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Ace_Help" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$AceActor" section="ch5_ace_help"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$AceActor" hidechoices="true">
                          <text line="30252508" comment="readtext.{10558}.{30252508} (QuickLookup)"/>
                          <text line="30252509" comment="readtext.{10558}.{30252509} (QuickLookup)"/>
                          <text line="30252510" comment="readtext.{10558}.{30252510} (QuickLookup)"/>
                        </add_npc_line>
                        <add_player_choice text="readtext.{30252}.{30252514}" section="ch5_ace_letsdoit" highlighted="true"/>
                        <add_player_choice text="readtext.{30252}.{30252513}" section="ch5_ace_notready"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Ace_Notready" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$AceActor" section="ch5_ace_notready"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$AceActor" hidechoices="true">
                          <text line="30252575" comment="readtext.{10558}.{30252575} (QuickLookup)"/>
                        </add_npc_line>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Ace_Letsdoit" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$AceActor" section="ch5_ace_letsdoit"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$AceActor" hidechoices="true">
                          <text line="30252520" comment="readtext.{10558}.{30252520} (QuickLookup)"/>
                          <!--<text line="30252521" comment="readtext.{10558}.{30252521} (QuickLookup)"/>-->
                        </add_npc_line>
                        <signal_cue_instantly cue="Ch5_1_Complete" param="Ch5_2a"/>
                      </actions>
                    </cue>

                    <!-- Axiom -->
                    <cue name="Ch5_1_Conv_Axiom_Started" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$AxiomActor"/>
                      </conditions>
                      <actions>
                        <do_any>
                          <add_npc_line speaker="$AxiomActor" hidechoices="true">
                            <text line="30252501" comment="readtext.{10356}.{30252501} (QuickLookup)"/>
                          </add_npc_line>
                          <add_npc_line speaker="$AxiomActor" hidechoices="true">
                            <text line="30252502" comment="readtext.{10356}.{30252502} (QuickLookup)"/>
                          </add_npc_line>
                          <add_npc_line speaker="$AxiomActor" hidechoices="true">
                            <text line="30252503" comment="readtext.{10356}.{30252503} (QuickLookup)"/>
                          </add_npc_line>
                          <add_npc_line speaker="$AxiomActor" hidechoices="true">
                            <text line="30252504" comment="readtext.{10356}.{30252504} (QuickLookup)"/>
                          </add_npc_line>
                        </do_any>
                        <signal_cue_instantly cue="Ch5_1_Conv_Axiom_MainChoices"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Axiom_MainChoices" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_conversation_next_section actor="$AxiomActor" section="ch5_axiom_mainchoices"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <add_player_choice text="readtext.{30252}.{30252523}" section="ch5_axiom_workingon" highlighted="true"/>
                        <add_player_choice text="readtext.{30252}.{30252520}" section="ch5_axiom_lucca"/>
                        <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="g_cancel"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Axiom_Lucca" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$AxiomActor" section="ch5_axiom_lucca"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252510" comment="readtext.{10356}.{30252510} (QuickLookup)"/>
                          <text line="30252511" comment="readtext.{10356}.{30252511} (QuickLookup)"/>
                          <text line="30252512" comment="readtext.{10356}.{30252512} (QuickLookup)"/>
                        </add_npc_line>
                        <signal_cue_instantly cue="Ch5_1_Conv_Axiom_MainChoices"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Axiom_WorkingOn" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$AxiomActor" section="ch5_axiom_workingon"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252520" comment="readtext.{10356}.{30252520} (QuickLookup)"/>
                          <text line="30252521" comment="readtext.{10356}.{30252521} (QuickLookup)"/>
                          <text line="30252522" comment="readtext.{10356}.{30252522} (QuickLookup)"/>
                          <text line="30252523" comment="readtext.{10356}.{30252523} (QuickLookup)"/>
                        </add_npc_line>
                        <add_player_choice text="readtext.{30252}.{30252521}" section="ch5_axiom_help" highlighted="true"/>
                        <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="ch5_axiom_mainchoices"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Axiom_Help" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$AxiomActor" section="ch5_axiom_help"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252525" comment="readtext.{10356}.{30252525} (QuickLookup)"/>
                          <text line="30252526" comment="readtext.{10356}.{30252526} (QuickLookup)"/>
                          <text line="30252527" comment="readtext.{10356}.{30252527} (QuickLookup)"/>
                        </add_npc_line>
                        <add_player_choice text="readtext.{30252}.{30252505}" section="ch5_axiom_quest" highlighted="true"/>
                        <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="ch5_axiom_mainchoices"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Conv_Axiom_Confirmed" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$AxiomActor" section="ch5_axiom_quest"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252528" comment="readtext.{10356}.{30252528} (QuickLookup)"/>
                          <text line="30252530" comment="readtext.{10356}.{30252530} (QuickLookup)"/>
                        </add_npc_line>
                        <signal_cue_instantly cue="Ch5_1_Complete" param="Ch5_2b"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AceActor,
                                                      table[
                                                      $requestercue = namespace,
                                                      $location = 'disconnect',
                                                      $priority = 100,
                                                      $debugchance = $DeepDebugChance,
                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                      ]"/>
                        <create_position name="$Pos" x="0.09" z="-13.325" space="$RaiderHubShip_GeneratorRoom"/>
                        <create_rotation name="$Rot" yaw="-180deg"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor,
                                                                                              table[
                                                                                              $requestercue = $MissionCue,
                                                                                              $location = $RaiderHubShip_GeneratorRoom,
                                                                                              $priority = 100,
                                                                                              $rotation = $Rot,
                                                                                              $position = $Pos,
                                                                                              $debugchance = $DeepDebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                              ]"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch5_1_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="parent"/>
                    <signal_cue_instantly cue="event.param"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch5_2a">
              <!-- Capture Ship -->
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <update_mission cue="$MissionCue" icon="'briefing_ace_01'" iconcaption="$AceActor.name"
                                name="{30252,5201}" description="{30252,5202}" rewardtext="{30252,5220}"/>
                <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.embark" text="{30252,5251}"  updatebriefing="true"/>

                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor,
                                                      table[
                                                      $requestercue = namespace,
                                                      $location = 'disconnect',
                                                      $priority = 100,
                                                      $debugchance = $DeepDebugChance,
                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                      ]"/>
              </actions>
              <cues>

                <!-- Setup Target Ship -->
                <cue name="Ch5_2a_CreateShip">
                  <actions>
                    <!-- $Ch5_TargetShip -->
                    <create_loadout result="$Ch5_AceShipLoadout">
                      <macros>
                        <engine macro="engine_tel_m_combat_01_mk1_macro" path="../con_engine_01"/>
                        <weapon macro="weapon_gen_m_shotgun_01_mk2_macro" path="../con_primaryweapon_01"/>
                        <!--<weapon macro="weapon_gen_m_shotgun_01_mk2_macro" path="../con_primaryweapon_02"/>-->
                        <shield macro="shield_tel_m_standard_01_mk2_macro" path="../con_shield_01"/>
                        <!--<shield macro="shield_tel_m_standard_01_mk2_macro" path="../con_shield_02"/>-->
                        <turret macro="turret_arg_m_shotgun_01_mk1_macro" path="../con_turret_l01"/>
                        <!--<turret macro="turret_arg_m_shotgun_01_mk1_macro" path="../con_turret_r01"/>-->
                      </macros>
                      <ammunition>
                        <ammunition macro="countermeasure_flares_01_macro" exact="2"/>
                        <ammunition macro="ship_gen_xs_lasertower_01_a_macro" exact="2"/>
                      </ammunition>
                      <software>
                        <software ware="software_flightassistmk1"/>
                        <software ware="software_scannerlongrangemk1"/>
                        <software ware="software_scannerobjectmk2"/>
                        <software ware="software_targetmk1"/>
                      </software>
                      <virtualmacros>
                        <thruster macro="thruster_gen_m_combat_01_mk3_macro"/>
                      </virtualmacros>
                    </create_loadout>

                    <set_value name="$Ch5_AceShipFaction" exact="faction.scaleplate"/>

                    <remove_value name="$Ch5_TargetShip"/>
                    <create_ship name="$Ch5_TargetShip" missioncue="namespace" macro="ship_arg_m_bomber_02_a_macro"
                                 sector="$S1a_North" commandeerable="false">
                      <owner exact="$Ch5_AceShipFaction"/>
                      <loadout loadout="$Ch5_AceShipLoadout"/>
                      <pilot>
                        <select faction="$Ch5_AceShipFaction" tags="tag.fighterpilot"/>
                      </pilot>
                      <people ref="teladi_military_crew">
                        <fillpercent exact="55"/>
                      </people>
                      <safepos x="30km" y="100km" z="0" object="player.entity" space="player.sector"/>
                      <rotation value="rotation.[180deg,180deg,180deg]"/>
                    </create_ship>
                    <cancel_all_orders object="$Ch5_TargetShip"/>
                    <create_order id="'ProtectPosition'" object="$Ch5_TargetShip" default="true">
                      <param name="destination" value="[$Ch5_TargetShip.sector, $Ch5_TargetShip.position]"/>
                    </create_order>

                    <set_value name="$Ch5_TargetShip_CrewCount" exact="$Ch5_TargetShip.people.count"/>
                    <!--<set_object_relation_behaviour object="$Ch5_TargetShip" disable="true"/>-->
                  </actions>
                  <cues>

                    <cue name="Ch5_2a_PreventVIGHostilities" instantiate="true" checkinterval="31s">
                      <conditions>
                        <check_value value="$Ch5_TargetShip.exists"/>
                        <check_value value="$Ch5_TargetShip.trueowner == $Ch5_AceShipFaction"/>
                      </conditions>
                      <actions>
                        <set_value name="$Ch5_TargetRelation" exact="faction.loanshark.relation.killmilitary.max + 0.0001f"/>

                        <!-- object towards faction, but not the other way around -->
                        <set_relation_boost faction="faction.loanshark" object="$Ch5_TargetShip" value="$Ch5_TargetRelation" decay="0" comment="asymmetrical, only object towards faction"/>

                        <!-- ships -->
                        <find_ship owner="faction.loanshark" space="$Ch5_TargetShip.sector" multiple="true" name="$Ch5_2a_LoanSharkShips"/>
                        <do_for_each in="$Ch5_2a_LoanSharkShips" name="$ship">
                          <set_relation_boost object="$Ch5_TargetShip" otherobject="$ship" value="$Ch5_TargetRelation" decay="0"/>
                          <set_relation_boost object="$ship" otherobject="$Ch5_TargetShip" value="$Ch5_TargetRelation" decay="0"/>
                        </do_for_each>

                        <!-- stations -->
                        <find_station owner="faction.loanshark" space="$Ch5_TargetShip.sector" multiple="true" name="$Ch5_2a_LoanSharkStations"/>
                        <do_for_each in="$Ch5_2a_LoanSharkStations" name="$station">
                          <set_relation_boost object="$Ch5_TargetShip" otherobject="$station" value="$Ch5_TargetRelation" decay="0"/>
                          <set_relation_boost object="$station" otherobject="$Ch5_TargetShip" value="$Ch5_TargetRelation" decay="0"/>
                        </do_for_each>
                      </actions>
                    </cue>

                    <cue name="DEBUG_Hostility" onfail="cancel">
                      <conditions>
                        <check_value value="false"/>
                      </conditions>
                      <actions>
                        <find_station owner="faction.loanshark" space="$Ch5_TargetShip.sector" multiple="true" name="$Ch5_2a_LoanSharkStations2" wharf="true"/>
                        <cancel_all_orders object="$Ch5_TargetShip"/>
                        <create_order id="'ProtectPosition'" object="$Ch5_TargetShip" default="true">
                          <param name="destination" value="[$Ch5_2a_LoanSharkStations2.{1}.zone, $Ch5_2a_LoanSharkStations2.{1}.position]"/>
                        </create_order>

                        <debug_text text="'CAVALRY COMING 2'"/>
                        <find_ship owner="faction.loanshark" space="$Ch5_TargetShip.sector" multiple="true" name="$Ch5_2a_LoanSharkShips"/>
                        <do_for_each in="$Ch5_2a_LoanSharkShips" name="$ship">
                          <cancel_all_orders object="$ship"/>
                          <create_order id="'ProtectPosition'" object="$ship" immediate="true">
                            <param name="destination" value="[$Ch5_2a_LoanSharkStations2.{1}.zone, $Ch5_2a_LoanSharkStations2.{1}.position]"/>
                          </create_order>
                        </do_for_each>
                      </actions>
                    </cue>
                    
                    <cue name="Ch5_2a_ObjectDestroyed">
                      <conditions>
                        <event_object_destroyed object="$Ch5_TargetShip"/>
                        <!--debug_text text="event.param.name + ' ' + event.param2"/-->
                      </conditions>
                      <actions>
                        <do_if value="$Ch5_GuidanceSet?">
                          <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                            <param name="Actor"             value="$AceActor"/>
                            <param name="Lines"             value="[[30252541],
                                                                    [30252542]]"/>
                            <!--
                            541	">	(	1/2	)	Our target got destroyed.
                            542	">	(	2/2	)	Give me a moment to locate another one.
                            -->
                          </run_actions>
                        </do_if>

                        <remove_value name="$Ch5_GuidanceSet"/>
                        <remove_value name="$Ch5_TargetAttacked"/>
                        <reset_cue cue="Ch5_2a_Guidance"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <reset_cue cue="Ch5_2a_CreateShip"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <!-- Ship Capture Guidance  -->
                <cue name="Ch5_2a_Guidance">
                  <conditions>
                    <event_cue_completed cue="Ch5_2a_CreateShip"/>
                  </conditions>
                  <cues>

                    <!-- Approach Target -->
                    <cue name="Ch5_2a_Approach_Target">
                      <cues>
                        <cue name="Ch5_2a_StartedControlRoom" onfail="cancel">
                          <conditions>
                            <check_value value="player.controlled"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch5_2a_Approach_Target_Objective"/>
                          </actions>
                        </cue>

                        <cue name="Ch5_2a_Approach_Target_Objective">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <event_player_started_control/>
                            </check_any>
                          </conditions>
                          <actions>
                            <set_value name="$Ch5_GuidanceSet"/>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.approach" object="$Ch5_TargetShip" updatebriefing="true"/>

                            <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="Lines"             value="[[30252522], [30252546], [30252547], [30252548]]"/>
                              <!--
                              30252	522	">	(	1/2	)	I marked the target.
                              30252546	">	(	1/3	)	First approach it peacefully and perform a scan to get an idea about their crew count.
                              30252547	">	(	2/3	)	Our job will be to keep the ship and ourselves healthy while we will try to get each one of them to bail.
                              30252548	">	(	3/3	)	Do not try this on capital ships. Their Marines and Captains are too stubborn to leave.
                              -->
                            </run_actions>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <!-- Scan Target -->
                    <cue name="Ch5_2a_Scan_Target">
                      <cues>
                        <cue name="Ch5_2a_Hint_ScanCrew_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                          <param name="ApproachObject"    value="player.entity"/>
                          <param name="ApproachTarget"    value="$Ch5_TargetShip"/>
                          <param name="ApproachDistance"  value="30km"/>
                          <param name="SuccessSignalCue"  value="Ch5_2a_Hint_ScanCrew"/>
                        </cue>
                        <cue name="Ch5_2a_Hint_ScanCrew">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="Lines"             value="[[30252562], [30252549, 1s, Ch5_2a_Objective_ScanCrew]]"/>
                              <!--
                              30252562	">				  This ship is heavily armed, take care.
                              30252549	">				Scan the ship so we get an idea about their crew count.
                              -->
                            </run_actions>
                          </actions>
                        </cue>
                        <cue name="Ch5_2a_Objective_ScanCrew">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.scan" object="$Ch5_TargetShip" updatebriefing="true"/>
                          </actions>
                          <delay exact="3s"/>
                          <actions>
                            <show_help line="15112" position="1" force="true" comment="Fly close to the target and select SCAN from the context menu." allowclose="true" timeout="false"/>
                          </actions>
                        </cue>
                        <cue name="Ch5_2a_TargetScanned">
                          <conditions>
                            <event_scan_finished scanned="$Ch5_TargetShip"/>
                          </conditions>
                          <actions>
                            <create_order id="'Wait'" object="$Ch5_TargetShip" default="true"/>
                          </actions>
                          <delay exact="1s"/>
                          <actions>
                            <signal_cue cue="Ch5_2a_Attack_Target"/>
                            <set_value name="$lines" exact="[]"/>
                            <append_to_list name="$lines" exact="[30252550]"  comment="Perfect."/>
                            <!--
                              30252543	">				Here it is!
                              30252	523	">	(	2/2	)	Engage, I will be right behind you.
                              -->
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <!-- Attack Target -->
                    <cue name="Ch5_2a_Attack_Target">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <check_all>
                            <event_object_attacked object="$Ch5_TargetShip"/>
                            <check_value value="event.param.owner == faction.player"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <!-- cancel previous objectives -->
                        <cancel_cue cue="Ch5_2a_Scan_Target"/>

                        <do_if value="event.name == 'event_object_attacked'">
                          <set_value name="$Ch5_TargetAttacked"/>
                        </do_if>
                      </actions>
                      <cues>
                        <cue name="Ch5_2a_AttackedFlag">
                          <conditions>
                            <event_object_attacked object="$Ch5_TargetShip"/>
                            <check_value value="event.param.owner == faction.player"/>
                          </conditions>
                          <actions>
                            <set_value name="$Ch5_TargetAttacked"/>
                          </actions>
                        </cue>
                        <cue name="Ch5_2a_TargetShip_Distance_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                          <param name="ApproachObject"    value="player.entity"/>
                          <param name="ApproachTarget"    value="$Ch5_TargetShip"/>
                          <param name="ApproachDistance"  value="30km"/>
                          <param name="SuccessSignalCue"  value="Ch5_2a_ApproachComplete"/>
                        </cue>
                        <cue name="Ch5_2a_ApproachComplete">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="not $Ch5_TargetAttacked?">
                              <append_to_list name="$lines" exact="[30252551]"  comment="(	1/4	)	Now, before we attack: Do not get hit."/>
                            </do_if>
                            <append_to_list name="$lines" exact="[30252552]"    comment="(	2/4	)	If your shield or hull get low, their crew will think they got a chance and likely resist the urge to jump into an Escape Pod."/>
                            <append_to_list name="$lines" exact="[30252553]"    comment="(	3/4	)	You can avoid getting hit by finding a blind spot or keep your distance to evade any turret fire."/>
                            <append_to_list name="$lines" exact="[30252554]"    comment="(	4/4	)	This ship has shard weapons and turrets, so better keep your distance."/>
                            <append_to_list name="$lines" exact="[30252555]"    comment="         If it gets too close, do not be afraid to disengage for a moment."/>
                            <append_to_list name="$lines" exact="[30252556]"    comment="(	1/2	)	We will need to keep their hull below 75% and the shields down."/>
                            <append_to_list name="$lines" exact="[30252557]"    comment="(	2/2	)	Once they realise that they cannot escape with their ship, they will jump into their Escape Pods and leave it behind."/>
                            <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="Lines"             value="$lines"/>
                              <param name="EndSignalCue"      value="Ch5_2a_Attack"/>
                            </run_actions>
                          </actions>
                        </cue>
                        <cue name="Ch5_2a_Attack">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="5s"/>
                          <actions>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.attack" object="$Ch5_TargetShip" updatebriefing="true"/>
                            <do_if value="not $Ch5_TargetAttacked?">
                              <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                                <param name="Actor"             value="$AceActor"/>
                                <param name="Lines"             value="[[30252558],[30252559]]"/>
                                <!--
                                <t id="	30252558	">				Weapons ready!
                                <t id="	30252559	">				Remove the target's shields to prevent it from boosting.
                                -->
                              </run_actions>
                            </do_if>
                          </actions>
                        </cue>
                        <cue name="Ch5_2a_HullLow">
                          <conditions>
                            <event_object_attacked object="$Ch5_TargetShip"/>
                            <set_value name="$Ch5_TargetShip_CurrentHull" exact="$Ch5_TargetShip.hullpercentage"/>
                            <check_value value="event.param.owner == faction.player"/>
                            <check_value value="$Ch5_TargetShip.hullpercentage lt 70"/>
                            <check_any>
                              <check_value value="not $Ch5_TargetShip_AttackedHull?"/>
                              <check_value value="$Ch5_TargetShip_CurrentHull lt ($Ch5_TargetShip_AttackedHull - 1)"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <set_value name="$Ch5_TargetShip_AttackedHull" exact="$Ch5_TargetShip.hullpercentage"/>
                            <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="Lines"             value="[[30252560],[30252561]]"/>
                              <!--
                              30252560	">	(	1/2	)	Careful, do not get their hull too low.
                              30252561	">	(	2/2	)	We do not want it to blow up.
                              -->
                            </run_actions>
                          </actions>
                          <delay exact="30s"/>
                          <actions>
                            <reset_cue cue="this"/>
                          </actions>
                        </cue>
                        <cue name="Ch5_2a_CrewLeaving">
                          <conditions>
                            <event_object_dropped_objects object="$Ch5_TargetShip"/>
                            <check_value value="$Ch5_TargetShip.people.count lt $Ch5_TargetShip_CrewCount"/>
                            <check_value value="$Ch5_TargetShip.people.count gt 0"/>
                          </conditions>
                          <actions>

                            <set_value name="$lines" exact="[[30252563]]"/>
                            <do_if value="(not $Ch5_Ace_PoliceInfo?) and ($Ch5_TargetShip.sector.policefaction.ishostileto.{$Ch5_TargetShip.owner})">
                              <set_value name="$Ch5_Ace_PoliceInfo"/>
                              <append_to_list name="$lines" exact="[30252544]"    comment="(	1/2	)	Our target will not get any help in this sector as the police authority does not care for them."/>
                              <append_to_list name="$lines" exact="[30252545]"    comment="(	2/2	)	So we do not need to look out for any distress drones while it tries to escape us."/>
                            </do_if>

                            <set_value name="$Ch5_TargetShip_CrewCount" exact="$Ch5_TargetShip.people.count"/>
                            <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="Lines"             value="$lines"/>
                              <!--
                              <t id="	30252563	">				Jolly discount! Crew are leaving!
                              -->
                            </run_actions>
                          </actions>
                          <delay exact="40s"/>
                          <actions>
                            <reset_cue cue="this"/>
                          </actions>
                        </cue>
                        <cue name="Ch5_2a_ShipStatusCheck" checkinterval="180s" instantiate="true">
                          <actions>
                            <do_if value="$Ch5_TargetShip.hullpercentage ge 75">
                              <signal_cue cue="Ch5_2a_AttackHullTooHigh" check="false"/>
                            </do_if>
                            <do_elseif value="$Ch5_TargetShip.shieldpercentage ge 10">
                              <signal_cue cue="Ch5_2a_AttackShieldsTooHigh" check="false"/>
                            </do_elseif>
                          </actions>
                        </cue>
                        <cue name="Ch5_2a_AttackShieldsTooHigh">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="Lines"             value="[[30252564]]"/>
                              <!--
                              <t id="	30252564	">				Keep the shields down, else they might feel too safe and comfortable.
                              -->
                            </run_actions>
                          </actions>
                          <delay exact="180s"/>
                          <actions>
                            <reset_cue cue="this"/>
                          </actions>
                        </cue>
                        <cue name="Ch5_2a_AttackHullTooHigh">
                          <conditions>
                            <event_cue_signalled/>
                            <check_value value="$Ch5_TargetAttacked?"/>
                          </conditions>
                          <actions>
                            <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="Lines"             value="[[30252565]]"/>
                              <!--
                              <t id="	30252565	">				Keep the hull down, they are repairing it.
                              -->
                            </run_actions>
                          </actions>
                          <delay exact="180s"/>
                          <actions>
                            <reset_cue cue="this"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <!-- Claim Target -->
                    <cue name="Ch5_2a_Claim_Target">
                      <conditions>
                        <event_object_abandoned object="$Ch5_TargetShip"/>
                        <cue_is_waiting cue="Ch5_2a_Deliver_Target"/>
                      </conditions>
                      <actions>
                        <!-- cancel previous objectives -->
                        <cancel_cue cue="Ch5_2a_Scan_Target"/>
                        <cancel_cue cue="Ch5_2a_Attack_Target"/>

                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.claim" object="$Ch5_TargetShip" updatebriefing="true"/>

                        <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                          <param name="Actor"             value="$AceActor"/>
                          <param name="Lines"             value="[[30252566],
                                                                  [30252567],
                                                                  [30252568],
                                                                  [30252569]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          <t id="	30252	566	">Jolly profit! The ship is abandoned!
                          <t id="	30252	567	">Time to claim our price.
                          <t id="	30252	568	">(	1/2	)	Now you could send Marines to claim abandoned ships, but they tend to damage it on    entry.
                          <t id="	30252	569	">(	2/2	)	It is better to go for a small space walk and claim the ship yourself.
                          <t id="	30252	577	">Go for a little space walk and claim the ship yourself.
                          -->
                        </run_actions>
                      </actions>
                      <cues>
                        <cue name="Ch5_2a_TargetShipInvincibility">
                          <actions>
                            <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                              <param name="Object" value="$Ch5_TargetShip"/>
                              <param name="RequesterCue" value="namespace"/>
                              <param name="DebugChance" value="$DebugChance"/>
                            </run_actions>
                          </actions>
                        </cue>

                        <cue name="Ch5_2a_Claim_Guidance_Timer">
                          <delay exact="5min"/>
                        </cue>

                        <cue name="Ch5_2a_Claim_Guidance">
                          <conditions>
                            <event_cue_completed cue="Ch5_2a_Claim_Guidance_Timer"/>
                          </conditions>
                          <cues>
                            <cue name="Ch5_2a_Reset_LeakGuidance" instantiate="true">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.claim" object="$Ch5_TargetShip" updatebriefing="true"/>
                                <reset_cue cue="Ch5_2a_Claim_Help_FindLeak"/>
                              </actions>
                              <delay exact="0.1s"/>
                              <actions>
                                <reset_cue cue="Ch5_2a_Claim_Help_Reset_InRange"/>
                              </actions>
                            </cue>

                            <cue name="Ch5_2a_Claim_Help_Reset_InRange" ref="md.LIB_Generic.ApproachObject_Handler">
                              <param name="ApproachObject"    value="player.entity"/>
                              <param name="ApproachTarget"    value="$Ch5_TargetShip"/>
                              <param name="ApproachDistance"  value="2km"/>
                              <param name="SuccessSignalCue"  value="Ch5_2a_Claim_Help_FindLeak"/>
                            </cue>

                            <cue name="Ch5_2a_Claim_Help_FindLeak">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <remove_value name="$Claim_SignalLeak"/>
                                <find_object_component name="$Claim_SignalLeak" object="$Ch5_TargetShip" class="class.signalleak" multiple="false"/>
                                <do_if value="$Claim_SignalLeak">
                                  <do_if value="player.entity.inventory.{ware.weapon_gen_spacesuit_repairlaser_01_mk1}.exists">
                                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.repair" object="$Claim_SignalLeak" updatebriefing="true"/>
                                  </do_if>
                                  <do_else>
                                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.scan" object="$Claim_SignalLeak" updatebriefing="true"/>
                                  </do_else>
                                </do_if>
                                <!--<do_else>
                                  <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.claim" object="$Ch5_TargetShip" updatebriefing="true"/>
                                </do_else>-->
                              </actions>
                              <cues>
                                <cue name="Ch5_2a_Claim_Help_Reset_OutOfRange" ref="md.LIB_Generic.ApproachObject_Handler">
                                  <param name="ApproachObject"    value="player.entity"/>
                                  <param name="ApproachTarget"    value="$Ch5_TargetShip"/>
                                  <param name="ApproachDistance"  value="2001m"/>
                                  <param name="Invert"            value="true"/>
                                  <param name="SuccessSignalCue"  value="Ch5_2a_Reset_LeakGuidance"/>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <!-- Deliver Ship -->
                    <cue name="Ch5_2a_Deliver_Target">
                      <conditions>
                        <event_object_changed_owner object="$Ch5_TargetShip" owner="faction.player"/>
                      </conditions>
                      <actions>
                        <!-- cancel previous objectives -->
                        <cancel_cue cue="Ch5_2a_Scan_Target"/>
                        <cancel_cue cue="Ch5_2a_Attack_Target"/>
                        <cancel_cue cue="Ch5_2a_Claim_Target"/>

                        <set_value name="$Fleet" exact="[
                          table[
                            $macro = macro.ship_arg_m_bomber_02_a_macro,
                            $amount = 1
                          ],
                         ]"/>

                        <!--$equipment = [
                        macro.engine_tel_m_combat_01_mk3_macro,
                        macro.weapon_gen_m_shotgun_01_mk2_macro,
                        macro.weapon_gen_m_shotgun_01_mk2_macro,
                        macro.turret_arg_m_shotgun_01_mk1_macro,
                        macro.turret_arg_m_shotgun_01_mk1_macro,
                        macro.shield_tel_m_standard_01_mk2_macro,
                        macro.shield_tel_m_standard_01_mk2_macro,
                        macro.thruster_gen_m_combat_01_mk3_macro],-->

                        <!-- Set $TextTable variables for GM briefing generation. -->
                        <set_value name="this.$TextTable" exact="table[]"/>

                        <set_value name="this.$TextTable.$objective"           exact="{30252,5501}"/>
                        <set_value name="this.$TextTable.$objective_transfer"  exact="{30252,5501}"/>
                        <set_value name="this.$TextTable.$progressbar"         exact="{30251,3502}"/>
                        <set_value name="this.$TextTable.$reject_transfer"     exact="{30251,3503}"/>
                        <set_value name="this.$TextTable.$accept_transfer"     exact="{30004,5312}"/>


                        <create_position name="$DeliveryTargetOffset" object="$RaiderHubShip" space="$RaiderHubShip.sector" x="0km" y="0km" z="1km"/>

                        <run_actions ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AceActor"/>
                          <param name="Lines"             value="[[30252570],
                                                                  [30252571],
                                                                  [30252572],
                                                                  [30252573]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          <t id="30252570">Jolly fortune!
                          <t id="30252571">(1/3)Send it back to the Arcadian Endeavour(ship name same as {30252,201}).
                          <t id="30252572">(2/3)I will meet you and the crew there.
                          <t id="30252573">(3/3)And then we will show those Ministry husks what a true Teladi is capable of!
                          -->
                        </run_actions>
                      </actions>
                      <cues>
                        <cue name="Ch5_2a_TargetShipVulnerability">
                          <actions>
                            <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                              <param name="Object" value="$Ch5_TargetShip"/>
                              <param name="RequesterCue" value="namespace"/>
                              <param name="DebugChance" value="$DebugChance"/>
                            </run_actions>
                          </actions>
                        </cue>

                        <!-- Deliver this ship -->
                        <cue name="Ch5_2a_Deliver_Fleet_Ref" ref="md.RML_Deliver_Fleet.DeliverFleet">
                          <param name="EndSignalCue"            value="Ch5_2a_DeliverFleet_Completed"/>
                          <param name="MissionCue"              value="$MissionCue"/>
                          <param name="StartStep"               value="$ObjectiveStep"                comment="Briefing step to start the mission on"/>
                          <param name="UpdateBriefing"          value="true"                            comment="Update the briefing objective step when the objective is updated"/>
                          <param name="DebugChance"             value="$DebugChance"/>

                          <param name="Text_MissionName"        value="{30252,5201}"/>
                          <param name="Text_Objective_Get"      value="Ch5_2a_Deliver_Target.$TextTable.$objective"           comment="Objective text to get ships"/>
                          <param name="Text_Objective_Transfer" value="Ch5_2a_Deliver_Target.$TextTable.$objective_transfer"  comment="Objective text to transfer ownership"/>
                          <param name="Text_AcceptTransfer"     value="Ch5_2a_Deliver_Target.$TextTable.$accept_transfer"     comment="Player choice text to initiate transfer"/>
                          <param name="Text_RejectTransfer"     value="Ch5_2a_Deliver_Target.$TextTable.$reject_transfer"     comment="Player choice text to reject transfer"/>
                          <param name="Text_ProgressBar"        value="Ch5_2a_Deliver_Target.$TextTable.$progressbar"         comment="Progress bar text for multiple ships"/>
                          <param name="Fleet"                   value="$Fleet"                          comment="The specific fleet we are looking for"/>
                          <param name="Transfer"                value="true"                            comment="Mission ends with a transfer of ownership to $Faction. Otherwise ends when ships are in position."/>
                          <param name="Faction"                 value="$AceActor.owner"               comment="The faction to which it needs to be delivered. Required if $Transfer is true"/>
                          <param name="Client"                  value="$AceActor"                       comment="client who wants the fleet. Required if $Transfer is true"/>
                          <param name="TargetSector"            value="$Ch5_TargetShip.sector"              comment="Sector to which to deliver the fleet"/>
                          <param name="TargetOffset"            value="$DeliveryTargetOffset"           comment="Location to which to deliver the fleet"/>
                          <param name="TargetRadius"            value="4km"                             comment="Radius around location in which we need to put the fleet"/>
                          <param name="CriteriaResultCue"       value="null"                            comment="Cue to signal with a table of ships with the result of the most recent processing of 'CheckMissionStatus'"/>
                          <param name="AdditionCheckCue"        value="null"                            comment="Cue to signal instantly to run additional checks on the object. event.param = [namespace, $ship]. Result saved to namespace.$CheckCueResult"/>
                          <param name="ReturnFleetShips"        value="true"/>
                          <param name="PreventFleetHandling"    value="true" comment="Prevents setting pilots and orders after transfer"/>
                          <param name="VoiceTable"              value="table[$CustomNotification = 30252570]"/>
                        </cue>

                        <cue name="Ch5_2a_DeliverFleet_Completed">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="this.$EndFeedbackValue" min="1">
                              <do_for_each in="this.$FleetShips" name="$CurrentShip">
                                <add_paint_mod object="$CurrentShip" ware="$EmpyreanCursPaint"/>
                              </do_for_each>
                              <!-- Set Variables -->
                              <set_value name="$OldAceShip" exact="$AceShip"/>
                              <set_value name="$AceShip" exact="this.$FleetShips.{1}"/>
                              <signal_cue_instantly cue="Ch5_2a_DeliverFleet_ShipSetup"/>
                            </do_if>
                            <do_else>
                              <reset_cue cue="this"/>
                              <reset_cue cue="Ch5_2a_Deliver_Fleet_Ref"/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Ch5_2a_DeliverFleet_ShipSetup">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!-- Setup new ship -->
                            <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                              <param name="Object" value="$AceShip"/>
                              <param name="MinHull" value="70"/>
                              <param name="RequesterCue" value="namespace"/>
                              <param name="DebugChance" value="$DebugChance"/>
                            </run_actions>
                            <set_object_name object="$AceShip" page="30252" line="205" comment="Carefree Whirlwind"/>

                            <!-- Assign new ship -->
                            <create_control_entity object="$AceShip" post="controlpost.aipilot">
                              <select faction="faction.civilian" tags="tag.fighterpilot"/>
                            </create_control_entity>
                            <create_order id="'AssignCommander'" object="$AceShip" immediate="true">
                              <param name="commander" value="$RaiderHubShip"/>
                              <param name="assignment" value="assignment.defence"/>
                              <param name="cancelorders" value="true"/>
                            </create_order>

                            <!-- Clear old ship -->
                            <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                              <param name="Object" value="$OldAceShip"/>
                              <param name="RequesterCue" value="namespace"/>
                              <param name="DebugChance" value="$DebugChance"/>
                            </run_actions>
                            <do_if value="$OldAceShip.assignedpilot" comment="shouldn't be necessary">
                              <dismiss_control_entity object="$OldAceShip" actor="$OldAceShip.assignedpilot"/>
                            </do_if>
                            <create_control_entity object="$OldAceShip" post="controlpost.aipilot">
                              <select faction="faction.civilian" tags="tag.fighterpilot"/>
                            </create_control_entity>
                            <cancel_all_orders object="$OldAceShip"/>
                            <create_order object="$OldAceShip" id="'MoveDie'" immediate="true">
                              <param name="atstation" value="$RaiderHubShip"/>
                              <param name="byidle" value="false"/>
                            </create_order>

                            <signal_cue cue="Ch5_2a_Complete"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch5_2a_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="parent"/>
                    <signal_cue_instantly cue="Ch5_Complete" param="'AceChoice'"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch5_2b">
              <!-- Craft Item -->
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <update_mission cue="$MissionCue" icon="'briefing_axiom_01'" iconcaption="$AxiomActor.name"
                                name="{30252,5301}" description="{30252,5302}" rewardtext="{30252,5320}"/>
                <set_value name="$StoryCraftingItem" exact="ware.inv_securityapparatus"/>
                <set_value name="$RequiredInventory" exact="$StoryCraftingItem.resources.list"/>
                <!--<set_value name="$RequiredInventory" exact="[ware.inv_agidevice_01,
                                                             ware.inv_decryptionmodule, axiom version
                                                             ware.inv_interfaceunit]"/>-->


              </actions>
              <cues>

                <cue name="Ch5_2b_Setup_Lockboxes">
                  <actions>
                    <set_value name="$TargetSector" exact="$Gate_S1a_18Bil.destination.sector" comment="18 bil"/>
                    <create_position name="$TargetOffset" space="$TargetSector" object="$Gate_S1a_18Bil.destination" value="position.[-30km, -22km, 31km]"/>                    
                    <set_value name="$TargetRadius" exact="3000m"/>
                    <!-- hardcoded to 3 known items + blaster (makes shooting the ch6 switches easier) -->
                    <set_value name="$CrateContent" exact="[
                          [[ware.weapon_gen_spacesuit_laser_02_mk1, 1],
                           [$RequiredInventory.{1}, $StoryCraftingItem.resources.{$RequiredInventory.{1}}.count],
                           [$RequiredInventory.{2}, $StoryCraftingItem.resources.{$RequiredInventory.{2}}.count],
                           [$RequiredInventory.{3}, $StoryCraftingItem.resources.{$RequiredInventory.{3}}.count]]
                        ]" comment="Lockbox group -> Lockbox' crate group -> Crate"/>
                    <set_value name="$LockboxMacro" exact="macro.sm_gen_lockbox_common_01_macro"/>
                    <create_group groupname="$DroppedObjects" comment="Gets filled in the RML."/>
                    <!--Use GM library to spawn crates. Output: $TargetObjects-->
                    <include_actions ref="md.GM_FindObject.Setup_SpawnCrates"/>
                    <do_for_each in="$TargetObjects" name="$CurrentCrate">
                      <set_object_min_hull object="$CurrentCrate" exact="20" comment="We don't want to deal with this one getting destroyed."/>
                    </do_for_each>
                    <signal_cue cue="Ch5_2b_Find_Object"/>
                  </actions>
                </cue>

                <cue name="Ch5_2b_Find_Object">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch5_2b_FindObject_Ref" ref="md.RML_FindObject.FindObject">
                      <!--always pass these-->
                      <param name="EndSignalCue"      value="Ch2_1_Find_Object_Failsafe"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="StartStep"         value="$ObjectiveStep" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"       value="$DebugChance"/>
                      <param name="Text_Objective_Find"   value="{30225,1018}"/>
                      <param name="Text_Objective_Pickup" value="{30225,1019}"/>
                      <!--mission-related parameters-->
                      <param name="TargetSector"      value="$TargetSector"/>
                      <param name="TargetOffset"      value="$TargetOffset"/>
                      <param name="TargetRadius"      value="$TargetRadius"/>
                      <param name="TargetObjects"     value="$TargetObjects"/>
                      <param name="DroppedObjects"    value="$DroppedObjects"/>
                      <param name="SignalCue_ObjectsDropped" value="Ch5_2b_Find_Object_Crates_Dropped"/>
                      <param name="SignalCue_ObjectCollected" value="Ch5_2b_Find_Object_Crates_Collected"/>
                    </cue>

                    <cue name="Ch5_2b_Find_Object_Crates_Dropped" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Dropped objects: ' + $DroppedObjects" chance="$DebugChance"/>
                        <do_for_each in="$DroppedObjects" name="$CurrentCrate">
                          <!--<debug_text text="'Dropped crate: ' + $CurrentCrate + ' made invincible.'" chance="$DebugChance"/>-->
                          <!--<set_object_min_hull object="$CurrentCrate" exact="100" comment="Players could theoretically destroy the dropped crates and get stuck."/>-->
                          <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                            <param name="Object" value="$CurrentCrate"/>
                            <param name="RequesterCue" value="namespace"/>
                            <param name="DebugChance" value="$DebugChance"/>
                          </run_actions>
                        </do_for_each>
                        <show_help position="1" force="true" line="14321" duration="15s" comment="Fly over an item or hold $INPUT_STATE_LOOTMAGNET$ to attract it."/>
                      </actions>
                    </cue>

                    <cue name="Ch5_2b_Find_Object_Crates_Collected" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <!-- Last item is collected -->
                        <check_value value="$DroppedObjects.count == 1"/>
                        <check_value value="Ch5_2b_Find_Object_Complete.state == cuestate.waiting"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch5_2b_Find_Object_Complete"/>
                        <cancel_cue cue="Ch5_2b_Find_Object" comment="parent"/>
                      </actions>
                    </cue>

                    <cue name="Ch2_1_Find_Object_Failsafe">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <!-- If the RML is complete and the objective hasn't changed, that means that something went wrong collecting the items. -->
                        <signal_cue cue="Ch5_2b_Find_Object_Complete" check="false"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch5_2b_Find_Object_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_for_each in="$RequiredInventory" name="$RequiredItem">
                      <do_if value="player.entity.inventory.{$RequiredItem}.count lt $StoryCraftingItem.resources.{$RequiredItem}.count">
                        <add_inventory ware="$RequiredItem" exact="$StoryCraftingItem.resources.{$RequiredItem}.count - player.entity.inventory.{$RequiredItem}.count"/>
                      </do_if>
                    </do_for_each>
                    <signal_cue cue="Ch5_2b_Craft"/>
                  </actions>
                </cue>

                <cue name="Ch5_2b_Craft">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- $StoryCraftingItem -->
                    <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.craft" text="$StoryCraftingItem.name" updatebriefing="true"/>
                  </actions>
                  <cues>
                    <cue name="Ch5_2b_Crafted">
                      <conditions>
                        <event_inventory_added object="player.entity"/>
                        <check_value value="event.param.{$StoryCraftingItem}?"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch5_2b_DeliverItem"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch5_2b_Conversation_Waiting">
                  <cues>
                    <cue name="Ch5_2b_Waiting" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$AxiomActor"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252543" comment="readtext.{10356}.{30252543} (QuickLookup)"/>
                          <text line="30252544" comment="readtext.{10356}.{30252544} (QuickLookup)"/>
                        </add_npc_line>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch5_2b_DeliverItem">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch5_2b_Conversation_Waiting"/>

                    <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.craft" text="$StoryCraftingItem.name" updatebriefing="true"/>
                  </actions>
                  <cues>
                    <cue name="Ch5_2b_Deliver_Started" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$AxiomActor"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252543" comment="readtext.{10356}.{30252543} (QuickLookup)"/>
                          <text line="30252545" comment="readtext.{10356}.{30252545} (QuickLookup)"/>
                        </add_npc_line>
                      </actions>
                    </cue>

                    <cue name="Ch5_2b_Deliver_Ref" ref="md.RML_Deliver_Inventory.Deliver_Inventory">
                      <param name="EndSignalCue"    value="Ch5_2b_DeliverItem_Complete"/>
                      <param name="MissionCue"      value="$MissionCue"/>
                      <param name="StartStep"       value="$ObjectiveStep"           comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"  value="true"        comment="Update the briefing objective step when the objective is updated"/>

                      <!--Delivery params-->
                      <param name="WaresTableParam"         value="table[{$StoryCraftingItem} = 1]"/>
                      <param name="DeliveryNPC"             value="$AxiomActor"      comment="The NPC to which the items should be delivered." />
                      <param name="DeliveryObject"          value="$AxiomActor.container"  comment="The object on which to point to before the NPC is placed. Also used to create the interior with the below parameters" />
                      <param name="ProgressBarText"         value="{30004,1054}" comment="Text to be displayed next to the ware delivery progress bar e.g. ('Delivered')"/>
                      <param name="ConversationOptionText"  value="{30252,30252551}" comment="(Player Choice)I brought Security Slicer."/>
                      <param name="ConversationTipText"     value="{30221,2152}" comment="(Tooltip for an unselectable Player Choice)Insufficient Inventory"/>
                      <param name="PlaceNPC"                value="false" comment="we place them ourselves now"/>
                      <param name="DebugChance"             value="$DeepDebugChance"/>
                    </cue>

                    <cue name="Ch5_2b_DeliverItem_Complete">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" action="objective.wait"/>
                        <add_npc_line speaker="$AxiomActor" hidechoices="true">
                          <text line="30252540" comment="readtext.{10356}.{30252540} (QuickLookup)"/>
                          <text line="30252541" comment="readtext.{10356}.{30252541} (QuickLookup)"/>
                          <text line="30252542" comment="readtext.{10356}.{30252542} (QuickLookup)"/>
                        </add_npc_line>
                      </actions>
                      <cues>
                        <cue name="Ch5_2b_DeliverItem_Conversation_Complete" instantiate="true">
                          <conditions>
                            <event_conversation_finished actor="$AxiomActor"/>
                          </conditions>
                          <actions>
                            <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                              <param name="Actor"             value="$MaestroActor"/>
                              <param name="Lines"             value="[[30252530],[30252531]]"/>
                              <param name="EndSignalCue"      value="Ch5_2b_Complete"/>
                              <!--
                              All crew back to the Arcadian Endeavour(ship name same as {30252,201}).
                              It is time to pay Mellerd a visit.(Menacing)
                              -->
                            </run_actions>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch5_2b_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="parent"/>
                    <signal_cue_instantly cue="Ch5_Complete" param="'AxiomChoice'"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch5_Complete">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="event.param == 'AceChoice'">
                  <set_value name="$Ch5_Choice_Ace"/>
                  <set_value name="$Ch5_AceMission" exact="true"/>
                  <write_to_logbook category="missions" faction="faction.player" title="{30252,5121}" text="{30252,5122}"/>
                </do_if>
                <do_else>
                  <set_value name="$Ch5_Choice_Axiom"/>
                  <set_value name="$Ch5_AceMission" exact="false"/>
                  <write_to_logbook category="missions" faction="faction.player" title="{30252,5121}" text="{30252,5123}"/>
                  <do_if value="$Ch5_TargetShip? and $Ch5_TargetShip.exists">
                    <create_order id="'MoveDie'" object="$Ch5_TargetShip"/>
                  </do_if>
                </do_else>
                <remove_mission cue="$MissionCue" type="completed"/>

                <signal_cue cue="Ch6_Final"/>
                <cancel_cue cue="parent" />
              </actions>
            </cue>
          </cues>
        </cue>

        <!-- Chapter 6 -->

        <cue name="Ch6_Force">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch6_Criminal_Story">
            <!-- Cancelling Previous Chapters -->
            <set_value name="$CurrentChapter" exact="Ch6_Final"/>
            <do_for_each in="$Chapters" name="$Chapter">
              <do_if value="$Chapter == $CurrentChapter">
                <!--<signal_cue cue="$CurrentChapter"/> Done below-->
                <break/>
              </do_if>
              <cancel_cue cue="$Chapter"/>
            </do_for_each>

            <!-- Special setup actions when you "fast-forward" into a chapter (skipping earlier ones) -->
            <set_value name="$Ch6Forced"/>
            <set_value name="$Flag_BetrayedMaestro" exact="false"/>
            <set_value name="$Ch5_AceMission" exact="false"/>
            <cancel_cue cue="md.GS_Pirate2.Start" comment="Cancel Gamestart2 (in case we started from that one)"/>

            <!-- Axiom & Ace on the AE when forcing -->
            <create_position name="$AcePos" x="1.78" z="-9.0"/>
            <create_rotation name="$AceRot" yaw="-14.0deg"/>
            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AceActor,
                table[ $requestercue = $MissionCue, $location = $MaestroActor.room, $priority = 100, $rotation = $AceRot, $position = $AcePos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null]
              ]"/>
            <create_position name="$AxiomPos" x="-3.0" z="-8.0"/>
            <create_rotation name="$AxiomRot" yaw="33.0deg"/>
            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor,
                table[$requestercue = $MissionCue, $location = $MaestroActor.room, $priority = 100, $rotation = $AxiomRot, $position = $AxiomPos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null] 
              ]"/>

            <add_inventory entity="player.entity" ware="ware.weapon_gen_spacesuit_laser_01_mk1"/>
            <add_inventory entity="player.entity" ware="ware.weapon_gen_spacesuit_laser_02_mk1"/>

            <force_cue cue="Ch6_Final"/>
          </force>
        </cue>

        <cue name="Ch6_PrisonStation_Force">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch6B_Criminal_Story">

            <!-- Cancelling Previous Chapters -->
            <set_value name="$CurrentChapter" exact="Ch6_Final"/>
            <do_for_each in="$Chapters" name="$Chapter">
              <do_if value="$Chapter == $CurrentChapter">
                <!--signal_cue cue="$CurrentChapter"/-->
                <break/>
              </do_if>
              <cancel_cue cue="$Chapter"/>
            </do_for_each>

            <set_known object="$PrisonStation" known="true"/>

            <!-- Special setup actions when you "fast-forward" into a chapter (skipping earlier ones) -->
            <set_value name="$Ch6Forced"/>
            <set_value name="$Ch6_SkippedBriefing"/>
            <set_value name="$Flag_BetrayedMaestro" exact="false"/>
            <set_value name="$Ch5_AceMission" exact="false"/>
            <cancel_cue cue="md.GS_Pirate2.Start" comment="Cancel Gamestart2 (in case we started from that one)"/>
            <teleport_player object="$PrisonStation" instant="true" force="true" />
            <add_inventory entity="player.entity" ware="ware.weapon_gen_spacesuit_laser_01_mk1"/>
            <add_inventory entity="player.entity" ware="ware.weapon_gen_spacesuit_laser_02_mk1"/>

            <get_safe_pos result="$Ch6_PrisonWaitingPos" object="$PrisonStation" sector="$PrisonStation.sector" min="6km" max="12km" allowyaxis="false"/>
            <cancel_all_orders object="$RaiderHubShip"/>
            <create_order object="$RaiderHubShip" id="'MoveWait'" default="true">
              <param name="destination" value="[$PrisonStation.sector, $Ch6_PrisonWaitingPos]"/>
              <param name="debugchance" value="$DebugChance"/>
            </create_order>

            <force_cue cue="Ch6_Final"/>
            <cancel_cue cue="Ch6_Meeting"/>
            <cancel_cue cue="Ch6_ToPrison"/>
            <signal_cue cue="Ch6_Prison"/>
          </force>
        </cue>

        <cue name="Ch6_Final">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- various setup -->

            <find_sector name="$EighteenBillionSector" macro="macro.cluster_02_sector001_macro" required="true"/>
            <find_station name="$PrisonStation" space="$EighteenBillionSector" godstationentry="'story_prison_station_id'" required="true"/>
            <find_object_component name="$PrisonModule"   object="$PrisonStation"  macro="macro.landmarks_gen_prison_01_macro" recursive="true"/>
            <find_object_component name="$PrisonCorridor" object="$PrisonModule"      macro="macro.prison_escape_v2_macro" recursive="true"/>
            <find_object_component name="$PrisonSwitchCellPower"    object="$PrisonModule" macro="macro.interactive_pir_doorcontrol_01_macro" grouptag="tag.cellpower"    required="true" />

            <!--find_object_component name="$PrisonEmitter" object="$PrisonModule"      macro="macro.room_gen_prison_forceemitter_macro" recursive="true"/-->

            <set_value name="$PrisonRoom" exact="md.Setup_DLC_Pirate.X4ep1_Prelude_Setup.$PrisonRoom"/>
            <set_value name="$PrisonRoom2" exact="md.Setup_DLC_Pirate.X4ep1_Prelude_Setup.$PrisonRoom2"/>

            <!-- create mission -->

            <set_value name="$ObjectiveStep" exact="1"/>
            <create_mission cue="$MissionCue" name="{30252,6001}" description="{30252,6002}" rewardtext="{30252,6035}" type="missiontype.plot" faction="faction.civilian" difficulty="level.medium" abortable="false" icon="'briefing_maestro_01'" iconcaption="$MaestroActor.knownname">
              <briefing>
                <objective step="1" action="objective.flyto" object="$RaiderHubShip" comment="meeting at the Arcadian Endeavor / AE"/>
              </briefing>
            </create_mission>
            <set_objective_from_briefing cue="$MissionCue" step="$ObjectiveStep"/>

            <!-- Recall Pirate Actors -->
            <do_if value="not $Ch6_SkippedBriefing?">
              <create_position name="$AxiomPos" x="-4.01" z="-9.88"/>
              <create_rotation name="$AxiomRot" yaw="40.0deg"/>
              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor,
                  table[ $requestercue = $MissionCue, $location = $RaiderHubShip_CrewQuartersRoom, $priority = 100, $rotation = $AxiomRot, $position = $AxiomPos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null]
                ]"/>
              <create_position name="$AcePos" x="-1.6" z="-7.58"/>
              <create_rotation name="$AceRot" yaw="-145.0deg"/>
              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AceActor,
                  table[ $requestercue = $MissionCue, $location = $RaiderHubShip_CrewQuartersRoom, $priority = 100, $rotation = $AceRot, $position = $AcePos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null]
                ]"/>

              <create_position name="$Maestro2Pos" x="-1.003" z="-9.80"/>
              <create_rotation name="$Maestro2Rot" yaw="-30.0deg"/>
              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $MaestroActor, Setup_RaiderHubShip]"/>
              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MaestroActor,
                  table[ $requestercue = $MissionCue, $location = $RaiderHubShip_CrewQuartersRoom, $priority = 100, $rotation = $Maestro2Rot, $position = $Maestro2Pos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null]
                ]"/>
            </do_if>
            <do_else>
              <!-- Axiom walks to near the airlock (where Stev will also go after unlocking the celldoor) -->
              <find_npc_waypoint name="this.$PrisonCorridorWaitLocation" object="$PrisonCorridor" tags="tag.waitlocation" comment="alternative: tag.hidelocation" />
              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor, table[$requestercue = namespace, $location = this.$PrisonCorridorWaitLocation, $priority = 100, $debugchance = $DeepDebugChance] ]"/>
            </do_else>

            <!-- make sure triggers are locked and celldoors closed -->
            <set_triggers_locked object="$PrisonRoom" group="tag.door_01" locked="true" comment="left"/>
            <set_triggers_locked object="$PrisonRoom" group="tag.door_02" locked="true" comment="center"/>
            <set_triggers_locked object="$PrisonRoom" group="tag.door_03" locked="true" comment="right cell / door button"/>
            <trigger_animation object="$PrisonRoom" group="tag.door_01" trigger="deactivate"/>
            <trigger_animation object="$PrisonRoom" group="tag.door_02" trigger="deactivate"/>
            <trigger_animation object="$PrisonRoom" group="tag.door_03" trigger="deactivate"/>

            <set_value name="$StevLuccaActor" exact="md.$PersistentCharacters.$StevLuccaActor"/>

            <!-- TODO: This might have to be triggered already in the previous chapter? -->
            <set_triggers_locked object="$PrisonCorridor" group="tag.transporter_01" locked="false" comment="Transporter station-prison is locked at gamestart, unlock it"/>

            <find_object_component name="$PrisonMarker_01" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy1_macro"  required="true" comment="Hangar shipspawn"/>
            <find_object_component name="$PrisonMarker_02" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy2_macro"  required="true" comment="exit tunnel corner"/>
            <find_object_component name="$PrisonMarker_04" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy4_macro"  required="true" comment="?"/>
            <find_object_component name="$PrisonMarker_07" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy7_macro"  required="true" comment="Junction in front of transporter room on Floor 1"/>
            <find_object_component name="$PrisonMarker_08" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy8_macro"  required="true" comment="Immediately in front of transporter room on Floor 1"/>
            <find_object_component name="$PrisonMarker_11" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy11_macro"  required="true" comment="Floor 3, after the bend in the hallway to the hangar"/>
            <find_object_component name="$PrisonMarker_12" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy12_macro"  required="true" comment="Hangar spacesuit/airlock"/>
            <find_object_component name="$PrisonMarker_13" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy13_macro"  required="true" comment="Hangar floor"/>
            <find_object_component name="$PrisonMarker_14" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy14_macro"  required="true" comment="Hangar near dock below spaceship"/>
            <find_object_component name="$PrisonMarker_19" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy19_macro"  required="true" comment="Hangar spacesuit/airlock II (2.5m next to the other)"/>
            <find_object_component name="$PrisonMarker_22" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy22_macro"  required="true" comment="Airlock-tower Floor 1"/>
            <find_object_component name="$PrisonMarker_23" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy23_macro"  required="true" comment="Airlock-tower Floor 2"/>
            <find_object_component name="$PrisonMarker_24" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy24_macro"  required="true" comment="Airlock-tower Floor 3"/>

            <set_value name="$HangarClampsDestroyed" exact="0"/>
            <find_object_component groupname="$HangarClamps" object="$PrisonModule" macro="macro.props_special_shipclamp_01_macro"  required="true" multiple="true"/>
            <add_to_group groupname="$PrisonStation.engineer.$ExcludedRepairElements" group="$HangarClamps" comment="avoid station engineer from repairing it"/>

            <find_object_component name="$HangarDoor1" groupname="$HangarDoors" object="$PrisonModule" macro="[macro.interactive_pir_doorcontrol_01_macro]" grouptag="tag.interactionspot_1" required="true" />
            <find_object_component name="$HangarDoor2" groupname="$HangarDoors" object="$PrisonModule" macro="[macro.interactive_pir_doorcontrol_01_macro]" grouptag="tag.interactionspot_2" required="true" />
            <add_to_group groupname="$PrisonStation.engineer.$ExcludedRepairElements" group="$HangarDoors" comment="avoid station engineer from repairing it"/>

            <find_object_component name="$PrisonEmitter"  object="$PrisonModule"  macro="macro.room_gen_prison_forceemitter_macro" recursive="true"/>

            <!-- Repair the RaiderHubShip's hull for the final battle -->
            <do_if value="$RaiderHubShip.hullpercentage lt 95">
              <set_object_hull object="$RaiderHubShip" exact="95"/>
            </do_if>
          </actions>
          <cues>

            <!--cue name="Ch6_PrisonComplex_AttentionChange_DEBUG" instantiate="true">
              <conditions>
                <event_object_changed_attention object="$PrisonCorridor"/>
              </conditions>
              <actions>
                <debug_text text="'attentionchange %s=%s (old=%s new=%s)'.[event.object, event.object.knownname, event.param2, event.param]"/>
              </actions>
            </cue-->

            <!--cue name="Ch6_PrisonComplex_AttentionChange_Handler" instantiate="true">
              <conditions>
                <event_object_changed_attention attention="attention.inroom" object="$PrisonCorridor"/>
              </conditions>
              <actions>
                <debug_text text="'attention.inroom: tag.upperlock -> deactivate'" chance="$DebugChance"/>
                <trigger_animation object="$PrisonCorridor" group="tag.upperlock" trigger="deactivate" comment="open large airlock to the next set of riddles - already happened in Ch4"/>
              </actions>
            </cue-->

            <!-- AnimationStates are not saved, so if you opened the large airlock in ch4 and "save/load" or "go away-and-return" it will be closed again. 
              In ch6 the room is guaranteed to be open, so restore state when entering room. -->
            <cue name="Ch6_EnteredPrisonComplex" instantiate="true">
              <conditions>
                <event_object_changed_room room="$PrisonCorridor" object="player.entity"/>
              </conditions>
              <actions>
                <debug_text text="'Player entered Prison Complex'" chance="$DebugChance"/>
                <trigger_animation object="$PrisonCorridor" group="tag.upperlock" trigger="deactivate" comment="open large airlock (separating the two parts of 'the tower')"/>
                <signal_cue cue="md.Setup_DLC_Pirate.Setup_AirlockLights_Update" comment="update airlock green/orange lights (otherwise they refresh when you enter the 'tower' and because you can watch through the airlock window that is slightly too late"/>
              </actions>
            </cue>

            <cue name="Ch6_PlayerInTower" version="2">
              <actions>
                <!--add_effect object="$PrisonSwitchCellPower" effect="'longsparks_3deg_bursts_v1'">
                  <position object="$PrisonSwitchCellPower" y="-1.2m" z="-.5m"/>
                  <rotation pitch="120deg"/>
                </add_effect-->
                <add_effect object="$PrisonSwitchCellPower" effect="'bluesparks_90deg_constant_v1_big'">
                  <position object="$PrisonSwitchCellPower" y="-1.2m" z="-1.5m"/>
                  <rotation pitch="90deg"/>
                </add_effect>
                <add_effect object="$PrisonSwitchCellPower" effect="'bluesparks_90deg_constant_v1_big'">
                  <position object="$PrisonSwitchCellPower" x="0.6m" y="1.7m" z="-.6m"/>
                  <rotation pitch="90deg"/>
                </add_effect>
                <add_effect object="$PrisonSwitchCellPower" effect="'bluesparks_90deg_constant_v1_big'">
                  <position object="$PrisonSwitchCellPower" x="-1.2m" y="0.7m" z="-.6m"/>
                  <rotation pitch="90deg"/>
                </add_effect>
              </actions>
              <patch sinceversion="2">
                <do_if value="$PlayerInTower? and (not $DeactivatedCriminalMasstraffic?)">
                  <set_job_active activate="false" job="'masstraffic_teladi_criminal'"/>
                  <set_value name="$DeactivatedCriminalMasstraffic"/>
                </do_if>
              </patch>
              <cues>
                <!-- Behaviour for entering/leaving the Tower -->
                <cue name="Ch6_PlayerEnteredTower" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="not $PlayerInTower?"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Player Entered Tower in Spacesuit'" chance="$DebugChance"/>
                    <set_value name="$PlayerInTower"/>

                    <set_object_relation_behaviour object="$PrisonStation" disable="true" comment="Do this AFTER destroying control entities!" />
                    <run_actions ref="md.LIB_Generic.SuppressChatter_AddCue">
                      <param name="Cue" value="Ch6_PlayerInTower"/>
                    </run_actions>

                    <signal_cue cue="md.Setup_DLC_Pirate.Setup_AirlockLights_Update" comment="update airlock green/orange lights"/>

                    <!-- Deactivate Mass Traffic -->
                    <set_job_active activate="false" job="'masstraffic_teladi_criminal'"/>
                    <set_value name="$DeactivatedCriminalMasstraffic"/>
                    <!--<stop_mass_traffic_quota quota="0" endtime="player.age" comment="no idea how to use this"/>-->
                  </actions>
                </cue>

                <cue name="Ch6_PlayerLeftTower" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="$PlayerInTower?"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Player Left Tower'" chance="$DebugChance"/>
                    <remove_value name="$PlayerInTower"/>

                    <set_object_relation_behaviour object="$PrisonStation" disable="false"/>
                    <run_actions ref="md.LIB_Generic.SuppressChatter_RemoveCue">
                      <param name="Cue" value="Ch6_PlayerInTower"/>
                    </run_actions>

                    <!-- Reactivate Mass Traffic -->
                    <set_job_active activate="true" job="'masstraffic_teladi_criminal'"/>
                    <remove_value name="$DeactivatedCriminalMasstraffic"/>
                    <!--<stop_mass_traffic_quota quota="0" endtime="player.age" comment="no idea how to use this"/>-->
                  </actions>
                </cue>

                <!-- Periodic Checks while in Space Suit in Prison.sector -->
                <cue name="Ch6_PlayerSpaceSuit_Init">
                  <actions>
                    <signal_cue cue="Ch6_PlayerEnteredSpaceSuitInTower"/>
                  </actions>
                </cue>

                <cue name="Ch6_PlayerEnteredSpaceSuitInTower">
                  <conditions>
                    <check_any>
                      <event_player_teleport_successful/>
                      <event_cue_signalled/>
                    </check_any>
                    <check_value value="@player.controlled.isclass.spacesuit"/>
                    <check_value value="player.sector == $PrisonStation.sector"/>
                    <check_value value="player.entity.distanceto.{$PrisonMarker_22} lt 55m"/>
                  </conditions>
                  <actions>
                  </actions>
                  <cues>
                    <cue name="Ch6_PlayerInTowerCheck" checkinterval="3s" instantiate="true">
                      <conditions>
                        <check_value value="@player.controlled.isclass.spacesuit"/>
                        <check_value value="player.sector == $PrisonStation.sector"/>
                      </conditions>
                      <actions>
                        <do_if value="player.entity.distanceto.{$PrisonMarker_22} lt 55m">
                          <signal_cue_instantly cue="Ch6_PlayerEnteredTower"/>
                        </do_if>
                        <do_else>
                          <signal_cue_instantly cue="Ch6_PlayerLeftTower"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch6_PlayerLeftSpaceSuit">
                      <conditions>
                        <event_player_teleport_successful/>
                        <check_value value="not @player.controlled.isclass.spacesuit"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="Ch6_PlayerLeftTower"/>
                        <reset_cue cue="parent"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Axiom_Comments" instantiate="true" comment="fire and forget speaks (no callbacks!)">
              <conditions>
                <event_cue_signalled comment="event.param contains lines to be spoken!"/>
                <check_value value="md.$PersistentCharacters.$AxiomActor"/>
              </conditions>
              <actions>
                <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                  <param name="Actor"             value="md.$PersistentCharacters.$AxiomActor"/>
                  <param name="Lines"             value="event.param"/>
                </run_actions>
              </actions>
            </cue>

            <cue name="Stev_Comments" instantiate="true" comment="fire and forget speaks (no callbacks!)">
              <conditions>
                <event_cue_signalled comment="event.param contains lines to be spoken!"/>
                <check_value value="md.$PersistentCharacters.$StevLuccaActor"/>
              </conditions>
              <actions>
                <set_value name="this.$lines" exact="event.param"/>
              </actions>
              <cues>
                <cue name="Stev_Comments_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="md.$PersistentCharacters.$StevLuccaActor"/>
                  <param name="Lines"             value="parent.$lines"/>
                </cue>
              </cues>
            </cue>

            <cue name="Mellerd_Comments" instantiate="true" comment="fire and forget speaks (no callbacks!)">
              <conditions>
                <event_cue_signalled comment="event.param contains lines to be spoken!"/>
                <check_value value="md.$PersistentCharacters.$KrissMellerdActor"/>
              </conditions>
              <actions>
                <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                  <param name="Actor"             value="md.$PersistentCharacters.$KrissMellerdActor"/>
                  <param name="Lines"             value="event.param"/>
                </run_actions>
              </actions>
            </cue>

            <!--cue name="Ch6_AceShipDock">
              <conditions>
                <event_cue_signalled comment="TODO: Ace's ship doesn't always exist / created in ch2/3 see '$AceShip'"/>
              </conditions>
              <actions>
                <cancel_all_orders object="$AceShip"/>
                <create_order id="'DockAndWait'" object="$AceShip" immediate="true">
                  <param name="destination" value="$RaiderHubShip" comment="stay docked at Halls of Judgement"/>
                  <param name="debugchance" value="$DebugChance"/>
                </create_order>
              </actions>
              <cues>
                <cue name="Ch6_AceShipDocked">
                  <conditions>
                    <event_object_docked_at container="$RaiderHubShip"/>
                    <check_value value=" event.param == $AceShip"/>
                  </conditions>
                  <delay exact="3s"/>
                  <actions>
                    <debug_text text="'Ace has docked'" chance="$DebugChance"/>
                    <create_position name="$AcePos" x="1.78" z="-9.0"/>
                    <create_rotation name="$AceRot" yaw="-14.0deg"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AceActor,
                        table[ $requestercue = $MissionCue, $location = $MaestroActor.room, $priority = 100, $rotation = $AceRot, $position = $AcePos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null]
                      ]"/>
                  </actions>
                </cue>
                <cue name="Ch6_AceShipUndock">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_order id="'AssignCommander'" object="$AceShip" immediate="true">
                      <param name="commander" value="$RaiderHubShip"/>
                      <param name="assignment" value="assignment.defence"/>
                      <param name="cancelorders" value="true"/>
                    </create_order>
                  </actions>
                </cue>
              </cues>
            </cue-->

            <cue name="Ch6_Meeting_AlreadyAtLocation" onfail="cancel">
              <conditions>
                <check_value value="player.ship == $RaiderHubShip"/>
              </conditions>
              <actions>
                <signal_cue cue="Ch6_Meeting"/>
              </actions>
            </cue>

            <cue name="Ch6_ApproachRaider_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
              <param name="ApproachTarget"    value="$RaiderHubShip"/>
              <param name="ApproachDistance"  value="2.0km"/>
              <param name="SuccessSignalCue"  value="Ch6_Meeting_Objective"/>
            </cue>

            <cue name="Ch6_Meeting_Objective">
              <conditions>
                <event_cue_signalled/>
                <cue_is_waiting cue="Ch6_Meeting"/>
              </conditions>
              <actions>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" text="{30252,10}" object="$MaestroActor" updatebriefing="true" comment="Talk to: Team"/>
              </actions>
            </cue>

            <cue name="Ch6_Meeting" version="2">
              <conditions>
                <check_any>
                  <check_all>
                    <event_object_docked_at container="$RaiderHubShip"/>
                    <check_value value="event.param == player.ship"/>
                  </check_all>
                  <event_cue_signalled/>
                  <event_object_changed_object object="player.entity" newobject="$RaiderHubShip"/>
                </check_any>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" text="{30252,10}" object="$MaestroActor" updatebriefing="true" comment="Talk to: Team" silent="true"/>
                <signal_cue cue="Ch6_RaiderHubShip_Fly" comment="Raiderhubship starts to move as early as possible towards prison to decrease player flight-time"/>
              </actions>
              <patch sinceversion="2">
                <do_if value="Ch_6_Briefing_Cutscene.state == cuestate.waiting">
                  <do_if value="$MaestroActor.room != $RaiderHubShip_CrewQuartersRoom">
                    <!--Recall Pirate Actors-->

                    <create_position name="$AxiomPos" x="-4.01" z="-9.88"/>
                    <create_rotation name="$AxiomRot" yaw="40.0deg"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor,
                        table[ $requestercue = $MissionCue, $location = $RaiderHubShip_CrewQuartersRoom, $priority = 100, $rotation = $AxiomRot, $position = $AxiomPos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null]
                      ]"/>
                    <create_position name="$AcePos" x="-1.6" z="-7.58"/>
                    <create_rotation name="$AceRot" yaw="-145.0deg"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AceActor,
                        table[ $requestercue = $MissionCue, $location = $RaiderHubShip_CrewQuartersRoom, $priority = 100, $rotation = $AceRot, $position = $AcePos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null]
                      ]"/>

                    <create_position name="$Maestro2Pos" x="-1.003" z="-9.80"/>
                    <create_rotation name="$Maestro2Rot" yaw="-30.0deg"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $MaestroActor, Setup_RaiderHubShip]"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MaestroActor,
                        table[ $requestercue = $MissionCue, $location = $RaiderHubShip_CrewQuartersRoom, $priority = 100, $rotation = $Maestro2Rot, $position = $Maestro2Pos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null]
                      ]"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" text="{30252,10}" object="$MaestroActor" updatebriefing="true" comment="Talk to: Team"/>
                  </do_if>
                </do_if>
              </patch>
              <cues>

                <cue name="Ch_6_Briefing_Cutscene" checkinterval="50ms">
                  <conditions>
                    <check_value value="player.room == $RaiderHubShip_CrewQuartersRoom"/>
                  </conditions>
                  <delay exact="0.3s"/>
                  <actions>
                    <do_if value="$Ch5_AceMission == true">
                      <set_value name="$SecondSpeakActor" exact="$AceActor"/>
                    </do_if>
                    <do_else>
                      <set_value name="$SecondSpeakActor" exact="$AxiomActor"/>
                    </do_else>

                    <set_value name="$CutsceneKey" exact="'story_criminal_ch6_briefing'"/>

                    <create_position name="$PlayerPos" x="-4.46m" y="1.87m" z="-7.5m" space="$RaiderHubShip_CrewQuartersRoom"/>

                    <!--Warp player to different position-->
                    <add_actor_to_room actor="player.entity" object="$RaiderHubShip_CrewQuartersRoom">
                      <position value="$PlayerPos" space="$RaiderHubShip_CrewQuartersRoom"/>
                      <rotation value="rotation.[124.698784deg, 1.948127deg, -0.000000deg]"/>
                    </add_actor_to_room>

                    <fade_screen fadeout="0s" fadein="1.4s" realtime="true"/>
                    <play_cutscene key="$CutsceneKey" result="this.$CutsceneID" abortable="true">
                      <param name="target_maestro"      object="$MaestroActor"/>
                      <param name="target_axiom"        object="$AxiomActor"/>
                      <param name="target_ace"          object="$AceActor"/>
                      <param name="target_player"       object="player.entity"/>
                    </play_cutscene>
                  </actions>
                  <cues>
                    <cue name="Ch_6_Briefing_Conversation">
                      <conditions>
                        <event_cutscene_started cutscene="parent.$CutsceneID"/>
                      </conditions>
                      <delay exact="1.5s"/>
                      <actions>
                        <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[ $name = '$Story_Criminal_Briefing_Scene_1', $actors = table[ $MaestroActor = $MaestroActor, $AxiomActor = $AxiomActor, $AceActor = $AceActor, $SecondSpeakActor = $SecondSpeakActor], $debugchance = $DeepDebugChance ]" />
                      </actions>
                      <cues>

                        <cue name="Ch6Maestro_Instructions_Pt1">
                          <conditions>
                            <event_speak_finished actor="$SecondSpeakActor" line="30252701"/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence1Done'"/>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence2Start'"/>
                          </actions>
                        </cue>

                        <cue name="Ch6_Maestro_OverShoulder">
                          <conditions>
                            <event_speak_finished actor="$MaestroActor" line="30252705"/>
                          </conditions>
                          <delay exact="0.2s"/>
                          <actions>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence2Done'"/>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence3Start'"/>
                          </actions>
                        </cue>

                        <cue name="Ch6_Maestro_AceInterjection">
                          <conditions>
                            <event_speak_finished actor="$MaestroActor" line="30252707"/>
                          </conditions>
                          <delay exact="1.5s"/>
                          <actions>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence3Done'"/>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence4Start'"/>
                          </actions>
                        </cue>

                        <cue name="Ch6_Axiom_Interjection">
                          <conditions>
                            <event_speak_finished actor="$MaestroActor" line="30252710"/>
                          </conditions>
                          <delay exact="1.5s"/>
                          <actions>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence4Done'"/>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence5Start'"/>
                          </actions>
                        </cue>

                        <cue name="Ch6_MaestroBriefing_Pt2">
                          <conditions>
                            <event_speak_finished actor="$AxiomActor" line="30252703"/>
                          </conditions>
                          <delay exact="1.5s"/>
                          <actions>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence5Done'"/>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence6Start'"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch5_Briefing_Cutscene_Stop">
                      <conditions>
                        <event_speak_finished actor="$MaestroActor" line="30252713"/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <cutscene_event key="$CutsceneKey" event="'TriggerSequence4Done'"/>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_MovingToNext_Objective">
                      <conditions>
                        <event_cutscene_stopped cutscene="parent.$CutsceneID"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch6_ToPrison" check="false"/>
                        <find_object_component name="$Dock" object="$RaiderHubShip" checkoperational="true" macro="macro.dockingbay_arg_s_01_macro"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AceActor,
                                                                                              table[
                                                                                              $requestercue = $MissionCue,
                                                                                              $location = $Dock,
                                                                                              $priority = 100,
                                                                                              $slottags = [tag.stand],
                                                                                              $debugchance = $DeepDebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                              ]"/>
                      </actions>
                      <delay exact="2s"/>
                      <actions>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MaestroActor,
                                                                                              table[
                                                                                              $requestercue = namespace,
                                                                                              $location = $RaiderHubShip.controlroom,
                                                                                              $priority = 100,
                                                                                              $rotation = $MaestroRot,
                                                                                              $position = $MaestroPos,
                                                                                              $debugchance = 0,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                              ]"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>


              </cues>
            </cue>

            <cue name="Ch6_RaiderHubShip_Fly">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <get_safe_pos result="$Ch6_PrisonWaitingPos" object="$PrisonStation" sector="$PrisonStation.sector" min="6km" max="12km" allowyaxis="false"/>
                <cancel_all_orders object="$RaiderHubShip"/>
                <create_order object="$RaiderHubShip" id="'MoveWait'" default="true">
                  <param name="destination" value="[$PrisonStation.sector, $Ch6_PrisonWaitingPos]"/>
                  <param name="debugchance" value="$DebugChance"/>
                </create_order>
              </actions>
            </cue>

            <cue name="Ch6_ToPrison">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.embark_passenger" object="$AxiomShip" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch6_Prepare">
                  <cues>

                    <cue name="Ch6_RecallShip" onfail="cancel">
                      <conditions>
                        <check_value value="true"/>
                      </conditions>
                      <actions>
                        <do_if value="$AxiomShip.isoperational and $AxiomShip.dock and $AxiomShip.dock.isstorage">
                          <!-- try and retrieve Axioms ship from internal storage (likely the playership is occupying the dock) -->
                          <request_retrieval queuedresult="$QueuedResult1" grantedresult="$GrantedResult1" ship="$AxiomShip" highpriority="false" allowplayeronly="true" />
                          <debug_text text="'request_retrieval for %s (%s) request=%s granted=%s'.[$AxiomShip, $AxiomShip.name, $QueuedResult1, $GrantedResult1]" chance="$DebugChance"/>
                        </do_if>
                        <do_if value="not $GrantedResult1">
                          <!-- retrieval failed, force whatever ship is docked into internal storage, so we can retrieve Axioms ship -->
                          <find_object_component name="$dockedships" docked="true" object="$RaiderHubShip" includeobjects="true" multiple="true">
                            <match_parent>
                              <match_dock storage="false"/>
                            </match_parent>
                          </find_object_component>
                          <do_for_each name="$dockedship" in="$dockedships">
                            <do_if value="$dockedship != $AxiomShip" comment="just in case, avoid putting back Axiom's ship into storage">
                              <request_store_ship object="$RaiderHubShip" allowplayeronly="true" highpriority="false" ship="$dockedship" skiptimeout="true" />
                              <debug_text text="'request_store_ship for %s (%s)'.[$dockedship, $dockedship.name]" chance="$DebugChance"/>
                            </do_if>
                          </do_for_each>
                        </do_if>
                      </actions>
                      <delay exact="15s"/>
                      <actions>
                        <reset_cue cue="Ch6_RecallShip" comment="periodically re-request, to avoid ship being put back in storage permanently, if player takes long"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Axiom_Embark">
                      <conditions>
                        <event_object_retrieved_from_internal_storage object="$AxiomShip" comment="wait for ship to be retrieved from storage"/>
                      </conditions>
                      <actions>
                        <debug_text text="'retrieved from storage'" chance="$DebugChance"/>
                      </actions>
                      <delay exact="3s"/>
                      <actions>
                        <!--signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $AxiomActor, md.GS_Pirate2.Start]" comment="fixed in r467750 / this workaround shouldn't be needed"/-->
                        <!--speak actor="$AxiomActor" line="zzz" comment="Time to head to the ship (intentionally as speak, only audible if player happens to be nearby)"/-->
                        <find_npc_waypoint name="this.$DespawnWaypoints" object="$AxiomShip" tags="tag.npctransport" multiple="true"/>
                        <do_if value="this.$DespawnWaypoints.count">
                          <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                              param="['add_definition', $AxiomActor, table[$requestercue = namespace, $location = this.$DespawnWaypoints.random, $priority = 100, $debugchance = $DeepDebugChance] ]"/>
                        </do_if>
                        <do_else>
                          <assert value="false"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch6_Axiom_Embarked">
                      <conditions>
                        <event_object_changed_room object="$AxiomActor" room="$AxiomShip.controlroom"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Axiom arrived'" chance="$DebugChance"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $AxiomActor, $MissionCue]"/>
                        <assign_control_entity object="$AxiomShip" actor="$AxiomActor" post="controlpost.aipilot" transfer="false" init="false"/>
                        <signal_objects object="$AxiomActor" param="'npc_state_reinit'"/>
                        <set_entity_traits entity="$AxiomActor" hidden="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Player_Embarked">
                      <conditions>
                        <event_object_changed_room object="player.entity" room="$AxiomShip.controlroom"/>
                      </conditions>
                      <delay exact="2s"/>
                      <actions>
                        <!--signal_cue_instantly cue="Axiom_Comments" param="[[zzz]]" comment="I'll be with you in a moment"/-->
                      </actions>
                    </cue>

                    <cue name="Ch6_AxiomPlayerReady" checkinterval="1s">
                      <conditions>
                        <check_value value="(player.ship == $AxiomShip) and ($AxiomActor.ship == $AxiomShip) and ($AxiomActor.distanceto.{player.entity} lt 2m)"/>
                      </conditions>
                      <delay exact="3s"/>
                      <actions>
                        <do_if value="not $AxiomShip.assignedpilot">
                          <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $AxiomActor, $MissionCue]"/>
                          <assign_control_entity object="$AxiomShip" actor="$AxiomActor" post="controlpost.aipilot" transfer="false" init="false"/>
                          <signal_objects object="$AxiomActor" param="'npc_state_reinit'"/>
                          <set_entity_traits entity="$AxiomActor" hidden="true"/>
                        </do_if>
                        <set_value name="$Ch6_ReadyUndock" exact="true"/>
                        <signal_cue cue="Ch6_Axiom_FlyToPrison"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_Axiom_FlyToPrison" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch6_Prepare" comment="stop retrieval requests"/>
                  </actions>
                  <patch sinceversion="2">
                    <do_if value="Ch6_Prison.state == cuestate.waiting and not $AxiomShip.assignedpilot">
                      <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $AxiomActor, $MissionCue]"/>
                      <assign_control_entity object="$AxiomShip" actor="$AxiomActor" post="controlpost.aipilot" transfer="false" init="false"/>
                      <signal_objects object="$AxiomActor" param="'npc_state_reinit'"/>
                      <set_entity_traits entity="$AxiomActor" hidden="true"/>
                    </do_if>
                  </patch>
                  <cues>

                    <cue name="Ch6_Ace_EmbarksShip_v2">
                      <actions>
                        <!-- Make sure Ace is in her ship and available for the final battle -->
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $AceActor, $MissionCue]"/>
                        <assign_control_entity object="$AceShip" actor="$AceActor" post="controlpost.aipilot" transfer="false" init="false"/>
                        <signal_objects object="$AceActor" param="'npc_state_reinit'"/>
                        <set_entity_traits entity="$AceActor" hidden="true"/>
                      </actions>
                      <delay exact="2s"/>
                      <actions>
                        <cancel_all_orders object="$AceShip"/>
                        <create_order id="'AssignCommander'" object="$AceShip" immediate="true">
                          <param name="commander" value="$RaiderHubShip"/>
                          <param name="assignment" value="assignment.defence"/>
                          <param name="cancelorders" value="true"/>
                        </create_order>
                      </actions>
                    </cue>

                    <cue name="Ch6_Axiom_FlyingToPrison_Speaks" comment="player is inside same ship as axiom, so speaks">
                      <actions>
                        <speak actor="$AxiomActor">
                          <text line="30252704" comment="This is the big one."/>
                          <text line="30252705" comment="Buckle up, Wildcard!"/>
                        </speak>
                      </actions>
                      <delay exact="20s"/>
                      <actions>
                        <speak actor="$AxiomActor">
                          <text line="30252706" comment="I have to admit, I am nervous"/>
                          <text line="30252707" comment="Sure, I have been involved in large-scale operations before, but never quite like this."/>
                          <text line="30252708"/>
                          <text line="30252709"/>
                        </speak>
                      </actions>
                    </cue>

                    <cue name="Ch6_Axiom_Fly">
                      <actions>
                        <cancel_all_orders object="$AxiomShip" comment="cancels the 'MoveWait' order"/>

                        <create_order id="'DockAndWait'" object="$AxiomShip" immediate="true">
                          <param name="destination" value="$PrisonStation"/>
                          <param name="noattackresponse" value="true"/>
                          <param name="debugchance" value="0"/>
                        </create_order>
                      </actions>
                      <delay exact="2s"/>
                      <actions>
                        <set_value name="$ObjectiveStep" operation="add"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30252,6020}" updatebriefing="true" object="$PrisonStation" suggestdocking="false" comment="Wait for arrival at Woodworm Scrubs"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_ToPrison_PlayerLeft">
                      <conditions>
                        <check_any>
                          <check_all>
                            <event_object_changed_room object="player.entity"/>
                            <check_value value="player.ship.isclass.spacesuit"/>
                          </check_all>
                          <check_all>
                            <event_player_teleport_successful/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.flyto"  updatebriefing="true" object="$PrisonStation" comment="Fly to: Wormwood Scrubs (yourself)"/>
                        <do_if value="event.name == 'event_object_changed_room'">
                          <set_value name="$lines" exact="[[30252714],[30252716],[30252717]]" comment="left in spacesuit"/>
                        </do_if>
                        <do_else>
                          <set_value name="$lines" exact="[[30252715],[30252716],[30252717]]" comment="teleported away"/>
                        </do_else>
                      </actions>
                      <cues>
                        <cue name="Ch6_PlayerLeftDialogueTrigger">
                          <conditions>
                            <event_cue_completed cue="Ch6_ToPrison_PlayerLeft"/>
                          </conditions>
                          <cues>
                            <cue name="Ch6_PlayerLeavingAxiomShip_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$AxiomActor"/>
                              <param name="Lines"             value="[$lines]"/>
                              <param name="DelayInitial"      value="1s"/>
                              <param name="EndSignalCue"      value="null" />
                              <!--
                              -->
                            </cue>
                            <cue name="Ch6_ArrivedAtPrison" checkinterval="7s" comment="Ch6_Prison can only start if both Axiom AND player on prison-station (no guarantee who arrives first)">
                              <conditions>
                                <check_value value="($AxiomActor.hascontext.{$PrisonStation}) and (player.entity.hascontext.{$PrisonStation})"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch6_Prison"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch6_AxiomRequestsDocking">
                      <conditions>
                        <event_object_docking_started object="$AxiomShip"/>
                        <check_value value="player.ship == $AxiomShip"/>
                      </conditions>
                      <actions>
                        <speak actor="$AxiomActor" line="30252710" comment="Okay, this is it! Initiating docking."/>
                      </actions>
                    </cue>
                    <cue name="Ch6_ToPrison_Docked" comment="Axiom continues with the mission (even in case the player left)">
                      <conditions>
                        <event_object_docked_at container="$PrisonStation"/>
                        <check_value value="event.param == $AxiomShip"/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_AxiomArrived" onfail="cancel" comment="If the player is already there, continue with Ch6_Prison">
                          <conditions>
                            <check_value value="(player.entity.hascontext.{$PrisonStation}) or (player.ship == $AxiomShip)"/>
                          </conditions>
                          <actions>
                            <!-- Note: If the player is quicker than Axiom and already standing on the station this will still trigger (even if he left earlier) -->
                            <cancel_cue cue="Ch6_ToPrison_PlayerLeft"/>
                            <signal_cue cue="Ch6_Prison" check="false"/>
                          </actions>
                        </cue>
                        <cue name="Ch6_AxiomArrived_Speak" onfail="cancel" comment="intentionally as speak, player should be onboard and nearby (if he left he got alternative instructions and shouldn't hear this)">
                          <conditions>
                            <check_value value="player.ship == $AxiomShip"/>
                          </conditions>
                          <actions>
                            <speak actor="$AxiomActor">
                              <text line="30252711" comment="(1/3)You know what to do, right? I will spoof your credentials, so that you can gain entry into the prison complex again."/>
                              <text line="30252712" comment="(2/3)Then locate Lucca. I'll talk you through the rest."/>
                              <text line="30252713" comment="(3/3)Good luck!"/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_AxiomArrived_Walk">
                          <delay exact="6s"/>
                          <actions>
                            <!-- Axiom walks to near the airlock (where Stev will also go after unlocking the celldoor) -->
                            <find_npc_waypoint name="this.$PrisonCorridorWaitLocation" object="$PrisonCorridor" tags="tag.waitlocation" comment="alternative: tag.hidelocation" />
                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor, table[$requestercue = namespace, $location = this.$PrisonCorridorWaitLocation, $priority = 100, $debugchance = $DeepDebugChance] ]"/>
                          </actions>
                          <delay exact="30s" comment="leave enough time for Axiom to walk of the platform"/>
                          <actions>
                          </actions>
                        </cue>

                        <!-- Note: MoveDie won't work without a pilot, handle it manually - and avoid the player from getting killed in the process -->
                        <cue name="Ch6_AxiomArrived_CleanupShip" checkinterval="10s" comment="wait ">
                          <conditions>
                            <check_any>
                              <check_value value="($AxiomShip.sector != player.sector)"/>
                              <check_value value="($AxiomShip.sector == player.sector) and ($AxiomShip.distanceto.{player.entity} gt 750) and ($AxiomShip.distanceto.{$AxiomActor} gt 750)"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <request_store_ship object="$PrisonStation" ship="$AxiomShip"/>
                          </actions>
                          <cues>
                            <cue name="Ch6_Axiom_CleanupShip" checkinterval="10s" comment="wait for ship to arrive in internal storage">
                              <conditions>
                                <check_value value="$AxiomShip.dock.isstorage"/>
                              </conditions>
                              <delay exact="5s"/>
                              <actions>
                                <destroy_object object="$AxiomShip"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Prison">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.explore" text="{30252,6011}" object="$PrisonRoom" updatebriefing="true" comment="Prison Level 1. Note: Guidance to $#PrisonModule doesn't work, see TOA-193"/>
              </actions>
              <cues>
                <cue name="Ch6_Setup_OpenFloor2" comment="wait until the player enters the prisoncorridor (guarantees player is nearby, otherwise trigger_animation is ignored)">
                  <conditions>
                    <event_object_changed_room object="player.entity" room="$PrisonCorridor" comment="prison_escape_v2_macro"/>
                    <check_value value="$Ch6Forced?"/>
                  </conditions>
                  <actions>
                    <trigger_animation object="$PrisonCorridor" group="tag.upperlock" trigger="activate" comment="this should not be necessary"/>
                    <trigger_animation object="$PrisonCorridor" group="tag.upperlock" trigger="deactivate" comment="open large airlock to the next set of riddles - already happened in Ch4"/>
                  </actions>
                </cue>

                <cue name="Ch6_StoryPrisoner" version="2" comment="Stev is escorted away (and despawned) in Ch4 where you last met - put him in the cell now">
                  <delay exact="0.1s" comment="help Ch6_FoundStev_Check notice cue_completed"/>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $StevLuccaActor, md.Story_Criminal.Start]"/>
                    <set_entity_traits entity="$StevLuccaActor" hidden="false" comment="Lucca is hidden (probably when he was a passenger earlier on in ch4), unhide"/>
                    <set_entity_overrides entity="$StevLuccaActor" icon="'shadyguy'" title="'{30252,158}'"/>
                    <find_npc_slot name="$NPCSlot" object="$PrisonRoom" tags="tag.prisoner" multiple="true" excludefilled="false" />
                    <do_all exact="$NPCSlot.count" counter="$i">
                      <do_if value="$NPCSlot.{$i}.group == tag.door_03" comment="cell on the right">
                        <add_actor_to_room result="$Prisoner1result" actor="$StevLuccaActor" slot="$NPCSlot.{$i}"/>
                        <debug_text text="'adding stevlucca to %s: %s'.[$NPCSlot.{$i}, $Prisoner1result]" chance="$DebugChance"/>
                        <do_if value="$Prisoner1result == false">
                          <debug_text text="'Adding actor failed?!'" chance="$DebugChance"/>
                        </do_if>
                      </do_if>
                    </do_all>
                  </actions>
                  <patch sinceversion="2">
                    <do_if value="(Ch6_StoryPrisoner.state == cuestate.complete)
                              and (Ch6_FoundStev.state == cuestate.waiting)
                              and ($StevLuccaActor.room != $PrisonRoom)">
                      <set_value name="$Ch6_StoryPrisoner_PatchV2_BugCase"/>
                      <!-- Lucca was placed, but is not in Prison and did not escape as intended through the player finding him -->
                      <!-- add_actor_to_room works, but if players leave the sector, an earlier disconnect placement request kicks in again -->
                      <do_if value="md.NPC_Instantiation.NPC_Placement_Manager.$RequestTable.{$StevLuccaActor}?">
                        <!--there is an active request for StevLucca-->
                        <set_value name="$Ch6_StoryPrisoner_PatchV2_RequestFound"/>
                      </do_if>
                      <reset_cue cue="this"/>
                    </do_if>
                  </patch>
                </cue>

                <cue name="Ch6_Setup_RemoveLeaks" comment="remove voice-leaks, during the spacesuit parts they repeat every few seconds endlessly and it becomes annoying very quickly ">
                  <actions>
                    <find_object_component name="$Leaks" object="$PrisonStation" signalleaktype="signalleaktype.voice" multiple="true"/>
                    <do_for_each name="$leak" in="$Leaks">
                      <destroy_object object="$leak" explosion="false"/>
                    </do_for_each>
                  </actions>
                </cue>

                <cue name="Ch6_SetupHangar" version="2">
                  <actions>
                    <find_object_component name="$PrisonMarker_01" groupname="$PrisonMarkerGroup" object="$PrisonModule" macro="macro.positiondummy1_macro"  required="true" comment="hangar spawn"/>
                    <create_ship name="$EscapeShip" macro="ship_tel_s_trans_container_02_a_macro" sector="$EighteenBillionSector" commandeerable="false" capturable="false">
                      <owner exact="faction.civilian"/>
                      <loadout ref="story_raven_hangar"/>
                      <equipmentmods>
                        <ship ware="ware.mod_ship_hidecargo_01"/>
                      </equipmentmods>
                      <!-- Ministry Camo 1 -->
                      <paint ware="ware.paintmod_0045"/>
                      <position object="$PrisonMarker_01"/>
                      <rotation yaw="180deg"/>
                    </create_ship>
                    <create_order object="$EscapeShip" id="'Wait'">
                      <param name="noattackresponse" value="true"/>
                    </create_order>
                    <set_object_name object="$EscapeShip" page="20101" line="22504" comment="Raven Prototype readtext.{20101}.{22504}"/>
                    <run_actions ref="md.LIB_Generic.RequestObjectInvincibility" comment="protected until player gets the ship">
                      <param name="Object" value="$EscapeShip"/>
                      <param name="RequesterCue" value="namespace"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>
                    <set_object_docking_enabled object="$EscapeShip" enabled="true"/>
                    <create_position name="$PrisonMarker01SectorPos" object="$PrisonMarker_01" space="$PrisonMarker_01.sector"/>
                    <create_position name="$EscapeShipSectorPos" object="$EscapeShip" space="$PrisonMarker_01.sector"/>
                    <!--set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.steal" text="{30252,6015}" object="$EscapeShip" updatebriefing="true" /-->
                  </actions>
                  <patch sinceversion="2" state="complete">
                    <do_if value="$EscapeShip.name == readtext.{20101}.{22501}" comment="Didn't rename from Raven">
                      <set_object_name object="$EscapeShip" page="20101" line="22504" comment="Raven Prototype readtext.{20101}.{22504}"/>
                    </do_if>
                  </patch>
                  <patch sinceversion="2" state="cancelled">
                    <do_if value="$EscapeShip.name == readtext.{20101}.{22501}" comment="Didn't rename from Raven">
                      <set_object_name object="$EscapeShip" page="20101" line="22504" comment="Raven Prototype readtext.{20101}.{22504}"/>
                    </do_if>
                  </patch>
                </cue>

                <cue name="Ch6_HandleOtherPrisoner">
                  <actions>
                    <!-- Ch6 cues are taking over from this point -->
                    <set_value name="md.Setup_DLC_Pirate.X4ep1_Prelude_Setup.$OtherPrisonerActive" exact="false"/>
                    <set_value name="$OtherPrisoner" exact="md.Setup_DLC_Pirate.X4ep1_Prelude_Setup.$OtherPrisoner"/>
                    <set_value name="$OtherPrisonerSpeak" exact="0"/>
                    <set_value name="$OtherPrisonerConversation" exact="0"/>
                  </actions>
                  <cues>

                    <cue name="Ch6_Prisoner_Approach" checkinterval="2s">
                      <conditions>
                        <check_value value="player.room == $OtherPrisoner.room"/>
                      </conditions>
                      <actions>
                        <do_if value="player.module == 'x4ep1_gamestart_pirate2'" comment="Player and Teladi Prisoner have met previously">
                          <speak actor="$OtherPrisoner" priority="90">
                            <text line="30288610" comment="hey you, I recognise you"/>
                            <text line="30288611" comment="you came back, get me out" delay="0.5s"/>
                          </speak>
                        </do_if>
                        <do_else>
                          <speak actor="$OtherPrisoner" priority="90">
                            <text line="30288601" comment="hey you"/>
                            <text line="30288602" comment="get me out" delay="0.5s"/>
                          </speak>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch6_Prisoner_Conversation_Started" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$OtherPrisoner"/>
                      </conditions>
                      <actions>
                        <do_if value="not $OtherPrisonerConversation">
                          <add_npc_line speaker="$OtherPrisoner" line="30288603"/>
                          <set_value name="$OtherPrisonerConversation" operation="add"/>
                        </do_if>
                        <do_elseif value="$OtherPrisonerConversation == 1">
                          <add_npc_line speaker="$OtherPrisoner" line="30288604"/>
                          <set_value name="$OtherPrisonerConversation" operation="add"/>
                        </do_elseif>
                        <do_elseif value="$OtherPrisonerConversation ge 2">
                          <add_npc_line speaker="$OtherPrisoner" line="30288605"/>
                        </do_elseif>
                      </actions>
                    </cue>

                    <cue name="Ch6_Prisoner_Complaining" checkinterval="6s">
                      <conditions>
                        <check_value value="player.room == $OtherPrisoner.room"/>
                        <check_value value="not player.isinconversation"/>
                      </conditions>
                      <actions>
                        <speak actor="$OtherPrisoner" line="30288630 + ($OtherPrisonerSpeak % 3)" priority="90"/>
                        <set_value name="$OtherPrisonerSpeak" operation="add"/>
                      </actions>
                      <delay exact="[10s,14s,18s].random"/>
                      <actions>
                        <reset_cue cue="Ch6_Prisoner_Complaining"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Teladi_Prisoner_Axiom_Comment" comment="Play only after the first conversation with the Teladi Prisoner.">
                      <conditions>
                        <event_conversation_finished actor="$OtherPrisoner"/>
                        <check_value value="not $OtherPrisonerFreed?" comment="Anticipating that this value is going to be set once freeing the Teladi Prisoner becomes an option."/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Axiom_TeladiPrisoner_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="Lines"             value="[[30252622]]"/>
                          <param name="EndSignalCue"      value="null" />
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <!-- TODO @Roger: Add option to free Teladi Prisoner. Axiom and Teladi Prisoner Dialog exists but is unused. -->
                <cue name="Ch6_Teladi_Prisoner_Freed">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="false"/>
                  </conditions>
                  <actions>
                    <!-- Listen for cell door opening and set $OtherPrisonerFreed, so that Ch6_Teladi_Prisoner_Axiom_Comment doesn't trigger. -->
                    <speak actor="$OtherPrisoner" line="30288620" comment="(1/2)thanks for letting me out"/>
                    <speak actor="$OtherPrisoner" line="30288621" comment="(2/2)I won't forget this"/>
                    <speak actor="$AxiomActor" line="30252623" comment="I saw you let him out"/>
                  </actions>
                </cue>

                <cue name="Ch6_PrisonFan_Control">
                  <actions>
                    <play_sound sound="'alarm(929)'" object="player.entity" chance="if $PlayerInTower? then 100 else 0"/>
                  </actions>
                  <delay exact="3s"/>
                  <actions>
                    <play_sound sound="'alarm(929)'" object="player.entity" chance="if $PlayerInTower? then 100 else 0"/>
                  </actions>
                  <delay exact="3s"/>
                  <actions>
                    <play_sound sound="'alarm(929)'" object="player.entity" chance="if $PlayerInTower? then 100 else 0"/>
                  </actions>
                  <delay exact="1.5s"/>
                  <actions>
                    <play_sound sound="'alarm(929)'" object="player.entity" chance="if $PlayerInTower? then 100 else 0"/>
                  </actions>
                  <delay exact="1.5s"/>
                  <actions>
                    <play_sound sound="'alarm(929)'" object="player.entity" chance="if $PlayerInTower? then 100 else 0"/>
                  </actions>
                  <delay exact="1.5s"/>
                  <actions>
                    <play_sound sound="'alarm(929)'" object="player.entity" chance="if $PlayerInTower? then 100 else 0"/>
                    <play_sound sound="'interior_lift_on_volume'" object="player.entity" chance="if $PlayerInTower? then 100 else 0"/>

                    <find_object_component name="$TheFan2" object="$PrisonModule" macro="macro.landmarks_tel_spacesuit_vertical_top_01_macro" required="true"/>

                    <debug_text text="'Fan on'" chance="$DebugChance"/>
                    <set_object_active object="$PrisonEmitter" activate="true" comment="push effect"/>
                    <trigger_animation object="$TheFan2" trigger="activate"/>
                  </actions>
                  <delay exact="20s"/>
                  <actions>
                    <debug_text text="'Fan Off'" chance="$DebugChance"/>
                    <play_sound sound="'interior_lift_off_volume'" object="player.entity" chance="if $PlayerInTower? then 100 else 0"/>
                    <set_object_active object="$PrisonEmitter" activate="false" comment="No push effect"/>
                    <trigger_animation object="$TheFan2" trigger="deactivate"/>
                  </actions>
                  <delay exact="80s"/>
                  <actions>
                    <do_if value="Ch6_Riddle_Solved.state != cuestate.complete" comment="fan stops when riddle complete">
                      <reset_cue cue="this"/>
                    </do_if>
                  </actions>
                </cue>
                <cue name="Ch6_PrisonFan_OFF">
                  <conditions>
                    <check_any>
                      <event_cue_signalled comment="for easier debugging"/>
                      <event_cue_completed cue="Ch6_Riddle_Solved"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <play_sound sound="'interior_lift_off_volume'" object="player.entity" chance="if $PlayerInTower? then 100 else 0"/>

                    <cancel_cue cue="Ch6_PrisonFan_Control"/>
                    <debug_text text="'Fan Off Permanently'" chance="$DebugChance"/>
                    <set_object_active object="$PrisonEmitter" activate="false" comment="No push effect"/>
                    <trigger_animation object="$TheFan2" trigger="deactivate"/>
                  </actions>
                </cue>

                <cue name="Ch6_PrisonEntrance_Nearby" checkinterval="1s">
                  <conditions>
                    <check_value value="(player.sector == $PrisonStation.sector) and (player.entity.distanceto.{$PrisonMarker_08} lt 5m)"/>
                  </conditions>
                  <actions>
                    <do_if value="player.module == 'x4ep1_gamestart_pirate2'" comment="Player and Axiom started in a cell">
                      <signal_cue_instantly cue="Axiom_Comments" param="[[30252602], [30252610]]" comment="back to where it started / According to our intel, Lucca should be somewhere on this floor."/>
                    </do_if>
                    <do_else comment="all other gamestarts">
                      <signal_cue_instantly cue="Axiom_Comments" param="[[30252610]]" comment="According to our intel, Lucca should be somewhere on this floor."/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch6_LowerAirlock_Nearby" checkinterval="2s">
                  <conditions>
                    <check_value value="@player.controlled.isclass.spacesuit" comment="only when in spacesuit"/>
                    <check_value value="(player.sector == $PrisonStation.sector) and (player.entity.distanceto.{$PrisonMarker_02} lt 10m)"/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="Axiom_Comments" param="[[30252601]]" comment="different exit this time"/>
                  </actions>
                </cue>

                <cue name="Ch6_FoundStev_Check" comment="part of a patch which can spawn Lucca in the cell while the player is looking at it">
                  <conditions>
                    <event_cue_completed cue="Ch6_StoryPrisoner"/>
                    <check_value value="$StevLuccaActor.room"/>
                    <check_value value="$StevLuccaActor.room == $PrisonRoom"/>
                    <check_value value="$StevLuccaActor.room == player.room"/>
                    <cue_is_waiting cue="Ch6_FoundStev"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch6_FoundStev"/>
                  </actions>
                </cue>
                <cue name="Ch6_FoundStev">
                  <conditions>
                    <check_any>
                      <event_object_changed_room object="player.entity" room="$StevLuccaActor.room" comment="$PrisonRoom"/>
                      <event_cue_signalled/>
                    </check_any>
                    <check_value value="$StevLuccaActor.room == $PrisonRoom"/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_Axiom_CheckingConsole_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$AxiomActor"/>
                      <param name="Lines"             value="[[30252611], [30252612,0.5s]]"/>
                      <param name="EndSignalCue"      value="Ch6_FoundStev_Update_Objective" />
                    </cue>
                    <cue name="Ch6_FoundStev_Update_Objective">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep" operation="add"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" text="$StevLuccaActor.knownname" object="$StevLuccaActor" updatebriefing="true"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Axiom_PrisonStation_Conversation_Started" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$AxiomActor"/>
                      <!--event_conversation_next_section actor="$AxiomActor" section="stev_main"/-->
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="not $StevEscaped?">
                      <add_npc_line speaker="$AxiomActor" hidechoices="true">
                        <text line="30252610" comment="(2/3)According to our intel, Lucca should be somewhere on this floor."/>
                        <text line="30252713" comment="(3/3)Good luck!"/>
                      </add_npc_line>
                    </do_if>
                    <do_elseif value="not $Ch6RiddleSolved?">
                      <add_npc_line speaker="$AxiomActor" hidechoices="true">
                        <text line="30252621" comment="(2/2)Head for the 2nd level. The Ministry seems to have installed more switches that'll require some adjustment, but I know you love a good puzzle."/>
                      </add_npc_line>
                    </do_elseif>
                    <do_else>
                      <add_npc_line speaker="$AxiomActor" hidechoices="true">
                        <text line="30252660" comment="Access to level 3 established."/>
                      </add_npc_line>
                    </do_else>
                  </actions>
                </cue>

                <library name="Ch6_Stev_PrisonStation__Conversation_DefaultChoices">
                  <actions>
                    <do_if value="not $StevEscaped?">
                      <!-- Stev in Cell -->
                      <do_if value="not $StevCalmed?">
                        <add_player_choice text="{30252,6041}" section="stev_main" choiceparam="'choice_story1'" />
                      </do_if>
                      <do_else>
                        <add_player_choice text="{30252,6042}" section="stev_main" choiceparam="'choice_story2'" />
                        <add_player_choice text="{30252,6043}" section="stev_main" choiceparam="'leave'" position="bottom_right" highlighted="true"/>
                      </do_else>
                    </do_if>
                    <do_elseif value="$StevHiding? and $StevHiding">
                      <!-- Stev walkin towards airlock / waiting near airlock  -->
                      <add_player_choice text="{30252,6044}" section="stev_main" choiceparam="'choice_story3'" />
                      <add_player_choice text="{30252,6045}" section="stev_main" choiceparam="'leave'" position="bottom_right" highlighted="true"/>
                    </do_elseif>
                  </actions>
                </library>

                <cue name="Ch6_Stev_PrisonStation_Conversation_Started" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$StevLuccaActor"/>
                      <event_conversation_next_section actor="$StevLuccaActor" section="stev_main"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="'p=%s p2=%s'.[event.param, event.param2]" chance="0"/>

                    <do_if value="event.param == 'stev_main' or event.param == 'default'">

                      <do_if value="$StevEscaped?">
                        <do_if value="event.name=='event_conversation_started'" comment="only on starting conversation, not for every selected dialog option">
                          <add_npc_line speaker="$StevLuccaActor" line="30252610" hidechoices="true" comment="Creature reveal Split hiding spot! Creature nothing better to do?"/>
                        </do_if>
                      </do_if>
                      <do_elseif value="not $StevGreeted?">
                        <set_value name="$StevGreeted"/>
                        <add_npc_line speaker="$StevLuccaActor" line="30252601" hidechoices="true" comment="worst taxi driver ever"/>
                        <add_npc_line speaker="$StevLuccaActor" line="30252602" hidechoices="true" comment="I'll kill you when I get out"/>
                      </do_elseif>

                      <do_if value="event.param2 == 'leave'">
                        <do_if value="not $StevEscaped?">
                          <add_npc_line speaker="$StevLuccaActor" line="30252608" hidechoices="true" comment="get me out"/>
                        </do_if>
                        <do_else>
                          <add_npc_line speaker="$StevLuccaActor" line="30252611" hidechoices="true" comment="shoo"/>
                        </do_else>
                      </do_if>
                      <do_else>
                        <do_if value="event.param2 == 'choice_story1'">
                          <set_value name="$StevCalmed"/>
                          <add_npc_line speaker="$StevLuccaActor" line="30252603" hidechoices="true"/>
                          <add_npc_line speaker="$StevLuccaActor" line="30252604" hidechoices="true"/>
                        </do_if>
                        <do_elseif value="event.param2 == 'choice_story2'">
                          <add_npc_line speaker="$StevLuccaActor" line="30252605" hidechoices="true"/>
                          <add_npc_line speaker="$StevLuccaActor" line="30252606" hidechoices="true"/>
                          <add_npc_line speaker="$StevLuccaActor" line="30252607" hidechoices="true"/>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'choice_story3'">
                          <add_npc_line speaker="$StevLuccaActor" line="30252612" hidechoices="true"/>
                          <add_npc_line speaker="$StevLuccaActor" line="30252613" hidechoices="true"/>
                        </do_elseif>
                        <include_actions ref="Ch6_Stev_PrisonStation__Conversation_DefaultChoices"/>
                      </do_else>
                    </do_if>
                    <do_elseif value="event.name == 'event_conversation_returned_to_section'">
                      <debug_text text="'return2section'" chance="0"/>
                      <include_actions ref="Ch6_Stev_PrisonStation__Conversation_DefaultChoices"/>
                    </do_elseif>
                    <do_else>
                      <debug_text text="'fallthrough 3'" chance="0"/>
                    </do_else>
                  </actions>
                  <cues>
                    <cue name="Ch6_Stev_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$StevLuccaActor"/>
                      </conditions>
                      <actions>
                        <debug_text text="'ConvFinished event=%s e.p=%s e.p2=%s '.[event.name, event.param, event.param2]" chance="0"/>
                        <do_if value="event.param2 == 'leave'">
                          <!--signal_cue cue="Ch6_Axiom_HackingConsole"/-->
                        </do_if>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Axiom_HackingConsole">
                  <conditions>
                    <event_conversation_finished actor="$StevLuccaActor" outcomeparam="'leave'"/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_Axiom_HackingConsole_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$AxiomActor"/>
                      <param name="DelayInitial"      value="2s"/>
                      <param name="Lines"             value="[[30252613], [30252614]]"/>
                      <param name="EndSignalCue"      value="Ch6_Axiom_HackingConsole_HackDone" />
                    </cue>

                    <cue name="Ch6_Axiom_HackingConsole_HackDone">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$AxiomHackedConsole" exact="true"/>
                        <set_triggers_locked object="$PrisonRoom" group="tag.door_03" locked="false" comment="right cell / door button"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <do_if value="Ch6_Player_OpenedCell3.state == cuestate.waiting">
                          <set_value name="$ObjectiveStep" operation="add"/>
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30252,6051}" updatebriefing="true" comment="use console"/>
                        </do_if>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Player_OpenedCell3">
                  <conditions>
                    <event_player_activated_platform_trigger component="$PrisonRoom" group="tag.door_03" />
                  </conditions>
                  <actions>
                    <set_value name="$AxiomHackedConsole_LockedAgain"/>
                    <set_triggers_locked object="$PrisonRoom" group="tag.door_03" locked="true" comment="right cell / door button"/>

                    <set_value name="$StevEscaped" exact="true"/>
                    <set_value name="$ObjectiveStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.wait" updatebriefing="true"/>
                    <set_entity_overrides entity="$StevLuccaActor" icon="'shadyguy'" title="'{30252,154}'"/>

                  </actions>
                  <delay exact="2s"/>
                  <actions>
                    <speak actor="$StevLuccaActor">
                      <text line="30252609" comment="about time, will find hiding spot"/>
                    </speak>
                  </actions>
                  <delay exact="1s"/>
                  <actions>
                    <find_npc_waypoint name="$PrisonCorridorWaypoints" object="$PrisonCorridor" multiple="true" tags="tag.hidelocation"/>
                    <do_if value="$PrisonCorridorWaypoints.count">
                      <set_value name="$StevHiding" exact="true"/>
                      <set_value name="$MovementTable" exact="table[$slot = $PrisonCorridorWaypoints.random]"/>
                      <signal_objects object="$StevLuccaActor" param="'npc_move_to'" param2="$MovementTable.clone"/>
                      <!--signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', event.param, table[$requestercue = namespace, $location = this.$DespawnWaypoints.random, $priority = 100, $debugchance = $DeepDebugChance] ]"/-->
                    </do_if>
                    <do_else>
                      <debug_text text="'No waypoints found?!'" chance="$DebugChance"/>
                    </do_else>
                  </actions>
                  <delay exact="8s"/>
                  <actions>
                    <signal_cue cue="Ch6_Floor2"/>
                  </actions>
                </cue>

                <cue name="Ch6_Floor2_Premature" checkinterval="4s">
                  <conditions>
                    <check_value value="(player.sector == $PrisonStation.sector) and ($PrisonMarker_23.exists) and (player.entity.distanceto.{$PrisonMarker_23} lt 10m)"/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="Axiom_Comments" param="[[30252627]]" comment="Floor 2 locked, first free Stev"/>
                  </actions>
                </cue>

                <cue name="Ch6_Floor2" version="4">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch6_Floor2_Premature" comment="Axiom hacked controls, player can gain access to floor 2 now"/>
                    <!-- find the two buttons to control the airlocks 2A/2B-->
                    <find_object_component name="$PrisonSwitch2A" groupname="$PrisonSwitchesAirlock" object="$PrisonModule" macro="macro.props_special_doorclamp_01_macro" grouptag="tag.airlockcontrol1" required="true"/>
                    <find_object_component name="$PrisonSwitch2B" groupname="$PrisonSwitchesAirlock" object="$PrisonModule" macro="macro.props_special_doorclamp_01_macro" grouptag="tag.airlockcontrol2" required="true"/>
                    <!-- Allow player to access access floor 2 -->
                    <set_object_min_hull object="$PrisonSwitch2A" exact="0"/>
                    <set_object_min_hull object="$PrisonSwitch2B" exact="0"/>

                    <!-- Alcove switches -->
                    <find_object_component groupname="$PrisonAlcoveSwitch" object="$PrisonModule" macro="macro.props_special_doorclamp_01_macro" grouptag="tag.alcove_1" multiple="true" required="true" />
                    <find_object_component groupname="$PrisonAlcoveSwitch" object="$PrisonModule" macro="macro.props_special_doorclamp_01_macro" grouptag="tag.alcove_2" multiple="true" required="true" append="true" />
                    <do_for_each name="$AlcoveSwitch" in="$PrisonAlcoveSwitch">
                      <set_relation_boost object="$AlcoveSwitch" faction="faction.player" value="1.0" decay="0"/>
                    </do_for_each>
                    <add_to_group groupname="$PrisonStation.engineer.$ExcludedRepairElements" group="$PrisonAlcoveSwitch" comment="avoid station engineer from repairing it"/>
                    <add_to_group groupname="$PrisonStation.engineer.$ExcludedRepairElements" group="$PrisonSwitchesAirlock" comment="avoid station engineer from repairing it"/>

                    <!-- Update TotalSwitchHP to include riddle Switches -->
                    <set_value name="$TotalSwitchHP" exact="0"/>
                    <do_for_each in="$PrisonAlcoveSwitch" name="this.$switch">
                      <set_value name="$TotalSwitchHP" exact="this.$switch.hullpercentage" operation="add"/>
                    </do_for_each>
                    <do_for_each in="$PrisonSwitchesAirlock" name="this.$switch">
                      <set_value name="$TotalSwitchHP" exact="this.$switch.hullpercentage" operation="add"/>
                    </do_for_each>
                    <set_value name="$TotalSwitchHP_Old" exact="$TotalSwitchHP" comment="update hp tracker"/>

                    <!--signal_cue cue="Ch6_SwitchRiddle"/-->
                    <set_value name="$PrisonLevel2Switches" exact="0"/>
                  </actions>
                  <patch sinceversion="2">
                    <set_value name="$PrisonLevel2Switches" exact="0"/>
                    <do_if value="Ch6_SpacesuitAirlock2A.state == cuestate.complete">
                      <set_value name="$PrisonLevel2Switches" exact="1" operation="add"/>
                    </do_if>
                    <do_if value="Ch6_SpacesuitAirlock2B.state == cuestate.complete">
                      <set_value name="$PrisonLevel2Switches" exact="1" operation="add"/>
                    </do_if>

                    <!-- next objective if we're not yet past that -->
                    <do_if value="Ch6_SwitchRiddle.state == cuestate.waiting">
                      <signal_cue_instantly cue="Ch6_Open_Level2_Objective"/>
                    </do_if>
                  </patch>
                  <patch sinceversion="3">
                    <add_to_group groupname="$PrisonStation.engineer.$ExcludedRepairElements" group="$PrisonSwitchesAirlock" comment="avoid station engineer from repairing it"/>
                  </patch>
                  <patch sinceversion="4">
                    <do_if value="Ch6_SwitchRiddle.state == cuestate.waiting">
                      <!-- Update TotalSwitchHP to include riddle Switches -->
                      <set_value name="$TotalSwitchHP" exact="0"/>
                      <do_for_each in="$PrisonAlcoveSwitch" name="this.$switch">
                        <set_value name="$TotalSwitchHP" exact="this.$switch.hullpercentage" operation="add"/>
                      </do_for_each>
                      <do_for_each in="$PrisonSwitchesAirlock" name="this.$switch">
                        <set_value name="$TotalSwitchHP" exact="this.$switch.hullpercentage" operation="add"/>
                      </do_for_each>
                      <set_value name="$TotalSwitchHP_Old" exact="$TotalSwitchHP" comment="update hp tracker"/>
                    </do_if>
                  </patch>
                  <cues>

                    <cue name="Ch6_Floor2_Axiom_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$AxiomActor"/>
                      <param name="Lines"             value="[[30252620], [30252621] ]"/>
                      <param name="EndSignalCue"      value="Ch6_Floor2_Axiom_Objective"/>
                      <!-- Found escape route via hangar, head for 2nd floor -->
                    </cue>

                    <cue name="Ch6_Floor2_Axiom_Objective">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{1004,93}" text="{30252,6012}" updatebriefing="true" comment="find way to: floor 2"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Floor2_Airlock_Hint" checkinterval="4s">
                      <conditions>
                        <check_value value="($PlayerInTower?) and ($PrisonMarker_23.exists) and (player.entity.distanceto.{$PrisonMarker_23} lt 12m)"/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="Lines"             value="[[30252628] ]"/>
                          <param name="EndSignalCue"      value="Ch6_Open_Level2_Objective"/>
                          <!-- The airlocks are shut, you'll need to find a way to bypass their locks -->
                        </run_actions>
                      </actions>
                    </cue>

                    <cue name="Ch6_Continue_Objective">
                      <!-- Explore Prison Level 2 -->
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$PrisonLevel2Switches ge 2"/>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.explore" text="{30252,6012}" updatebriefing="true" comment="explore floor 2"/>
                        <!--  x -->
                      </actions>
                    </cue>

                    <cue name="Ch6_Open_Level2_Objective" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <cue_is_waiting cue="Ch6_Continue_Objective"/>
                      </conditions>
                      <actions>
                        <!-- Unlock airlocks to Prison Level 2 -->
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30252,6053}"  updatebriefing="true" silent="true" >
                          <progress text="{30252,6054}" progress="$PrisonLevel2Switches" max="2"/>
                        </set_objective>
                      </actions>
                    </cue>

                    <cue name="Ch6_EnteredSpacesuit">
                      <conditions>
                        <event_object_changed_room object="player.entity" previous="$PrisonCorridor"/>
                        <check_value value="player.ship.isclass.spacesuit"/>
                      </conditions>
                      <delay exact="3s"/>
                      <actions>
                        <signal_cue_instantly cue="Axiom_Comments" param="[[30252624],[30252625],[30252626]]" comment="get access to floor 2, exhaust-fan explanation"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_SpacesuitAirlock2A">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$PrisonSwitch2A"/>
                          <event_object_hull_below_function_threshold object="$PrisonSwitch2A"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <set_value name="$PrisonLevel2Switches" exact="1" operation="add"/>
                        <signal_cue_instantly cue="Ch6_Open_Level2_Objective"/>
                        <set_triggers_locked object="$PrisonCorridor" group="tag.airlock_06" locked="false" comment="Spacesuit/Airlock 2A"/>
                        <signal_cue cue="md.Setup_DLC_Pirate.Setup_AirlockLights_Update" comment="update airlock green/orange lights"/>
                        <signal_cue cue="Ch6_SwitchRiddle" check="false"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_SpacesuitAirlock2A_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="Lines"             value="if Ch6_SpacesuitAirlock2B.state == cuestate.complete then [[30252604, 1s, Ch6_Continue_Objective]] else [[30252603]]"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_SpacesuitAirlock2B">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$PrisonSwitch2B"/>
                          <event_object_hull_below_function_threshold object="$PrisonSwitch2B"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <set_value name="$PrisonLevel2Switches" exact="1" operation="add"/>
                        <signal_cue_instantly cue="Ch6_Open_Level2_Objective"/>
                        <set_triggers_locked object="$PrisonCorridor" group="tag.airlock_02" locked="false" comment="Spacesuit/Airlock 2B"/>
                        <signal_cue cue="md.Setup_DLC_Pirate.Setup_AirlockLights_Update" comment="update airlock green/orange lights"/>
                        <signal_cue cue="Ch6_SwitchRiddle" check="false"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_SpacesuitAirlock2B_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="Lines"             value="if Ch6_SpacesuitAirlock2A.state == cuestate.complete then [[30252604, 1s, Ch6_Continue_Objective]] else [[30252603]]"/>
                          <param name="EndSignalCue"      value="null"/>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_SwitchHP_Tracker" instantiate="true" checkinterval="1.6s">
                  <actions>
                    <!-- initialise tracking -->
                    <do_if value="not $TotalSwitchHP?">
                      <set_value name="$TotalSwitchHP" exact="0"/>
                    </do_if>

                    <!-- count all switches current HP -->
                    <set_value name="$TotalSwitchHP" exact="0"/>
                    <do_if value="$PrisonAlcoveSwitch?">
                      <do_for_each in="$PrisonAlcoveSwitch" name="this.$switch">
                        <set_value name="$TotalSwitchHP" exact="this.$switch.hullpercentage" operation="add"/>
                      </do_for_each>
                    </do_if>
                    <do_if value="$PrisonSwitchesAirlock?">
                      <do_for_each in="$PrisonSwitchesAirlock" name="this.$switch">
                        <set_value name="$TotalSwitchHP" exact="this.$switch.hullpercentage" operation="add"/>
                      </do_for_each>
                    </do_if>

                    <!-- Add riddle switches to the mix -->
                    <do_if value="Ch6_SwitchRiddle.state == cuestate.complete">
                      <do_for_each in="$PrisonSwitches" name="this.$switch">
                        <set_value name="$TotalSwitchHP" exact="this.$switch.hullpercentage" operation="add"/>
                      </do_for_each>
                    </do_if>

                    <!-- initialise compare value -->
                    <do_if value="not $TotalSwitchHP_Old?">
                      <set_value name="$TotalSwitchHP_Old" exact="$TotalSwitchHP"/>
                    </do_if>
                    <debug_text text="$TotalSwitchHP + ' / ' + $TotalSwitchHP_Old" chance="0" comment="very spamming"/>
                  </actions>
                </cue>
                <cue name="Ch6_Hint_Axiom_WeakLaser" instantiate="false">
                  <conditions>
                    <event_player_attacked_object/>
                    <check_value value="macro.spacesuit_gen_laser_01_macro == event.param3.{2}.macro"/>
                    <check_value value="event.param == $PrisonStation" comment="attacked object is the station, not the switches"/>
                    <check_value value="$TotalSwitchHP lt $TotalSwitchHP_Old"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                      <param name="Actor" value="$AxiomActor"/>
                      <param name="Lines" value="[[30288169]]"/>
                      <!--<t id="30288169">Your new laser is low powered, but if you keep it aimed at the lock, it will break eventually.</t>-->
                      <param name="EndSignalCue" value="Ch6_Hint_Axiom_WeakLaser_Reset"/>
                    </run_actions>
                  </actions>
                </cue>
                <cue name="Ch6_Hint_Axiom_WeakLaser_Reset">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="300s"/>
                  <actions>
                    <set_value name="$TotalSwitchHP_Old" exact="$TotalSwitchHP"/>
                    <reset_cue cue="Ch6_Hint_Axiom_WeakLaser"/>
                    <reset_cue cue="this"/>
                  </actions>
                </cue>

                <cue name="Ch6_SwitchRiddle" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$SwitchHullMin" exact="0.1"/>
                    <set_value name="$SwitchHullMax" exact="100" comment="percentage, absolute is 10"/>

                    <!-- find the riddleswitches -->
                    <find_object_component name="$PrisonSwitch1" groupname="$PrisonSwitches" object="$PrisonModule" macro="macro.props_special_doorclamp_01_macro" grouptag="tag.riddleswitch_1" required="true"/>
                    <find_object_component name="$PrisonSwitch2" groupname="$PrisonSwitches" object="$PrisonModule" macro="macro.props_special_doorclamp_01_macro" grouptag="tag.riddleswitch_2" required="true"/>
                    <find_object_component name="$PrisonSwitch3" groupname="$PrisonSwitches" object="$PrisonModule" macro="macro.props_special_doorclamp_01_macro" grouptag="tag.riddleswitch_3" required="true"/>
                    <find_object_component name="$PrisonSwitch4" groupname="$PrisonSwitches" object="$PrisonModule" macro="macro.props_special_doorclamp_01_macro" grouptag="tag.riddleswitch_4" required="true"/>
                    <find_object_component name="$PrisonSwitch5" groupname="$PrisonSwitches" object="$PrisonModule" macro="macro.props_special_doorclamp_01_macro" grouptag="tag.riddleswitch_5" required="true"/>
                    <add_to_group groupname="$PrisonStation.engineer.$ExcludedRepairElements" group="$PrisonSwitches" comment="avoid station engineer from repairing it"/>

                    <!-- Update TotalSwitchHP to include riddle Switches -->
                    <set_value name="$TotalSwitchHP" exact="0"/>
                    <do_for_each in="$PrisonAlcoveSwitch" name="this.$switch">
                      <set_value name="$TotalSwitchHP" exact="this.$switch.hullpercentage" operation="add"/>
                    </do_for_each>
                    <do_for_each in="$PrisonSwitchesAirlock" name="this.$switch">
                      <set_value name="$TotalSwitchHP" exact="this.$switch.hullpercentage" operation="add"/>
                    </do_for_each>
                    <do_for_each name="this.$switch" in="$PrisonSwitches">
                      <set_object_min_hull object="this.$switch" exact="1" comment="don't allow destruction of riddle-switches"/>
                      <set_value name="$TotalSwitchHP" exact="this.$switch.hullpercentage" operation="add" comment="update hp tracker"/>
                    </do_for_each>
                    <set_value name="$TotalSwitchHP_Old" exact="$TotalSwitchHP" comment="update hp tracker"/>

                    <set_value name="$LidChanges" exact="0"/>
                    <set_value name="$Lid1State" exact="false"/>
                    <set_value name="$Lid2State" exact="false"/>
                  </actions>
                  <patch sinceversion="2">
                    <set_value name="$SwitchHullMin" exact="0.1"/>
                    <set_value name="$SwitchHullMax" exact="100" comment="percentage, absolute is 10"/>
                  </patch>
                  <cues>
                    <cue name="Ch6_Objective_Lids" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$PrisonLevel2Switches ge 2"/>
                      </conditions>
                      <actions>
                        <set_value name="$LidsDone" exact="0"/>
                        <set_value name="$LidsDone" exact="1" operation="add" chance="if $Lid1State then 100 else 0"/>
                        <set_value name="$LidsDone" exact="1" operation="add" chance="if $Lid2State then 100 else 0"/>

                        <!-- Unlock Switch Covers at: Prison Level 2 -->
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30252,6057}" text="{30252,6012}"  updatebriefing="true" silent="true" >
                          <progress text="{30252,6058}" progress="$LidsDone" max="2"/>
                        </set_objective>
                      </actions>
                    </cue>

                    <cue name="Ch6_SwitchRiddle_InitialState">
                      <actions>
                        <!-- solved when all are set to min -->
                        <set_value name="$IgnoreSwitch"/>
                        <set_object_hull object="$PrisonSwitch1" exact="$SwitchHullMax"/>
                        <set_object_hull object="$PrisonSwitch2" exact="$SwitchHullMin"/>
                        <set_object_hull object="$PrisonSwitch3" exact="$SwitchHullMin"/>
                        <set_object_hull object="$PrisonSwitch4" exact="$SwitchHullMin"/>
                        <set_object_hull object="$PrisonSwitch5" exact="$SwitchHullMax"/>
                        <remove_value name="$IgnoreSwitch"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Lid1_Deactivated" instantiate="true">
                      <conditions>
                        <event_player_deactivated_platform_trigger component="$PrisonCorridor" group="tag.lidgroup1" />
                      </conditions>
                      <actions>
                        <set_value name="$Lid1State" exact="false"/>
                        <set_value name="$LidChanges" operation="add"/>
                        <signal_cue cue="Ch6_Objective_Lids"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_Lid1_Deactivated_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="Lines"             value="[[30252634],[30252635] ]"/>
                          <param name="EndSignalCue"      value="null"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Lid1_Activated" instantiate="true">
                      <conditions>
                        <event_player_activated_platform_trigger component="$PrisonCorridor" group="tag.lidgroup1" />
                      </conditions>
                      <actions>
                        <set_value name="$Lid1State" exact="true"/>
                        <signal_cue cue="Ch6_Objective_Lids"/>
                        <do_if value="$Lid1State and $Lid2State">
                          <signal_cue_instantly cue="Axiom_Comments" param="[[30252632], [30252633]]" comment="continue with switch-riddle"/>
                        </do_if>
                        <do_elseif value="$LidChanges == 0">
                          <signal_cue_instantly cue="Axiom_Comments" param="[[30252630], [30252631]]" comment="find other lid-switch"/>
                        </do_elseif>
                        <do_else>
                          <signal_cue_instantly cue="Axiom_Comments" param="[[30252631]]" comment="both lids must be open"/>
                        </do_else>
                        <set_value name="$LidChanges" operation="add"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Lid2_Deactivated" instantiate="true">
                      <conditions>
                        <event_player_deactivated_platform_trigger component="$PrisonCorridor" group="tag.lidgroup2" />
                      </conditions>
                      <actions>
                        <set_value name="$Lid2State" exact="false"/>
                        <set_value name="$LidChanges" operation="add"/>
                        <signal_cue cue="Ch6_Objective_Lids"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_Lid2_Deactivated_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="Lines"             value="[[30252634],[30252635] ]"/>
                          <param name="EndSignalCue"      value="null"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Lid2_Activated" instantiate="true">
                      <conditions>
                        <event_player_activated_platform_trigger component="$PrisonCorridor" group="tag.lidgroup2" />
                      </conditions>
                      <actions>
                        <set_value name="$Lid2State" exact="true"/>
                        <signal_cue cue="Ch6_Objective_Lids"/>
                        <do_if value="$Lid1State and $Lid2State">
                          <signal_cue_instantly cue="Axiom_Comments" param="[[30252632], [30252633]]" comment="continue with switch-riddle"/>
                        </do_if>
                        <do_elseif value="$LidChanges == 0">
                          <signal_cue_instantly cue="Axiom_Comments" param="[[30252630], [30252631]]" comment="find other lid-switch"/>
                        </do_elseif>
                        <do_else>
                          <signal_cue_instantly cue="Axiom_Comments" param="[[30252631]]" comment="not all lids open"/>
                        </do_else>
                        <set_value name="$LidChanges" operation="add"/>
                      </actions>
                      <cues>

                      </cues>
                    </cue>

                    <cue name="Ch6_BothLids_Open">
                      <conditions>
                        <event_speak_finished actor="$AxiomActor" line="30252632"/>
                      </conditions>
                      <actions>
                        <set_value name="$LidTaskComplete" exact="true"/>
                        <set_value name="$ObjectiveStep" operation="add"/>
                        <!-- Bypass Security System -->
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30252,6014}" comment="setting group $PrisonSwitches adds a dock at station objective.. " updatebriefing="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_RiddleSwitch_Toggled" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold group="$PrisonSwitches"/>
                          <event_object_hull_below_function_threshold group="$PrisonSwitches"/>
                        </check_any>
                        <check_value value="not $IgnoreSwitch?" comment="trigger only player input, not switches set as a result of that"/>
                      </conditions>
                      <actions>

                        <!-- Toggle Neighbouring Switches -->
                        <set_value name="$IgnoreSwitch"/>

                        <do_if value="event.object == $PrisonSwitch1">
                          <debug_text text="'Switch 1 toggled ' + event.object.hull" chance="$DebugChance"/>
                          <signal_cue_instantly cue="Ch6_RiddleSwitch_Flip" param="$PrisonSwitch2"/>
                        </do_if>
                        <do_elseif value="event.object == $PrisonSwitch2">
                          <debug_text text="'Switch 2 toggled ' + event.object.hull" chance="$DebugChance"/>
                          <signal_cue_instantly cue="Ch6_RiddleSwitch_Flip" param="$PrisonSwitch1"/>
                          <signal_cue_instantly cue="Ch6_RiddleSwitch_Flip" param="$PrisonSwitch3"/>
                        </do_elseif>
                        <do_elseif value="event.object == $PrisonSwitch3">
                          <debug_text text="'Switch 3 toggled ' + event.object.hull" chance="$DebugChance"/>
                          <signal_cue_instantly cue="Ch6_RiddleSwitch_Flip" param="$PrisonSwitch2"/>
                          <signal_cue_instantly cue="Ch6_RiddleSwitch_Flip" param="$PrisonSwitch4"/>
                        </do_elseif>
                        <do_elseif value="event.object == $PrisonSwitch4">
                          <debug_text text="'Switch 4 toggled ' + event.object.hull" chance="$DebugChance"/>
                          <signal_cue_instantly cue="Ch6_RiddleSwitch_Flip" param="$PrisonSwitch3"/>
                          <signal_cue_instantly cue="Ch6_RiddleSwitch_Flip" param="$PrisonSwitch5"/>
                        </do_elseif>
                        <do_elseif value="event.object == $PrisonSwitch5">
                          <debug_text text="'Switch 5 toggled ' + event.object.hull" chance="$DebugChance"/>
                          <signal_cue_instantly cue="Ch6_RiddleSwitch_Flip" param="$PrisonSwitch4"/>
                        </do_elseif>
                        <do_else>
                          <debug_text text="'Switch ? toggled %s %s %s'.[event.object.name, event.object.name, event.object.grouptag]" chance="$DebugChance"/>
                          <assert value="false" text="'Unknown switch?!'"/>
                        </do_else>

                        <remove_value name="$IgnoreSwitch"/>

                        <!-- Hints -->
                        <signal_cue cue="Ch6_Riddle_Hint_SwitchesAffecting" check="false"/>

                        <!-- Update Objective -->
                        <set_value name="$DeactivatedSwitches" exact="0"/>
                        <do_for_each in="$PrisonSwitches" name="$switch">
                          <do_if value="not $switch.isfunctional">
                            <set_value name="$DeactivatedSwitches" operation="add" exact="1"/>
                          </do_if>
                        </do_for_each>

                        <do_if value="$LidTaskComplete?" comment="switch objective if both lids were open (at some point - even if the user now closed one or both)">
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30252,6014}"  updatebriefing="true" silent="true" comment="setting group $PrisonSwitches adds a dock at station objective.. ">
                            <progress text="{30252,6018}" progress="$DeactivatedSwitches" max="$PrisonSwitches.count"/>
                          </set_objective>
                        </do_if>

                        <!-- Check for Success -->
                        <do_if value="not ($PrisonSwitch1.isfunctional or $PrisonSwitch2.isfunctional or $PrisonSwitch3.isfunctional or  $PrisonSwitch4.isfunctional or $PrisonSwitch5.isfunctional)" comment="neither functional => Solved">
                          <signal_cue cue="Ch6_Riddle_Solved" check="false"/>
                        </do_if>

                      </actions>
                    </cue>

                    <cue name="Ch6_RiddleSwitch_Flip" instantiate="true">
                      <conditions>
                        <event_cue_signalled comment="event.param is a Switch"/>
                      </conditions>
                      <actions>
                        <do_if value="event.param.isfunctional">
                          <set_object_hull object="event.param" exact="$SwitchHullMin"/>
                          <debug_text text="'attempting to set min ' + event.param.hull" chance="$DebugChance"/>
                        </do_if>
                        <do_else>
                          <set_object_hull object="event.param" exact="$SwitchHullMax"/>
                          <debug_text text="'attempting to set max ' + event.param.hull" chance="$DebugChance"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch6_Riddle_Solved">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_triggers_locked object="$PrisonCorridor" group="tag.airlock_07" locked="false" comment="Floor3 spacesuit-airlock I" />
                        <set_triggers_locked object="$PrisonCorridor" group="tag.airlock_03" locked="false" comment="Floor3 spacesuit-airlock II" />
                        <signal_cue cue="md.Setup_DLC_Pirate.Setup_AirlockLights_Update" comment="update airlock green/orange lights"/>
                        <!--<set_triggers_locked object="$PrisonCorridor" group="tag.lidgroup1" locked="true" comment="Riddle Lids" />
                        <set_triggers_locked object="$PrisonCorridor" group="tag.lidgroup2" locked="true" comment="Riddle Lids" />-->
                      </actions>
                      <cues>
                        <cue name="Ch6_Riddle_Solved_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="Lines"             value="[[30252781],[30252660],[30252782],[30252783] ]"/>
                          <param name="EndSignalCue"      value="Ch6_Riddle_Solved_Done"/>
                          <!-- access to level 3-->
                          <!--
                          30252781	">	(	1/3	)	You got it, Wildcard!
                          30252782	">	(	2/3	)	And it turned off the darn fan!
                          30252783	">	(	3/3	)	Off to the hangar then.
                          -->
                        </cue>
                        <cue name="Ch6_Riddle_Solved_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$Ch6RiddleSolved" exact="true"/>
                            <set_value name="$ObjectiveStep" operation="add"/>
                            <!-- removed object="$PrisonCorridor" as it was a random point -->
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.explore" text="{30252,6013}" updatebriefing="true" />
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Riddle_Hints">
                      <cues>
                        <cue name="Ch6_Riddle_Hint_SwitchesAffecting">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                              <param name="Actor"             value="$AxiomActor"/>
                              <param name="Lines"             value="[[30252777], [30252778], [30252779], [30252780]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                              30252777	">	(	1/4	)	Something's off.	
                              30252778	">	(	2/4	)	The switches are also setting the state of their neighbours.	(Neighbouring switches)
                              30252779	">	(	3/4	)	You'll have to find a combination which turns them all off.	
                              30252780	">	(	4/4	)	I don't think a game whack-a-mole will get you there. Though.. actually it might.	
                              -->
                            </run_actions>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_HallwayHangar_Nearby" checkinterval="1s">
                  <conditions>
                    <check_value value="(player.sector == $PrisonStation.sector) and ($PrisonMarker_11.exists) and (player.entity.distanceto.{$PrisonMarker_11} lt 5m)"/>
                  </conditions>
                  <actions>
                    <do_if value="player.debug" comment="using noclip we can get to the hangar while skipping the switch-riddle">
                      <cancel_cue cue="Ch6_Floor2"/>
                      <cancel_cue cue="Ch6_SwitchRiddle"/>
                    </do_if>
                  </actions>
                  <cues>
                    <cue name="Ch6_HallwayHangar_Nearby_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$AxiomActor"/>
                      <param name="Lines"             value="[[30252680] ]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!-- hurry, near hangar -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_HallwayHangar_Prepare">
                  <conditions>
                    <event_speak_finished actor="$AxiomActor" line="30252680"/>
                  </conditions>
                  <actions>
                    <!--set_value name="$ObjectiveStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.steal" text="{30252,6015}" object="$EscapeShip" updatebriefing="true" /-->
                  </actions>
                  <cues>
                    <cue name="Ch6_TemporaryStationRelation_Periodic" checktime="5s" checkinterval="5s"  comment="avoid station retaliating if you attack the clamps">
                      <conditions>
                        <check_value value="$HangarClampsDestroyed lt 2"/>
                      </conditions>
                      <actions>
                        <do_if value="(player.sector == $EscapeShip.sector) and (player.entity.distanceto.{$EscapeShip} lt 100m)">
                          <debug_text text="'station relationchange = disabled'" chance="$DebugChance"/>
                          <set_object_relation_behaviour object="$PrisonStation" disable="true"/>
                          <!-- Evaluated component 0x908506 'props_special_shipclamp_01_macro' is not of class object -->
                          <!--do_for_each name="this.$clamp" in="$HangarClamps">
                            <set_object_relation_behaviour object="this.$clamp" disable="true"/>
                          </do_for_each-->
                        </do_if>
                        <do_else>
                          <debug_text text="'station relationchange = enabled'" chance="$DebugChance"/>
                          <set_object_relation_behaviour object="$PrisonStation" disable="false"/>
                        </do_else>
                      </actions>
                      <delay exact="5s"/>
                      <actions>
                        <reset_cue cue="Ch6_TemporaryStationRelation_Periodic"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_EnteredHangar">
                      <conditions>
                        <event_object_changed_room object="player.entity"/>
                        <check_value value="player.ship.isclass.spacesuit"/>
                        <check_value value="player.entity.distanceto.{$EscapeShip} lt 100m"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch6_Mellerd_Arrives"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_EnteredHangar_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="DelayInitial"      value="5s"/>
                          <param name="Lines"             value="[[30252684] ]"/>
                          <param name="EndSignalCue"      value="Ch6_DestroyClamps_Objective"/>
                          <!-- unlock clamps, open bay doors -->
                        </cue>
                        <cue name="Ch6_DestroyClamps_Objective">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <set_value name="$ObjectiveStep" operation="add" comment="next objective-slot"/>
                            <signal_cue cue="Ch6_Hangar_Objective"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <!-- entering hangar -->

                <cue name="Ch6_Hangar_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$HangarClampsDestroyed lt 2" comment="still need to destroy clamps?">
                      <!-- overwrite current objective step -->
                      <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.destroy" text="{30252,6017}" group="$HangarClamps" updatebriefing="true" suggestdocking="false" />
                      <reset_cue cue="Ch6_Hangar_Objective"/>
                    </do_if>
                    <do_elseif value="not ($HangarDoor1Done? and $HangarDoor2Done?)" comment="still need to open both doors?">
                      <!-- overwrite current objective step -->
                      <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.sabotage" text="{30252,6016}" group="$HangarDoors" updatebriefing="true" suggestdocking="false" />
                      <reset_cue cue="Ch6_Hangar_Objective"/>
                    </do_elseif>
                    <do_else>
                      <set_objective cue="$MissionCue" action="objective.wait" comment="no need to update briefing" />
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch6_ClampsDestroyed" instantiate="true">
                  <conditions>
                    <event_object_destroyed group="$HangarClamps"/>
                    <set_value name="$HangarClampsDestroyed" operation="add"/>
                    <check_value value="$HangarClampsDestroyed ge 2"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <do_if value="not ($HangarDoor1Done? and $HangarDoor2Done?)" comment="only if not already done">
                      <signal_cue_instantly cue="Axiom_Comments" param="[[30252690]]" comment="get those hangar doors open!" />
                    </do_if>
                  </actions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue cue="Ch6_Hangar_Objective"/>
                  </actions>
                </cue>

                <cue name="Ch6_Hangar_Alert" comment="alert, when first clamp destroyed">
                  <conditions>
                    <event_object_destroyed group="$HangarClamps"/>
                  </conditions>
                  <actions>
                    <set_alert_level object="$PrisonStation" level="red" />
                  </actions>
                  <delay exact="2s"/>
                  <actions>
                    <signal_cue_instantly cue="Axiom_Comments" param="[[30252686]]" comment="run for the ship" />
                    <signal_cue cue="Ch6_SpacesuitAxion_Escape"/>
                    <signal_cue cue="Ch6_SpacesuitStev_Escape"/>
                  </actions>
                  <delay exact="300s"/>
                  <actions>
                    <set_alert_level object="$PrisonStation" level="green" />
                  </actions>
                </cue>

                <cue name="Ch6_HangarDoors_Open" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_object_hull_above_function_threshold group="$HangarDoors"/>
                      <event_object_hull_below_function_threshold group="$HangarDoors"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <!-- TODO: repair or destroy? -->
                    <do_if value="event.object == $HangarDoor1">
                      <set_value name="$HangarDoor1Done" exact="true"/>
                    </do_if>
                    <do_if value="event.object == $HangarDoor2">
                      <set_value name="$HangarDoor2Done" exact="true"/>
                    </do_if>
                    <do_if value="$HangarDoor1Done? and $HangarDoor2Done?">
                      <signal_cue cue="Ch6_Hangar_Objective"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch6_SpacesuitAxion_Escape">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor,
                                                                                                  table[
                                                                                                  $requestercue = $MissionCue,
                                                                                                  $location = 'inert',
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]" comment="add inert request for Axiom to be placed as pilot of the spacesuit"/>
                    <create_ship name="$AxiomSpacesuit" sector="$EighteenBillionSector" capturable="false" commandeerable="false" missioncue="namespace" macro="ship_par_xs_spacesuit_01_a_macro">
                      <owner exact="faction.scavenger"/>
                      <pilot actor="$AxiomActor"/>
                      <position value="$PrisonMarker_12.position" object="$PrisonModule" />
                      <rotation yaw="-180deg" pitch="0deg" roll="0deg"/>
                    </create_ship>
                    <debug_text text="'Axiom-Spacesuit %s'.[$AxiomSpacesuit]" chance="$DebugChance"/>
                    <disable_collision_response object="$AxiomSpacesuit" comment="avoid bouncing"/>

                    <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                      <param name="Object" value="$AxiomSpacesuit"/>
                      <param name="RequesterCue" value="namespace"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>
                    <set_object_relation_behaviour object="$AxiomSpacesuit" disable="true" comment="ignore friendly-fire"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_AxiomSpacesuit_Order">
                      <actions>
                        <debug_text text="'Axiom Spacesuit-order apply'" chance="$DebugChance"/>
                        <cancel_all_orders object="$AxiomSpacesuit"/>
                        <create_order id="'MoveGeneric'" object="$AxiomSpacesuit">
                          <param name="destination" value="$PrisonModule"/>
                          <param name="position" value="$PrisonMarker_13.position"/>
                          <param name="precise" value="true"/>
                          <param name="disablecollisionavoidance" value="true"/>
                        </create_order>
                        <create_order id="'MoveGeneric'" object="$AxiomSpacesuit">
                          <param name="destination" value="$PrisonModule"/>
                          <param name="position" value="$PrisonMarker_14.position"/>
                          <param name="precise" value="true"/>
                          <param name="disablecollisionavoidance" value="true"/>
                        </create_order>
                        <create_order id="'DockAndWait'" object="$AxiomSpacesuit" default="true">
                          <param name="destination" value="$EscapeShip"/>
                          <param name="noattackresponse" value="true"/>
                          <param name="debugchance" value="0"/>
                        </create_order>
                      </actions>
                    </cue>

                    <cue name="Ch6_AxiomSpacesuit_Approach" checkinterval="0.5s">
                      <conditions>
                        <check_value value="($AxiomSpacesuit.exists) and ($AxiomSpacesuit.sector == $EscapeShip.sector) and ($AxiomSpacesuit.distanceto.{$EscapeShip} lt 15m)"/>
                        <!--check_value value="player.ship == $EscapeShip" comment="player can't see the dock, keep him updated on what is going on"/-->
                      </conditions>
                      <cues>
                        <cue name="Ch6_AxiomSpacesuit_Approach_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="Lines"             value="[[30288173] ]" comment="Approaching the dock. I'll be with you in a moment."/>
                          <param name="EndSignalCue"      value="null"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_AxiomSpaceSuit_ForceDock" comment="in case the AI doesn't manage to get near the ship">
                      <delay exact="40s"/>
                      <actions>
                        <cancel_cue cue="Ch6_AxiomSpaceSuit_Docked"/>
                        <signal_cue cue="Ch6_AxiomSpaceSuit_Continue"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_AxiomSpaceSuit_Docked">
                      <conditions>
                        <event_object_docked object="$AxiomSpacesuit"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch6_AxiomSpaceSuit_ForceDock"/>
                        <signal_cue cue="Ch6_AxiomSpaceSuit_Continue"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_AxiomSpaceSuit_Continue" comment="called by both docked/forcedock">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch6_AxiomSpacesuit_Approach"/>
                        <do_if value="$AxiomSpacesuit.exists" comment="doesn't exist if we force this cue">
                          <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                            <param name="Object" value="$AxiomSpacesuit"/>
                            <param name="RequesterCue" value="namespace"/>
                            <param name="DebugChance" value="$DebugChance"/>
                          </run_actions>
                          <cancel_all_orders object="$AxiomSpacesuit"/>
                          <remove_actor_from_room actor="$AxiomActor"/>
                          <dismiss_control_entity actor="$AxiomActor" object="$AxiomSpacesuit"/>
                          <destroy_object object="$AxiomSpacesuit" explosion="false"/>
                        </do_if>
                        <find_npc_waypoint name="$EscapeShipCabinSlot" object="$EscapeShip" tags="tag.npctransport"/>
                        <do_if value="$EscapeShipCabinSlot">
                          <set_entity_traits entity="$AxiomActor" hidden="true"/>
                          <add_actor_to_room actor="$AxiomActor" slot="$EscapeShipCabinSlot"/>
                        </do_if>
                        <do_else>
                          <add_actor_to_post_location actor="$AxiomActor"/>
                        </do_else>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <do_if value="$StevSpacesuit.exists" comment="docking hack">
                          <do_if value="true" comment="Test for Owen">
                            <!-- After docking npc is onboard of the $EscapeShip in the room 'cockpit' but not visible, neither visible in the UI. Place onboard as passenger -->
                            <set_entity_role entity="$AxiomActor" role="entityrole.passenger"/>
                            <set_entity_role_object entity="$AxiomActor" object="$EscapeShip"/>
                            <create_npc_template name="$AxiomTemplate" object="$EscapeShip" entity="$AxiomActor" role="entityrole.passenger"/>
                          </do_if>
                        </do_if>

                        <!-- TODO: (1/2) lib dialog hanging - transition of NPCs into the ship broken? -->
                        <set_value name="$lines" exact="if ($StevLuccaActor.ship == $EscapeShip) then [[30252688],[30252689]] else [[30252687],[30252689]]"/>
                        <set_value name="$EndSignalCue" exact="if ($StevLuccaActor.ship == $EscapeShip) then Ch6_TransferOwnership else null"/>
                        <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                          <param name="Actor"             value="$AxiomActor"/>
                          <param name="Lines"             value="$lines"/>
                          <param name="EndSignalCue"      value="$EndSignalCue"/>
                        </run_actions>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_SpacesuitStev_Escape">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$StevHiding" exact="false"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $StevLuccaActor,
                                                                                                  table[
                                                                                                  $requestercue = $MissionCue,
                                                                                                  $location = 'inert',
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]" comment="add inert request for Steve to be placed as pilot of the spacesuit"/>
                    <create_ship name="$StevSpacesuit" sector="$EighteenBillionSector" capturable="false" commandeerable="false" missioncue="namespace" macro="ship_arg_xs_spacesuit_01_a_macro">
                      <owner exact="faction.scavenger"/>
                      <pilot actor="$StevLuccaActor"/>
                      <position value="$PrisonMarker_19.position" x="2m" object="$PrisonModule" />
                      <rotation yaw="-180deg" pitch="0deg" roll="0deg"/>
                    </create_ship>
                    <debug_text text="'Stev-Spacesuits %s'.[$StevSpacesuit]" chance="$DebugChance"/>
                    <!--set_object_name object="$StevSpacesuit" name="$StevLuccaActor.name"/-->
                    <disable_collision_response object="$StevSpacesuit" comment="avoid bouncing"/>
                    <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                      <param name="Object" value="$StevSpacesuit"/>
                      <param name="RequesterCue" value="namespace"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>
                    <set_object_relation_behaviour object="$StevSpacesuit" disable="true" comment="ignore friendly-fire"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_StevSpacesuit_Order">
                      <delay exact="5s" comment="slightly slower then Axiom"/>
                      <actions>
                        <debug_text text="'Stev Spacesuit-order apply'" chance="$DebugChance"/>
                        <cancel_all_orders object="$StevSpacesuit"/>
                        <create_order id="'MoveGeneric'" object="$StevSpacesuit">
                          <param name="destination" value="$PrisonModule"/>
                          <param name="position" value="$PrisonMarker_13.position"/>
                          <param name="precise" value="true"/>
                          <param name="disablecollisionavoidance" value="true"/>
                        </create_order>
                        <create_order id="'MoveGeneric'" object="$StevSpacesuit">
                          <param name="destination" value="$PrisonModule"/>
                          <param name="position" value="$PrisonMarker_14.position"/>
                          <param name="precise" value="true"/>
                          <param name="disablecollisionavoidance" value="true"/>
                        </create_order>
                        <create_order id="'DockAndWait'" object="$StevSpacesuit" default="true">
                          <param name="destination" value="$EscapeShip"/>
                          <param name="noattackresponse" value="true"/>
                          <param name="debugchance" value="0"/>
                        </create_order>
                      </actions>
                    </cue>

                    <cue name="Ch6_StevSpacesuit_Approach" checkinterval="0.5s">
                      <conditions>
                        <check_value value="($StevSpacesuit.exists) and ($StevSpacesuit.sector == $EscapeShip.sector) and ($StevSpacesuit.distanceto.{$EscapeShip} lt 10m)"/>
                        <!--check_value value="player.ship == $EscapeShip" comment="player can't see the dock, keep him updated on what is going on"/-->
                      </conditions>
                      <cues>
                        <cue name="Ch6_StevLuccaSpacesuit_Approach_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$StevLuccaActor"/>
                          <param name="Lines"             value="[[30252686] ]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!-- Approaching the Dock -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_StevSpaceSuit_ForceDock" comment="in case the AI doesn't manage to get near the ship">
                      <delay exact="45s"/>
                      <actions>
                        <cancel_cue cue="Ch6_StevSpaceSuit_Docked"/>
                        <signal_cue cue="Ch6_StevSpaceSuit_Continue"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_StevSpaceSuit_Docked">
                      <conditions>
                        <event_object_docked object="$StevSpacesuit"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch6_StevSpaceSuit_ForceDock"/>
                        <signal_cue cue="Ch6_StevSpaceSuit_Continue"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_StevSpaceSuit_Continue" comment="called by both docked/forcedock">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch6_StevSpacesuit_Approach"/>
                        <do_if value="$StevSpacesuit.exists" comment="doesn't exist if we force this cue">
                          <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                            <param name="Object" value="$StevSpacesuit"/>
                            <param name="RequesterCue" value="namespace"/>
                            <param name="DebugChance" value="$DebugChance"/>
                          </run_actions>
                          <cancel_all_orders object="$StevSpacesuit"/>
                          <remove_actor_from_room actor="$StevLuccaActor"/>
                          <dismiss_control_entity actor="$StevLuccaActor" object="$StevSpacesuit"/>
                          <destroy_object object="$StevSpacesuit" explosion="false"/>
                        </do_if>
                        <find_npc_waypoint name="$EscapeShipCabinSlot" object="$EscapeShip" tags="tag.npctransport"/>
                        <do_if value="$EscapeShipCabinSlot">
                          <set_entity_traits entity="$StevLuccaActor" hidden="true"/>
                          <add_actor_to_room actor="$StevLuccaActor" slot="$EscapeShipCabinSlot"/>
                        </do_if>
                        <do_else>
                          <add_actor_to_post_location actor="$StevLuccaActor"/>
                        </do_else>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <!-- After docking npc is onboard of the $EscapeShip in the room 'cockpit' but not visible, neither visible in the UI. Place onboard as passenger -->
                        <do_if value="true" comment="test for Owen">
                          <set_entity_role entity="$StevLuccaActor" role="entityrole.passenger"/>
                          <set_entity_role_object entity="$StevLuccaActor" object="$EscapeShip"/>
                          <create_npc_template name="$StevTemplate" object="$EscapeShip" entity="$StevLuccaActor" role="entityrole.passenger"/>
                        </do_if>

                        <!-- TODO: (2/2) lib dialog hanging - transition of NPCs into the ship broken? -->
                        <set_value name="$lines" exact="if ($AxiomActor.ship == $EscapeShip) then [[30252688]] else [[30252687]]"/>
                        <set_value name="$EndSignalCue" exact="if ($AxiomActor.ship == $EscapeShip) then Ch6_TransferOwnership else null"/>
                        <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                          <param name="Actor"             value="$StevLuccaActor"/>
                          <param name="Lines"             value="$lines"/>
                          <param name="EndSignalCue"      value="$EndSignalCue"/>
                        </run_actions>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_TransferOwnership" comment="this guarantees both Axiom and Stev are onboard / transfering ownership allows the player to get onboard">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_TransferOwnership_Dialog" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$AxiomActor"/>
                      <param name="DelayInitial"      value="2s"/>
                      <param name="Lines"             value="[[30252691], [30252692], [30252693], [30252732, 2s]]"/>
                      <param name="EndSignalCue"      value="null" comment="checks individial speaks"/>
                      <!-- Get onboard so we can get out! -->
                    </cue>

                    <cue name="Ch6_TransferOwnership_Apply">
                      <conditions>
                        <check_any>
                          <event_speak_line_finished actor="$AxiomActor" line="30252692"/>
                          <event_speak_finished actor="$AxiomActor" line="30252691"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <set_owner object="$EscapeShip" faction="faction.player"/>
                        <set_value name="$ObjectiveStep" operation="add" comment="next objective-slot"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.embark" text="$EscapeShip.name" object="$EscapeShip" updatebriefing="true" />
                      </actions>
                    </cue>

                    <cue name="Ch6_WaitForPlayer">
                      <delay exact="30s"/>
                      <actions>
                        <signal_cue_instantly cue="Axiom_Comments" param="[[30252696]]" comment="Get onboard so we can get out!"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_PlayerOnboard">
                  <conditions>
                    <event_object_changed_room object="player.entity" room="$EscapeShip.controlroom"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch6_WaitForPlayer"/>
                    <set_value name="$ObjectiveStep" operation="add" comment="next objective-slot"/>
                    <get_safe_pos result="$RaiderHubProximityPos" object="$RaiderHubShip" min="3km" max="5km" radius="3km" sector="$RaiderHubShip.sector"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30252,6022}" object="$RaiderHubShip.sector" offset="$RaiderHubProximityPos" updatebriefing="true" />
                    <!-- player, Axiom, and Stev onboard - ship becomes vulnerable -->
                    <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                      <param name="Object" value="$EscapeShip"/>
                      <param name="RequesterCue" value="namespace"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>
                  </actions>
                </cue>

                <cue name="Ch6_PlayerSits">
                  <conditions>
                    <event_player_started_control/>
                    <check_value value="player.ship == $EscapeShip"/>
                  </conditions>
                  <actions>
                    <unlock_achievement name="TOA_PLOT_CRIMINAL_3" comment="On Raven Wings"/>
                    <set_emergency_eject_active active="false"/>
                  </actions>
                  <delay exact="1.5s" comment="give player some time, maybe already fly out of the hangar, before Mellerd initiates contact"/>
                  <actions>
                    <signal_cue cue="Ch6_Mellerd_Dialog"/>
                    <cancel_cue cue="Ch6_Prison"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Mellerd_Arrives" comment="signalled when player enters the hangar">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_ship name="$MellerdShip" macro="ship_tel_l_destroyer_02_a_macro" commandeerable="false" capturable="false" missioncue="namespace" sector="$RaiderHubShip.sector">
                  <owner exact="faction.ministry" overridenpc="true"/>
                  <pilot>
                    <select faction="faction.ministry" tags="tag.pilot"/>
                  </pilot>
                  <loadout ref="story_mellerd_destroyer"/>
                  <loadout>
                    <level exact="1.0"/>
                  </loadout>
                  <safepos object="$RaiderHubShip" min="5km" max="15km"/>
                </create_ship>
                <set_object_name object="$MellerdShip" page="30252" line="204" comment="Rolling Rock"/>
                <set_object_docking_enabled object="$MellerdShip" enabled="false" comment="disabled briefly, until Mellerd finishes speaking"/>

                <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                  <param name="Object" value="$MellerdShip"/>
                  <!--param name="IncludeEngines" value="true" comment="not a big deal if Mellerd can't move"-->
                  <param name="MinHull" value="100"/>
                  <param name="IncludeTurrets" value="true" comment="needs to fight"/>
                  <param name="IncludeShields" value="true"/>
                  <param name="IncludeEngines" value="true"/>
                  <param name="RequesterCue" value="namespace"/>
                  <param name="ReachedThresholdSignalCue" value="null"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </run_actions>
                <set_object_min_shield object="$MellerdShip" exact="60"/>

                <!-- Mellard moves (from her office where she was since ch4) onto the bridge of the destroyer -->
                <create_position name="$MellerdPos" x="0.8" z="0.50" y="0.72" space="$MellerdShip.controlroom"/>
                <create_rotation name="$MellerdRot" yaw="-20.0deg"/>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $KrissMellerdActor, 
                    table[$requestercue = $MissionCue, $priority = 100, $location = $MellerdShip.controlroom, $position = $MellerdPos, $rotation = $MellerdRot, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null] 
                    ]"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <signal_cue cue="Ch6_Mellerd_Fighter"/>
              </actions>
              <cues>
                <cue name="Ch6_Mellerd_Fighter">
                  <conditions>
                    <!--event_cue_completed cue="Ch6_Mellerd_Arrives"/-->
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$MellerdFighterMacro" exact="macro.ship_tel_s_fighter_01_a_macro"/>
                    <find_dockingbay name="this.$MellerdDockInternal" object="$MellerdShip" required="true">
                      <match_dock storage="true" size="$MellerdFighterMacro.docksize"/>
                    </find_dockingbay>
                    <create_ship name="$MellerdFighter" missioncue="namespace" macro="$MellerdFighterMacro" dock="this.$MellerdDockInternal" capturable="false" commandeerable="false">
                      <owner exact="$MellerdShip.owner"/>
                      <loadout ref="story_mellerd_fighter"/>
                    </create_ship>
                    <create_order object="$MellerdFighter" id="'Wait'">
                      <param name="noattackresponse" value="true"/>
                      <param name="allowdocked" value="true"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Ch6_RaiderHub_vs_Mellerd">
                  <actions>
                    <create_order object="$MellerdShip" id="'Attack'" name="$mellerd_attackorder" immediate="true">
                      <param name="primarytarget" value="$RaiderHubShip"/>
                      <param name="allowothertargets" value="false"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="checkrelation" value="false"/>
                      <param name="forceprimarytarget" value="true"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>
                    <create_order object="$RaiderHubShip" id="'Attack'" name="$raiderhub_attackorder" immediate="true">
                      <param name="primarytarget" value="$MellerdShip"/>
                      <param name="allowothertargets" value="false"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="checkrelation" value="false"/>
                      <param name="forceprimarytarget" value="true"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Ch6_Ace_vs_Mellerd" onfail="cancel">
                  <conditions>
                    <check_value value="$AceShip? and $AceShip.exists"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Ace to her ship'" chance="$DebugChance"/>
                    <!-- remove old pilot, if any (or Ace can't take over) -->
                    <do_if value="@$AceShip.pilot.exists">
                      <dismiss_control_entity actor="$AceShip.pilot" object="$AceShip" />
                      <signal_objects object="$AceShip.pilot" param="'npc_despawn'" param2="table[$disconnect = true]"/>
                    </do_if>
                    <!-- Ace last location was on the AE bridge (meeting start of ch6-start) -->
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $AceActor, $MissionCue]"/>
                    <assign_control_entity object="$AceShip" actor="$AceActor" post="controlpost.aipilot" transfer="true" init="true"/>
                    <signal_objects object="$AceActor" param="'npc_state_reinit'"/>
                    <!-- Defend the AE (which implicitly means attack Mellards ship, or any other attackers) -->
                    <create_order id="'AssignCommander'" object="$AceShip" immediate="true">
                      <param name="commander" value="$RaiderHubShip"/>
                      <param name="assignment" value="assignment.defence"/>
                      <param name="cancelorders" value="true"/>
                    </create_order>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_Create_MIN_Reinforcements">
              <conditions>
                <event_cue_completed cue="Ch6_Mellerd_Arrives"/>
              </conditions>
              <actions>
                <!-- create Security Response-->
                <find_dockingbay name="$PrisonStationDocks_M" object="$PrisonStation" multiple="true">
                  <match_dock storage="false" size="tag.dock_m" free="true"/>
                </find_dockingbay>
                <find_dockingbay name="$PrisonStationDocks_S" object="$PrisonStation" multiple="true">
                  <match_dock storage="false" size="tag.dock_s" free="true"/>
                </find_dockingbay>

                <do_all exact="2" counter="$i">
                  <get_ship_definition reference="$MINPoliceShipDef_M" size="class.ship_m" faction="faction.teladi" tags="tag.military"/>
                  <do_if value="$PrisonStationDocks_M.count">
                    <set_value name="$CurrentDock" exact="$PrisonStationDocks_M.{1}"/>
                    <create_ship name="$MIN_Ship" ref="$MINPoliceShipDef_M" dock="$CurrentDock" capturable="false" groupname="$MIN_Reinforcements">
                      <owner exact="faction.ministry" overridenpc="true" />
                      <pilot group="teladi.pilot"/>
                    </create_ship>
                    <remove_from_list name="$PrisonStationDocks_M" exact="$CurrentDock"/>
                  </do_if>
                  <do_else>
                    <create_ship name="$MIN_Ship" ref="$MINPoliceShipDef_M" capturable="false" sector="$PrisonStation.sector" groupname="$MIN_Reinforcements">
                      <owner exact="faction.ministry" overridenpc="true" />
                      <pilot group="teladi.pilot"/>
                      <safepos object="$PrisonStation" min="5km" max="15km"/>
                    </create_ship>
                  </do_else>
                  <create_order id="'AssignCommander'" object="$MIN_Ship" immediate="true">
                    <param name="commander" value="$MellerdShip"/>
                    <param name="assignment" value="assignment.defence"/>
                    <param name="cancelorders" value="true"/>
                  </create_order>
                </do_all>

                <do_all exact="2" counter="$i">
                  <get_ship_definition reference="$MINPoliceShipDef_S" size="class.ship_s" faction="faction.teladi" tags="tag.military"/>
                  <do_if value="$PrisonStationDocks_S.count">
                    <set_value name="$CurrentDock" exact="$PrisonStationDocks_S.{1}"/>
                    <create_ship name="$MIN_Ship" ref="$MINPoliceShipDef_S" dock="$CurrentDock" capturable="false" groupname="$MIN_Reinforcements">
                      <owner exact="faction.ministry" overridenpc="true" />
                      <pilot group="teladi.pilot"/>
                    </create_ship>
                    <remove_from_list name="$PrisonStationDocks_S" exact="$CurrentDock"/>
                  </do_if>
                  <do_else>
                    <create_ship name="$MIN_Ship" ref="$MINPoliceShipDef_S" capturable="false" sector="$PrisonStation.sector" groupname="$MIN_Reinforcements">
                      <owner exact="faction.ministry" overridenpc="true" />
                      <pilot group="teladi.pilot"/>
                      <safepos object="$PrisonStation" min="5km" max="15km"/>
                    </create_ship>
                  </do_else>
                  <create_order id="'AssignCommander'" object="$MIN_Ship" immediate="true">
                    <param name="commander" value="$MellerdShip"/>
                    <param name="assignment" value="assignment.defence"/>
                    <param name="cancelorders" value="true"/>
                  </create_order>
                </do_all>
              </actions>
            </cue>

            <cue name="Ch6_Mellerd_Dialog">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="$Flag_BetrayedMaestro == true">
                  <set_value name="$OptionalLine" exact="30252706"/>
                </do_if>
                <do_else>
                  <set_value name="$OptionalLine" exact="null"/>
                </do_else>
              </actions>
              <cues>
                <cue name="Ch6_Mellerd_Dialog_Ref_v2" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$MaestroActor, $AxiomActor, $KrissMellerdActor]"/>
                  <param name="DelayInitial"      value="[0s, 0s, 1s]"/>
                  <param name="Lines"             value="[[[30252716],[30252717],[30252718],[30252719]],
                                                          [[30252718]],
                                                          [[30252701],[30252702],[30252703],[30252704],[30252705],[$OptionalLine]]]"/>
                  <param name="EndSignalCue"      value="[null, null, Ch6_Mellerd_Dialog_Done]"/>
                  <!--
                  Maestro
                    <t id="30252716">(1/4)Split been moving into position.</t>
                    <t id="30252717">(2/4)Alarm must have mobilised more Ministry forces than Split anticipated!</t>
                    <t id="30252718">(3/4)Must have been ploy. Bait Curs so Mellerd not have to smoke us out.</t>
                    <t id="30252719">(4/4)No matter now. Dock fast, hand Split brother over!(eager)</t>
                  Axiom
                    <t id="30252718">Thrice blasted! Mellerd deployed a capital ship to head off the Arcadian Endeavour!(nervous)</t>
                  Mellerd
                    <t id="30252701">(1/6)Thank you for leading the old man and his crew of clowns right to my doorstep.</t>
                    <t id="30252702">(2/6)Crossing them off the Ministry's list will do wonders to advance my career.</t>
                    <t id="30252703">(3/6)You just stumbled into this whole affair, so I will offer you a onetime chance to get out of this.(if not betrayed plan to Mellerd)</t>
                    <t id="30252704">(4/6)All you have to do is dock at my ship to hand over the pirates you are currently harbouring.</t>
                    <t id="30252705">(5/6)You won't be able to keep the ship, but I will promise I will make it up to you!</t>
                    <t id="30252706">(6/6)This is what we agreed on. Dock, and our deal will be complete!(if betrayed plan to Mellerd)</t>
                  -->
                </cue>

                <cue name="Ch6_Mellerd_Dialog_Done">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_group groupname="$ChoiceShips"/>
                    <add_to_group groupname="$ChoiceShips" object="$RaiderHubShip"/>
                    <add_to_group groupname="$ChoiceShips" object="$MellerdShip"/>

                    <find_object_component groupname="$RaiderHubShipEngines" object="$RaiderHubShip" multiple="true" class="[class.engine]"/>
                    <find_object_component groupname="$MellerdShipEngines" object="$MellerdShip" multiple="true" class="[class.engine]"/>
                    <find_object_component groupname="$RaiderHubShipTurrets" object="$RaiderHubShip" multiple="true" class="[class.turret]"/>
                    <find_object_component groupname="$MellerdShipTurrets" object="$MellerdShip" multiple="true" class="[class.turret]"/>
                    <set_value name="$RaiderHubShipTurretsInitialCount" exact="$RaiderHubShipTurrets.count"/>
                    <set_value name="$MellerdShipTurretsInitialCount" exact="$MellerdShipTurrets.count"/>

                    <!--find_object_component groupname="$MellerdShipTurrets" object="$MellerdShip" multiple="true" class="[class.shieldgenerator]"/-->
                    <debug_text text="'RaiderHub Engines#%s Turrets#%s / MellerdShip Engines#%s Turrets#%s'.[$RaiderHubShipEngines.count, $RaiderHubShipTurrets.count, $MellerdShipEngines.count, $MellerdShipTurrets.count]" chance="$DebugChance"/>

                    <set_value name="$ObjectiveStep" operation="add" comment="next objective-slot"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30252,6023}" group="$ChoiceShips" updatebriefing="true" />

                    <set_object_docking_enabled object="$MellerdShip" enabled="true"/>
                    <signal_cue cue="Ch6_PlayerChoice"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <!-- Ch6_PlayerChoice
            
              Stolen Prototype is destroyed (after hangar-escape, before docking at either AE or MellerdShip)
              - Player is Emergency Ejected, Axiom and Steve die
              - Continues as-if chosen Mellerd, objective to destroy the AE's engines
            
              Player choses Mellerd
              - Axiom & Steve walk to the bridge of Mellerds ship as prisoners (can we have them cuffed?)
              - if any playerownedship attacks AE
	              - AE and Ace become vulnerable (on first hit)
              - Ace flees after 1 minute (prep for optional ch7 ambush)
              - if AE engines destroyed
	              - $MellerdShip Wait (10 minutes)
	              - $RaiderHubShip Wait (10 minutes)
	              - $MellerdShip (after 10 minutes)
	              - $RaiderHubShip explode (after 10 minutes 
              - if AE destroyed
	              - $MellerdShip movedie (with 600s delay)
              - if Ace destroyed 
	              - voiceline 

              Player choses Raiders 
              - if any playerownedship attacks Mellerd
	              - Mellerd becomes vulnerable 
	              - speech by Mellerd 
              - if Mellerd engines destroyed
	              - $MellerdShip movedie (with 600s delay) -> (needs to change for optional ch7 ambush)
	              - $RaiderHubShip patrol 
	              - $AceShip assignment.defence AE 
              - if Mellerd destroyed
	              - $RaiderHubShip patrol 
	              - $AceShip assignment.defence AE 
            -->

            <cue name="Ch6_ShipChange_Handler">
              <conditions>
                <event_cue_completed cue="Ch6_Mellerd_Dialog"/>
              </conditions>
              <actions>
                <set_emergency_eject_active active="false"/>
              </actions>
              <cues>

                <!-- Any time the player enters or exits the Prototype ship, the emergency eject is disabled/enabled -->
                <cue name="Ch6_ShipChange" instantiate="true">
                  <conditions>
                    <event_object_changed_object object="player.entity"/>
                    <check_value value="(event.param == $EscapeShip) or (event.param2 == $EscapeShip)"/>
                  </conditions>
                  <actions>
                    <do_if value="event.param2 == $EscapeShip">
                      <set_emergency_eject_active active="true"/>
                    </do_if>
                    <do_elseif value="event.param == $EscapeShip">
                      <set_emergency_eject_active active="false"/>
                    </do_elseif>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_PlayerChoice" comment="Player has to chose between docking at Mellerds ship or the RaiderHub and fight the other one">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch6_PlayerChoice_EscapeShip_Check" onfail="cancel">
                  <conditions>
                    <check_value value="not $EscapeShip.exists"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch6_PlayerChoice_EscapeShip"/>
                  </actions>
                </cue>

                <cue name="Ch6_PlayerChoice_EscapeShip_v2">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_object_destroyed object="$EscapeShip"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <!-- automatic choice for Mellerd -->
                    <debug_text text="'Stolen prototype with Axiom and Stev was destroyed...'" chance="$DebugChance"/>
                    <signal_cue cue="Ch6_PlayerChoice_Mellerd"/>
                  </actions>
                </cue>

                <cue name="Ch6_PlayerChoice_Mellerd_WrongShip" instantiate="true">
                  <conditions>
                    <event_object_docked object="$MellerdShip"/>
                    <check_value value="(event.param != $EscapeShip) and (event.param.owner == faction.player)"/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_PlayerChoice_Mellerd_WrongShip_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$KrissMellerdActor"/>
                      <param name="DelayInitial"      value="1s"/>
                      <param name="Lines"             value="[[30252733]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                        <t id="30252733">What, are you trying to fool me? The deal is off if you don't bring me the right ship!(if player delivers wrong ship)</t>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_PlayerChoice_Mellerd">
                  <conditions>
                    <check_any>
                      <event_cue_signalled comment="forced, in case $EscapeShip was destroyed"/>
                      <check_all>
                        <event_object_docked_at container="$MellerdShip"/>
                        <check_value value="event.param == $EscapeShip" comment="specifically this ship (with Axiom and Stev), player can't deliver another ship"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep" operation="add" comment="next objective-slot"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" object="$KrissMellerdActor" updatebriefing="true" />
                    <set_value name="$PlayerChoiceMellerd" exact="true"/>
                    <cancel_cue cue="Ch6_PlayerChoice_RaiderHubShip"/>
                    <cancel_cue cue="Ch6_PlayerChoice_Mellerd_WrongShip"/>

                    <cancel_cue cue="Ch6_ShipChange_Handler"/>
                    <set_emergency_eject_active active="true"/>

                    <set_relation_boost object="$RaiderHubShip" value="-1" faction="faction.player" silent="true" decay="0" comment="relentless"/>
                    <set_relation_boost object="$AceShip" value="-1" faction="faction.player" silent="true" decay="0" comment="relentless"/>

                    <create_position name="$MellerdPos" x="4.62" z="21.542"/>
                    <create_rotation name="$MellerdRot" yaw="162.0deg"/>

                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $KrissMellerdActor,
                                                                                                  table[
                                                                                                  $requestercue = $MissionCue,
                                                                                                  $location = $EscapeShip.dock,
                                                                                                  $priority = 100,
                                                                                                  $rotation = $MellerdRot,
                                                                                                  $position = $MellerdPos,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]"/>
                  </actions>
                  <delay exact="1s"/>
                  <actions>
                    <do_if value="$RaiderHubShipEngines.count == 0">
                      <signal_cue cue="Ch6_Mellerd_RaiderHubShip_Engines_Damaged" comment="already destroyed"/>
                    </do_if>

                  </actions>
                  <cues>

                    <cue name="Ch6_Mellerd_Prisoners" onfail="cancel">
                      <conditions>
                        <check_value value="($EscapeShip.exists) and (not $EscapeShip.iswreck)" comment="ignore, in case the ship was destroyed"/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_PlayerChoice_Mellerd_Dialog_Prisoners_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$KrissMellerdActor"/>
                          <param name="DelayInitial"      value="1s"/>
                          <param name="Lines"             value="[[30252714],[30252713],[30252715]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            <t id="30252714">(2/4)Your help is very much appreciated.</t>
                            <t id="30252713">(1/4)Step away from the ship now.(matter of fact)</t>
                            <t id="30252715">(3/4)Allow me to take the prisoners away.</t>
                            -->
                        </cue>

                        <cue name="Ch6_Mellerd_Prisoners_Disembark">
                          <delay exact="2s"/>
                          <actions>
                            <remove_npc_template object="$EscapeShip" template="$AxiomTemplate" comment="passenger/template from Ch6_AxiomSpaceSuit_Continue"/>
                            <remove_npc_template object="$EscapeShip" template="$StevTemplate"  comment="passenger/template from Ch6_StevSpaceSuit_Continue"/>

                            <find_object_component name="$ShipPrisonRoom" object="$MellerdShip" roomtype="roomtype.prison"/>
                            <set_value name="$ShipPrisonInterior" exact="$ShipPrisonRoom.dynamicinterior"/>
                            <set_dynamic_interior_persistent object="$MellerdShip" interior="$ShipPrisonInterior" persistent="true"/>

                            <create_position name="$StevPos" x="-2.94" z="-6.16"/>
                            <create_rotation name="$StevRot" yaw="4deg"/>
                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $StevLuccaActor,
                                table[ $requestercue = $MissionCue, $location = $ShipPrisonRoom, $priority = 100, $rotation = $StevRot, $position = $StevPos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null]
                              ]"/>

                            <create_position name="$AxiomPos" x="0.05" z="-6.02"/>
                            <create_rotation name="$AxiomRot" yaw="-6deg"/>
                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor,
                                table[ $requestercue = $MissionCue, $location = $ShipPrisonRoom, $priority = 100, $rotation = $AxiomRot, $position = $AxiomPos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null]
                              ]"/>

                            <set_entity_role entity="$StevLuccaActor" role="entityrole.prisoner"/>
                            <set_entity_role entity="$AxiomActor" role="entityrole.prisoner"/>

                          </actions>
                        </cue>
                        <cue name="Ch6_Mellerd_Axiom_Prisoner_Conversation" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$AxiomActor"/>
                            <check_value value="not (Post_Story_IdleLines_Mellerd.state == cuestate.complete)"/>
                            <check_value value="not (Post_Story_IdleLines_Pirates.state == cuestate.complete)"/>
                          </conditions>
                          <actions>
                            <speak actor="$AxiomActor" line="30252727" comment="(2/2)Why would you be doing this?(frustration)"/>
                          </actions>
                        </cue>
                        <cue name="Ch6_Mellerd_Stev_Prisoner_Conversation" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$StevLuccaActor"/>
                            <check_value value="not (Post_Story_IdleLines_Mellerd.state == cuestate.complete)"/>
                            <check_value value="not (Post_Story_IdleLines_Pirates.state == cuestate.complete)"/>
                          </conditions>
                          <actions>
                            <speak actor="$StevLuccaActor" line="30252705" comment="Please, no! Split kill you!(desperation and anger)"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Mellerd_NoPrisoners" onfail="cancel" comment="stolen prototype destroyed with Axiom and Steve onboard">
                      <conditions>
                        <check_value value="(not $EscapeShip.exists) or ($EscapeShip.iswreck)"/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_PlayerChoice_Mellerd_Dialog_NoPrisoners_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$KrissMellerdActor"/>
                          <param name="DelayInitial"      value="4s"/>
                          <param name="Lines"             value="[[30252735],[30252736,1s],[30252737,1s]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            <t id="30252735">(1/4)Hah, that is a very unconventional way of solving this particular conundrum.(slightly amused, when player ship destroyed)</t>
                            <t id="30252736">(2/4)But I guess I can make this work, still sell this as a victory to the Ministry.(more thinking out loud than talking to player)</t>
                            <t id="30252737">(3/4)Two down, two more to go.(Matter of fact)</t>
                            <t id="30252738">(4/4)Take out the Arcadian Endeavour's engines and I will forget the role you played in all this!</t>
                            -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Mellerd_Objective">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                      </actions>
                    </cue>

                    <cue name="Ch6_Mellerd_Conversation" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$KrissMellerdActor"/>
                        <check_value value="not (Post_Story_IdleLines_Mellerd.state == cuestate.complete)"/>
                        <check_value value="not (Post_Story_IdleLines_Pirates.state == cuestate.complete)"/>
                      </conditions>
                      <actions>
                        <!-- Note: This needs to work, irrelevant of wether the prisoners died (Raven destroyed) or were arrested (by Mellerd) -->
                        <do_if value="not $MellerdFighterGift?">
                          <set_value name="$MellerdFighterGift" exact="true"/>
                          <signal_cue cue="Ch6_RaiderHub_ShipSwap"/>
                          <add_npc_line speaker="$KrissMellerdActor">
                            <text line="30252716" comment="As we agreed, a brand-new Ministry ship for you"/>
                            <text line="30252718" comment="The Ministry wants the pirates alive, to make an example of them."/>
                            <text line="30252719" comment="So, I would preferably like to get my hands on the old fool alive."/>
                            <text line="30252720" comment="Help me out, will you?"/>
                          </add_npc_line>
                        </do_if>
                        <do_else>
                          <add_npc_line speaker="$KrissMellerdActor">
                            <text line="30252717" comment="Our work is not yet done!"/>
                          </add_npc_line>
                        </do_else>
                      </actions>
                      <cues>
                        <cue name="Ch6_Mellerd_ConversationEnded" instantiate="true">
                          <conditions>
                            <event_conversation_finished actor="$KrissMellerdActor"/>
                          </conditions>
                          <actions>
                            <do_if value="not $Ch6_RepeatConversation?">
                              <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                                <param name="Actor"             value="$AxiomActor"/>
                                <param name="DelayInitial"      value="2s"/>
                                <param name="SpeechPriority"    value="80"/>
                                <param name="Lines"             value="[[30252728]]"/>
                                <param name="EndSignalCue"      value="null"/>
                                <!--
                                  Why did you do this? We were wrong to trust you!
                                -->
                              </run_actions>
                              <set_value name="$Ch6_RepeatConversation"/>
                              <signal_cue cue="Ch6_RaiderHub_Vulnerable" comment="At this point, AE becomes vulnerable after first hit by player(owned)"/>
                            </do_if>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_RaiderHub_ShipSwap">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Confiscate_EscapeShip">
                          <actions>
                            <set_owner object="$EscapeShip" faction="$MellerdShip.owner"/>
                            <request_store_ship object="$MellerdShip" allowplayeronly="true" highpriority="false" ship="$EscapeShip" skiptimeout="true" />
                          </actions>
                        </cue>

                        <cue name="Ch6_Gift_MellerdFighter">
                          <actions>
                            <set_owner object="$MellerdFighter" faction="faction.player"/>
                            <request_retrieval queuedresult="$QueuedResult1" grantedresult="$GrantedResult1" ship="$MellerdFighter" highpriority="false" allowplayeronly="true" />
                            <!-- No problem if it doesn't work, player can always recall it himself, being the owner) -->
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_RaiderHub_Vulnerable">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep" operation="add" comment="next objective-slot"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.destroy" group="$RaiderHubShipEngines" updatebriefing="true" />
                      </actions>
                      <cues>
                        <cue name="Ch6_RaiderHub_Attacked2" comment="both raiderhub and mellerdship indestructible and in a battle, up to the point the player choses">
                          <conditions>
                            <check_any>
                              <event_object_attacked object="$RaiderHubShip"/>
                              <event_object_attacked object="$AceShip"/>
                            </check_any>
                            <check_value value="event.param.owner == faction.player" comment="attack by any player-owner ship removes invulnerability"/>
                          </conditions>
                          <actions>
                            <debug_text text="'AE Vulnerable, attacked by e.p=%s macro=%s fac=%s'.[event.param, event.param.macro, event.param.owner]" chance="$DebugChance"/>
                            <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                              <param name="Object" value="$RaiderHubShip"/>
                              <param name="RequesterCue" value="namespace"/>
                              <param name="DebugChance" value="$DebugChance"/>
                            </run_actions>
                            <set_object_min_shield object="$RaiderHubShip" exact="0"/>
                            <do_if value="$AceShip? and $AceShip.exists">
                              <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                                <param name="Object" value="$AceShip"/>
                                <param name="RequesterCue" value="namespace"/>
                                <param name="DebugChance" value="$DebugChance"/>
                              </run_actions>
                            </do_if>
                          </actions>
                          <cues>
                            <cue name="Ch6_Mellerd_Ace_DelayRetreat">
                              <delay min="2min" max="3min"/>
                              <actions>
                                <signal_cue cue="Ch6_Mellerd_Ace_Retreats"/>
                              </actions>
                            </cue>

                            <cue name="Ch6_Mellerd_Ace_LowHull">
                              <conditions>
                                <event_object_attacked object="$AceShip"/>
                                <check_value value="$AceShip.hullpercentage le 60"/>
                              </conditions>
                              <actions>
                                <cancel_cue cue="Ch6_Mellerd_Ace_DelayRetreat"/>
                                <signal_cue_instantly cue="Ch6_Mellerd_Ace_Retreats" param="event.param"/>
                              </actions>
                            </cue>

                            <cue name="Ch6_Mellerd_Ace_Retreats">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <debug_text text="'Ace is now trying to flee'" chance="$DebugChance"/>
                                <set_value name="$attacker" exact="if event.param then event.param else $MellerdShip"/>
                                <!-- Ace retreats after a while -->
                                <cancel_all_orders object="$AceShip"/>
                                <create_order id="'Patrol'" object="$AceShip" default="true">
                                  <param name="space" value="$S1a_North"/>
                                </create_order>
                                <create_order id="'MoveGeneric'" object="$AceShip">
                                  <param name="destination" value="$S1a_North"/>
                                  <param name="debugchance" value="$DebugChance"/>
                                </create_order>
                                <create_order id="'Flee'" object="$AceShip" immediate="true">
                                  <param name="method" value="'boost'"/>
                                  <param name="attacker" value="$attacker"/>
                                  <param name="donotdrop" value="true"/>
                                  <param name="deploydistraction" value="true"/>
                                  <param name="log" value="false"/>
                                  <param name="debugchance" value="$DeepDebugChance"/>
                                </create_order>
                                <!-- Give Ace a fleeing chance -->
                                <set_object_min_hull object="$AceShip" exact="20"/>
                              </actions>
                              <delay exact="8s"/>
                              <actions>
                                <set_object_min_hull object="$AceShip" exact="0"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Mellerd_RaiderHubShip_Turrets_Damaged" comment="one comment when at least 1/2 the turrets destroyed">
                      <conditions>
                        <event_object_destroyed group="$RaiderHubShipTurrets"/>
                        <check_value value="$RaiderHubShipTurrets.count lt ($RaiderHubShipTurretsInitialCount * 0.7)"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Destroyed part of turrets on RaiderHub ship'" chance="$DebugChance"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Mellerd_RaiderHubShip_Engines_Damaged" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <check_all>
                            <event_object_destroyed group="$RaiderHubShipEngines"/>
                            <check_value value="$RaiderHubShipEngines.count le 1"/>
                            <check_value value="event.param3 == false"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <!-- Enable post-story idle lines -->
                        <signal_cue cue="Post_Story_IdleLines_Mellerd"/>

                        <dismiss_pilot object="$RaiderHubShip"/>
                        <eject_npcs object="$RaiderHubShip"/>
                        <eject_people object="$RaiderHubShip"/>

                        <!-- Move Maestro to the Brig -->
                        <create_position name="$MaestroPos" x="2.86" z="-6.87"/>
                        <create_rotation name="$MaestroRot" yaw="184deg"/>
                        <set_entity_role entity="$MaestroActor" role="entityrole.prisoner"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MaestroActor,
                                table[ $requestercue = $MissionCue, $location = $ShipPrisonRoom, $priority = 100, $rotation = $MaestroRot, $position = $MaestroPos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null]
                        ]"/>

                        <!-- Cease MIN attack -->
                        <cancel_all_orders object="$MellerdShip"/>
                        <create_order object="$MellerdShip" id="'Wait'">
                          <param name="noattackresponse" value="false"/>
                        </create_order>
                        <cancel_all_orders object="$RaiderHubShip"/>
                        <create_order object="$RaiderHubShip" id="'Wait'">
                          <param name="noattackresponse" value="true"/>
                        </create_order>

                        <do_for_each name="$Ship" in="$MIN_Reinforcements">
                          <cancel_all_orders object="$Ship"/>
                          <create_order object="$Ship" id="'MoveDie'" immediate="true"/>
                        </do_for_each>
                        <set_owner object="$RaiderHubShip" faction="faction.ownerless"/>
                        <set_relation_boost object="$RaiderHubShip" value="0" faction="faction.player" silent="true" decay="0" comment="relentless"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_DestroyTurrets" instantiate="true" checkinterval="1s" onfail="cancel">
                          <conditions>
                            <check_value value="$RaiderHubShipTurrets.count ge 1"/>
                          </conditions>
                          <delay min="0.2s" max="1s"/>
                          <actions>
                            <do_if value="$RaiderHubShipTurrets.count">
                              <shuffle_group group="$RaiderHubShipTurrets"/>
                              <destroy_object object="$RaiderHubShipTurrets.{1}" explosion="true"/>
                            </do_if>
                          </actions>
                        </cue>

                        <cue name="Ch6_Mellerd_RaiderHubShip_Damaged_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$KrissMellerdActor"/>
                          <param name="DelayInitial"      value="1s"/>
                          <param name="Lines"             value="[[30252721],[30252722],[30252723],[30252724]]"/>
                          <param name="EndSignalCue"      value="Ch6_Mellerd_RaiderHubShip_Damaged_Done"/>
                          <!--
                            <t id="30252721">(1/4)Thank you. The Ministry will take it from here.</t>
                            <t id="30252722">(2/4)I will make sure to update your record to reflect your change of heart.</t>
                            <t id="30252723">(3/4)Rest assured the prisoners will be subject to a a fair trial before being transferred to an on-world prison.</t>
                            <t id="30252724">(4/4)Be proud of a job well done.</t>
                          -->
                        </cue>
                        <cue name="Ch6_Mellerd_RaiderHubShip_Damaged_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!-- RaiderHub damaged (explode after a while), Mellerd Waits near hubship and moveDie after a while -->
                            <signal_cue cue="Ch6_Complete"/>
                            <unlock_achievement name="TOA_PLOT_CRIMINAL_5" comment="Breaking up the Band"/>
                          </actions>
                          <delay exact="10min" comment="Ch6_Complete delays cancelling of the root-cue for 15min so this can still run"/>
                          <actions>
                            <cancel_all_orders object="$MellerdShip"/>
                            <create_order object="$MellerdShip" id="'MoveDie'" immediate="true">
                              <param name="byhostile" value="true"/>
                              <param name="mintime" value="600s" comment="stay alive for specified time"/>
                            </create_order>
                            <destroy_object object="$RaiderHubShip" explosion="true"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Mellerd_RaiderHubShip_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$RaiderHubShip"/>
                        <check_value value="not (Ch6_Mellerd_RaiderHubShip_Engines_Damaged.state == cuestate.complete)"/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <!-- Enable post-story idle lines -->
                        <signal_cue cue="Post_Story_IdleLines_Mellerd"/>
                        <unlock_achievement name="TOA_PLOT_CRIMINAL_5" comment="Breaking up the Band"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_Mellerd_RaiderHubShip_Destroyed_Dialog_Ref_v2" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$MaestroActor, $KrissMellerdActor]"/>
                          <param name="DelayInitial"      value="[0s, 2s]"/>
                          <param name="Lines"             value="[[[30252]],[[30252725],[30252726],[30252727]]]"/>
                          <param name="EndSignalCue"      value="[null, Ch6_Mellerd_RaiderHubShip_Destroyed_Done]"/>
                          <!--
                          Maestro
                            Split not expect to die today!
                          Mellerd
                            <t id="30252725">(1/3)I would have preferred to have taken him alive.(if pirate ship destroyed)</t>
                            <t id="30252726">(2/3)But then again, it does not really matter that much.(if pirate ship destroyed)</t>
                            <t id="30252727">(3/3)I still have the others to show for.(if pirate ship destroyed)</t>
                          -->
                        </cue>
                        <cue name="Ch6_Mellerd_RaiderHubShip_Destroyed_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!-- RaiderHub destroyed, Mellard moveDie -->
                            <do_for_each name="$Ship" in="$MIN_Reinforcements">
                              <cancel_all_orders object="$Ship"/>
                              <create_order object="$Ship" id="'MoveDie'" immediate="true">
                                <param name="mintime" value="60s" comment="stay alive for specified time, after it docks"/>
                              </create_order>
                            </do_for_each>
                            <create_order object="$MellerdShip" id="'MoveDie'" immediate="true">
                              <param name="byhostile" value="true"/>
                              <param name="mintime" value="600s" comment="stay alive for specified time"/>
                            </create_order>
                            <signal_cue cue="Ch6_Complete"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_AceShip_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$AceShip"/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                          <param name="Actor"             value="$AceActor"/>
                          <param name="Cutscene"         value="false"/>
                          <param name="Lines"             value="[[30252714]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                              This is Ace, signing off!(matter of fact, when character dies)
                          -->
                        </run_actions>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_PlayerChoice_RaiderHubShip_WrongShip" instantiate="true">
                  <conditions>
                    <event_object_docked object="$RaiderHubShip"/>
                    <check_value value="(event.param != $EscapeShip) and (event.param.owner == faction.player)"/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_PlayerChoice_RaiderHubShip_WrongShip_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$MaestroActor"/>
                      <param name="DelayInitial"      value="1s"/>
                      <param name="Lines"             value="[[30252749]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                        <t id="30252749">Where are Split brother and Axiom? Wildcard, this is wrong ship!(worked up, if player delivers wrong ship)</t>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_PlayerRequestDocking_Mellerd">
                  <conditions>
                    <event_object_dock_assigned_at object="$MellerdShip"/>
                    <check_value value="event.param2 == $EscapeShip"/>
                  </conditions>
                  <actions>
                    <!-- Trigger Axiom/Lucca flavour dialogue -->
                    <run_actions ref="md.LIB_Dialog.Speak_Actors_Run">
                      <param name="Actor"             value="[$AxiomActor, $StevLuccaActor]"/>
                      <param name="Lines"             value="[[[30252726],[30252727]],
                                                              [[30252702],[30252703]]]"/>
                      <param name="EndSignalCue"      value="[null, null]"/>
                      <!--
                        Axiom
                          Wildcard, this is the wrong ship...? Oh no!
                          Why would you be doing this?
                        Ace
                          No! Against better judgement Split trusted creature!
                          How dare it? Split will rip to shreds! Beat dead!
                      -->
                    </run_actions>
                  </actions>
                </cue>

                <cue name="Ch6_PlayerRequestDocking_Maestro">
                  <conditions>
                    <event_object_dock_assigned_at object="$RaiderHubShip"/>
                    <check_value value="event.param2 == $EscapeShip"/>
                  </conditions>
                  <actions>
                    <!-- Trigger Lucca flavour dialogue -->
                    <run_actions ref="md.LIB_Dialog.Speak_Actors_Run">
                      <param name="Actor"             value="[$StevLuccaActor, $AxiomActor]"/>
                      <param name="Lines"             value="[[[30252701]],[[30252719]]]"/>
                      <param name="EndSignalCue"      value="[null, null]"/>
                      <!--
                        Yes, almost there!
                      -->
                    </run_actions>
                  </actions>
                </cue>

                <cue name="Ch6_PlayerChoice_RaiderHubShip">
                  <conditions>
                    <event_object_docked_at container="$RaiderHubShip"/>
                    <check_value value="event.param == $EscapeShip" comment="specifically this ship (with Axiom and Stev)"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch6_ShipChange_Handler"/>
                    <set_emergency_eject_active active="true"/>

                    <set_value name="$PlayerChoiceAE" exact="true"/>
                    <cancel_cue cue="Ch6_PlayerChoice_Mellerd"/>
                    <cancel_cue cue="Ch6_PlayerChoice_RaiderHubShip_WrongShip"/>
                    <set_value name="$ObjectiveStep" operation="add" comment="next objective-slot"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.destroy" group="$MellerdShipEngines" updatebriefing="true" />
                    <set_relation_boost object="$MellerdShip" value="-1" faction="faction.player" silent="true" decay="0" comment="relentless"/>
                    <do_for_each name="$ship" in="$MIN_Reinforcements">
                      <set_relation_boost object="$ship" value="-1" faction="faction.player" silent="true" decay="0" comment="relentless"/>
                    </do_for_each>
                    <set_relation_boost object="$PrisonStation" silent="true" faction="faction.player" value="-1.0" decay="0.02" delay="540s" />
                  </actions>
                  <delay exact="1s"/>
                  <actions>
                    <do_if value="$MellerdShipEngines.count == 0" comment="already destroyed">
                      <signal_cue cue="Ch6_RaiderHub_Mellerd_Engines_Damaged"/>
                    </do_if>
                  </actions>
                  <cues>

                    <cue name="Ch6_Axiom_AssistanceCheck" onfail="cancel">
                      <conditions>
                        <check_value value="$Ch5_AceMission == false"/>
                      </conditions>
                      <delay exact="1min"/>
                      <cues>

                        <cue name="Ch6_Axiom_Assistance">
                          <conditions>
                            <event_cue_completed cue="Ch6_Axiom_AssistanceCheck"/>
                          </conditions>
                          <delay exact="8s"/>
                          <actions>
                            <!-- set the Mellerd crew to hostile to the station for a limited time -->
                            <set_relation_boost object="$MellerdShip" value="-1" otherobject="$PrisonStation" silent="true" decay="0" comment="relentless"/>
                            <do_for_each name="$ship" in="$MIN_Reinforcements">
                              <set_relation_boost object="$ship" value="-1" otherobject="$PrisonStation" silent="true" decay="0" comment="relentless"/>
                            </do_for_each>
                            <set_relation_boost object="$MellerdShip" value="0" faction="faction.player" silent="true" decay="0" comment="relentless"/>
                          </actions>
                          <delay exact="60s"/>
                          <actions>
                            <set_relation_boost object="$MellerdShip" value="0" otherobject="$PrisonStation" silent="true" decay="0" comment="relentless"/>
                            <do_for_each name="$ship" in="$MIN_Reinforcements">
                              <set_relation_boost object="$ship" value="0" otherobject="$PrisonStation" silent="true" decay="0" comment="relentless"/>
                            </do_for_each>
                            <set_relation_boost object="$PrisonStation" silent="true" faction="faction.player" value="-1.0" decay="0.02" delay="480s" />
                          </actions>
                          <cues>

                            <cue name="Ch6_Axiom_Turretlines_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor" value="$AxiomActor"/>
                              <param name="Lines" value="[[30252721],[30252722],[30252723]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                There is nothing quite as satisfying as triggering an EMP bomb!
                                You will see that the detonation tore created signal leaks that you can scan.
                                Change into scan mode and approach the leak to intercept the data leaking out.
                              -->
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch6_Ace_AssistanceCheck" onfail="cancel">
                      <conditions>
                        <check_value value="$Ch5_AceMission == true"/>
                      </conditions>
                      <delay exact="20s"/>
                      <cues>

                        <cue name="Ch6_Ace_Assistance">
                          <conditions>
                            <event_cue_completed cue="Ch6_Ace_AssistanceCheck"/>
                          </conditions>
                          <actions>
                            <!-- Trigger Ace flavour dialogue -->
                            <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="Lines"             value="[[30252704],[30252705],[30252706]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                  I am right beside you.
                                  Thanks to the ship you got me I can really dish out some damage!
                                  This is it... Attack!
                              -->
                            </run_actions>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch6_RaiderHub_Passengers">
                      <cues>
                        <cue name="Ch6_RaiderHub_Disembark">
                          <actions>
                            <remove_npc_template object="$EscapeShip" template="$AxiomTemplate" comment="passenger/template from Ch6_AxiomSpaceSuit_Continue"/>
                            <remove_npc_template object="$EscapeShip" template="$StevTemplate"  comment="passenger/template from Ch6_StevSpaceSuit_Continue"/>
                            <create_position name="$StevPos" x="3.17" y="0.1" z="-2.2" space="$RaiderHubShip.controlroom"/>
                            <create_rotation name="$StevRot" yaw="-173.3deg"/>
                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $StevLuccaActor,
                                table[ $requestercue = $MissionCue, $location = $RaiderHubShip.controlroom, $priority = 100, $rotation = $StevRot, $position = $StevPos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null]
                              ]"/>
                            <set_owner object="$StevLuccaActor" faction="faction.civilian"/>
                            <create_position name="$AxiomPos" x="-1.646" z="-7.321"/>
                            <create_rotation name="$AxiomRot" yaw="89.90deg"/>
                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AxiomActor,
                                table[ $requestercue = $MissionCue, $location = $RaiderHubShip.controlroom, $priority = 100, $rotation = $AxiomRot, $position = $AxiomPos, $debugchance = $DeepDebugChance, $debugcaller = if $DebugChance == 100 then this else null]
                              ]"/>
                            <set_owner object="$AxiomActor" faction="faction.civilian"/>
                          </actions>
                        </cue>
                        <cue name="Ch6_RaiderHub_Axiom_Conversation" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$AxiomActor"/>
                            <check_value value="not (Post_Story_IdleLines_Mellerd.state == cuestate.complete)"/>
                            <check_value value="not (Post_Story_IdleLines_Pirates.state == cuestate.complete)"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$AxiomActor" line="30288108" comment="(jubilant)Praise the twinkling stars, you did it!"/>
                          </actions>
                        </cue>
                        <cue name="Ch6_RaiderHub_Stev_Conversation" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$StevLuccaActor"/>
                            <check_value value="not (Post_Story_IdleLines_Mellerd.state == cuestate.complete)"/>
                            <check_value value="not (Post_Story_IdleLines_Pirates.state == cuestate.complete)"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$StevLuccaActor">
                              <text line="30252707" comment="(1/4)Split thanks creature for saving Split!(happy and grateful)"/>
                              <text line="30252710" comment="(4/4)Now leave Split to making arrangements to leave system for good!(determined but not unfriendly)"/>
                            </add_npc_line>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_PlayerChoice_RaiderHubShip_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$MaestroActor"/>
                      <param name="DelayInitial"      value="1s"/>
                      <param name="Lines"             value="[[30252720],[30252721],[30252722],[30252723],[30252724]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                        <t id="30252720">(1/5)Thanks be to the ancestors!</t>
                        <t id="30252721">(2/5)Lu t'Cca, join me on bridge!</t>
                        <t id="30252722">(3/5)Wildcard, Curs need help! Arcadian Endeavour cannot escape with Mellerd's ship functional!</t>
                        <t id="30252723">(4/5)Need to take out turrets and engines.</t>
                        <t id="30252724">(5/5)Only chance of escape! Get out there!</t>
                      -->
                    </cue>

                    <cue name="Ch6_RaiderHub_Mellerd_Attacked">
                      <conditions>
                        <event_object_attacked object="$MellerdShip"/>
                        <check_value value="event.param.owner == faction.player" comment="attack by any player-owner ship removes invulnerability"/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                          <param name="Object" value="$MellerdShip"/>
                          <param name="RequesterCue" value="namespace"/>
                          <param name="DebugChance" value="$DebugChance"/>
                        </run_actions>
                        <set_object_min_shield object="$MellerdShip" exact="0"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_RaiderHub_Mellerd_Attacked_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$KrissMellerdActor"/>
                          <param name="DelayInitial"      value="1s"/>
                          <param name="Lines"             value="[[30252707],[30252708],[30252709]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            <t id="30252707">(1/3)So you have chosen to go down with the sinking ship?(not surprised)</t>
                            <t id="30252708">(2/3)Ah, it is all the same to me!(indifferent)</t>
                            <t id="30252709">(3/3)One less loose end I would have to tie up later!</t>                    
                          -->
                        </cue>
                      </cues>
                    </cue>



                    <cue name="Ch6_RaiderHub_Mellerd_Turrets_Damaged_DEBUG" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <destroy_object object="$MellerdShipTurrets.random" explosion="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_RaiderHub_Mellerd_Turrets_Damaged" comment="one-time comment when part of the turrets are destroyed">
                      <conditions>
                        <event_object_destroyed group="$MellerdShipTurrets"/>
                        <check_value value="$MellerdShipTurrets.count lt ($MellerdShipTurretsInitialCount * .70)"/>
                        <check_value value="event.param3 == false"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Destroyed part of turrets on Mellerds ship'" chance="$DebugChance"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_RaiderHub_Mellerd_Turrets_Damaged_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$MaestroActor"/>
                          <param name="DelayInitial"      value="1s"/>
                          <param name="Lines"             value="[[30252726]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            <t id="30252726">We are taking less damage! Good!(when the player destroys turrets)</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_RaiderHub_Mellerd_Engines_Damaged_DEBUG" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <destroy_object object="$MellerdShipEngines.random" explosion="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_RaiderHub_Mellerd_Engines_Damaged" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <check_all>
                            <event_object_destroyed group="$MellerdShipEngines"/>
                            <check_value value="$MellerdShipEngines.count le 1"/>
                            <check_value value="event.param3 == false"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <unlock_achievement name="TOA_PLOT_CRIMINAL_4" comment="The Emyprean Curs"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_PlayerChoice_Mellerd_Damaged_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$MaestroActor"/>
                          <param name="DelayInitial"      value="1s"/>
                          <param name="Lines"             value="[[30252727],[30252728]]"/>
                          <param name="EndSignalCue"      value="Ch6_PlayerChoice_Mellerd_Damaged_Done"/>
                          <!--
                            <t id="30252727">(1/2)Their ship's engines are dead! Now is window to slip away!</t>
                            <t id="30252728">(2/2)Everyone, fall back!(excited)</t>
                          -->
                        </cue>

                        <cue name="Ch6_PlayerChoice_Mellerd_Damaged_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!-- MellerShip damaged (moveDie), cleanup RaiderHub (retreat / regular pirate plunder job) -->
                            <cancel_all_orders object="$MellerdShip"/>
                            <create_order object="$MellerdShip" id="'MoveDie'" immediate="true">
                              <param name="byhostile" value="true"/>
                              <param name="mintime" value="600s" comment="stay alive for specified time"/>
                            </create_order>
                            <cancel_all_orders object="$RaiderHubShip"/>
                            <!--create_order name="$RaiderHubOrder" id="'Plunder'" object="$RaiderHubShip">
                              <param name="space" value="$Mark"/>
                              <param name="base" value="$FenceStation"/>
                              <param name="returntobase" value="true"/>
                              <param name="basebasket" value="[$Ware]"/>
                              <param name="plundermode" value="1"/>
                              <param name="debugchance" value="$DebugChance"/>
                            </create_order-->
                            <create_order id="'Patrol'" object="$RaiderHubShip" default="true">
                              <param name="space" value="$S1a_North"/>
                            </create_order>
                            <create_order id="'MoveGeneric'" object="$RaiderHubShip" immediate="true">
                              <param name="destination" value="$S1a_North"/>
                              <param name="debugchance" value="$DebugChance"/>
                            </create_order>
                            <create_order id="'AssignCommander'" object="$AceShip" immediate="true">
                              <param name="commander" value="$RaiderHubShip"/>
                              <param name="assignment" value="assignment.defence"/>
                              <param name="cancelorders" value="true"/>
                            </create_order>
                            <do_for_each name="$Ship" in="$MIN_Reinforcements">
                              <cancel_all_orders object="$Ship"/>
                              <create_order object="$Ship" id="'MoveDie'" immediate="true">
                                <param name="mintime" value="60s" comment="stay alive for specified time, after it docks"/>
                              </create_order>
                            </do_for_each>
                            <signal_cue cue="Post_Story_IdleLines_Pirates"/>
                            <cancel_cue cue="Ch6_RaiderHub_Mellerd_Destroyed"/>
                            <signal_cue cue="Ch6_Fallback_v2"/>
                          </actions>
                          <delay exact="4s"/>
                          <actions>
                            <signal_cue_instantly cue="Mellerd_Comments" param="[[30252710],[30252711]]" comment="(1/2)No, I cannot let you get away!"/>
                          </actions>

                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_RaiderHub_Mellerd_Destroyed_DEBUG" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <destroy_object object="$MellerdShip" explosion="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_RaiderHub_Mellerd_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$MellerdShip"/>
                        <check_value value="not (Ch6_RaiderHub_Mellerd_Engines_Damaged.state == cuestate.complete)"/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <set_value name="$MellerdShipDestroyed"/>
                        <unlock_achievement name="TOA_PLOT_CRIMINAL_4" comment="The Emyprean Curs"/>
                      </actions>
                      <cues>

                        <cue name="Ch6_RaiderHub_Mellerd_Destroyed_Dialog1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$KrissMellerdActor"/>
                          <param name="DelayInitial"      value="1s"/>
                          <param name="Cutscene"          value="false"/>
                          <param name="Lines"             value="[[30252712]]"/>
                          <param name="EndSignalCue"      value="Ch6_RaiderHub_Mellerd_Destroyed_Dialog2"/>
                          <!--
                            <t id="30252712">No, please! I don't want to die!(when Mellerd's capital ship is blowing up)</t>
                          -->
                        </cue>

                        <cue name="Ch6_RaiderHub_Mellerd_Destroyed_Dialog2">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch6_RaiderHub_Mellerd_Destroyed_Dialog2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$MaestroActor"/>
                              <param name="DelayInitial"      value="3s"/>
                              <param name="Lines"             value="[[30252729],[30252730]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                <t id="30252729">(1/8)Split did not expect turning of battle.(when player destroys Mellerd's ship)</t>
                                <t id="30252730">(2/8)Wildcard demonstrated nature true to name.(when player destroys Mellerd's ship)</t>
                              -->
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch6_RaiderHub_Mellerd_Destroyed_Done">
                          <actions>
                            <!-- MellerdShip destroyed, Raiderhub retreats and turns to regular pirate plunderjob after a while-->
                            <cancel_all_orders object="$RaiderHubShip"/>
                            <cancel_all_orders object="$AceShip"/>
                            <!--create_order name="$RaiderHubOrder" id="'Plunder'" object="$RaiderHubShip">
                              <param name="space" value="$Mark"/>
                              <param name="base" value="$FenceStation"/>
                              <param name="returntobase" value="true"/>
                              <param name="basebasket" value="[$Ware]"/>
                              <param name="plundermode" value="1"/>
                              <param name="debugchance" value="$DebugChance"/>
                            </create_order-->
                            <create_order id="'Patrol'" object="$RaiderHubShip" default="true">
                              <param name="space" value="$S1a_North"/>
                            </create_order>
                            <create_order id="'MoveGeneric'" object="$RaiderHubShip" immediate="true">
                              <param name="destination" value="$S1a_North"/>
                              <param name="debugchance" value="$DebugChance"/>
                            </create_order>
                            <create_order id="'AssignCommander'" object="$AceShip" immediate="true">
                              <param name="commander" value="$RaiderHubShip"/>
                              <param name="assignment" value="assignment.interception"/>
                              <param name="cancelorders" value="true"/>
                            </create_order>
                            <do_for_each name="$Ship" in="$MIN_Reinforcements">
                              <cancel_all_orders object="$Ship"/>
                              <create_order object="$Ship" id="'MoveDie'" immediate="true">
                                <param name="mintime" value="60s" comment="stay alive for specified time, after it docks"/>
                              </create_order>
                            </do_for_each>
                            <signal_cue cue="Post_Story_IdleLines_Pirates"/>
                            <signal_cue cue="Ch6_Fallback_v2"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>


                    <cue name="Ch6_Fallback_v2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep" operation="add" comment="next objective-slot"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.retreat" object="$RaiderHubShip" updatebriefing="true" />
                        <set_value name="$EndTime" exact="player.age + 180s"/>
                      </actions>
                      <cues>

                        <cue name="Ch6_Fallback_Complete_v2" checkinterval="5s">
                          <conditions>
                            <check_any>
                              <check_value value="player.age ge $EndTime"/>
                              <check_value value="(player.entity.distanceto.{$RaiderHubShip} lt 5km) 
                                                      and ((player.entity.distanceto.{$MellerdShip} gt 45km) and (player.entity.distanceto.{$PrisonStation} gt 45km))"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <!-- return the ship back to being vulnerable -->
                            <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                              <param name="Object" value="$RaiderHubShip"/>
                              <param name="RequesterCue" value="namespace"/>
                              <param name="DebugChance" value="$DebugChance"/>
                            </run_actions>
                            <set_object_min_shield object="$RaiderHubShip" exact="0"/>

                            <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                              <param name="Object" value="$AceShip"/>
                              <param name="RequesterCue" value="namespace"/>
                              <param name="DebugChance" value="$DebugChance"/>
                            </run_actions>
                            <signal_cue cue="Ch6_Complete"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Complete" version="5">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="$PlayerChoiceAE?">
                  <!-- Trigger Axiom/Lucca flavour dialogue -->
                  <run_actions ref="md.LIB_Dialog.Speak_Actors_Run">
                    <param name="Actor"             value="[$MaestroActor, $AxiomActor, $MaestroActor]"/>
                    <param name="Lines"             value="[[[30252729],[30252730],[30252731],[30252732],[30252733],[30252734],[30252735],[30252736]],
                                                              [[30252724],[30252725]],
                                                              [[30252737]]]"/>
                    <param name="EndSignalCue"      value="[null, null, null]"/>
                    <!--
                        Maestro
                          Split did not expect turning of battle.
                          Wildcard demonstrated nature true to name.
                          Curs got away!
                          Still, this call was too close.
                          Everyone, regroup and take time to recover.
                          Wildcard, without you heist would not have been possible.
                          You are true Empyrean Cur!
                          Keep ship!
                        Axiom
                          Yes, I already took all the readings that were required as we were heading back to the Arcadian Endeavour.
                          This data will go a long way in making our pirate incursions more efficient.
                        Maestro
                          Yes, your contributions invaluable!
                      -->
                  </run_actions>
                  <set_userdata storystate="'story_criminal_wildcard'" value="1"/>
                </do_if>
                <do_else>
                  <do_if value="$RaiderHubShip.iswreck">
                    <!-- Trigger Axiom/Lucca flavour dialogue -->
                    <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                      <param name="Actor"             value="$KrissMellerdActor"/>
                      <param name="DelayInitial"      value="1s"/>
                      <param name="Lines"             value="[[30252721],[30252722],[30252723],[30252724]]"/>
                      <param name="EndSignalCue"      value="Ch6_Mellerd_RaiderHubShip_Damaged_Done"/>
                      <!--
                            <t id="30252721">(1/4)Thank you. The Ministry will take it from here.</t>
                            <t id="30252722">(2/4)I will make sure to update your record to reflect your change of heart.</t>
                            <t id="30252723">(3/4)Rest assured the prisoners will be subject to a a fair trial before being transferred to an on-world prison.</t>
                            <t id="30252724">(4/4)Be proud of a job well done.</t>
                          -->
                    </run_actions>
                  </do_if>
                  <add_faction_relation faction="faction.player" otherfaction="faction.ministry" value="0.015" reason="relationchangereason.missioncompleted"/>
                  <reward_player money="100000Cr"/>
                  <set_userdata storystate="'story_criminal_arrested_curs'" value="1"/>
                </do_else>
                <!-- cleanup and logging -->
                <remove_mission cue="$MissionCue" type="completed"/>
                <do_if value="$PlayerChoiceMellerd?">
                  <write_to_logbook category="missions" faction="faction.player" title="{30252,6031}" text="{30252,6033}" comment="You stole the Ministry of Finance prototype, and in doing so drew the Maestro and his Empyrean Curs close to Woodworm Scrubs, where Mellerd promptly..."/>
                </do_if>
                <do_elseif value="$PlayerChoiceAE?">
                  <write_to_logbook category="missions" faction="faction.player" title="{30252,6031}" text="{30252,6032}" comment="You rescued Lu t'Cca from his cell, and swiped an experimental Ministry of Finance prototype..."/>
                </do_elseif>
                <set_alert_level object="$PrisonStation" level="green" comment="avoid station being in red-alert state permanently" />
              </actions>
              <delay exact="3min"/>
              <actions>
                <do_if value="$PlayerChoiceAE?">
                  <write_incoming_message title="{30252,10101}" text="{30252,10102}" source="{30252,10103}" highpriority="false" comment="worldbuilding AE wrap-up email"/>
                </do_if>
                <do_else>
                  <write_incoming_message title="{30252,10201}" text="{30252,10202}" source="{30252,10203}" highpriority="false" comment="worldbuilding Mellerd wrap-up email"/>
                </do_else>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_criminal_arcadian_endeavour"/>
              </actions>
              <delay exact="12min" comment="Ships need delayed cleanup (ai-orders/destroy), wait until these are triggered"/>
              <actions>
                <signal_cue_instantly cue="Ch6_PlayerLeftTower" comment="We cease PlayerInTower handling so we don't want it"/>
                <!-- Reactivate Mass Traffic -->
                <do_if value="$DeactivatedCriminalMasstraffic?">
                  <set_job_active activate="true" job="'masstraffic_teladi_criminal'"/>
                  <remove_value name="$DeactivatedCriminalMasstraffic"/>
                </do_if>

                <set_job_active activate="true" job="'ministry_food_smuggler_s'"/>
                <set_job_active activate="true" job="'ministry_tech_trader_s'"/>

                <signal_cue cue="Ch7_Ambush"/>
                <cancel_cue cue="Ch6_Final" />
              </actions>
              <patch sinceversion="2" state="cancelled">
                <set_job_active activate="true" job="'ministry_food_smuggler_s'"/>
                <set_job_active activate="true" job="'ministry_tech_trader_s'"/>
              </patch>
              <patch sinceversion="3" state="cancelled">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_criminal_arcadian_endeavour"/>
              </patch>
              <patch sinceversion="4" state="active">
                <!-- Make Ace vulnerable again -->
                <do_if value="$AceShip.isoperational">
                  <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                    <param name="Object" value="$AceShip"/>
                    <param name="RequesterCue" value="namespace"/>
                    <param name="DebugChance" value="$DebugChance"/>
                  </run_actions>
                </do_if>
              </patch>
              <patch sinceversion="4" state="cancelled">
                <!-- Make Ace vulnerable again -->
                <do_if value="$AceShip.isoperational">
                  <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                    <param name="Object" value="$AceShip"/>
                    <param name="RequesterCue" value="namespace"/>
                    <param name="DebugChance" value="$DebugChance"/>
                  </run_actions>
                </do_if>
              </patch>
              <patch sinceversion="5" state="active">
                <!-- Add the Min reward after the fact -->
                <do_if value="$PlayerChoiceMellerd?">
                  <add_faction_relation faction="faction.player" otherfaction="faction.ministry" value="0.015" reason="relationchangereason.missioncompleted"/>
                  <reward_player money="100000Cr"/>
                </do_if>
              </patch>
              <patch sinceversion="5" state="cancelled">
                <!-- Add the Min reward after the fact -->
                <do_if value="$PlayerChoiceMellerd?">
                  <add_faction_relation faction="faction.player" otherfaction="faction.ministry" value="0.015" reason="relationchangereason.missioncompleted"/>
                  <reward_player money="100000Cr"/>
                </do_if>
              </patch>
            </cue>

          </cues>

        </cue>

        <cue name="Post_Story_IdleLines_Pirates">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Maestro_IdleLines_Pirates" instantiate="true">
              <conditions>
                <event_conversation_started actor="$MaestroActor"/>
              </conditions>
              <actions>
                <add_npc_line speaker="$MaestroActor">
                  <text line="30252747" comment="Wildcard!"/>
                  <text line="30252748" comment="Thousand thanks for getting brother out! And buying time to flee battle."/>
                </add_npc_line>
              </actions>
            </cue>

            <cue name="Axiom_IdleLines_Pirates" instantiate="true">
              <conditions>
                <event_conversation_started actor="$AxiomActor"/>
              </conditions>
              <actions>
                <add_npc_line speaker="$AxiomActor">
                  <text line="30252729" comment="The Ministry is working on some fascinating technology..."/>
                  <text line="30252730" comment="This all will take me some time to work through."/>
                </add_npc_line>
              </actions>
            </cue>

            <cue name="Ace_IdleLines_Pirates" instantiate="true">
              <conditions>
                <event_conversation_started actor="$AceActor"/>
              </conditions>
              <actions>
                <add_npc_line speaker="$AceActor">
                  <text line="30252711" comment="What a jolly excitement! I have to be honest, for a second there I thought we were done for!"/>
                  <text line="30252712" comment="I have to be honest, for a second there I thought we were done for!"/>
                  <text line="30252713" comment="But of course, we persevered! We had a Wildcard up our sleeve!"/>
                </add_npc_line>
              </actions>
            </cue>

            <cue name="Lucca_IdleLines_Pirates" instantiate="true">
              <conditions>
                <event_conversation_started actor="$StevLuccaActor"/>
              </conditions>
              <actions>
                <add_npc_line speaker="$StevLuccaActor">
                  <text line="30252707" comment="Split thanks creature for saving Split!(happy and grateful)"/>
                  <text line="30252708" delay="1s" comment="From situation creature put Split in."/>
                  <text line="30252709" comment="Should not be mad, is Kriss' fault!"/>
                  <text line="30252710" comment="Now leave Split to making arrangements to leave system for good!"/>
                </add_npc_line>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Post_Story_IdleLines_Mellerd">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Maestro_IdleLines_Mellerd" instantiate="true">
              <conditions>
                <event_conversation_started actor="$MaestroActor"/>
              </conditions>
              <actions>
                <add_npc_line speaker="$MaestroActor">
                  <text line="30252745" comment="Proud now? Serving Curs up to Mellerd?"/>
                  <text line="30252746" comment="Suppose you had no skin in the game. No honour either!"/>
                </add_npc_line>
              </actions>
            </cue>

            <cue name="Axiom_IdleLines_Mellerd" instantiate="true">
              <conditions>
                <event_conversation_started actor="$AxiomActor"/>
              </conditions>
              <actions>
                <add_npc_line speaker="$AxiomActor">
                  <text line="30252728" comment="Why did you do this? We were wrong to trust you!"/>
                </add_npc_line>
              </actions>
            </cue>

            <cue name="Ace_IdleLines_Mellerd" instantiate="true">
              <conditions>
                <event_conversation_started actor="$AceActor"/>
              </conditions>
              <actions>
                <add_npc_line speaker="$AceActor">
                  <text line="30252707" comment="How could you have done this?"/>
                </add_npc_line>
              </actions>
            </cue>

            <cue name="Lucca_IdleLines_Mellerd" instantiate="true">
              <conditions>
                <event_conversation_started actor="$StevLuccaActor"/>
              </conditions>
              <actions>
                <add_npc_line speaker="$StevLuccaActor">
                  <text line="30252705" comment="Please, no! Split kill you!"/>
                </add_npc_line>
              </actions>
            </cue>

            <cue name="Mellerd_IdleLines_Mellerd" instantiate="true">
              <conditions>
                <event_conversation_started actor="$KrissMellerdActor"/>
              </conditions>
              <actions>
                <add_npc_line speaker="$KrissMellerdActor">
                  <text line="30252728" comment="You have done the Ministry a great service."/>
                  <text line="30252729" comment="Best keep your nose reasonably clean from now on."/>
                  <text line="30252730" comment="Unfortunately, I do not have enough pull in the Ministry to offer complete impunity to associates. But I am sure I'll get there..."/>
                </add_npc_line>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch7_Force_AE_Choice">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch7_Mellerd_Ambush">
            <!-- Cancelling Previous Chapters -->
            <set_value name="$CurrentChapter" exact="Ch7_Ambush"/>
            <set_value name="$PlayerChoiceAE"/>

            <!-- Custom Setup -->
            <signal_cue cue="Ch7_Ambush"/>
          </force>
        </cue>

        <cue name="Ch7_Force_Mellerd_Choice">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch7_AE_Ambush">
            <!-- Cancelling Previous Chapters -->
            <set_value name="$CurrentChapter" exact="Ch7_Ambush"/>
            <set_value name="$PlayerChoiceMellerd"/>

            <!-- Custom Setup -->
            <create_loadout result="$AceLoadout" comment="Magpie Vanguard, S Courier (ship_tel_s_trans_container_01_a_macro)">
              <macros>
                <engine macro="engine_tel_s_combat_01_mk3_macro" path="../con_engine_02"/>
                <engine macro="engine_tel_s_combat_01_mk3_macro" path="../con_engine_01"/>
                <weapon macro="weapon_gen_s_gatling_01_mk2_macro" path="../con_weapon_01"/>
                <shield macro="shield_tel_s_standard_01_mk3_macro" path="../con_shield_01"/>
                <shield macro="shield_tel_s_standard_01_mk3_macro" path="../con_shield_02"/>
              </macros>
              <ammunition>
                <ammunition macro="countermeasure_flares_01_macro" exact="4"/>
              </ammunition>
              <software>
                <software ware="software_dockmk2"/>
                <software ware="software_flightassistmk1"/>
                <software ware="software_scannerlongrangemk2"/>
                <software ware="software_scannerobjectmk2"/>
                <software ware="software_targetmk1"/>
                <software ware="software_trademk1"/>
              </software>
              <virtualmacros>
                <thruster macro="thruster_gen_s_combat_01_mk3_macro"/>
              </virtualmacros>
            </create_loadout>
            <find_dockingbay name="this.$RaiderHubShipDockInternal" object="$RaiderHubShip" required="true">
              <match_dock storage="true" size="$AceShipMacro.docksize"/>
            </find_dockingbay>

            <create_ship name="$AceShip" missioncue="namespace" macro="macro.ship_tel_s_trans_container_01_a_macro" sector="$S1a_North" capturable="false" commandeerable="false">
              <owner exact="faction.civilian"/>
              <pilot actor="$AceActor"/>
              <loadout loadout="$AceLoadout"/>
              <equipmentmods>
                <engine ware="ware.mod_engine_forwardthrust_01_mk3"/>
                <shield ware="ware.mod_shield_capacity_01_mk3"/>
                <ship ware="ware.mod_ship_mass_01_mk3"/>
              </equipmentmods>
              <paint ware="ware.paintmod_0098"/>
            </create_ship>

            <set_value name="$AceShipDefault" exact="$AceShip" comment="$AceShip is the current one, but Ace can have multiple ships so keep references to them."/>
            <set_object_name object="$AceShip" page="30252" line="202" comment="Golden Flea"/>

            <signal_cue cue="Ch7_Ambush"/>
          </force>
        </cue>

        <cue name="Ch7_Ambush">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- The mission already completed, ch7 might trigger an ambush by whoever was betrayed in ch6 (without an active mission) -->
          </actions>
          <cues>
            <cue name="Ch7_Mellerd_Ambush" onfail="cancel">
              <conditions>
                <check_value value="$PlayerChoiceAE?" comment="player chose AE, Mellerd wants revenge"/>
              </conditions>
              <delay exact="28min"/>
              <actions>
                <debug_text text="'Mellerd ambush can now commence'" chance="$DebugChance"/>
              </actions>
              <cues>

                <cue name="DelayedTrigger_MellerdAmbush">
                  <conditions>
                    <event_cue_completed cue="Ch7_Mellerd_Ambush"/>
                  </conditions>
                  <cues>

                    <cue name="CheckForTELSpace">
                      <conditions>
                        <event_object_changed_sector object="player.entity"/>
                        <check_value value="event.param.owner == faction.teladi or event.param.owner == faction.ministry"/>
                        <check_value value="not player.container.isrealclass.station"/>
                        <check_value value="not player.isinconversation"/>
                        <check_value value="not player.isscreenshotmode"/>
                        <check_value value="not md.$MissionDND.count"/>
                      </conditions>
                      <actions>
                        <set_value name="$AmbushSector" exact="event.param"/>
                      </actions>
                      <cues>

                        <cue name="Create_AmbushShips">
                          <actions>
                            <set_value name="$PlayerShip" exact="player.entity.ship"/>
                            <set_value name="$AmbushTime" exact="player.age"/>
                            <do_if value="not $MellerdShipDestroyed?">

                              <create_ship name="$MellerdShip" macro="ship_tel_l_destroyer_02_a_macro" commandeerable="false" capturable="false" missioncue="namespace" sector="$AmbushSector" groupname="$AmbushFleet">
                                <owner exact="faction.ministry" overridenpc="true"/>
                                <pilot>
                                  <select faction="faction.ministry" tags="tag.pilot"/>
                                </pilot>
                                <loadout ref="story_mellerd_destroyer"/>
                                <loadout>
                                  <level exact="1.0"/>
                                </loadout>
                                <orientation orientation="look_at" refobject="$PlayerShip"/>
                                <safepos object="$PlayerShip" min="25km" max="35km"/>
                              </create_ship>
                              <set_object_name object="$MellerdShip" page="30252" line="204" comment="Rolling Rock"/>

                              <!-- Mellard moves (from her office where she was since ch4) onto the bridge of the destroyer -->
                              <create_position name="$MellerdPos" x="0.8" z="0.50" y="0.72" space="$MellerdShip.controlroom"/>
                              <create_rotation name="$MellerdRot" yaw="-20.0deg"/>
                              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $KrissMellerdActor, 
                                                                                                                table[$requestercue = $MissionCue,
                                                                                                                $priority = 100, $location = $MellerdShip.controlroom,
                                                                                                                $position = $MellerdPos, $rotation = $MellerdRot,
                                                                                                                $debugchance = $DeepDebugChance,
                                                                                                                $debugcaller = if $DebugChance == 100 then this else null] 
                                                                                                                ]"/>

                              <cancel_all_orders object="$MellerdShip"/>
                              <create_order object="$MellerdShip" id="'Attack'" name="$mellerd_attackorder" immediate="true">
                                <param name="primarytarget" value="$PlayerShip"/>
                                <param name="allowothertargets" value="false"/>
                                <param name="pursuetargets" value="true"/>
                                <param name="checkrelation" value="false"/>
                                <param name="forceprimarytarget" value="true"/>
                                <param name="debugchance" value="$DeepDebugChance"/>
                              </create_order>

                            </do_if>

                            <create_ship name="$AmbushShip" macro="macro.ship_tel_m_bomber_01_b_macro" commandeerable="false" capturable="false" sector="$AmbushSector" groupname="$AmbushFleet">
                              <owner exact="faction.ministry" overridenpc="true" />
                              <pilot actor="$MellerdsThugActor"/>
                              <loadout>
                                <level exact="1.0"/>
                              </loadout>
                              <orientation orientation="look_at" refobject="$PlayerShip"/>
                              <safepos object="$PlayerShip" min="15km" max="20km" radius="600m"/>
                            </create_ship>

                            <set_value name="$AmbushFleetComposition"   exact="[ macro.ship_tel_s_fighter_01_b_macro, macro.ship_tel_s_fighter_01_b_macro ]" />

                            <do_for_each in="$AmbushFleetComposition" name="$CurrentMacro" counter="$i">
                              <create_ship name="$CurrentShip" macro="$CurrentMacro" commandeerable="false" capturable="false" sector="$AmbushSector" groupname="$AmbushFleet">
                                <owner exact="faction.ministry" overridenpc="true" />
                                <pilot>
                                  <select faction="faction.ministry" tags="tag.fighterpilot"/>
                                </pilot>
                                <loadout>
                                  <level exact="1.0"/>
                                </loadout>
                                <orientation orientation="look_at" refobject="$PlayerShip"/>
                                <safepos object="$AmbushShip" min="1km" max="3km" radius="600m"/>
                              </create_ship>

                              <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                                <param name="commander" value="$AmbushShip"/>
                                <param name="assignment" value="assignment.attack"/>
                                <param name="cancelorders" value="true"/>
                              </create_order>
                            </do_for_each>

                            <create_order object="$AmbushShip" id="'Attack'" name="$ambushship_attackorder" immediate="true">
                              <param name="primarytarget" value="$PlayerShip"/>
                              <param name="allowothertargets" value="false"/>
                              <param name="pursuetargets" value="true"/>
                              <param name="checkrelation" value="false"/>
                              <param name="forceprimarytarget" value="true"/>
                              <param name="debugchance" value="$DeepDebugChance"/>
                            </create_order>

                          </actions>
                          <delay exact="0.5s"/>
                          <actions>
                            <!-- Trigger the dialogue -->
                            <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                              <param name="Actor"             value="$MellerdsThugActor"/>
                              <param name="Lines"             value="[[if $MellerdShipDestroyed? then 30252802 else 30252801],[30252803, 1s],[30252804]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                  Ma'am, I have a potential target in sights!/Stop right there, I need to get a read on you!
                                  Affiliation with Empyrean Curs confirmed.
                                  Everyone, engage!
                              -->
                            </run_actions>
                          </actions>
                        </cue>

                        <cue name="AmbushFleetCreated">
                          <conditions>
                            <event_cue_completed cue="Create_AmbushShips"/>
                          </conditions>
                          <cues>

                            <cue name="DelayedAttackComment">
                              <conditions>
                                <event_object_attacked_object group="$AmbushFleet"/>
                                <check_value value="event.param == $PlayerShip"/>
                              </conditions>
                              <actions>
                                <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                                  <param name="Actor"             value="$MellerdsThugActor"/>
                                  <param name="Lines"             value="[[30252805]]"/>
                                  <param name="EndSignalCue"      value="null"/>
                                  <!--
                                    That is what you get for crossing Mellerd!
                                  -->
                                </run_actions>
                              </actions>
                            </cue>

                            <cue name="MellerdThug_IdleConversation">
                              <conditions>
                                <event_conversation_started actor="$MellerdsThugActor"/>
                              </conditions>
                              <actions>
                                <add_npc_line speaker="$MellerdsThugActor" hidechoices="true">
                                  <text line="30252806" comment="We are done talking!"/>
                                </add_npc_line>
                              </actions>
                            </cue>

                            <cue name="Check_DistanceTo_MellerdShip" checkinterval="5s">
                              <conditions>
                                <check_value value="not $MellerdShipDestroyed?"/>
                                <check_value value="$MellerdShip.sector != player.entity.sector"/>
                                <check_value value="player.age gt ($AmbushTime + 10min)"/>
                              </conditions>
                              <actions>
                                <cancel_all_orders object="$MellerdShip"/>
                                <create_order object="$MellerdShip" id="'MoveDie'" immediate="true">
                                  <param name="byhostile" value="true"/>
                                  <param name="mintime" value="300s" comment="stay alive for specified time"/>
                                </create_order>
                              </actions>
                            </cue>

                            <cue name="Check_DistanceTo_AmbushShip" checkinterval="5s">
                              <conditions>
                                <check_value value="$AmbushShip.sector != player.entity.sector"/>
                                <check_value value="player.age gt ($AmbushTime + 10min)"/>
                              </conditions>
                              <actions>
                                <cancel_all_orders object="$MellerdShip"/>
                                <do_for_each name="$ship" in="$AmbushFleet">
                                  <create_order object="$ship" id="'MoveDie'" immediate="true">
                                    <param name="byhostile" value="true"/>
                                    <param name="mintime" value="60s" comment="stay alive for specified time"/>
                                  </create_order>
                                </do_for_each>
                              </actions>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch7_Raiders_Ambush" onfail="cancel">
              <conditions>
                <check_value value="$PlayerChoiceMellerd?" comment="player chose Mellerd, Raiders want revenge"/>
                <check_value value="$AceShip.exists"/>
              </conditions>
              <delay exact="30min"/>
              <actions>
                <debug_text text="'Ace ambush can now commence'" chance="$DebugChance"/>
                <set_object_hull object="$AceShip" exact="100"/>
              </actions>
              <cues>

                <cue name="AceShip_Destroyed">
                  <conditions>
                    <event_object_destroyed object="$AceShip"/>
                  </conditions>
                  <actions>
                    <!-- Ship has been destroyed in the meantime, cancel this chapter -->
                    <cancel_cue cue="Ch7_Ambush"/>
                  </actions>
                </cue>

                <cue name="DelayedTrigger_AceAmbush">
                  <conditions>
                    <event_cue_completed cue="Ch7_Raiders_Ambush"/>
                  </conditions>
                  <cues>

                    <cue name="CheckForAmbushSpace">
                      <conditions>
                        <event_object_changed_sector object="player.entity"/>
                        <check_value value="event.param.owner == faction.ownerless or event.param.owner == faction.loanshark or event.param.owner == faction.scavenger or event.param.owner == faction.player"/>
                        <check_value value="not player.container.isrealclass.station"/>
                        <check_value value="not player.isinconversation"/>
                        <check_value value="not player.isscreenshotmode"/>
                        <check_value value="not md.$MissionDND.count"/>
                      </conditions>
                      <actions>
                        <set_value name="$AmbushSector" exact="event.param"/>
                      </actions>
                      <cues>

                        <cue name="Warp_AceShip">
                          <actions>
                            <set_value name="$PlayerShip" exact="player.entity.ship"/>
                            <set_value name="$AmbushTime" exact="player.age"/>

                            <do_if value="$AceShip.exists">
                              <set_object_hull object="$AceShip" exact="100"/>
                              <set_object_shield object="$AceShip" exact="100"/>
                              <warp object="$AceShip" sector="$AmbushSector">
                                <orientation orientation="look_at" refobject="$PlayerShip"/>
                                <safepos object="$PlayerShip" min="5km" max="25km"/>
                              </warp>

                              <add_to_group object="$AceShip" groupname="$AmbushGroup"/>

                              <cancel_all_orders object="$AceShip"/>
                              <create_order object="$AceShip" id="'Attack'" name="$ace_attackorder" immediate="true">
                                <param name="primarytarget" value="$PlayerShip"/>
                                <param name="allowothertargets" value="false"/>
                                <param name="pursuetargets" value="true"/>
                                <param name="checkrelation" value="false"/>
                                <param name="forceprimarytarget" value="true"/>
                                <param name="debugchance" value="$DeepDebugChance"/>
                              </create_order>
                            </do_if>


                          </actions>
                          <delay exact="0.5s"/>
                          <actions>
                            <!-- Trigger the dialogue -->
                            <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                              <param name="Actor"             value="$AceActor"/>
                              <param name="Lines"             value="[[30252801],[30252802],[30252803]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                  There you are!
                                  I have been looking all over for you, you traitor!
                                  For the Maestro and the Axiom!
                              -->
                            </run_actions>
                          </actions>
                        </cue>

                        <cue name="Despawn_AceShip">
                          <conditions>
                            <event_object_changed_attention object="$AceShip" />
                            <check_value value="player.age gt ($AmbushTime + 10s)"/>
                            <check_value value="event.param lt attention.visible"/>
                          </conditions>
                          <actions>
                            <cancel_all_orders object="$AceShip"/>
                            <create_order object="$AceShip" id="'MoveDie'" immediate="true">
                              <param name="byhostile" value="true"/>
                              <param name="mintime" value="300s" comment="stay alive for specified time"/>
                            </create_order>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ace_AttackLine">
                      <conditions>
                        <event_object_attacked_object object="$AceShip"/>
                        <check_value value="event.param == $PlayerShip"/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Dialog.Speak_Actor_Run">
                          <param name="Actor"             value="$AceActor"/>
                          <param name="Lines"             value="[[30252804]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            The Curs shall have their revenge!
                          -->
                        </run_actions>
                      </actions>
                    </cue>

                    <cue name="Ace_IdleConversation">
                      <conditions>
                        <event_conversation_started actor="$AceActor"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$AceActor" hidechoices="true">
                          <text line="30252805" comment="No more talking!"/>
                        </add_npc_line>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

      </cues>

    </cue>
  </cues>
</mdscript>
